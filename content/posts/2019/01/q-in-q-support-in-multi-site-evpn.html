---
url: /2019/01/q-in-q-support-in-multi-site-evpn.html
title: "Q-in-Q Support in Multi-Site EVPN"
date: "2019-01-23T08:43:00.000+01:00"
tags: [ Design,VXLAN,EVPN ]
---

<p>One of my subscribers sent me a question along these lines (heavily abridged):</p>
<blockquote class="cite">My customer is running a colocation business, and has to provide L2 connectivity between racks, sometimes even across multiple data centers. They were using Q-in-Q to deliver that in a traditional fabric, and would like to replace that with multi-site EVPN fabric with ~100 ToR switches in each data center. However, Cisco doesn’t support Q-in-Q with multi-site EVPN. Any ideas?</blockquote>
<p>As Lukas Krattiger explained in his part of <a href="https://my.ipspace.net/bin/list?id=Clos#MULTISITE">Multi-Site Leaf-and-Spine Fabrics</a> section of <a href="https://www.ipspace.net/Leaf-and-Spine_Fabric_Architectures">Leaf-and-Spine Fabric Architectures</a> webinar, multi-site EVPN (VXLAN-to-VXLAN bridging) is hard. Don’t expect miracles like Q-in-Q over VNI any time soon ;)<!--more--></p>
<p>Also, Cisco’s Cloud Scale ASICs are the only chipsets supporting VXLAN-to-VXLAN bridging at this point - most recent merchant silicon can do VXLAN routing, including VXLAN-to-VXLAN routing, but I haven’t seen anyone else but Cisco doing VXLAN-to-VXLAN bridging or intra-VXLAN split-horizon flooding.</p>
<p>However, you might not need multi-site VXLAN bridging and/or IP multicast (or even EVPN). Figure out:</p>
<ul class="ListParagraph"><li><strong>What services the customer plans to offer</strong>. Are they looking for P2P pseudowires over VXLAN (E-line in Carrier Ethernet terminology) or any-to-any connectivity (E-LAN)? Can your preferred $vendor provide Q-in-Q with P2P VXLAN? If not, can any other vendor do that?</li>
<li><strong>What are the hardware limitations</strong> (number of VTEPs in ingress node replication list and total number of remote VTEPs per switch)? Have some serious discussions with the vendor engineers and get the answers in writing (and change vendor if they can’t/won’t provide them). Make your RFP contingent on meeting/exceeding these limitations.</li>
<li><strong>Is there a scenario where these hardware limitations could be exceeded?</strong> In the case of my subscriber, we’re not talking about any-to-any networking over a generic virtualized compute/networking infrastructure but about implementing Carrier Ethernet functionality with VXLAN.</li>
</ul>
<p class="more">Check out the <a href="https://blog.ipspace.net/2017/06/packet-fabric-on-software-gone-wild.html">podcast we did with PacketFabric</a> – they went through this same process and deployed a large-scale VXLAN-based solution in production without the complexities of multi-site EVPN.</p>
<p>If you figure out that the hardware limitations will not be exceeded, stop cramming complex technologies into places where they’re not needed. You might not need EVPN at all, automated flood list configuration based on customer/services database might be good enough (and more reliable/secure than a dynamic routing protocol ;).</p>
<p class="more">INEX did exactly this. Instead of using EVPN they automated flood list management with <a href="https://www.ixpmanager.org/">IXP Manager</a> (an open-source IXP orchestration tool). For more details, watch the <a href="https://my.ipspace.net/bin/list?id=NetAutSol&amp;module=6#M6S5">presentation Nick Hilliard had</a> in <a href="https://www.ipspace.net/Building_Network_Automation_Solutions">Building Network Automation Solutions</a> online course (available to course attendees and users with <a href="https://www.ipspace.net/Subscription/Individual">Expert Subscription</a>).</p>
<p>In any case, building a multi-site fabric with hundreds of edge switches is a complex problem, and like I said in the <a href="https://my.ipspace.net/bin/list?id=DCFabric#INTRO">introduction</a> to <a href="https://www.ipspace.net/Data_Center_Fabrics">Data Center Fabric Architectures</a> webinar: if you’re building a fabric of this size, find someone who did something similar in the past (and we have a few people like that in <a href="https://www.ipspace.net/ExpertExpress">ExpertExpress team</a>). Relying solely on information provided on the Internet (including my webinars) is probably not good enough as we can never cover the specifics of your particular deployment.</p>
<hr/><p>Want to know more? I did a <a href="https://www.ipspace.net/VXLAN_Technical_Deep_Dive">VXLAN deep dive</a> a long while ago, and Dinesh Dutt explained the <a href="https://www.ipspace.net/EVPN_Technical_Deep_Dive">details of EVPN</a> in mid-2018. </p>
<p>Looking for design guidelines? You’ll find them in:</p>
<ul class="ListParagraph"><li><a href="https://www.ipspace.net/Leaf-and-Spine_Fabric_Architectures">Leaf-and-Spine Fabrics webinar</a> if you prefer studying on your own, </li>
<li><a href="https://www.ipspace.net/Designing_and_Building_Data_Center_Fabrics">Designing and Building Data Center Fabrics</a> self-paced course if you prefer to have a guided tour, reviewed design assignments and support), or </li>
<li><a href="https://www.ipspace.net/Building_Next-Generation_Data_Center">Building Next-Generation Data Center</a> online course if you’d like to learn about more than just network fabrics.</li>
</ul>

