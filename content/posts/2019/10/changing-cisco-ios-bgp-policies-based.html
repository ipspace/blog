---
url: /2019/10/changing-cisco-ios-bgp-policies-based.html
title: "Changing Cisco IOS BGP Policies Based on IP SLA Measurements"
date: "2019-10-01T09:01:00.000+02:00"
tags: [ BGP,SLA,SD-WAN ]
---

<p>This is a guest blog post by <a href="https://www.linkedin.com/in/phjounin/">Philippe Jounin</a>, Senior Network Architect at Orange Business Services.</p>
<hr/><p>You could use <strong>track</strong> objects in Cisco IOS to track route reachability or metric, the status of an interface, or IP SLA compliance for a long time. Initially you could use them to implement <a href="https://blog.ipspace.net/2007/02/reliable-static-routing.html">reliable static routing</a> (or even <a href="https://blog.ipspace.net/2011/09/shut-down-bgp-session-based-on-tracked.html">shut down a BGP session</a>) or trigger EEM scripts. With a bit more work (and a few more EEM scripts) you could use object tracking to create <a href="https://blog.ipspace.net/2010/11/time-based-static-routes.html">time-dependent static routes</a>.</p>
<p>Cisco IOS 15 has introduced <a href="https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/ipapp/configuration/xe-2/iap-xe-2-book/iap-eot.html">Enhanced Object Tracking</a> that allows first-hop router protocols like VRRP or HSRP to use tracking state to modify their behavior.<!--more--></p>
<p>Although it is not documented, I was curious to test if object tracking may be used inside a BGP <strong>route-map</strong>. This would provide a nice alternative to BGP knobs like <strong>inject-maps</strong> or <strong>advertise-maps</strong>, but also make BGP react to ip SLA measurements, just like a brand new SD-WAN network!</p>
<p>My lab consists of 2 routers connected with 2 links (replace direct links with IPSec tunnels if you are thinking about SD-WAN). The traffic between the two endpoints should go through Link1 if the link’s delay is below 10 ms, and go through Link2 otherwise (obviously only if Link2 is available).</p>
<p>Collecting the delay between the routers is quite easy with the IP SLA Monitoring feature:</p>
<pre><code>ip sla 65000<br/> udp-echo 10.0.1.2 3456<br/> threshold 10<br/> timeout 100<br/> frequency 3<br/>ip sla schedule 65000 life forever start-time now<br/>ip sla responder</code></pre><p>The IP SLA measurement is linked with an object in order to monitor the SLA compliance. The tracking object will be <em>up</em> if the delay is below 10 msec and <em>down</em> otherwise. I’m also using dampening timers (15 seconds on delay increase, 30 seconds on decrease).</p>
<pre><code>track 65 ip sla 65000<br/> delay down 15 up 30<br/> match track 65</code></pre><p>Using the tracking object inside a route-map allows BGP to change some attributes after a the tracking object changes state. In this lab, we change Link1 local preference in order to reflect the IP SLA status.</p>
<pre><code>router bgp 65000<br/> bgp log-neighbor-changes<br/> network 192.168.7.0<br/> neighbor 10.0.1.2 remote-as 65000<br/> neighbor 10.0.1.2 description -- Link 1 --<br/> neighbor 10.0.1.2 route-map DynamicLP out<br/> neighbor 10.0.2.2 remote-as 65000<br/> neighbor 10.0.2.2 description -- Link 2 –<br/><br/>route-map DynamicLP permit 10<br/> description -- SLA in profile: primary path --<br/> match track 65<br/> set local-preference 200<br/>!<br/>route-map DynamicLP permit 20<br/> description -- SLA out of profile: backup path --<br/> set local-preference 50</code></pre><p>As expected, the local preference is correctly set by the <strong>route-map</strong> depending on the link SLA.</p>
<p>At t=10s, we set a jitter of 50ms, randomly increasing the delay on the Link1. The tracking object status changes after about 20 seconds and BGP advertises the new local preference after another 30 seconds, moving the traffic to Link2.</p>
<p>Of course, if we remove the jitter, the traffic returns to Link1</p>
<div class="separator"><a href="/2019/10/s1600-tracked+object.png" imageanchor="1"><img border="0" data-original-height="694" data-original-width="548" src="/2019/10/s1600-tracked+object.png"/></a></div>

