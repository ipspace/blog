---
url: /2009/11/hqf-intra-class-wfq-ignores-ip.html
title: "HQF: intra-class WFQ ignores the IP precedence"
date: "2009-11-26T06:56:00.001+01:00"
tags: [ QoS ]
---

<p>Continuing my <a href="https://blog.ipspace.net/2009/11/hqf-intra-class-fair-queuing.html">tests of the Hierarchical Queuing Framework</a>, I’ve tested whether the fair queuing works similarly to the previous IOS implementations, where the high-precedence sessions got proportionally more bandwidth.</p>
<p><strong>Summary:</strong> Fair queuing within HQF ignores IP precedence.</p>
<!--more--><h4>Setup</h4><p>I ran an <em>iperf </em>session in parallel with a UDP flood using the <a href="https://blog.ipspace.net/2009/11/first-hqf-impressions-excellent-job.html">same physical setup as with the previous HQF tests</a>. I’ve configured an inbound <strong>service-policy </strong>on the LAN interface to ensure the packets belonging to TCP sessions had their IP precedence set to 5 (the default value is zero).</p>
<pre class="code">policy-map LAN<br/> class TCP<br/>  set ip precedence 5<br/>!<br/>interface FastEthernet0/0<br/> ip address 10.0.0.5 255.255.255.0<br/> no ip redirects<br/> load-interval 30<br/> service-policy input LAN</pre><h4>Baseline tests</h4><p>I configured weighted fair queuing on a 2 Mbps WAN interface:</p>
<pre class="code">interface Serial0/1/0<br/> bandwidth 2000<br/> ip address 10.0.1.1 255.255.255.252<br/> encapsulation ppp<br/> fair-queue<br/> ip ospf 1 area 0<br/> load-interval 30</pre><p>As expected, the <em>iperf </em>session ran in parallel with a UDP flood got more than half the available bandwidth:</p>
<pre class="code">$ <strong>iperf -c 10.0.20.10 -t 180 -p 5002</strong><br/>------------------------------------------------------------<br/>Client connecting to 10.0.20.10, TCP port 5002<br/>TCP window size: 8.00 KByte (default)<br/>------------------------------------------------------------<br/>[1916] local 10.0.0.10 port 1064 connected with 10.0.20.10 port 5002<br/>[ ID] Interval       Transfer     Bandwidth<br/>[1916]  0.0-180.1 sec  35.2 MBytes  1.64 Mbits/sec</pre><p>The <strong>show queue </strong>command (which is still available in IOS release 15.0 unless you configure HQF on the interface) displayed two sessions within the WFQ system with expected TOS values and weights (the weight of the TCP session was 6 times lower than the weight of the UDP session):</p>
<pre class="code">rtr#<strong>show queue serial 0/1/0</strong><br/>  Input queue: 0/75/0/0 (size/max/drops/flushes); Total output drops: 135567<br/>  Queueing strategy: weighted fair<br/>  Output queue: 64/1000/64/12798 (size/max total/threshold/drops)<br/>     Conversations  2/3/256 (active/max active/max total)<br/>     Reserved Conversations 0/0 (allocated/max allocated)<br/>     Available Bandwidth 1500 kilobits/sec<br/><br/>  (depth/weight/total drops/no-buffer drops/interleaves) 57/<span class="high">32384</span>/12799/0/0<br/>  Conversation 10, linktype: ip, length: 260<br/>  source: 10.0.0.10, destination: 10.0.20.3, id: 0xB1C1, ttl: 127,<br/>  <span class="high">TOS: 0 prot: 17</span>, source port 1059, destination port 5002<br/><br/>  (depth/weight/total drops/no-buffer drops/interleaves) 7/<span class="high">5397</span>/0/0/0<br/>  Conversation 11, linktype: ip, length: 1304<br/>  source: 10.0.0.10, destination: 10.0.20.10, id: 0xB382, ttl: 127,<br/>  <span class="high">TOS: 160 prot: 6</span>, source port 1064, destination port 5002</pre><h4>Fair queuing within HQF</h4><p>To test the fair queuing behavior within HQF I configured a simple policy map which used <strong>fair-queue </strong>within the default class:</p>
<pre class="code">policy-map WAN<br/> class class-default<br/>    fair-queue</pre><p>I attached the policy map to the interface …</p>
<pre class="code">interface Serial0/1/0<br/> service-policy output WAN</pre><p>… and repeated the <em>iperf </em>test:</p>
<pre class="code">$ iperf -c 10.0.20.10 -t 60 -p 5002<br/>------------------------------------------------------------<br/>Client connecting to 10.0.20.10, TCP port 5002<br/>TCP window size: 8.00 KByte (default)<br/>------------------------------------------------------------<br/>[1916] local 10.0.0.10 port 1062 connected with 10.0.20.10 port 5002<br/>[ ID] Interval       Transfer     Bandwidth<br/>[1916]  0.0-60.0 sec  7.18 MBytes  956 Kbits/sec</pre><p>This time the TCP session got only half of the bandwidth although its packets had higher IP precedence.</p>

