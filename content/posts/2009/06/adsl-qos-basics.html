---
title: "ADSL QoS basics"
date: "2009-06-30T07:25:00.005+02:00"
tags: [ WAN,ADSL ]
---

<div class="bloggerBody"><p>Based on the <a href="http://blog.ioshints.info/2009/06/adsl-reference-diagram.html">ADSL reference model</a> we’ve discussed last week, let’s try to figure out how you can influence the quality of service over your ADSL link (for example, you’d like to prioritize VoIP packets over web download). To understand the QoS issues, we need to analyze the congestion points; these are the points where a queue might form when the network is overloaded and where you can reorder the packets to give some applications a preferential treatment.</p>
<p class="info">Remember: QoS is always a zero-sum game. If you prioritize some applications, you’re automatically penalizing all others. </p>
<p>The primary congestion point in the downstream path is the PPPoE virtual interface on the NAS router (marked with a red arrow in the diagram below), where the Service Provider usually performs traffic policing. It’s better from the SP perspective to police the traffic @ NAS than to send all the traffic to DSLAM where it would be dropped in the ATM hardware. Secondary congestion points might arise in the backhaul network (if the network is heavily oversubscribed) and in DSLAM (if the NAS policing does not match the QoS parameters of the ATM virtual circuit).</p>
<script>startHide()</script><p><a href="http://wiki.nil.com/wk/images/8/82/ADSL_Downstream_Congestion.png"><img src="http://wiki.nil.com/wk/images/8/82/ADSL_Downstream_Congestion.png" style="width: 540px;" class="ImgFLT"></a></p>
<p>In the upstream direction, the congestion occurs on the DSL modem – the path between the CPE and the modem (Ethernet or Fast Ethernet) is much faster than the upstream ATM virtual circuit. Secondary congestions might occur in DSLAM or the backhaul network. NAS usually does not police inbound traffic, as it’s assumed the DSL access network already limits the user traffic to its contractual upstream speed.</p>
<p><a href="http://wiki.nil.com/wk/images/e/e1/ADSL_Upstream_Congestion.png"><img src="http://wiki.nil.com/wk/images/e/e1/ADSL_Upstream_Congestion.png" style="width: 540px;" class="ImgFLT"></a></p>
<p>Based on the congestion analysis, it’s obvious <a href="http://wiki.nil.com/Queuing_Principles_in_Cisco_IOS">you cannot use queuing</a> on the CPE (marked “2” in the diagrams) to influence the ADSL QoS as you don’t control a single congestion point. You have to use <a href="http://wiki.nil.com/Traffic_shaping_in_Cisco_IOS">traffic shaping</a> on the CPE to introduce artificial congestion points in which the queues will form. You can then use the usual queuing mechanisms to prioritize the application traffic. </p>
<p><a href="http://wiki.nil.com/wk/images/f/fb/ADSL_CPE_QoS.png"><img src="http://wiki.nil.com/wk/images/f/fb/ADSL_CPE_QoS.png" style="width: 540px;" class="ImgFLT"></a></p>
<p>The shaping configured on the PPPoE interface on the CPE router neatly removes the congestion on the DSL modem. The backhaul network is rarely congested in the upstream direction (unless your <a href="http://blog.ioshints.info/2009/06/internet-socialism-all-i-can-eat.html">friendly neighbors are devoted fans of P2P protocols</a>). </p>
<p>When configuring the upstream shaping rate, you just have to take in account the extra overhead introduced by the PPPoE framing, which is not yet present in packets shaped on the <strong>Dialer</strong> interface, and reduce the upstream shaping speed to a value slightly below your DSL upstream speed.</p>
<p class="important">If your DSL configuration uses PPPoE <strong>Dialer</strong> interface, you have to shape the traffic on the <del class='wrong'><strong>Dialer </strong>interface, not the outside Ethernet interface. The outside Ethernet interface transmits PPPoE-encapsulated IP traffic on which you cannot use the IP-based queuing classifiers.</del><ins class='corr'><a href="http://blog.ioshints.info/2009/07/not-all-interfaces-are-created-equal.html">outside Ethernet interface</a>.</ins></p>
<p>Assuming most of your traffic is TCP-based (or that all non-TCP traffic is prioritized), the shaping on the inside LAN interface will cause enough TCP delays to slow down the downstream TCP transmission. However, it’s harder to determine the correct shaping rate and optimize the shaping behavior when the high-priority traffic is not present; we’ll cover these issues in an upcoming post.</p>
<script>endHide()</script></div>

