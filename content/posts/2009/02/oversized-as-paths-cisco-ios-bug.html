---
title: "Oversized AS paths: Cisco IOS bug details"
date: "2009-02-20T21:32:00.004+01:00"
tags: [ BGP ]
---

<div class="bloggerBody"><p>Numerous articles describing the widespread routing instabilities caused by <a href="http://blog.ioshints.info/2009/02/root-cause-analysis-oversized-as-paths.html">sloppy parser of a small router vendor</a> (including posts at <a href="http://bgpmon.net/blog/?p=125">BGPmon</a>, <a href="http://www.renesys.com/blog/2009/02/the-flap-heard-around-the-worl.shtml">Renesys</a>, <a href="http://asert.arbornetworks.com/2009/02/ahh-the-ease-of-introducing-global-routing-instability/">Arbor Security</a> and <a href="http://blog.ioshints.info/2009/02/protect-your-network-with-bgp-maxas.html">my blog</a>) hinted that the unusual BGP update caused so many problems because the ISPs were using outdated Cisco IOS releases. This is definitely not the case; all classic IOS releases were affected.</p>
<p>Rodney Dunn from Cisco and myself were quickly able to <a href="http://blog.ioshints.info/2009/02/update-oversized-as-paths.html">reproduce so far unknown bug in Cisco IOS</a> that occurs only when the inbound AS-path contains close to 255 AS numbers and the router does inbound or outbound AS-path prepending. The new bug is tracked as <a href="http://www.merit.edu/mail.archives/nanog/msg15784.html">CSCsx73770</a> and affects downstream EBGP or IBGP sessions as follows:</p>
&lt;!--more--&gt;<ul class="Bullet1"><li>When you do <em>inbound AS-path prepending</em> and receive a BGP update where the total length of inbound AS-path and prepending exceeds 255, the AS-path in your BGP table is completely mangled. The path is sporadically advertised to IBGP or EBGP peers and kills downstream BGP sessions (remote BGP peer sends BGP notification due to invalid UPDATE message).</li>
<p class="note">The results of inbound AS-path prepending are very hard to reproduce, so they might be completely random</p>
<li>When you do <em>outbound AS-path prepending</em> and send a BGP update where the total length of the AS-path in your BGP table, prepended AS-path and your own AS-number exceed 255, the outbound EBGP update is incorrect and the downstream EBGP peer sends BGP notification, resulting in BGP session reset. IBGP peers are not affected, as IOS does not perform AS-path prepending on IBGP sessions.</li>
<li>If you don’t prepend, you’re safe. IOS marks BGP paths with AS-path length greater or equal to 254 as invalid and does not propagate them, so the AS-path length in the outbound update can never exceed 255 without prepending.</li>
</ul>
<p class="warn">All the problems associated with CSCsx73770 can be avoided if you limit the AS-path length with the <strong>bgp maxas-limit </strong>global configuration command.</p>
<p class="note">Obviously, if a downstream device is running a very old IOS release that is <a href="http://wiki.nil.com/Limit_the_maximum_BGP_AS-path_length">vulnerable to CSCdr54230</a>, it has no chance of surviving incoming BGP update.</p>
<p>When I was testing the IOS behavior in my lab, I was not aware how long the offending AS-path was, so my <a href="http://www.merit.edu/mail.archives/nanog/msg15530.html">initial analysis was incorrect</a>. With the input from NANOG mailing list <a href="http://www.merit.edu/mail.archives/nanog/msg15730.html">supplying to the actual length of the AS-path</a>, this is the most probably scenario: the offending AS-path length was close enough to 255 that the outbound AS-path prepending performed between Tier-1 providers (or their peers) that did not limit the AS-path length caused EBGP sessions to reset (if someone performs inbound AS-path prepending, the IBGP sessions would suffer). Those providers that implemented AS-path length limiting successfully protected their downstream peers and their customers (unless, of course, the customers were running really old IOS releases).</p>
</div>

