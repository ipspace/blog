---
url: /2009/12/hqf-truly-hierarchical-queuing.html
title: "HQF: truly hierarchical queuing"
date: "2009-12-15T07:00:00.002+01:00"
tags: [ QoS ]
---

<p>After doing the <a href="https://blog.ipspace.net/2009/11/first-hqf-impressions-excellent-job.html">initial tests of the HQF framework</a>, I wanted to check how “hierarchical” it is. I’ve created a policy-map (as before) allocating various bandwidth percentages to individual TCP/UDP ports. One of the classes had a child service policy that allocated 70% of the bandwidth to TCP and 30% of the bandwidth to UDP (going to the same port#), with fair queuing being used in the TCP subclass.</p>
<p><strong>Short summary:</strong> HQF worked brilliantly.</p>
<!--more--><p>Here’s the relevant configuration: the per-interface policy …</p>
<pre class="code">policy-map WAN<br/> class P5001<br/>   bandwidth percent 20<br/>   fair-queue<br/> class P5003<br/>   bandwidth percent 30<br/>   service-policy Intra<br/> class class-default<br/>   fair-queue</pre><p>… and the child policy:</p>
<pre class="code">policy-map Intra<br/> class TCP<br/>   bandwidth percent 70<br/>   fair-queue<br/> class class-default<br/>   bandwidth percent 30</pre><p class="note">You’d have to create the child policy first, IOS would not allow you to attach a non-existent policy-map as a service-policy within a class.</p>
<p>I’ve applied the <strong>policy-map </strong>to a 2 Mbps point-to-point link and started various traffic sources (similar to the <a href="https://blog.ipspace.net/2009/11/hqf-intra-class-fair-queuing.html">previous tests</a>).</p>
<p class="more">Please read the <a href="https://blog.ipspace.net/search?q=HQF&amp;updated-max=2009-12-10T00:00:00-00:00">previous HQF-related posts</a> to find a detailed lab description, complete router configurations and traffic source descriptions.</p>
<p>As before, the <strong>show policy-map interface </strong>command can be used to inspect the QoS state of an interface. The printout clearly documents the hierarchical queuing policies and shows </p>
<pre class="code">a1#<strong>show policy-map interface ser 0/1/0</strong><br/> Serial0/1/0<br/><br/>  Service-policy output: WAN<br/><br/>    Class-map: P5001 (match-all)<br/>      303 packets, 367480 bytes<br/>      30 second offered rate 409000 bps, drop rate 15000 bps<br/>      Match: access-group name P5001<br/>      Queueing<br/>      queue limit 64 packets<br/>      (queue depth/total drops/no-buffer drops/flowdrops) 111/0/0/0<br/>      (pkts output/bytes output) 303/367480<br/>      bandwidth 20% (400 kbps)<br/>      Fair-queue: per-flow queue limit 16<br/><br/>    <span class="high">Class-map: P5003 (match-all)</span><br/>      5407 packets, 1706420 bytes<br/>      30 second offered rate 2059000 bps, drop rate 810000 bps<br/>      Match: access-group name P5003<br/>      Queueing<br/>      queue limit 64 packets<br/>      (queue depth/total drops/no-buffer drops) 174/4465/0<br/>      (pkts output/bytes output) 945/546300<br/>      bandwidth 30% (600 kbps)<br/><br/>      <span class="high">Service-policy : Intra</span><br/><br/>        <span class="high">Class-map: TCP (match-all)</span><br/>          315 packets, 382500 bytes<br/>          <span class="high">30 second offered rate 418000 bps</span>, drop rate 11000 bps<br/>          Match: access-group name TCP<br/>          Queueing<br/>          queue limit 64 packets<br/>          (queue depth/total drops/no-buffer drops/flowdrops) 107/0/0/0<br/>          (pkts output/bytes output) 315/382500<br/>          bandwidth 70% (420 kbps)<br/>          Fair-queue: per-flow queue limit 16<br/><br/>        Class-map: class-default (match-any)<br/>          5092 packets, 1323920 bytes<br/>          30 second offered rate 1620000 bps, drop rate 1500000 bps<br/>          Match: any<br/>          Queueing<br/>          queue limit 64 packets<br/>          (queue depth/total drops/no-buffer drops) 64/4466/0<br/>          (pkts output/bytes output) 630/163800<br/>          bandwidth 30% (180 kbps)<br/><br/>    Class-map: class-default (match-any)<br/>      5097 packets, 1325220 bytes<br/>      30 second offered rate 1635000 bps, drop rate 733000 bps<br/>      Match: any<br/>      Queueing<br/>      queue limit 64 packets<br/>      (queue depth/total drops/no-buffer drops/flowdrops) 18/1605/0/1605<br/>      (pkts output/bytes output) 3496/908540<br/>      Fair-queue: per-flow queue limit 16</pre><p>The results of the <strong>iperf </strong>program matched the expectations very well: P5003 class gets 30% of 2Mbps (600 kbps) and the TCP traffic gets 70% of that (420 kbps). With the TCP overhead, the goodput should be slightly higher than 400 kbps (and it is).</p>
<pre class="code">$ <strong>iperf -c 10.0.20.10 -t 3600 -p 5003 -i 60 -P 10</strong><br/>------------------------------------------------------------<br/>Client connecting to 10.0.20.10, TCP port 5003<br/>TCP window size: 8.00 KByte (default)<br/>------------------------------------------------------------<br/>…<br/>[SUM] 480.0-540.0 sec  2.87 MBytes   401 Kbits/sec</pre>

