---
url: /2018/06/avoid-summarization-in-leaf-and-spine.html
title: "Avoid Summarization in Leaf-and-Spine Fabrics"
date: "2018-06-11T08:39:00.000+02:00"
tags: [ Design,Data Center,Fabric,BGP ]
---

<p><a name="_GoBack"></a>I got this design improvement suggestion after publishing <a href="http://blog.ipspace.net/2018/06/is-ebgp-really-better-than-ospf-in-leaf.html"><em>When Is BGP No Better than OSPF</em></a><em> </em>blog post:</p>
<blockquote class="cite">Putting all the leafs in the same ASN and filtering routes sent down to the leafs (sending just a default) are potential enhancements that make BGP a nice option. </blockquote>
<p><a href="https://www.linkedin.com/in/dr-tony-przygienda-018501/">Tony Przygienda</a> quickly wrote a one-line rebuttal: “<em>unless links break ;-)</em><em>”</em><!--more--></p>
<p class="warn">This is a generic blog post written for data center engineers building fabrics with less than few hundred switches. If you’re building a larger fabric, don’t look for recipes on the Internet. Your fabric will be grateful.</p>
<p>We covered the drawbacks of summarization in leaf-and-spine fabrics in great details in the <a href="https://my.ipspace.net/bin/list?id=Clos#L3_SINGLE"><em>Layer-3 Fabrics with Non-Redundant Server Connectivity</em></a><em> </em>part of <a href="http://www.ipspace.net/Leaf-and-Spine_Fabric_Architectures"><em>Leaf-and-Spine Fabrics Architectures</em></a> webinar and <a href="http://www.ipspace.net/Designing_and_Building_Data_Center_Fabrics"><em>Designing and Building Leaf-and-Spine Fabrics</em></a> online course. Here’s a short summary of that discussion.</p>
<h4>The Problem</h4><p>Imagine the design proposed by my reader:</p>
<div class="separator"><a href="/2018/06/s1600-Default-Route-Setup.png" imageanchor="1"><img border="0" data-original-height="666" data-original-width="1600" src="/2018/06/s600-Default-Route-Setup.png"/></a></div>
<p>Spines announce a default route (or some other summary route) to the leaves, and the prefixes announced by leaves are not propagated to other leaves. </p>
<p>Now image the L1-S1 link fails. No routing update is sent to other leaves, and they continue sending the traffic as they did before. For example, L4 will (on average) send 50% of its traffic for L1 toward S1… where the traffic will be dropped because S1 has no route for prefixes advertised by L1.</p>
<div class="separator"><a href="/2018/06/s1600-Default-Route-Failure.png" imageanchor="1"><img border="0" data-original-height="670" data-original-width="1600" src="/2018/06/s600-Default-Route-Failure.png"/></a></div>
<p class="note">The scenario (although in a slightly different format) should be familiar to anyone who had to deal with inter-area summarization in redundantly-built OSPF networks.</p>
<h4>Can We Fix It?</h4><p>Sure. You can add links between spine switches, add a superspine layer, or use RIFT (not available for production deployment at the time this blog post was written) that does selective deaggregation following a link failure – more details in Software Gone Wild <a href="http://blog.ipspace.net/2018/03/data-center-routing-with-rift-on.html">Episode 88</a>.</p>
<p>Let’s focus on the challenges of the inter-spine links. Life is simple if we have just two spines: we add a link between them and run IBGP session across that link. </p>
<div class="separator"><a href="/2018/06/s1600-Default-Route-Packet-Flow.png" imageanchor="1"><img border="0" data-original-height="664" data-original-width="1600" src="/2018/06/s600-Default-Route-Packet-Flow.png"/></a></div>
<p>That link (as <a href="https://www.linkedin.com/in/oliver-herms-7974b091/">Oliver Herms</a> pointed out in a LinkedIn discussion) also increases the fabric resiliency. Without it, two link failures (example: Spine1-to-Leaf1 and Spine2-to-Leaf2) could partition the fabric.</p>
<p>What about larger fabrics with more than two spines. The design quickly gets trickier:</p>
<p><strong>Topology</strong>: Will you create a full mesh between spines, or a ring between them? What will you do when you go from two spines to four or eight spines? Also, you no longer need the inter-spine link for resiliency.</p>
<p><strong>Routing</strong>: Spines have to exchange routes across inter-spine links. Will you use IBGP or will you go for some crazy schizophrenic idea of running EBGP between routers in the same autonomous system by faking AS numbers on both ends of the session? If you go for IBGP, will you add IGP to the mix, or will you tweak next hops on IBGP sessions? Will some spines become route reflectors or will you have a full-mesh of IBGP sessions?</p>
<p>Think again. Is the extra complexity really worth it? Or as Russ White would say “<em>if you haven’t identified the tradeoffs, you haven’t looked hard enough</em>”.</p>
<p class="info">If you want to hear Russ speak about network complexity (or whitebox switching), join the <a href="http://www.ipspace.net/Building_Next-Generation_Data_Center">Building Next-Generation Data Center</a> online course.</p>
<h4>Is It Worth the Effort?</h4><p>Control-plane traffic (BGP updates) is negligible compared to the usual leaf-to-spine bandwidth. Control-plane CPU in data center switches is usually not involved in packet forwarding, so the CPU has all the time in the world to process BGP updates. The number of prefixes advertised in a data center fabric is typically low.</p>
<p>So what exactly are we trying to optimize? The only reason I could see for summarization between spines and leaves is forwarding table size on leaves. Modern data center switches shouldn’t have that problem in most deployments – for more details on unified forwarding tables (UFT) and typical table sizes in data center switches see <a href="http://www.ipspace.net/Data_Center_Fabrics">Data Center Fabric Architectures</a> webinar, in particular the <a href="https://my.ipspace.net/bin/list?id=DCFabric#TECHNOLOGY">UFT Technology Overview</a> video.</p>
<p>There might be an interesting edge case where you’d need lots of MAC and ARP entries on leaf switches, so you’d go for small IPv4 forwarding table… but even the host-focused UFT profile on Broadcom’s Trident-2 has 16.000 IPv4 prefixes (and 288.000 MAC/ARP entries). Apart from that, I’d stick with the simplest possible design without any form of route summarization.</p>
<h4>Is This Applicable to Your Fabric?</h4><p>I can’t possibly know… but if you need design guidance or a second opinion, an expert from our <a href="http://www.ipspace.net/ExpertExpress">ExpertExpress</a> team could help you.</p>

