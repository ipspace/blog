---
title: "Is EBGP Really Better than OSPF in Leaf-and-Spine Fabrics?"
date: "2018-06-04T08:35:00.000+02:00"
tags: [ Design,Fabric,BGP,IP routing ]
---

<p>Using EBGP instead of an IGP (OSPF or IS-IS) in leaf-and-spine data center fabrics is becoming a best practice (read: thing to do when you have no clue what you&rsquo;re doing).</p>
<p>The usual argument defending this design choice is &ldquo;<em>BGP scales better than OSPF or IS-IS</em>&rdquo;. That&rsquo;s usually true (see also: Internet), and so far, EBGP is the only reasonable choice in very large leaf-and-spine fabrics&hellip; but does it really scale better than a link-state IGP in smaller fabrics?<!--more--></p>
<p>There are operators running single-level IS-IS networks with thousands of devices, and yet most everyone claims you <a href="http://blog.ipspace.net/2018/05/is-ospf-or-is-is-good-enough-for-my.html">cannot use OSPF or IS-IS in a leaf-and-spine fabric with more than a few hundred nodes</a> due to <a href="http://blog.ipspace.net/2018/03/data-center-routing-with-rift-on.html">inordinate amount of flooding traffic caused by the fabric topology</a>.</p>
<p>This is the moment when a skeptic should say &ldquo;<em>are you sure BGP works any better?</em>&rdquo; and the answer is (not surprisingly) &ldquo;<em>not exactly</em>&rdquo;, at least if you get your design wrong.</p>
<h4>EBGP or IBGP?</h4><p>Most everyone understanding how BGP really works agrees that it makes more sense to use EBGP between leaf and spine switches than trying to get IBGP to work without underlying IGP, so we&rsquo;ll ignore IBGP as a viable design option for the rest of this blog post.</p>
<p class="info">You can run IBGP without IGP, and we had to make it work a long while ago because customers, but it&rsquo;s somewhat counter-intuitive and requires additional configuration tweaks.</p>
<h4>Let&rsquo;s make it simple&hellip;</h4><p>Not knowing any better, let&rsquo;s assume a simplistic design where every switch has a different AS number:</p>
<p class="note">If your first thought was &ldquo;<em>didn&rsquo;t you tell us we shouldn&rsquo;t do it this way in the </em><a href="http://www.ipspace.net/Leaf-and-Spine_Fabric_Architectures"><em>Leaf-and-Spine Fabric Architectures</em></a><em> webinar,</em>&rdquo; you&rsquo;re absolutely right. There&rsquo;s a reason why this is a bad idea. Keep reading&hellip;</p>
<p>Now imagine a leaf switch advertising a prefix:</p>
<ul class="ListParagraph"><li>It advertises the prefix to all spine switches;</li>
<li>Spine switches advertise the prefix to all other leaf switches;</li>
<li>Properly-configured leaf switches use all equal-cost BGP prefixes for traffic forwarding, but still select one of the as the best BGP path (that&rsquo;s how BGP works when you don&rsquo;t configure <em>add-path </em>functionality);</li>
</ul>
<p class="warn">It&rsquo;s worth mentioning that by default some common BGP implementations don&rsquo;t do ECMP across EBGP paths, and don&rsquo;t accept paths coming from different autonomous systems as equal-cost paths. You need two nerd knobs to get it working.</p>
<ul class="ListParagraph"><li>Leaf switches advertise their best BGP path <strong>to all spine switches </strong>apart from the one that advertised the best path to them. Some BGP implementations might actually advertise the best path to the router they got the best path from.</li>
<li>Every single spine switch installs all the alternate BGP paths received from all leaf switches in BGP table&hellip; just in case it might be needed.</li>
</ul>
<div class='separator'><a href="https://3.bp.blogspot.com/-WjUzmzQBxqk/WxONOKIyCbI/AAAAAAAAJJs/MqSruzMfqcolE8_N6zQcQmiURsCru2dSACLcBGAs/s1600/Paper.EVPN%2Bdiagrams.3.png" imageanchor="1" ><img border="0" src="https://3.bp.blogspot.com/-WjUzmzQBxqk/WxONOKIyCbI/AAAAAAAAJJs/MqSruzMfqcolE8_N6zQcQmiURsCru2dSACLcBGAs/s600/Paper.EVPN%2Bdiagrams.3.png" data-original-width="1600" data-original-height="744" /></a></div>
<p>To recap: on most spine switches you&rsquo;ll see N entries for every single prefix in the BGP table (where N is the number of leaf switches) &ndash; one from the leaf switch with the prefix, and one from every other leaf switch that didn&rsquo;t select the path through the current spine switch as the best BGP path. </p>
<p class="note">Figuring out what happens when a leaf switch revokes one of its prefixes and how many unnecessary BGP updates are sent is left as an exercise for the reader.</p>
<p>Compare that to how OSPF flooding works and you&rsquo;ll see that there&rsquo;s not much difference between the two. In fact, BGP probably uses even more resources in this setup than OSPF because it has to run BGP path selection algorithm whenever BGP table changes, whereas OSPF separates flooding and path computation processes.</p>
<h4>Fixing the mess we made&hellip;</h4><p>Obviously, we need to do something to reduce the unnecessary flooding. There&rsquo;s not much one could do in OSPF or IS-IS (don&rsquo;t get me started on IS-IS mesh groups), which is the real reason why you can&rsquo;t use them in larger fabrics, and why smart engineers work on RIFT and OpenFabric.</p>
<p>What about BGP? There are two simple ways to filter the unnecessary announcements:</p>
<ul class="ListParagraph"><li>Configure outbound update filtering on leaf switches (or inbound update filtering on spine switches) to discard paths that traverse more than one leaf switch;</li>
<li>Use the same AS number on all spine switches and let BGP&rsquo;s default AS-path-based filtering do its job.</li>
</ul>
<div class='separator'><a href="https://4.bp.blogspot.com/-U7BV5OXWs2s/WxONOLA37rI/AAAAAAAAJJw/qp5TTDrGg4YEul0sVClvY-_kLJ_20PtbwCLcBGAs/s1600/Paper.EVPN%2Bdiagrams.4.png" imageanchor="1" ><img border="0" src="https://4.bp.blogspot.com/-U7BV5OXWs2s/WxONOLA37rI/AAAAAAAAJJw/qp5TTDrGg4YEul0sVClvY-_kLJ_20PtbwCLcBGAs/s600/Paper.EVPN%2Bdiagrams.4.png" data-original-width="1600" data-original-height="725" /></a></div>
<p>Now you know why smart network architects use the same AS number on all spine switches and why <a href="https://tools.ietf.org/html/rfc7938#section-5.2">RFC 7938 recommends it</a>.</p>
<h4>The Dirty Details&hellip;</h4><p>The effectiveness of default AS-path-based filtering depends on the BGP implementation:</p>
<ul class="ListParagraph"><li>Some implementations (example: Cisco IOS) send BGP updates to all EBGP neighbors regardless of whether the neighbor AS is already in the AS path. The neighbor has to process the update and drop it;</li>
<li>Other implementations (example: Junos) filter BGP updates on the sender side and don&rsquo;t send BGP updates that would be dropped by the receiver (as always, there&rsquo;s a nerd knob to twiddle if you want those updates sent).</li>
</ul>
<p>Finally, it&rsquo;s interesting to note that using IBGP without IGP, with spine switches being BGP route reflectors tweaking BGP next hops in outbound updates, results in exactly the same behavior &ndash; another exercise for the reader if you happen to be so inclined.</p>
<h4>Want to know more?</h4><ul class="ListParagraph"><li>Start with <a href="http://www.ipspace.net/Data_Center_BGP">Using BGP in Data Center Leaf-and-Spine Fabrics</a> document;</li>
<li>Watch <a href="http://www.ipspace.net/Leaf-and-Spine_Fabric_Architectures">Leaf-and-Spine Fabric Architectures</a> webinar;</li>
<li>Enroll into <a href="http://www.ipspace.net/Designing_and_Building_Data_Center_Fabrics">Designing and Building Data Center Fabrics</a> online course.</li>
</ul>

