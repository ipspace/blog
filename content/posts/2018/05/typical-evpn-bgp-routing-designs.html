---
url: /2018/05/typical-evpn-bgp-routing-designs.html
title: "Typical EVPN BGP Routing Designs"
date: "2018-05-30T09:06:00.000+02:00"
tags: [ Design,BGP,EVPN ]
---

<p>As discussed in a <a href="http://blog.ipspace.net/2018/05/what-is-evpn.html">previous blog post</a>, IETF designed EVPN to be next-generation BGP-based VPN technology providing scalable layer-2 and layer-3 VPN functionality. EVPN was initially designed to be used with MPLS data plane and was later extended to use numerous data plane encapsulations, VXLAN being the most common one.</p>
<h4>Design Requirements</h4><p>Like any other BGP-based solution, EVPN uses BGP to transport endpoint reachability information (customer MAC and IP addresses and prefixes, flooding trees, and multi-attached segments), and relies on an underlying routing protocol to provide BGP next-hop reachability information.<!--more--></p>
<p>The most obvious approach would thus be to use BGP-based control plane with an underlying IGP (or even Fast Reroute) providing fast-converging paths to BGP next hops. You can use the same design with EVPN regardless of whether you use MPLS or VXLAN data plane:</p>
<ul class="ListParagraph"><li>Use <a href="http://blog.ipspace.net/2018/05/is-ospf-or-is-is-good-enough-for-my.html">any IGP suitable for the size of your network</a>. Some service providers have over a thousand routers in a single OSPF or IS-IS area. Even in highly-meshed environments (leaf-and-spine fabrics), OSPF or IS-IS easily scale to over a hundred switches.</li>
<li>Use IBGP to transport EVPN BGP updates, and BGP route reflectors for scalability.</li>
</ul>
<p>In data centers using EBGP as an IGP replacement, you could use the existing EBGP sessions to carry IPv4 (underlay) and EVPN (overlay) address families. For more information on this approach and some alternative designs read the <a href="http://www.ipspace.net/Data_Center_BGP/BGP_in_EVPN-Based_Data_Center_Fabrics">BGP in EVPN-Based Data Center Fabrics</a> part of <a href="http://www.ipspace.net/Data_Center_BGP">Using BGP in Data Center Leaf-and-Spine Fabrics</a> document.</p>
<h4>Beyond a Single Autonomous System or Fabric</h4><p>Like with MPLS/VPN, EVPN EBGP designs are a bit more convoluted than IBGP designs.</p>
<p>When using MPLS data plane, there’s almost no difference between MPLS/VPN and EVPN designs:</p>
<ul class="ListParagraph"><li>Inter-AS Option B: change BGP next hop on AS boundary, and stitch EVPN MPLS labels at AS boundary. Like with MPLS/VPN, AS boundary routers would have to contain forwarding information for all VPNs (VLANs and VRFs) stretching across the AS boundary.</li>
<li>Inter-AS Option C: retain the original BGP next hop, and stitch MPLS labels for BGP next hops at AS boundary. Network operators using BGP autonomous systems in the way they were designed to be used (<em>collection of connected prefixes under control of a single administrative entity</em>) rarely use Inter-AS Option C because it requires unlimited MPLS connectivity between PE-routers in different autonomous systems.</li>
</ul>
<p>Situation is a bit different when using EVPN with VXLAN encapsulation. There’s no need for a hop-by-hop LSP between ingress and egress device – all they need is IP transport provided by the network core. It’s therefore best to leave BGP next hop (egress VXLAN Tunnel Endpoint – VTEP) unchanged unless you’re hitting the scalability limits of ASIC forwarding tables – an equivalent to Inter-AS Option C.</p>
<div class="separator"><a href="/2018/05/s1600-Multi-Pod+Overlay+Control+Plane.png" imageanchor="1"><img border="0" data-original-height="827" data-original-width="1600" src="/2018/05/s550-Multi-Pod+Overlay+Control+Plane.png"/></a><br/>Multi-pod EBGP - next hop is unchanged (diagram by Lukas Krattiger)</div>
<p class="info">The diagrams were taken from <a href="https://my.ipspace.net/bin/get?doc=73f25e70-31cd-11e8-b156-005056880254">Using VXLAN and EVPN in Multi-Pod and Multi-Site Fabric</a> presentation by Lukas Krattiger – part of <a href="https://my.ipspace.net/bin/list?id=Clos#MULTISITE">Multi-Pod and Multi-Site Fabrics</a> section of <a href="http://www.ipspace.net/Leaf-and-Spine_Fabric_Architectures">Leaf-and-Spine Fabric Architectures</a> webinar.</p>
<p>A VXLAN equivalent to MPLS Inter-AS Option B is harder to implement. In this scenario, the AS boundary device changes BGP next hop, becoming an endpoint of VXLAN tunnels. </p>
<div class="separator"><a href="/2018/05/s1600-Multi-Site+Hierarchical+Control+Plane.png" imageanchor="1"><img border="0" data-original-height="831" data-original-width="1600" src="/2018/05/s550-Multi-Site+Hierarchical+Control+Plane.png"/></a><br/>BGP next hop is changed on fabric boundary (diagram by Lukas Krattiger)</div>
<p>The border gateway (device changing BGP next hop on fabric boundary) has to be able to:</p>
<ul class="ListParagraph"><li>Receive VXLAN-encapsulated packet;</li>
<li>Perform forwarding based on MAC address toward the next-hop VTEP, including split-horizon flooding;</li>
<li>Re-encapsulate the forwarded Ethernet frame into another VXLAN packet.</li>
</ul>
<div class="separator"><a href="/2018/05/s1600-Multi-Site+Border+Gateway.png" imageanchor="1"><img border="0" data-original-height="825" data-original-width="1600" src="/2018/05/s550-Multi-Site+Border+Gateway.png"/></a><br/>Border gateways perform VXLAN-to-VXLAN forwarding (diagram by Lukas Krattiger)</div>
<p>While recent merchant silicon ASICs implement RIOT (Routing In-and-Out of VXLAN Tunnels), I’m not aware of anyone apart from Cisco doing Bridging In-and-Out of VXLAN Tunnels – the mandatory prerequisite for Inter-AS Option B.</p>
<p class="info">For more details watch <a href="https://my.ipspace.net/bin/list?id=Clos#MULTISITE">Implementing true multi-site layer-2 fabrics with Cisco’s ASICs</a> in <a href="http://www.ipspace.net/Leaf-and-Spine_Fabric_Architectures">Leaf-and-Spine Fabric Architectures</a> webinar – Lukas Krattiger did a great job explaining the intricacies of multi-site fabrics with VXLAN-to-VXLAN bridging at the fabric edge.</p>
<h4>More EVPN information</h4><ul class="ListParagraph"><li>An <a href="http://www.ipspace.net/Data_Center_BGP">overview of using BGP in data center fabrics</a> including <a href="http://www.ipspace.net/Data_Center_BGP/BGP_in_EVPN-Based_Data_Center_Fabrics">EVPN considerations</a>.</li>
<li><a href="http://www.ipspace.net/EVPN_Technical_Deep_Dive">EVPN Deep Dive</a> (focused on data center fabrics using VXLAN).</li>
</ul>

