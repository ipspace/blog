---
url: /2018/05/using-4-byte-bgp-as-numbers-with-evpn.html
title: "Using 4-Byte BGP AS Numbers with EVPN on Junos"
date: "2018-05-07T07:47:00.000+02:00"
tags: [ EVPN ]
pre_scroll: True
---
<p>After documenting the <a href="http://www.ipspace.net/Data_Center_BGP/EVPN_Route_Target_Considerations">basic challenges of using EBGP and 4-byte AS numbers with EVPN automatic route targets</a>, I asked my friends working for various vendors how their implementation solves these challenges. This is what <a href="https://www.oreilly.com/pub/au/6140">Krzysztof Szarkowicz</a> sent me on specifics of Junos implementation:</p>
<p class="info">To learn more about EVPN technology and its use in data center fabrics, watch the <a href="http://www.ipspace.net/EVPN_Technical_Deep_Dive">EVPN Technical Deep Dive</a> webinar.<!--more--></p>
<p>Four byte ASN can be used with EVPN (from Junos 13.x), including within an EVPN RT community, where the AS number takes four bytes, leaving two bytes for the VPN ID. Here is an example of EVPN advertisement with four-byte ASN from Junos EVPN PE:</p>
<pre class="code">root@R1# <strong>run show route advertising-protocol bgp 192.168.0.4 table RI-EVPN-1.evpn.0 detail</strong>    <br/>W15: Sun 2018-04-15T16:32:18 CEST (UTC+0200)<br/><span> </span><br/>RI-EVPN-1.evpn.0: 4 destinations, 4 routes (4 active, 0 holddown, 0 hidden)<br/>* 1:192.168.0.1:201::0201222222000000::0/192 AD/EVI (1 entry, 1 announced)<br/> BGP group IBGP-TO-RR type Internal<br/>     Route Distinguisher: 192.168.0.1:201<br/>     Route Label: 37<br/>     Nexthop: Self<br/>     Localpref: 100<br/>     AS path: [4200000000] I <span style="color: #E36C0A;"><strong>← Local AS is </strong></span><span style="color: #E36C0A;"><strong>4200000000</strong></span><br/>     Communities: target:4200000000L:1111 <span style="color: #E36C0A;"><strong>← RT with 4-byte ASN</strong></span></pre><p>However, 4B ASN doesn’t currently (18.1) works with automatic RT. When Automatic RT is used together with 4B ASN, 16 least significant bits from 4B ASN are used to populate automatic RT, e.g.:</p>
<pre class="code">* 2:192.168.0.1:201::201::00:11:11:11:11:11/304 MAC/IP (1 entry, 1 announced)<br/> BGP group IBGP-TO-RR type Internal<br/>     Route Distinguisher: 192.168.0.1:201<br/>     Route Label: 81<br/>     ESI: 00:11:22:33:44:55:66:00:00:00<br/>     Nexthop: Self<br/>     Localpref: 100<br/>     AS path: [4200000000] I <span style="color: #E36C0A;"><strong>← Local AS is </strong></span><span style="color: #E36C0A;"><strong>4200000000</strong></span><br/>     Communities: target:59904:201 mac-mobility:0x1:sticky (sequence 0). <span style="color: #E36C0A;"><strong>← 59904 is used in automatic RT</strong></span></pre><p>Where:</p>
<pre class="code">4200000000:    0xFA56EA00<br/>     59904:        0xEA00</pre><h4>More Details on Automatic Route Targets in EBGP Environment</h4><p>Automatic RT on MX platforms works since Junos 18.1. The ASN part is taken from global AS configuration (‘set routing-options autonomous-system &lt;ASN&gt;’). </p>
<p>In case of four-byte ASN, only 16 least significant bits are taken from global AS to generate automatic RT. In Junos, EBGP IP fabric configuration with automatic RT is quite simple, since we can define different local AS for iBGP (EVPN Overlay, RT autogeneration) and eBGP (Underlay).</p>
<p>Also, there is one more aspect, which are important from RT perspective. EVPN Type 4 routes have auto generated RTs encoded as ES-Import RT communities (RFC 7432, Section 7.6). Here’s an example:</p>
<pre class="code">* 4:192.168.0.1:0::112233445566000000:192.168.0.1/296 ES (1 entry, 1 announced) <span style="color: #E36C0A;"><strong>← encoded ESI: Type 0</strong></span><br/> BGP group IBGP-TO-RR type Internal<br/>     Route Distinguisher: 192.168.0.1:0<br/>     Nexthop: Self<br/>     Localpref: 100<br/>     AS path: [4200000000] I<br/>     Communities: es-import-target: 11-22-33-44-55-66 <span style="color: #E36C0A;"><strong>← ES-Import RT</strong></span></pre><p>These ES-Import RTs are generated from ESI, e.g.:</p>
<pre class="code">set interfaces ge-0/0/4 unit 201 esi 00:11:22:33:44:55:66:00:00:00</pre><p>ESI has 10 bytes; ES-Import RT has space for 6 bytes payload (useful info). Therefore, first 6 most significant bytes from ESI payload are taken to generate ES-Import RT. In ESI, first byte is ESI Type (e.g. Type 0: manually configured), Therefore in the above example 11:22:33:44:55:66 are taken from configured ESI and used to populate advertised ES-Import RT. ES-Import RT enables all the PEs connected to the same multihomed site to import the Ethernet Segment (Type 4) routes.</p>
<p>Now, if I have following ESIs configured on some interfaces:</p>
<pre class="code">00:00:00:00:11:22:33:44:55:66, connected to PE1/PE2<br/>00:00:00:00:11:22:33:44:55:77, connected to PE2/PE3<br/>00:00:00:00:11:22:33:44:55:88, connected to PE3/PE1 </pre><p>ES-Import RT will be:</p>
<pre class="code">00:00:00:00:11:22:33:44:55:66, —&gt; 00:00:00:11:22:33 <br/>00:00:00:00:11:22:33:44:55:77, —&gt; 00:00:00:11:22:33<br/>00:00:00:00:11:22:33:44:55:88, —&gt; 00:00:00:11:22:33</pre><p>That is, it is the same for all above ESIs. So, all PEs will import these Type 4 routes, but later, based on the actual ESI advertised in this Type 4 routes, and actual ESI configured on some local interface, if there is no match, the route will not be used. </p>
<p>So, while from EVPN machinery perspective, it is OK, it is not most optimal. Most optimal (i.e. for control plane optimization), is to differentiate ESIs in the first 6 useful bytes (rather than use last 3 bytes), so that generated ES-Import RT prevents these routes from even being imported on PEs that don’t need them.</p>
<h4>Master EVPN and Data Center Fabrics</h4><ul class="ListParagraph"><li>Want to know more about EVPN technology? Watch the <a href="http://www.ipspace.net/EVPN_Technical_Deep_Dive">EVPN Technical Deep Dive</a> webinar.</li>
<li>Want to know how to use EVPN in data center fabric designs? Watch the <a href="https://my.ipspace.net/bin/list?id=Clos#L2_L3_FABRIC">Mixed Layer-2+3 Fabrics</a> section of <a href="http://www.ipspace.net/Leaf-and-Spine_Fabric_Architectures">Leaf-and-Spine Fabric Architectures</a> webinar.</li>
<li>Want to learn the basics of data center fabrics and figure out what individual vendors are doing? Check out the <a href="http://www.ipspace.net/Data_Center_Fabrics">Data Center Fabrics</a> webinar.</li>
<li>Looking for a guided and mentored tour with plenty of peer- and instructor support? You probably need <a href="http://www.ipspace.net/Designing_and_Building_Data_Center_Fabrics">Designing and Building Data Center Fabrics online course</a>.</li>
</ul>

