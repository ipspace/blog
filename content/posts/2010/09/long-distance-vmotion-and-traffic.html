---
date: 2010-09-14T07:09:00.004+02:00
tags:
- data center
- workshop
- vMotion
- virtualization
title: Long-distance vMotion and the traffic trombone
url: /2010/09/long-distance-vmotion-and-traffic/
---

<p>Few days ago I wrote about the <a href="/2010/09/vmotion-elephant-in-data-center-room/">impact of vMotion on a Data Center network</a> and the traffic flow issues. Now let’s walk through what happens when you move a running virtual machine (VM) between two data centers (long-distance vMotion). Imagine we’re moving a web server that is:</p>
<ul class="ListParagraph"><li>Serving a few Internet clients (with firewall/NAT and/or load balancing somewhere in the path);</li>
<li>Getting most of its data from a database server sitting nearby;</li>
<li>Reading and writing to a local disk.</li>
</ul>
<p>The traffic flows are shown in the following diagram:</p>
<!--more--><p style="clear: both; text-align: center;"><a href="/2010/09/s1600-vmotion_trombone_1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="276" src="/2010/09/s400-vmotion_trombone_1.png" width="400"/></a></p>
<p>After you move the VM, its sessions remain intact. The traffic to/from the Internet still has to pass through the original firewall/load balancer (otherwise you’d lose the sessions) and the database traffic is still going to the original database server (otherwise the web applications would generate “a few” database errors).</p>
<p>Even worse, in many cases all disk write requests generated by the VM would have to go back to the primary data center. The resulting traffic flow spaghetti mess was <a href="http://etherealmind.com/vmware-vfabric-data-centre-network-design/">aptly named <em>the traffic trombone </em>by Greg Ferro</a>.</p>
<p style="clear: both; text-align: center;"><a href="/2010/09/s1600-vmotion_trombone_2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="276" src="/2010/09/s400-vmotion_trombone_2.png" width="400"/></a></p>
<h4>Notes</h4><ul class="ListParagraph"><li>Storage vMotion can be used to transfer the virtual disk file to another logical disk (LUN) with a primary copy in the second data center, effectively localizing the SAN traffic.</li>
<li>(Speculative) SAN write requests might be quickly optimized if the virtual disk file (VMDK) is stored in a truly distributed NFS store (as opposed to active/standby block storage).</li>
</ul>
<p>To give you a real-world (actually a lab) example: Cisco and VMware published a <a href="http://www.cisco.com/en/US/solutions/collateral/ns340/ns517/ns224/ns836/white_paper_c11-557822.pdf">white paper</a> describing how they managed to move a live Microsoft SQL server to a backup data center ... resulting in ~15% performance degradation and unspecified increase in WAN traffic.</p>
<h4>What do you think?</h4><p>Now that you know what’s behind the scenes of long-distance vMotion, please tell me why it would make sense to you and where you’d use it in your production network ... or, even better, what business problems are your server admins trying to solve with it.</p>
<p>Oh, and I simply have to mention the <a href="https://www.ipspace.net/DC30">Data Center 3.0 for Networking Engineers</a> webinar, it’s full of down-to-earth facts like this one (<a href="https://www.ipspace.net/SingleRecording?code=DC30">buy a recording</a> or <a href="https://www.ipspace.net/Subscription">yearly subscription</a>).</p>

