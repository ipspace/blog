---
url: /2010/09/ribs-and-fibs.html
title: "RIBs and FIBs (aka IP routing table and CEF table)"
date: "2010-09-02T07:14:00.002+02:00"
tags: [ switching,IP routing ]
---

<p>Every now and then, I’m asked about the difference between Routing Information Base (RIB), also known as IP Routing Table and Forwarding Information Base (FIB), also known as CEF table or IP forwarding table.</p>
<p class="more">We’ve discussed this topic during the <a href="http://packetpushers.net/show-7-hiding-in-plain-sight-enterprise-mpls/">Enterprise MPLS Packet Pushers Podcast</a>, so you might want to <a href="http://media.blubrry.com/packetpushers/content.blubrry.com/packetpushers/Packet-Pushers-07-Hiding-in-Plain-Sight-Enterprise-MPLS.mp3">listen to that one first</a> before going into details.</p>
<p>Let’s start with an overview picture (which does tell you more than the next thousand words I’ll write):</p>
<p style="clear: both; text-align: center;"><a href="/2010/09/s1600-RibFib.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="185" src="/2010/09/s400-RibFib.png" width="400"/></a></p>
<!--more--><p>A router has numerous ways of learning the best paths toward individual IP prefixes: they might be directly connected, configured as static routes or learned through dynamic routing protocols.</p>
<p>Each dynamic routing protocol (<a href="https://blog.ipspace.net/2008/08/rip-route-database.html">including RIP</a>) has its own set of internal data structures, known as OSPF/IS-IS database, EIGRP topology table or BGP table. The routing protocol updates its data structures based on routing protocol updates exchanged with its neighbors, eventually collecting all the relevant information. Throughout this article we’ll work with 10.0.1.1/32 learned through OSPF and 10.0.11.11/32 learned through BGP, so let’s inspect the relevant OSPF/BGP data structures.</p>
<pre class="code">RR#<strong>show ip bgp | begin Network</strong><br/>   Network          Next Hop            Metric LocPrf Weight Path<br/>r&gt;i10.0.1.1/32      10.0.1.1                 0    100      0 i<br/>r&gt;i10.0.1.2/32      10.0.1.2                 0    100      0 i<br/>*&gt;i10.0.11.11/32    10.0.1.1                 0    100      0 i<br/><br/>RR#<strong>show ip ospf database router 10.0.1.1</strong><br/><br/>            OSPF Router with ID (10.0.1.5) (Process ID 1)<br/><br/>                Router Link States (Area 0)<br/><br/>  LS age: 1612<br/>  Options: (No TOS-capability, DC)<br/>  LS Type: Router Links<br/>  Link State ID: 10.0.1.1<br/>  Advertising Router: 10.0.1.1<br/>  LS Seq Number: 80000003<br/>  Checksum: 0xC764<br/>  Length: 60<br/>  Number of Links: 3<br/><br/>    Link connected to: a Stub Network<br/>     (Link ID) Network/subnet number: 10.0.1.1<br/>     (Link Data) Network Mask: 255.255.255.255<br/>      Number of MTID metrics: 0<br/>       TOS 0 Metrics: 1<br/><br/>    Link connected to: another Router (point-to-point)<br/>     (Link ID) Neighboring Router ID: 10.0.1.6<br/>     (Link Data) Router Interface address: 10.0.7.9<br/>      Number of MTID metrics: 0<br/>       TOS 0 Metrics: 64<br/><br/>    Link connected to: a Stub Network<br/>     (Link ID) Network/subnet number: 10.0.7.8<br/>     (Link Data) Network Mask: 255.255.255.252<br/>      Number of MTID metrics: 0<br/>       TOS 0 Metrics: 64</pre><p>Each routing protocol runs its own route selection algorithm (SPF algorithm in case of OSPF or IS-IS or <a href="http://www.cisco.com/en/US/tech/tk365/technologies_tech_note09186a0080094431.shtml">pretty complex set of rules in case of BGP</a>), deriving a set of IP prefixes reachable through that routing protocol and IP next hops that should be used to reach them. You can view the results of these route selection algorithms with protocol-specific <strong>show </strong>commands (for example, <strong>show ip bgp </strong><strong><em>prefix </em></strong>for BGP and <strong>show ip ospf rib </strong><strong><em>prefix </em></strong>for OSPF).</p>
<pre class="code">RR#<strong>show ip bgp 10.0.11.11</strong><br/>BGP routing table entry for 10.0.11.11/32, version 6<br/>Paths: (1 available, best #1, table default)<br/>  Not advertised to any peer<br/>  Local<br/>    10.0.1.1 (metric 66) from 10.0.1.1 (10.0.1.1)<br/>      Origin IGP, metric 0, localpref 100, valid, internal, best<br/>RR#<strong>show ip ospf rib 10.0.1.1</strong><br/><br/>            OSPF Router with ID (10.0.1.5) (Process ID 1)<br/><br/>OSPF local RIB<br/>Codes: * - Best, &gt; - Installed in global RIB<br/><br/>*&gt;  10.0.1.1/32, Intra, cost 66, area 0<br/>     SPF Instance 2, age 00:48:15<br/>     Flags: RIB, HiPrio<br/>      via 10.0.2.1, FastEthernet0/0, flags: RIB<br/>       LSA: 1/10.0.1.1/10.0.1.1</pre><p>Both BGP and OSPF associate IP next hops with IP prefixes, but BGP simply uses the value of the next-hop attribute attached to the BGP route, whereas OSPF computes the IP address of the next-hop OSPF router with the SPF algorithm.</p>
<p>The results of intra-routing-protocol route selection are inserted in the IP routing table (RIB) based on <em>administrative distance</em> (and there are <a href="http://packetlife.net/blog/2008/dec/6/two-routing-protocols-same-ad/">interesting consequences if two routing protocols have the same AD</a>). Most routing protocols don’t complain when their routes are not used in the IP routing table; <a href="https://blog.ipspace.net/2007/12/what-is-bgp-rib-failure.html">BGP has a special show command that can display RIB failures</a>. In our scenario, the 10.0.1.1/32 prefix is received via OSPF and BGP and the OSPF route wins as OSPF has lower AD than internal BGP route.</p>
<pre class="code">RR#<strong>show ip bgp rib-failure</strong><br/>Network      Next Hop    RIB-failure            RIB-NH Matches<br/>10.0.1.1/32  10.0.1.1    Higher admin distance  n/a<br/>10.0.1.2/32  10.0.1.2    Higher admin distance  n/a</pre><p>Ideally, we would use RIB to forward IP packets, but we can’t as some entries in it (static routes and BGP routes) could have next hops that are not directly connected. </p>
<p>Compare an IBGP route in the IP routing table (RIB) with an OSPF route:</p>
<pre class="code">RR#<strong>show ip route 10.0.11.11</strong><br/>Routing entry for 10.0.11.11/32<br/>  Known via "bgp 65000", distance 200, metric 0, type internal<br/>  Last update from 10.0.1.1 00:00:55 ago<br/>  Routing Descriptor Blocks:<br/>  * 10.0.1.1, from 10.0.1.1, 00:00:55 ago<br/>      Route metric is 0, traffic share count is 1<br/>      AS Hops 0<br/>      MPLS label: none<br/><br/>RR#<strong>show ip route 10.0.1.1</strong><br/>Routing entry for 10.0.1.1/32<br/>  Known via "ospf 1", distance 110, metric 66, type intra area<br/>  Last update from 10.0.2.1 on FastEthernet0/0, 00:33:47 ago<br/>  Routing Descriptor Blocks:<br/>  * 10.0.2.1, from 10.0.1.1, 00:33:47 ago, via FastEthernet0/0<br/>      Route metric is 66, traffic share count is 1</pre><p>OSPF route has an outgoing interface; it’s computed by the SPF algorithm and transferred in the IP routing table. BGP route has no outgoing interface and its next hop is not directly connected; the router has to perform <em>recursive lookups </em>to find the outgoing interface (recursive lookups are also used to <a href="http://wiki.nil.com/EBGP_load_balancing_with_EBGP_session_between_loopback_interfaces">implement EBGP load balancing with loopback interfaces</a>).</p>
<p>Early IOS releases performed a recursive lookup on the first packet sent to a new destination (<em>process switching</em>) and cached the result for subsequent packets (<em>fast switching</em>). Fast switching worked well in early Internet (with few global IP prefixes), but as the Internet grew and address-spraying DoS attacks became common, core routers frequently experienced <em>cache </em><a href="http://en.wikipedia.org/wiki/Thrashing_(computer_science)"><em>trashing</em></a>. Large number of packets were being process switched, resulting in very high CPU utilization and occasional router meltdown. It was time to move from cache-assisted forwarding to deterministic forwarding.</p>
<p>Forwarding Information Base (FIB) and Cisco Express Forwarding (CEF) switching were introduced to make layer-3 switching deterministic. When IP routes are copied from RIB to FIB, their next hops are resolved, outgoing interfaces are computed and multiple entries are created when the next-hop resolution results in multiple paths to the same destination.</p>
<p>For example, when the BGP route from the previous printout is inserted into FIB, its next-hop is changed to point to the actual next-hop router. The information about the recursive next-hop is retained, as it allows the router to update the FIB (CEF table) without rescanning and recomputing the whole RIB if the path toward the BGP next-hop changes.</p>
<pre class="code">RR#<strong>show ip cef 10.0.11.11 detail</strong><br/>10.0.11.11/32, epoch 0, flags rib only nolabel, rib defined all labels<br/>  recursive via 10.0.1.1<br/>    nexthop 10.0.2.1 FastEthernet0/0 label 19</pre><p>Fully-evaluated FIB (CEF table) can then be used directly for layer-3 switching. </p>

