---
url: /2010/08/i-dont-need-no-stinking-firewall-or-do.html
title: "I don’t need no stinking firewall ... or do I?"
date: "2010-08-19T07:04:00.008+02:00"
tags: [ firewalls,Data Center,Workshop ]
---

<p>Brian Johnson started a lively “<a href="http://markmail.org/thread/fvordsbnuc74fuu2"><em>I don’t need no stinking firewall</em></a>” discussion on NANOG mailing list in January. I wanted to write about the topic then, but somehow the post slipped through the cracks (thank you, Pavel, for a <a href="http://blog.ioshints.info/2010/08/rest-in-peace-my-waf-friend.html#jsid-1280938787-466">kindly reminder</a>!) ... and I’m glad it did, as I’ve learned a few things in the meantime, including the (now obvious) fact that no two data centers are equal (the original debate had to do with protecting servers in large-scale data center).</p>
<p>First let’s rephrase the provocative headline from the discussion. The real question is: do I need a stateful firewall or is a stateless one enough?</p>
<p style="clear: both; text-align: center;"><a href="http://picasaweb.google.com/lh/photo/i6FV_-suun0FCJ1c3HRm8sh1SULQCbwzWL6IH5NBoZg?feat=embedwebsite"><img src="http://lh6.ggpht.com/_K_pkZO5-tTg/TGpV23jYSfI/AAAAAAAAEM8/ZY5wyjzDrSc/s400/FirewallsOrRouters.png.jpg"/></a></p>
<!--more--><p class="note">Stateless firewalling is implemented quite easily with router access lists and thus works at line speed in most routers. Stateful firewalls implemented in routers are usually suitable for low-speed remote offices; you should use dedicated firewall devices in data centers. </p>
<h4>Technology issues</h4><p>Stateful firewall is the only option if you’re trying to tightly protect applications that use dynamic port numbers, including everything from peer-to-peer applications (including SIP) to RPC-based applications (let’s try not to call them <em>broken </em>... how about <em>unpredictable applications</em>). </p>
<p class="note">You can <a href="http://blog.ioshints.info/2010/05/update-make-ftp-server-slightly-more.html">limit the dynamic port range for some of these applications</a> and allow all ports in that range through the firewall ... while hoping that some other service on your server won’t grab one of those ports and expose itself unnecessarily.</p>
<p>If your applications use only well-known fixed port numbers (let’s call them <em>fixed-port applications</em>), you don’t have to inspect the application data stream and can match the applications with access lists; stateless solutions seem appropriate.</p>
<p>However, some stateful firewalls can add value even in <em>fixed-port </em>environments: they can delay the commitment of server resources to TCP sessions with <a href="http://en.wikipedia.org/wiki/SYN_cookies">TCP SYN cookies</a> (also available in numerous server operating systems) and check the validity of TCP sessions.</p>
<p class="note">You might think that there are no vulnerabilities left in TCP that could be exploited. A long while ago, everyone thought it was impossible to establish one-way spoofed TCP sessions even though there were known vulnerabilities in TCP sequence number generation ... until Kevin Mitnick proved them wrong.</p>
<p>Last but not least, stateful firewall in front of a server can block <a href="http://en.wikipedia.org/wiki/TCP/IP_stack_fingerprinting">TCP fingerprinting</a> attempts. Sometimes you simply don’t want the attacker to know too much about your infrastructure.</p>
<h4>Design choices</h4><p>There are two extremes you can be facing in a data center:</p>
<p><strong>Unified large-scale infrastructure using fixed-port applications</strong>, including Google, Yahoo, Facebook, Twitter and a few others. You would expect to see from tens to thousands of almost-identical servers with standardized and identically-configured operating system in these environments. It’s quite manageable to harden and patch these servers and combined with <em>fixed-port </em>applications these environments usually offer, it makes perfect sense to be satisfied with router ACLs (and that was the case the proponents of “get rid of the firewall” line of thinking were promoting in the NANOG discussion).</p>
<p><strong>Dynamic hodgepodge of servers, operating systems and application</strong> encountered in a usual enterprise data center. Server hardening is mission impossible (as you have so many different operating systems and/or versions of the same operating system), patching is the responsibility of individual server administrators (and they might not even be a unified team) and the applications are a nightmare from the security perspective. For example, <a href="http://support.microsoft.com/kb/259240">early Outlook Web Access was easy to firewall</a> but even then <a href="http://articles.techrepublic.com.com/5100-10878_11-5112761.html">some people advocated putting OWA in the inside network</a> (I wish I were blogging at that time, I would have had so much fun debunking that article). I was not able to find anything from Microsoft telling me how to configure my firewall to support OWA for Exchange Server 2010; the cynical response I got from a (non-Microsoft) security engineer a few days ago was “nobody can figure out which ports it uses”.</p>
<h4>Now what?</h4><p>Obviously you’re the only one who can decide where your Data Center environment is and which measures you’d like to implement, but as a generic rule, the more exposed (and the worse managed) a server is, the more you should lean toward a stateful firewall in front of it. Most enterprise data centers make heavy use of stateful firewalls and that’s also what we’re recommending to most of our customers.</p>
<p>To get insight into typical Data Center architectures (including load balancing and firewalling) and emerging DC technologies, watch my <a href="http://www.ioshints.info/DC30">Data Center 3.0 for Networking Engineers</a> webinar (<a href="http://www.ioshints.info/SingleRecording?code=DC30">buy a recording</a> or <a href="http://www.ioshints.info/Subscription">yearly subscription</a>). For an in-depth solution, you might want to consider the benefits of our <a href="http://www.nil.si/go/hypercenter">Hypercenter architecture</a>.</p>

