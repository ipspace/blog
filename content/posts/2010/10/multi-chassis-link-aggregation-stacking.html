---
date: 2010-10-18T06:39:00.003+02:00
tags:
- link aggregation
- switching
- data center
- workshop
- LAN
title: 'Multi-chassis Link Aggregation: Stacking on Steroids'
url: /2010/10/multi-chassis-link-aggregation-stacking.html
---

<p>In the <a href="https://blog.ipspace.net/2010/10/multi-chassis-link-aggregation-basics.html"><em>Multi-chassis Link Aggregation </em><em>(MLAG) </em><em>Basics</em></a><em> </em>post I’ve described how you can use (vendor-proprietary) technologies to bundle links connected to two upstream switches into a single logical channel, bypassing the Spanning Tree Protocol (STP) port blocking. While every vendor takes a different approach to MLAG, there are only a few architectures that you’ll see. Let’s start with the most obvious one: <em>stacking on steroids</em>.</p>
<!--more--><h4>The basics</h4><p>Low-end devices have provided multi-chassis link aggregation for a long time and nobody realized it’s a big deal. After all, a stackable switch is just a stackable switch; in opinion of many networking engineers that’s not necessarily a sin, but neither is it something to be very proud about.</p>
<p>When the vendors decided to introduce the same mentality to the core Data Center switches, they couldn’t say “well, we just made our core switches stackable”; their marketing department had to invent a fancy name for the technology, be it <a href="http://www.cisco.com/en/US/prod/collateral/switches/ps5718/ps9336/product_solution_overview0900aecd806fa5d0.html">Virtual Switching System</a> or <a href="http://h3c.com/portal/Products___Solutions/Technology/IRF/Technology_White_Paper/200901/624932_57_0.htm">Intelligent Resilient Framework</a>. </p>
<p>Regardless of the branding efforts, the architecture of VSS/IRF solution still looks and feels like a stackable switch: you take X independent boxes (X = 2 in VSS case) and turn all but one brain (= control plane) off. Distributed switching subsystems add some spice (= complexity) to the mix. For example, in a VSS system, the SUP blade in the secondary chassis still controls its switching fabrics.</p>
<p style="clear: both; text-align: center;"><a href="/2010/10/s1600-vss1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="168" src="/2010/10/s400-vss1.png" width="400"/></a></p>
<p>With all the control planes but one gone into self-induced coma (vendors prefer the term <em>standby</em>), it’s easy to implement link aggregation. After all, the primary control plane receives all control packets (including LACP and STP messages) and directly or indirectly (through standby control planes) controls the switching fabrics in the whole system.</p>
<p>The traffic flow across the whole stacked system is usually optimal. Consider, for example, the following diagram:</p>
<p style="clear: both; text-align: center;"><a href="/2010/10/s1600-vss2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="265" src="/2010/10/s320-vss2.png" width="320"/></a></p>
<p>When server A sends a packet to server B through the Primary switch, the Primary switch automatically updates its own MAC address table and the MAC address table on the Standby switch (both entries for MAC address A point to local links in the port channel with server A). When server B sends a subsequent packet to server A it uses the optimal path and does not traverse the inter-switch link.</p>
<p style="clear: both; text-align: center;"><a href="/2010/10/s1600-vss3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="265" src="/2010/10/s320-vss3.png" width="320"/></a></p>
<h4>Schizophrenia</h4><p>The worst scenario in any stackable solution is a split-brain failure – the link between the primary switch and standby switches is lost while the access links remain operational.</p>
<p>In a pure layer-2 solution, split-brain failure is not necessarily a disaster. The standby switch discovers the primary switch is gone, becomes independent (causing, among other things, STP topology change) and tries to renegotiate port channels with a different switch ID, which causes a port channel failure. Depending on how the southward switches are implemented (isn’t compass terminology a great invention?), they could split the port channel in two independent links (and STP would block one of them) or shut down half of the links in the port channel.</p>
<p>Layer-3 split brain event is a cataclysm. All of a sudden you have two routers with the same set of IP addresses and same router IDs in your network. Try to imagine what that does to your ARP caches and routing protocol and how long the post-traumatic effects will linger after you manage to shut down one of the switches (in case of OSPF, up to one hour).</p>
<p style="clear: both; text-align: center;"><a href="/2010/10/s1600-vss4.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="150" src="/2010/10/s400-vss4.png" width="400"/></a></p>
<h4>Read the smallprint</h4><p>If a vendor tells you virtual device partitioning is not a problem, run away ... or ask them how they handle layer-3 problems, lean back and enjoy the show.</p>
<p>The methods vendors use to deal with detecting and recovering from device partitioning tells you a lot about their commitment to the stability of your network. Don’t be dazzled by the flamboyant approaches like “this can never happen”; personally I prefer to see someone who thought seriously about the problem and tried hard to detect it and recover from it (even though we agree it should never happen).</p>
<p>Consider, for example, <a href="http://www.cisco.com/en/US/docs/solutions/Enterprise/Data_Center/DC_3_0/DC-3_0_IPInfra.html">design recommendations and dual-active detection technologies used by Cisco’s VSS</a> (a stack of Catalyst 6500s):</p>
<ul class="ListParagraph"><li>You should use multiple physical links bundled into a channel for the Virtual-Switch Link (VSL);</li>
<li>Apart from VSL, there should be an independent keepalive link between the switches.</li>
<li>BFD is run on the keepalive link to distinguish between switch failure and VSL failure;</li>
<li>If you have Cisco’s switches connected to the VSS complex, you can run Enhanced Port Aggregation Protocol (EPagP) across some port channels to allow the VSS switches to communicate across access switches.</li>
</ul>
<p>As for what happens when the dual-active condition is detected, Cisco is yet again quite honest: the primary switch is immediately restarted (assuming the standby switch has already transitioned into an active role).</p>
<h4>Feedback highly appreciated</h4><p>As you know, I’m most familiar with Cisco’s switches and you were a great help when I started digging into multi-chassis implementations from various vendors. If I’ve missed a vendor that also uses a stackable approach (Juniper comes to mind), please let me know. If you have links to in-depth documents that you can share, please post them.</p>
<h4>More information</h4><p>On Cisco VSS:</p>
<ul class="ListParagraph"><li><a href="http://www.cisco.com/en/US/docs/solutions/Enterprise/Data_Center/DC_3_0/DC-3_0_IPInfra.html">Data Center Design – IP Network Infrastructure</a></li>
<li><a href="http://www.cisco.com/en/US/prod/collateral/switches/ps5718/ps9336/prod_qas0900aecd806ed74b.html">Virtual Switching System (VSS) Q&amp;A</a></li>
</ul>
<p>On 3Com/Huawei/HP IRF:</p>
<ul class="ListParagraph"><li><a href="http://h3c.com/portal/Products___Solutions/Technology/IRF/">IRF technology introduction and white paper</a></li>
</ul>
<p>And don’t forget the <a href="https://www.ipspace.net/DC30">Data Center 3.0 for Networking Engineers</a> webinar (<a href="https://www.ipspace.net/SingleRecording?code=DC30">buy a recording</a> or <a href="https://www.ipspace.net/Subscription">yearly subscription</a>), which covers VSS, vPC, port extenders, TRILL and numerous other data center technologies.</p>

