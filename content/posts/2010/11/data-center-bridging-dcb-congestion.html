---
date: 2010-11-16T06:33:00.006+01:00
tags:
- DCB
- switching
- data center
- workshop
- QoS
title: Data Center Bridging (DCB) Congestion Notification (802.1Qau)
url: /2010/11/data-center-bridging-dcb-congestion.html
---

<p>The last (and the least popular) Data Center Bridging (DCB) standard tries to solve the problem of congestion in large bridged domains (<a href="https://blog.ipspace.net/2010/09/introduction-to-8021qbb-priority-flow.html">PFC enables lossless transport</a> and <a href="https://blog.ipspace.net/2010/09/introduction-to-8021qaz-enhanced.html">ETS standardizes DWRR queuing</a>). To illustrate the need for congestion control, consider a simple example shown in the following diagram:</p>
<p style="clear: both; text-align: center;"><a href="/2010/11/s1600-802.1Qau.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="107" src="/2010/11/s400-802.1Qau.png" width="400"/></a></p>
<p class="warn" style="border-left-color: rgb(178,26,26)">It came to my attention that a vendor might be using this blog post to justify the need for QCN in FCoE environments. Should that be the case, please make sure you also read about the <a href="https://blog.ipspace.net/2010/08/multihop-fcoe-101.html">difference between dense and sparse FCoE</a>, the <a href="https://blog.ipspace.net/2010/11/does-fcoe-need-qcn-8021qau.html">(lack of) need for QCN in FCoE</a> and <a href="https://blog.ipspace.net/2011/06/fcoe-over-trill-this-time-from-juniper.html">whether it makes sense to run FCoE over TRILL</a>. Finally, consider how you’ll <a href="https://blog.ipspace.net/2011/06/beauties-of-dense-mode-fcoe.html">troubleshoot FCoE environments</a>.<!--more--></p>
<p>Server <em>S</em> writes large amounts of data to a slow storage array <em>D</em>, which has to use PFC PAUSE frame to tell the upstream switch <em>B </em>to stop sending SAN (for example, FCoE) traffic. Eventually switch <em>B </em>runs out of buffer space and has to tell switch <em>A </em>to stop sending SAN traffic.</p>
<p>At that time, the <em>A</em>-to-<em>B</em> link is blocked for SAN traffic, so server <em>X </em>cannot write data to disk <em>Y</em>, even though the path <em>X-A-B-Y</em> is not congested. Obviously we need a mechanism that would allow switch <em>B </em>to tell <em>S </em>to stop without affecting other traffic.</p>
<p class="note">The example is very simplistic, worse problems arise when a local congestion of an oversubscribed inter-switch link spills over into upstream switches without a single end-to-end session getting slowed down by the end hosts.</p>
<p>The 802.1Qau standard tries to solve the large-scale congestion problem with the <em>Quantized Congestion Notification (QCN) </em>protocol, which the bridges can use to send the <em>Congestion Notification Messages </em>(<em>CNM</em>) to the senders (end hosts).</p>
<p>The bridges (<em>congestion points</em>) constantly monitor output queues sizes. When the output queue size grows beyond an (implementation-dependent) optimum point and is still increasing, CNM is sent back to the sender of a frame entering the output queue with probability (between 1% and 10%) that depends on the severity of the congestion. Lightly-congested output queues will cause a CNM to be sent on every 100<span style="vertical-align: super; font-size: 80%;">th</span> packet (on average, it’s a random process); highly congested queues will send a CNM on every 10<span style="vertical-align: super; font-size: 80%;">th</span> packet.</p>
<p class="note">Frames with different 802.1p priority values are usually sorted into different output queues. 802.1Qau is thus automatically priority-aware and will not send CNMs to senders in other priority classes (assuming those priority classes don’t have overloaded output queues).</p>
<p>The CNM contains several fields that help the sender identify the cause of the congestion: 802.1p priority value, destination MAC address and first few bytes of the offending message. It also contains a 6-bit indication of the congestion severity that the sender must use to adjust the outgoing traffic rate.</p>
<p>After receiving CNM, the sender (<em>reaction point</em>) slows down the offending traffic based on the congestion severity value (maximum: 50%) and enters <em>Fast Recovery </em>phase, during which the sending rate is slowly increased until it gets close to the value it had before the CNM message was received (after 150 kilobytes worth of data is sent, the sending rate is increased by half the difference between the current and target sending rate). If no further CNM messages are received after five cycles (750 kilobytes), the sender switches to <em>Active Increase </em>mode, where the sending rate increases beyond the original value (unless, of course, another CNM is received).</p>
<h4>Interesting details</h4><ul class="ListParagraph"><li>QCN makes most sense for lossless traffic. In most cases packet drops are good enough for loss-tolerant traffic.</li>
<li>Simulations indicate QCN can also improve TCP and UDP performance and make UDP “fair” (assuming senders use a separate shaping queue for UDP and rate-limit that queue based on CNMs). See <a href="http://www.ietf.org/proceedings/67/slides/tsvarea-2.pdf">slides 21-27 of this presentation</a>.</li>
<li>QCN works across a single layer-2 domain. As soon as the traffic crosses a router (or FCoE switch), it enters a different QCN domain.</li>
<li>QCN has to be implemented in hardware on bridges and all end-hosts (responding to CNM messages in software on 10 GE links is probably too slow).</li>
<li>It’s extremely unlikely that the existing hardware will be able to support QCN. You’ll probably have to change all the server/storage NICs and all the linecards in your switches before deploying QCN (unless someone figures out a way to do fast-enough QCN in software).</li>
<li>QCN requires multiple shaping queues on every QCN-enabled host, making host NICs more expensive.</li>
<li>IEEE working group changed the congestion notification details a few times, the last time from simple Backward Congestion Notification (BCN) to Quantized Congestion Notification (QCN). A vendor or two that relied on BCN being ratified probably had to scrap their already-developed hardware.</li>
</ul>
<p>Taking all these details in account, I don’t expect to see QCN deployed in production networks any time soon (if at all). According to Pat Thaler (see the comments), 802.1Qau has been ratified in March 2010 (obviously someone forgot to update the IEEE 802.1 web page, which at the time I’m writing this post still lists 802.1Qau as an <em>active project</em>) and I haven’t heard about production-ready chipsets yet.</p>
<p class="update">Update 2010-11-17: The original version of this post contained two factual errors: FCoE does not have BB_credits and the 802.1Qau standard was ratified in March 2010. I would like to thank Pat Thaler for bringing them to my attention. </p>
<h4>More information</h4><p>If you’d like to hear more about emerging Data Center technologies, including Data Center Bridging, Shortest Path Bridging (TRILL, FabricPath and 802.1aq) and FCoE, watch my <a href="https://www.ipspace.net/DC30">Data Center 3.0 for Networking Engineers</a> webinar (<a href="https://www.ipspace.net/SingleRecording?code=DC30">buy a recording</a> or <a href="https://www.ipspace.net/Subscription">yearly subscription</a>).</p>

