---
date: 2011-10-10T07:21:00.000+02:00
tags:
- VXLAN
- switching
- data center
- workshop
- overlay networks
- virtualization
title: VXLAN termination on physical devices
url: /2011/10/vxlan-termination-on-physical-devices/
---

<p>Every time I’m discussing the VXLAN technology with a fellow networking engineer, I inevitably get the question “how will I connect this to the outside world?” Let’s assume you want to build pretty typical 3-tier application architecture (next diagram) using VXLAN-based virtual subnets and you already have firewalls and load balancers – can you use them?</p>
<p class="warn">The product information in this blog post is outdated - Arista, Brocade, Cisco, Dell, F5, HP and Juniper are all shipping hardware VXLAN gateways (<a href="/2015/09/vxlan-hardware-gateway-overview/">this post</a> has more up-to-date information). The concepts explained in the following text are still valid; however, I would encourage you to read <a href="/tag/vxlan/">other VXLAN-related posts</a> on this web site or watch the <a href="http://www.ipspace.net/VXLAN_Technical_Deep_Dive">VXLAN webinar</a> to get a more recent picture.<!--more--></p>
<p class="separator" style="clear: both; text-align: center;"><a href="/2011/10/s1600-vXLAN-Typical-Architecture.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="82" src="/2011/10/s320-vXLAN-Typical-Architecture.png" width="320"/></a><!--more--></p>
<p>The only product supporting VXLAN Tunnel End Point (VTEP) in the near future is the Nexus 1000V virtual switch; the only devices you can connect to a VXLAN segment are thus Ethernet interface cards in virtual machines. If you want to use a router, firewall or load balancer (sometimes lovingly called <em>application delivery controller</em>) between two VXLAN segments or between a VXLAN segment and the outside world (for example, a VLAN), you have to use a VM version of the layer-3 device. That’s not necessarily a good idea; <a href="/2011/04/virtual-network-appliances-benefits-and/">virtual networking appliances have numerous performance drawbacks</a> and consume way more CPU cycles than needed ... but if you’re a cloud provider billing your customers by VM instances or CPU cycles, you might not care too much.</p>
<p>The virtual networking appliances also introduce extra hops and unpredictable traffic flows into your network, as they can freely move around the data center at the whim of workload balancers like VMware’s DRS. A clean network design (left) is thus quickly morphed into a total spaghetti mess (right):</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/10/s1600-VXLAN-Virtual-to-Physical.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="173" src="/2011/10/s320-VXLAN-Virtual-to-Physical.png" width="320"/></a></div>
<p>Cisco doesn’t have any L3 VM-based product, and the only thing you can get from VMware is vShield Edge – a dumbed down Linux with a fancy GUI. If you’re absolutely keen on deploying VXLAN, that shouldn’t stop you; there are numerous VM-based products, including BIG-IP load balancer from F5 and Vyatta’s routers. Worst case, you can turn a standard Linux VM into a usable router, firewall or NAT device by removing less functionality from it than VMware did. Not that I would necessarily like doing that, but it’s one of the few options we have at the moment.</p>
<h4>Next steps?</h4><p>Someone will have to implement VXLAN on physical devices sooner or later; running networking functions in VMs is simply too slow and too expensive. While I don’t have any firm information (not even roadmaps), do keep in mind Ken Duda’s enthusiasm during the <a href="http://packetpushers.net/show-66-vxlan-nvgre-ken-duda/">VXLAN Packet Pushers podcast</a> (and remember that both Arista and Broadcom appear in the author list of VXLAN and NVGRE drafts). </p>
<p>Furthermore, VXLAN encapsulation format is actually a subset of OTV encapsulation, as Omar Sultan pointed out in his <a href="http://blogs.cisco.com/datacenter/vxlan-deep-dive-part-2-looking-at-the-options/">VXLAN Deep Dive</a> blog post, which means that Cisco already has the hardware necessary to terminate VXLAN segments in Nexus 7000.</p>
<h4>How could you do it?</h4><p><strong>Layer-3 termination</strong> of VXLAN segments is actually pretty easy (from the architectural and control plane perspective):</p>
<ul class="ListParagraph"><li>VMs attached to a VXLAN segment are configured with the default gateway’s IP address (intra-VXLAN subnet logical IP address of the physical termination device);</li>
<li>A VM sending an IP packet to an off-subnet destination has to send it to the default gateway’s IP address and performs an ARP request;</li>
<li>One or more layer-3 VXLAN termination devices respond to the ARP request sent in the VXLAN encapsulation and the Nexus 1000V switch in the hypervisor running the VM remembers RouterVXLANMAC-to-RouterPhysicalIP address mapping;</li>
<li>When the VM sends an IP packet to the default gateway’s MAC address, the Nexus 1000V switch forwards the IP-in-MAC frame to the nearest RouterPhysicalIP address.</li>
</ul>
<p>No broadcast or flooding is involved in the layer-3 termination, so you could easily use the same physical IP address and the same VXLAN MAC address on multiple routers (anycast) and achieve instant redundancy without first hop redundancy protocols like HSRP or VRRP.</p>
<p><strong>Layer-2 extension</strong> of VXLAN segments into VLANs (that you might need to connect VXLAN-based hosts to an external firewall) is a bit tougher. As you’re bridging between VXLAN and an 802.1Q VLAN, you have to ensure that you don’t create a forwarding loop. </p>
<p>You could configure the VXLAN layer-2 extension (bridging) on multiple physical switches and run STP over VXLAN ... but I hope we’ll never see that implemented. It would be way better to use IP functionality to select the VXLAN-to-VLAN forwarder. You could, for example, run VRRP between redundant VXLAN-to-VLAN bridges and use VRRP IP address as the VXLAN physical IP address of the bridge (all off-VXLAN MAC addresses would appear as being reachable via that IP address to other VTEPs). The VRRP functionality would also control the VXLAN-to-VLAN forwarding – only the active VRRP gateway would perform the L2 forwarding. You could still use a minimal subset of STP to prevent forwarding loops, but I wouldn’t use it as the main convergence mechanism.</p>
<h4>Summary</h4><p>VXLAN is a great concept that gives you clean separation between virtual networks and physical IP-based transport infrastructure, but we need VXLAN termination in physical devices (switches, potentially also firewalls and load balancers) before we can start considering large-scale deployments. Till then, it will remain an interesting proof-of-concept tool or a niche product used by infrastructure cloud providers.</p>
<h4>More information</h4><p>The concepts and challenges of virtualized networking are described in the <a href="https://www.ipspace.net/VMintro">Introduction to Virtualized Networking</a> webinar. For more details, check out my <a href="https://www.ipspace.net/Data_Center_3.0_for_Networking_Engineers">Data Center 3.0 for Networking Engineers</a> (<a href="https://www.ipspace.net/Recordings?code=DC30">recording</a>) and <a href="https://www.ipspace.net/VMnet">VMware Networking Deep Dive</a> (<a href="https://www.ipspace.net/Recordings?code=VMnet">recording</a>) webinars. Both of them are also available as part of the <a href="https://www.ipspace.net/Data_Center_trilogy">Data Center Trilogy</a> and you get access to all three webinars (and numerous others) as part of the <a href="https://www.ipspace.net/Subscription">yearly subscription</a>.</p>

