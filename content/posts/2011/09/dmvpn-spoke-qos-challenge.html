---
url: /2011/09/dmvpn-spoke-qos-challenge.html
title: "DMVPN: Spoke QoS Challenge"
date: "2011-09-29T07:14:00.000+02:00"
tags: [ DMVPN,Workshop ]
---

<p>Got the following question with an invalid return address, so I’m broadcasting the reply ;)</p>
<blockquote class="cite">I am running a DMVPN network and recently got a requirement for spoke-to-spoke communication. We currently shape traffic on a per spoke basis on the hub, and have a single shaper at the remote site. However, if a spoke is receiving a large amount of traffic from the hub and another spoke site, how will the sites sending traffic know that the remote port is congested? </blockquote>
<p>Short answer – they won’t. You have a mission-impossible problem (very similar to <a href="https://blog.ipspace.net/2009/06/adsl-qos-basics.html">ADSL QoS</a>), but there might be some slight silver lining:<!--more--></p>
<ul class="ListParagraph"><li>TCP traffic adapts to congestion. If most of your traffic is TCP, you’ll do fine. If you have voice in the mix, you have a real problem. Even though TCP will eventually back off, congestion on the Internet-to-site link causes increased latency making VoIP users unhappy.</li>
<li>To keep voice latency within reasonable bounds, you have to shape TCP traffic to approximately two thirds of your access bandwidth. Jared Valentine wrote a great article describing his <a href="http://www.xmission.com/~hidden/aatqos/">adaptive ADSL QoS solution</a>. You could do something similar on your DMVPN spoke routers.</li>
<li>You can always use appliances like <a href="http://www.bluecoat.com/products/packetshaper">PacketShaper</a>/Packeteer or <a href="http://www.ipanematech.com/">Ipanema</a> – but make sure you understand what they do and don’t buy the snake oil. If your problem involves a combination of inbound traffic streams from multiple sites, you need on-site appliance, not something like emulated <a href="http://www.ipanematech.com/en/tele-engine">tele|engine</a>.</li>
<li>Worst case, buy two Internet access links for each spoke – one for data, one for voice. At $50/month, this solution just might be cheaper than an on-site appliance.</li>
</ul>
<h4>More information</h4><p>I wrote about DMVPN QoS before. Read <a href="https://blog.ipspace.net/2011/06/qos-in-large-scale-dmvpn-networks.html">QoS in Large-Scale DMVPN Networks</a>. </p>
<p>DMVPN QoS issues are similar to those faced by DSL users. Read <a href="https://blog.ipspace.net/2009/06/adsl-qos-basics.html">ADSL QoS Basics</a>.</p>
<p>You can implement adaptive QoS with EEM, but it <a href="https://blog.ipspace.net/2008/12/this-is-qos-who-cares-about-real-time.html">won’t be reacting to fast changes</a> in line utilization (<a href="https://blog.ipspace.net/2010/01/update-workaround-for-sluggish-cb-qos.html">here’s an update</a>). </p>
<p>DMVPN QoS is also described in the <a href="http://www.ioshints.info/DMVPN150">DMVPN New Features</a> webinar. You can buy the <a href="http://www.ioshints.info/Recordings?code=DMVPN150">recording</a> or get it as part of the <a href="http://www.ioshints.info/Subscription">yearly subscription</a>.</p>

