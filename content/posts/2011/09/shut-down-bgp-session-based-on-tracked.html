---
url: /2011/09/shut-down-bgp-session-based-on-tracked.html
title: "Shut down BGP session based on tracked object"
date: "2011-09-09T06:33:00.000+02:00"
tags: [ BGP,EEM ]
---

<p>In responses to my <a href="https://blog.ipspace.net/2011/08/road-to-complex-designs-is-paved-with.html"><em>The Road to Complex Designs is Paved With Great Recipes</em></a> post Daniel suggested shutting down EBGP session if your BGP router cannot reach the DMZ firewall and Cristoph guessed that it might be done without changing the router configuration with the <strong>neighbor fall-over route-map </strong>BGP configuration command. He was sort-of right, but the solution is slightly more convoluted than he imagined.<!--more--></p>
<p>Cristoph’s original idea was simple enough: create a fake static route based on a <strong>track </strong>object (that can track anything you want) and match that route with the <strong>fall-over route-map</strong>. Unfortunately, that’s not how the fast fall-over functionality works – it takes the neighbor’s IP address, finds all routes that can be used to reach the neighbor, and tests them with the specified <strong>route-map</strong> (more details in my <a href="http://www.nil.com/ipcorner/DesigningBGPNetworks/"><em>Designing Fast Converging BGP Networks</em></a> article).</p>
<p>I used a creative approach to create a static route that fits the requirements of the <a href="http://www.cisco.com/en/US/docs/ios/12_0s/feature/guide/cs_bsfda.html"><em>Fast Peering Deactivation</em></a>: a host route toward the BGP next hop pointing at BGP next hop. </p>
<p>Let’s walk through a lab-tested example: The router is running BGP in AS#65100 and has an EBGP session with 10.0.7.10 in AS#65000:</p>
<pre class="code">router bgp 65100<br/> bgp log-neighbor-changes<br/> network 10.0.1.1 mask 255.255.255.255<br/> neighbor 10.0.7.10 remote-as 65000</pre><p>First we have to create the track object that will cause the BGP session termination. It can track anything – you can track interface state, use IP SLA and ping the firewall, or even use EEM to trigger time-based (or other event-based) session shutdown. I decided to track the state of the LAN interface.</p>
<p class="info">There are simpler solutions if you want to originate a BGP route only when the LAN interface is operational. Read <a href="https://blog.ipspace.net/2011/08/road-to-complex-designs-is-paved-with.html">this blog post</a> for more information.</p>
<pre class="code">track 10 interface FastEthernet0/0 ip routing<br/> carrier-delay</pre><p>Next, create a host route for the BGP next hop pointing to the next hop itself.</p>
<p class="info">If you use a PPP interface to connect to the BGP next hop, make sure you disable <strong>peer neighbor-route</strong>, otherwise the router <a href="https://blog.ipspace.net/2008/02/remove-unwanted-ppp-peer-route.html">creates a competing host route</a> for the BGP next hop.</p>
<pre class="code">ip route 10.0.7.10 255.255.255.255 Serial1/0 10.0.7.10 track 10<br/>!<br/>interface Serial1/0<br/> description Link to AS65000<br/> ip address 10.0.7.9 255.255.255.252<br/> encapsulation ppp<br/> no peer neighbor-route</pre><p>We need a <strong>prefix-list</strong> and a <strong>route-map</strong> to match the host route toward the BGP next hop:</p>
<pre class="code">ip prefix-list BGP_OK seq 5 permit 10.0.7.10/32<br/>!<br/>route-map BGP_OK permit 10<br/> match ip address prefix-list BGP_OK</pre><p>And finally, we can configure the fast BGP session deactivation on the EBGP session:</p>
<pre class="code">router bgp 65100<br/> neighbor 10.0.7.10 fall-over route-map BGP_OK</pre><p><strong>Test#1 – shut down the LAN interface</strong>. BGP session is shut down almost immediately (you can fine-tune the delay with <strong>track </strong>object parameters).</p>
<pre class="code">A1#conf t<br/>Enter configuration commands, one per line.  End with CNTL/Z.<br/>A1(config)#int fa 0/0<br/>A1(config-if)#shut<br/>A1(config-if)#<br/>15:27:55.719: %LINK-5-CHANGED: Interface FastEthernet0/0, changed state to <br/>  administratively down<br/>15:27:56.383: %TRACKING-5-STATE: 10 interface Fa0/0 ip routing Up-&gt;Down<br/>15:27:56.415: %BGP-5-ADJCHANGE: neighbor 10.0.7.10 Down Route to peer lost<br/>15:27:56.415: %BGP_SESSION-5-ADJCHANGE: neighbor 10.0.7.10 IPv4 Unicast <br/>  topology base removed from session  Route to peer lost<br/>15:27:56.719: %LINEPROTO-5-UPDOWN: Line protocol on Interface <br/>  FastEthernet0/0, changed state to down</pre><p><strong>Test#2 – re-enable the LAN interface</strong>. BGP session is reestablished in less than a second. Perfect ;)</p>
<pre class="code">A1(config-if)#no shut<br/>A1(config-if)#<br/>15:29:22.211: %LINK-3-UPDOWN: Interface FastEthernet0/0, changed state to up<br/>15:29:22.395: %TRACKING-5-STATE: 10 interface Fa0/0 ip routing Down-&gt;Up<br/>15:29:22.511: %BGP-5-ADJCHANGE: neighbor 10.0.7.10 Up<br/>15:29:23.211: %LINEPROTO-5-UPDOWN: Line protocol on Interface<br/>  FastEthernet0/0, changed state to up</pre><h4>Need help?</h4><p>BGP is one of those topics that never cease to intrigue me. If you need me (or one of our experts) for a few day on-site network design/review workshop, <a href="http://www.ioshints.info/Contact">get in touch</a> ... and there’s always the <a href="http://www.ioshints.info/ExpertExpress"><em>ExpertExpress</em></a> option if you’re looking for a quick design review, second opinion or troubleshooting help.</p>

