---
date: 2011-09-05T06:53:00.000+02:00
tags:
- link aggregation
- switching
- workshop
- virtualization
title: Nexus 1000V LACP offload and the dangers of in-band control
url: /2011/09/nexus-1000v-lacp-offload-and-dangers-of.html
---
<div class='update'>2021-03-01: Nexus 1000v turned into abandonware long time ago, and is now officially a zombie (oops, EOL). However, the challenges they were facing with LACP offload are still worth pointing out to anyone advocating centralized control plane (stupidity formerly known as SDN).</div>
<p>A while ago someone sent me the following comment as part of a lengthy discussion focusing on Nexus 1000V: “<em>My SE tells me that the latest 1000V release has rewritten the LACP code so that it operates entirely within the VEM. VSM will be out of the picture for LACP negotiations. I guess there have been problems.</em>”</p>
<p>If you’re not familiar with the Nexus 1000V architecture, <a href="https://blog.ipspace.net/2011/06/what-exactly-is-nexus-1000v.html">read this post first</a>. If you’re not convinced you should be running LACP between the ESX hosts and the physical switches, <a href="https://blog.ipspace.net/2011/01/vswitch-in-multi-chassis-link.html">read this one</a> (and <a href="https://blog.ipspace.net/2011/01/vmware-vswitch-does-not-support-lacp.html">this one</a>). Ready? Let’s go.<!--more--></p>
<p>Now imagine you’ve just installed the Nexus 1000V software on a bunch of ESX hosts and decided to <a href="https://blog.ipspace.net/2011/01/vmware-vswitch-does-not-support-lacp.html">enable LACP to support proper link aggregation</a> between the hosts and a redundant pair of switches running <a href="https://blog.ipspace.net/2010/10/multi-chassis-link-aggregation-stacking.html">multi-chassis link aggregation</a>. All the soft switches (VEMs) are controlled by a VSM through the <a href="https://blog.ipspace.net/2011/08/vlans-used-by-nexus-1000v.html">control VLAN</a>, all the configuration is centralized on the VSM (where you can use <strong>show running </strong>to look at it without getting the carpal tunnel syndrome navigating the GUI); life is good.</p>
<p>Next, an ESX host reloads. The VEM module is loaded into the VMware kernel during the startup process, and tries to contact the VSM ... but it can’t. The network interfaces are not operational; the switch is waiting for the LACP negotiation to finish and VSM won’t even start the LACP negotiation until it’s configured to do so by the VSM.</p>
<p>There are two solutions to this problem:</p>
<p><strong>Build an out-of-band control network</strong>. Install additional NICs in the ESX host and use them for control traffic (communication with vCenter and VSM). Obviously you’d need two additional NICs for redundancy. Not a big deal if your hardware supports <a href="https://blog.ipspace.net/2011/06/vn-tag8021qbh-basics.html">virtual NICs</a> (like Cisco UCS); in most other cases installing two extra NICs (and consuming two more switch ports per server) just to get the management traffic going doesn’t sound attractive if you’re on the buying side.</p>
<p><strong>Make </strong><strong>the switching element </strong><strong>self-sufficient</strong>. This is exactly what Cisco did with LACP offload. Once you configure ESX host NICs in a port channel, VSM stores the LACP configuration in the local VEM settings. As part of the LACP offload functionality, the LACP code was ported to VEM module, allowing VEM to complete LACP negotiation with the upstream physical switch without VSM involvement (without LACP offload, all LACP packets are forwarded to the VSM through the packet VLAN and processed by the VSM).</p>
<h4>Is this a Cisco-specific problem?</h4><p>Absolutely not. LACP offload is just a simple manifestation of a fundamental problem well-known to operators of ATM or SONET/SDH networks: it’s hard to implement distributed switching architecture with central controller (like Nexus 1000V VSM or OpenFlow controller) without having completely independent out-of-band control network or at least some local intelligence in the switching elements – yet another “trivial” detail that’s usually glossed over in OpenFlow discussions.</p>
<h4>Even more information</h4><p>You’ll find big-picture perspective as well as in-depth discussions of various data center and network virtualization technologies in <a href="https://www.ipspace.net/Data_Center_3.0_for_Networking_Engineers">Data Center 3.0 for Networking Engineers</a> and <a href="https://www.ipspace.net/VMnet">VMware Networking Deep Dive</a> webinars.</p>

