---
url: /2011/09/responsible-generation-of-bgp-default.html
title: "Responsible generation of BGP default route"
date: "2011-09-16T07:14:00.000+02:00"
tags: [ BGP ]
---

<p>Chris sent me the following question a while ago:</p>
<blockquote class="cite">I've got a full Internet BGP table, and want to <span class="emphasis">responsibly</span> send a default route to a downstream AS. It's the "responsibly" part that's got me frustrated: How can I judge whether the internet is working and make the origination of the default conditional on that?</blockquote>
<p>He’d already figured out the <strong>neighbor default-originate route-map </strong>command, but wanted to check for more generic conditions than the presence of one or more prefixes in the IP routing table.<!--more--></p>
<p>Let’s start with the easy part: conditional origination of a BGP default route. If you attach a route map to the <strong>neighbor default-originate </strong>router configuration command then the default route will be sent to the specified neighbor only when the configured route map matches at least one prefix in the <em>IP routing table</em>. The catch is in the “<em>match in the IP routing table</em>” part – you cannot use any of the BGP attributes as matching criteria in the route map.</p>
<p>Here’s a simple example: if the IP prefix 10.255.255.7/32 is in the IP routing table, the BGP default route will be sent to BGP neighbor 10.0.7.9. I’m using a loopback interface to generate the host route; you could easily create a <a href="https://blog.ipspace.net/2011/09/shut-down-bgp-session-based-on-tracked.html">track-object-based static route to <em>null 0</em></a><em> </em>and use EEM (or any other mechanism) to change the state of the track object.</p>
<pre class="code">interface Loopback202<br/> ip address 10.255.255.7 255.255.255.255<br/>!<br/>router bgp 65000<br/> neighbor 10.0.7.9 remote-as 65100<br/> neighbor 10.0.7.9 default-originate route-map CheckDefault<br/>!<br/>ip prefix-list CheckDefault seq 5 permit 10.255.255.7/32<br/>!<br/>route-map CheckDefault permit 10<br/> match ip address prefix-list CheckDefault</pre><p>Chris already had a great idea how to solve the problem:</p>
<blockquote class="cite">I'd really like to use that sort of construct to match AS-paths: If I see ASes belonging to Google, Facebook, etc, then that's probably a good sign. </blockquote>
<p>There’s a way to check whether paths from a certain AS are in the BGP table without listing the whole table – the <strong>show ip bgp paths </strong>command. The AS paths are stored in a hash table (to save memory) and this <strong>show</strong> command dumps the AS paths table without walking through the whole 350.000 routes (or whatever the BGP table size might be when you read this article). </p>
<p>You can use the <strong>show ip bgp paths </strong>command in an EEM applet combined with an output filter matching individual AS numbers you’re interested in to change the state of a track object (and thus influence the IP routing table). </p>
<p class="note">You might find a few useful EEM programming tricks in <a href="http://wiki.nil.com/Report_interface_loss_based_on_OSPF_neighbor_loss">this applet</a> and <a href="http://wiki.nil.com/Regular_expressions_in_Embedded_Event_Manager_applets">this article</a>.</p>
<p>For example, you could use <strong>show ip bgp paths | include _(32934|13413)_ </strong>to display paths containing Facebook’s or Twitter’s AS (two most important parts of the Internet in some people’s opinion) in your BGP table and check for the presence of ‘0x’ string (which is always present in a non-empty <strong>show ip bgp paths </strong>printout).</p>
<p>However, even the <strong>show ip bgp paths </strong>command burns a lot of unnecessary CPU cycles which you might need for more useful things on your PE-routers. It’s best to offload the Internet connectivity test to a central server; you can do it on your route reflector or you could deploy a <a href="http://wiki.nil.com/Installing_and_running_Quagga">Quagga (or equivalent) BGP daemon</a>, check the BGP tables there, and <a href="http://wiki.nil.com/Use_Quagga_to_generate_BGP_routes">insert (or revoke) a BGP prefix</a> that signals all PE-routers to send (or revoke) the BGP default route.</p>

