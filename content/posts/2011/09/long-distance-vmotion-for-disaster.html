---
title: "Long-distance vMotion for disaster avoidance? Do the math first"
date: "2011-09-30T06:43:00.000+02:00"
tags: [ Data Center,Workshop,vMotion ]
---

<p>The proponents of inter-DC layer-2 connectivity (required by long-distance vMotion) inevitably cite <em>disaster avoidance </em>(along with buzzword-bingo-winning <em>business agility</em>) as one of the primary requirements after they figure out <a href="http://blog.ioshints.info/2011/06/stretched-clusters-almost-as-good-as.html">stretched clusters might not be such a good idea</a> (and there’s no way to explain <a href="http://blog.ioshints.info/2011/04/distributed-firewalls-how-badly-do-you.html">the dangers of split subnets</a> to some people). When faced with the <em>disaster avoidance </em>“requirement”, ask them to do some basic math first.<!--more--></p>
<p>However, before starting this third-grade math exercise, let’s define <em>disaster avoidance</em>. The idea is simple: an <a href="http://en.wikipedia.org/wiki/Hurricane_Irene_(2011)">iRene</a> is approaching, you know you’ll have to shut down one of the data centers, and want to migrate the workload to another data center. Major obstacle: <a href="http://www.yellow-bricks.com/2009/09/21/long-distance-vmotion/">maximum round-trip time supported by vMotion with vSphere 4.x is 5 ms</a> (some other documents cite 200 km), extended to <a href="http://www.yellow-bricks.com/2011/08/03/vsphere-5-metro-vmotion/">10 ms in vSphere 5.x</a>. Is that enough to bring you out of harm’s way? It depends; you might want to check the disaster avoidance requirements against the distance limits first.</p>
<p>Now let’s focus on the inter-DC bandwidth. To simplify the math, assume you have two 1Gbps links (that seems to be a common inter-DC link speed these days) between your data centers.</p>
<p class="note">If you have a single link and someone starts talking about disaster avoidance, tell them to buy the second link first.</p>
<p>The inter-DC links are probably not empty (or your boss should be asking you some tough questions), so let’s say we have 1Gbps of bandwidth available for disaster avoidance-induced vMotion. Assuming perfect link utilization, no protocol overhead, and no <a href="http://blogs.vmware.com/uptime/2011/02/vmotion-whats-going-on-under-the-covers.html">repeat copies of dirty memory pages</a>, you can move a GB of RAM in 8 seconds ... or completely saturate a 1Gbps link to vacate a physical server with 256 GB of RAM in just over half an hour ... or 2 hours for a single quarter-rack UCS chassis full of <a href="http://www.cisco.com/en/US/products/ps11206/index.html">B230 M1 blade servers</a>. Obviously the moved VMs will cause <a href="http://blog.ioshints.info/2010/09/long-distance-vmotion-and-traffic.html">long-distance traffic trombones</a>, further increasing the utilization of inter-DC link and reducing effective migration rate.</p>
<p>So, the next time someone drops by with a great disaster avoidance scheme, make sure you ask the following questions (after politely listening to all the perceived business benefits):</p>
<p><strong>How much workload do we need to migrate?</strong> Remember the VM RAM utilization only tends to increase (and the few mission-critical VMs they talk about today will likely explode as soon as you implement inter-DC vMotion), so you might want to multiply today’s figures by a healthy safety margin.</p>
<p><strong>How quickly do we need to evacuate the data center?</strong> Don’t forget that this business objective includes the time required for all preparatory and cleanup operations, including fixing the storage configuration and IP routing at the end of the migration.</p>
<p><strong>How often do you think we’ll do that?</strong> Of course the answer will be “we don’t know” but good disaster recovery planners should always know whether they’re trying to protect the assets against frequently recurring events (like yearly floods) or <a href="http://en.wikipedia.org/wiki/Hundred_year_flood">100-year events</a>.</p>
<p>From the answers to these questions, you can compute the extra bandwidth needed to migrate the workload. Add another safety margin for protocol overhead and repeat copies. 20-30% seems reasonable, but you might get way more repeat copies if you move large VMs over low-speed links; if you disagree, please add your comment.</p>
<p>Next, investigate how much spare capacity you have on the inter-DC links during the peak period (unless someone gives you 48 hours to evacuate the data center, you have to assume the worst-case scenario). Subtract that from the required migration bandwidth. Now you know how much extra bandwidth you need to support the disaster avoidance solution.</p>
<p>Last step: ask your service provider for a quote and multiply incremental monthly costs by the expected period between disaster avoidance events (if you want to be extra fancy, compute the <a href="http://en.wikipedia.org/wiki/Time_value_of_money#Present_value_of_a_perpetuity">present value of a perpetual expense</a>). </p>
<p class="info">A simplified data point: present value of a $10,000 perpetual monthly expense is just over one and a quarter million dollars ($1,254,054 to be precise) assuming 10% discount rate.</p>
<p>The present value of the future WAN link expenses is the minimum implementation cost of the disaster avoidance idea; add the additional equipment/licensing expenses you need to support it (for example, OTV licenses for Nexus 7000) and the costs caused by increased operational complexity. Icing on the cake: add the opportunity cost of a once-in-a-decade two-DC meltdown caused by a broadcast storm or a bridging loop.</p>
<p>Expected final result: the disaster avoidance idea just might lose a bit of its luster after having to face the real-life implementation costs. Disagree? Please write a comment.</p>
<p class="more">I would like to thank Jeremy Filliben, Matthew Norwood and Ethan Banks who helped me verify the basic assumptions of this blog post.</p>
<h4>More information</h4><p>You’ll find a long list of L2 DCI caveats and descriptions of major applicable technologies (including VPLS, OTV, vPC/VSS and F5’s EtherIP) in my <a href="http://www.ioshints.info/DCI">Data Center Interconnects</a> webinar (<a href="http://www.ioshints.info/Recordings?code=DCI">recording</a>). They might come handy if someone forces you to implement layer-2 inter-DC link.</p>
<p>You’ll find big-picture perspective as well as in-depth discussions of various data center and network virtualization technologies in two other webinars: <a href="http://www.ioshints.info/Data_Center_3.0_for_Networking_Engineers">Data Center 3.0 for Networking Engineers</a> (<a href="http://www.ioshints.info/Recordings?code=DC30">recording</a>) and <a href="http://www.ioshints.info/VMnet">VMware Networking Deep Dive</a> (<a href="http://www.ioshints.info/Recordings?code=VMnet">recording</a>). </p>
<p>All three webinars are also available as part of the <a href="http://www.ioshints.info/Subscription_to_ioshints_webinars">yearly subscription</a> and as a stand-alone <a href="http://www.ioshints.info/Data_Center_trilogy">Data Center Trilogy</a>.</p>

