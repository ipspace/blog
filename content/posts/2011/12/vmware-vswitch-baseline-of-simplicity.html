---
date: 2011-12-01T07:09:00.000+01:00
tags:
- switching
- workshop
- cloud
- virtualization
title: VMware vSwitch – the baseline of simplicity
url: /2011/12/vmware-vswitch-baseline-of-simplicity.html
---

<p>If you’re looking for a simple virtual switch, look no further than VMware’s venerable vSwitch. It runs very few control protocols (just CDP or LLDP, no STP or LACP), has no dynamic MAC learning, and only a few knobs and moving parts – ideal for simple deployments. Of course you have to pay for all that ease-of-use: designing a scalable vSwitch-based solution is tough (but then it all depends on <a href="https://blog.ipspace.net/2011/11/virtual-switches-from-simple-to.html">what kind of environment you’re building</a>).<!--more--></p>
<h4>How did it all start?</h4><p>As always, there’s a bit of a history there. Like many other disruptive technologies (including Netware and Windows networking), VMware entered the enterprise networks “under the radar” – geeks playing with it and implementing totally undercover solutions. </p>
<p>It was important in those days to be able to connect an ESX host to the network with minimum disruption (even if you had sub-zero networking skills). The decision to <a href="https://blog.ipspace.net/2010/11/vmware-virtual-switch-no-need-for-stp.html">avoid STP and implement split-horizon switching</a> made perfect sense; running STP in an ESX host would get you banned in a microsecond. vSwitch is also robust enough that you can connect it to a network that was “designed” by someone who got all his networking skillz through Linksys Web UI … and it would still work.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/12/s1600-poni.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="240" src="/2011/12/s320-poni.png" width="320"/></a><br/><span style="font-size: 90%">vSwitch is like the bike I had as a kid: simple, robust and<br/>virtually indestructible ... but it didn't get you very far.</span></div>
<h4>The growing pains</h4><p>In the meantime, VMware has grown from a tiny disruptive startup to a major IT company and THE major virtualization vendor (literally created that market), and became part of almost every virtualized data center … but the <a href="https://blog.ipspace.net/2011/07/vsphere-50-new-networking-features.html">vSwitch has failed to grow up</a>. </p>
<p>vSwitch got some scalability enhancements (distributed vSwitch), but only on the management plane; apart from a few features that are enabled in vDS and not in vSwitch, the two products use the same control/data plane. There’s some basic QoS (per-VM policing and 802.1p marking) and some support for network management and troubleshooting (Netflow, SPAN, remote SPAN). Still no STP nor LACP.</p>
<p><a href="https://blog.ipspace.net/2011/01/vmware-vswitch-does-not-support-lacp.html">Lack of LACP</a> is a particularly tough nut. Once you try to do anything a bit more complex, like proper per-session load balancing, or <a href="https://blog.ipspace.net/2011/01/vswitch-in-multi-chassis-link.html">achieving optimum traffic flow in a MLAG environment</a>, you have to carefully configure vSwitch and pSwitch just right. You can eventually squeeze the vSwitch into those spots, and get it to work, but it will definitely be a tight fit, and it won’t be nearly as reliable as it could have been were vSwitch to support proper control-plane protocols.</p>
<h4>Is it just VMware?</h4><p>Definitely not. Other virtual switches <a href="http://www.virtualizationmatrix.com/matrix.php#Networking">fare no better</a>, and the Open vSwitch is no<a name="_GoBack"></a> more intelligent without an external OpenFlow controller. At the moment, VMware’s vSwitch is probably still the most intelligent vSwitch shipping with a hypervisor.</p>
<p class="note">The only reason XenServer supports LACP is because LACP support is embedded in the underlying Linux kernel … but even then the <a href="http://support.citrix.com/article/CTX124421">LACP-based bonding is not officially supported</a>.</p>
<h4>Multi-tenant support</h4><p>vSwitch’s multi-tenant support reflects its typical use case (virtualized enterprise data center). The only virtual networking technology it supports is 802.1Q-based VLANs (using a single VLAN tag), limiting you to 4000 logical networks (assuming the physical switches can support that many VLANs). There’s also no communication between the virtual switches and adjacent physical switches – a vSwitch embedded in a vSphere host cannot tell the adjacent physical switch which VLANs it needs.</p>
<p class="note"><a href="https://blog.ipspace.net/2011/04/vcloud-director-networking.html">vCDNI</a> and <a href="https://blog.ipspace.net/search?q=VXLAN">VXLAN</a> (both scale much better and offer wider range of logical networks) are not part of vSwitch. vCDNI is an add-on module using VMsafe API and VXLAN currently exists only within Nexus 1000V.</p>
<p>On top of all that, vSwitch assumes “friends and family” environment. BPDUs generated by a VM can <a href="https://blog.ipspace.net/2011/11/virtual-switches-need-bpdu-guard.html">easily escape into the wild and trigger BPDU guard</a> on upstream switches; it’s also possible to send <a href="http://communities.vmware.com/message/1320716">tagged packets from VMs into the network</a> (implementing VLAN hopping would take a few extra steps and a misconfigured physical network), and there’s no per-VM broadcast storm control. Using a vSwitch in a potentially hostile cloud environment is a risky proposition.</p>
<h4>Scalability? No thanks.</h4><p>There is an easy way to deploy vSwitch in the worst-case “any VM can be started on any hypervisor host” scenario – configure all VM-supporting VLANs on all switch-to-server access trunks, effectively turning the whole data center into a single broadcast domain. As <a href="https://blog.ipspace.net/2011/07/hypervisors-use-promiscuous-nic-mode.html">hypervisor NICs operate in promiscuous mode</a>, every hypervisor receives and processes every flooded packet, regardless of its VLAN and its actual target.</p>
<div class="separator" style="clear: both; text-align: center"><a href="http://www.flickr.com/photos/figcookies/248108138/" title="Bikes!!! by Miss Mita, on Flickr"><img src="http://farm1.staticflickr.com/94/248108138_2e7d78d8bd.jpg" width="320"/></a><br/><span style="font-size: 90%">Who says you can't scale bikes as a public transport?<br/>It might get messy, though ...</span></div>
<p>There are three factors that limit the scalability of such a design:</p>
<p><strong>Reliance on bridging</strong>, which usually implies reliance on STP. STP is not necessarily a limiting factor; you can create bridged networks with thousands of ports without having a single blocked link if you have a well-designed spine &amp; leaf architecture, and large core switches. Alternatively, you could trust emerging technologies like FabricPath or QFabric.</p>
<p><strong>Single broadcast domain</strong>. I don’t want to be the one telling you how many hosts you can have in a broadcast domain, let’s turn to <a href="http://tools.ietf.org/html/rfc5556">TRILL Problem and Applicability Statement (RFC 5556)</a>. Its <a href="http://tools.ietf.org/html/rfc5556#section-2.6">section 2.6 (Problems Not Addressed)</a> is very clear: a single bridged LAN supports around 1000 hosts.  Due to physical NICs being in promiscuous mode and all VLANs being enabled on all access trunks, VLAN segmentation doesn’t help us; effectively we still have a single broadcast domain. We’re thus talking about ~1000 VMs (regardless of the number of VLANs they reside in).</p>
<p class="note">I’m positive I’ll get comments along the lines of “I’m running 100.000 VMs in a single bridged domain and they work just fine”. <a href="http://en.wikipedia.org/wiki/Free_solo_climbing">Free soloing</a> (rock climbing with zero protection) also works great until the first fall. Seriously, I would appreciate all data points you're willing to share in the comments.</p>
<p><strong>Number of VLANs.</strong> Although vSphere supports the full 12-bit VLAN range, many physical switches don’t. The number of VLANs doesn’t matter in a traditional virtualized data center, with only a few (or maybe a few tens) security zones, but it’s a major showstopper in a public cloud deployment. Try telling your boss that your solution supports only around 1000 customers (assuming each customer wants to have a few virtual subnets) … after replacing all the switches you bought last year.</p>
<h4>Conclusions</h4><p>The vSwitch is either the best thing ever invented (if you’re running a small data center with a few VLANs) or a major showstopper (if you’re building an IaaS cloud). Use it in environments it was designed for and you’ll have a fantastically robust solution.</p>
<p>There are also a few things you can do in the physical network to improve the scalability of vSwitch-based networks; I’ll describe them in the next post.</p>
<h4>More information</h4><p>You’ll find a lot more information about virtualized networking in my webinars:</p>
<ul class="ListParagraph"><li>Start with <a href="http://www.ipspace.net/Introduction_to_Virtualized_Networking">Introduction to Virtualized Networking</a>;</li>
<li>Learn everything there is to know about VMware’s vSwitch and other VMware-related networking solutions in <a href="http://www.ipspace.net/VMware_Networking_Deep_Dive">VMware Networking Deep Dive</a>.</li>
<li>Cloud networking-specific topics are the focus of <a href="http://www.ipspace.net/Cloud_Computing_Networking:_Under_the_Hood">Cloud Computing Networking – Under the Hood</a> webinar.</li>
<li>Generic data center technologies and designs are described in <a href="http://www.ipspace.net/Data_Center_3.0_for_Networking_Engineers">Data Center 3.0 for Networking Engineer</a>.</li>
<li>You’ll find large-scale bridged network designs (including leaf &amp; spine and Clos network architectures) in the <a href="http://www.ipspace.net/Data_Center_Fabrics">Data Center Fabric Architectures</a> webinar. </li>
</ul>
<p>And don’t forget: you get access to all these webinars (and numerous others) if you buy the <a href="http://www.ipspace.net/Subscription">yearly subscription</a>.</p>

