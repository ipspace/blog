---
url: /2011/12/ipv6-multihoming-without-nat-problem.html
title: "IPv6 multihoming without NAT: the problem"
date: "2011-12-13T06:29:00.000+01:00"
---

<p>Every time I write about <a href="https://blog.ipspace.net/2010/12/small-site-multihoming-in-ipv6-mission.html">IPv6 multihoming issues</a> and the <a href="https://blog.ipspace.net/2011/12/we-just-might-need-nat66.html">need for NPT66</a>, I get a comment or two saying “but I thought this is already part of IPv6 stack – can’t you have two or more IPv6 addresses on the same interface?” The commentators are right, you can have multiple IPv6 addresses on the same interface; the problem is: which one do you choose for outgoing sessions. </p>
<p>The source address selection rules are specified in <a href="http://tools.ietf.org/html/rfc3484">RFC 3484</a> (Greg translated that RFC into an <a href="http://etherealmind.com/ipv6-which-address-multiple-ipv6-address-default-address-selection/">easy-to-consume format</a> a while ago), but they are not very helpful as they cannot be influenced by the CPE router. Let’s look at the details.<!--more--></p>
<h4>Phase 1 – single ISP connection</h4><p>We have a simple SMB network: a single CPE router connected to one ISP and a host sitting behind the router (ignore the PE-B part for the moment). CPE router asks ISPA for a delegated prefix (using IA_PD option in DHCPv6) and uses part of that prefix to address its LAN interface.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/12/s1600-IPv6MH_PD1.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="/2011/12/s520-IPv6MH_PD1.png"/></a></div>
<p>This is how you configure the CPE router if you’re using Cisco IOS:</p>
<p class="codecaption">Simple CPE router configuration</p>
<pre class="code">ipv6 unicast-routing<br/>!<br/>interface FastEthernet0/0<br/> description Inside interface<br/> ipv6 address ISPA ::1/64<br/> ipv6 nd router-preference High<br/> ipv6 nd ra interval 10<br/>!<br/>interface FastEthernet1/0<br/> description ISP A uplink<br/> ipv6 address autoconfig default<br/> ipv6 dhcp client pd ISPA</pre><p class="note">The CPE router configuration is not complete; you would also need DHCPv6 server on the inside interface to pass DNS server IPv6 address to the clients. A complete (and tested) configuration is included in the materials you get with the <a href="http://www.ipspace.net/Building_IPv6_Service_Provider_Core">Building IPv6 Service Provider Core</a> webinar.</p>
<p>The IPv6 client receives RA messages sent by the CPE and creates an IPv6 address from the advertised /64 prefix on its LAN interface:</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/12/s1600-IPv6MH_RA1.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="/2011/12/s520-IPv6MH_RA1.png"/></a></div>
<p>The client is now able to communicate with the IPv6 Internet. Problem solved ... until someone figures out a single upstream connection is a single point of failure and orders a second Internet service.</p>
<h4>Phase 2 – Two ISP uplinks</h4><p>The second ISP uplink is configured almost identically to the first. Since you cannot have two RA-generated default routes in Cisco IOS release 15.1M, I had to use a floating static default route and hard-code the next-hop router’s IPv6 address in it.</p>
<p class="codecaption">Simple CPE router configuration – two uplinks</p>
<pre class="code">ipv6 unicast-routing<br/>!<br/>interface FastEthernet0/0<br/> description Inside interface<br/> ipv6 address ISPA ::1/64<br/> ipv6 address ISPB ::1/64<br/> ipv6 nd router-preference High<br/> ipv6 nd ra interval 10<br/>!<br/>interface FastEthernet1/0<br/> description ISP A uplink<br/> ipv6 address autoconfig default<br/> ipv6 dhcp client pd ISPA<br/>!<br/>interface FastEthernet1/1<br/> description ISP B uplink<br/> ipv6 address autoconfig<br/> ipv6 dhcp client pd ISPB<br/>!<br/>ipv6 route ::/0 FastEthernet1/1 FE80::2 30</pre><p>After the CPE router receives a delegated prefix from PE-B, it adds a /64 prefix from that address range to its LAN interface and starts advertising two /64 prefixes (one from each ISP) in its RA messages. The IPv6 client creates a second IPv6 address from the second advertised prefix – it now has two IPv6 addresses on its LAN interface.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/12/s1600-IPv6MH_2.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="/2011/12/s520-IPv6MH_2.png"/></a></div>
<h4>The Problem</h4><p>There are numerous problems associated with this setup, some of them architectural, many more due to suboptimal implementations, omissions, or strict adherence to RFCs in host and router stacks.</p>
<p>The easy one first: when an IPv6 client with multiple IPv6 addresses starts a new session, it chooses a source address that best matches the destination address (ULA address for ULA destination, global address for global destination ...) without any knowledge of the network topology.</p>
<p class="note"><a href="http://tools.ietf.org/html/draft-ietf-6man-addr-select-opt-01">Distributing Address Selection Policy using DHCPv6</a> draft describes a potential solution ... but it has to be implemented in both routers and hosts, and it’s implemented nowhere at this moment. </p>
<p>For example, when the IPv6 client in our small network connects to the outside world, it might choose a source IPv6 address assigned by the wrong ISP. </p>
<p class="note">You can see the source address used by the client with the <strong>netstat -n -p tcpv6 </strong>(Windows) or <strong>netstat -n -f inet6 -p tcp </strong>(Linux/OSX) command. It seems that Windows picks the lowest IPv6 address while OSX picks the oldest IPv6 address when all interface IPv6 addresses are equivalent according to RFC 3484 rules.</p>
<p>The best that could happen is asymmetrical routing:</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/12/s1600-IPv6MH_Asym.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="/2011/12/s520-IPv6MH_Asym.png"/></a></div>
<p>In some rare cases, the ISP actually performs RPF check and drops the packet with an unexpected source IPv6 address.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/12/s1600-IPv6MH_RPF.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img src="/2011/12/s520-IPv6MH_RPF.png"/></a></div>
<p>The whole situation might have been survivable were this the only problem to solve (and the lack of RPF checks on the ISP side causes people to claim that IPv6 multihoming works). Unfortunately, there are many others, for example:</p>
<ul class="ListParagraph"><li>When the CPE router (Cisco IOS router running 15.1(4)M) loses an uplink, it does not stop advertising the delegated prefix it received through that uplink (implementation issue). One of the client IPv6 addresses is thus completely invalid without client being aware of it.</li>
<li>If you clear the delegated prefix manually (or with an EEM applet) on the CPE router, it stops advertising the prefix in its RA messages ... but the prefix remains valid on the IPv6 hosts until it expires (architectural issue). Prefix expiration is based on its <em>preferred lifetime</em>, which is derived straight from DHCPv6 prefix delegation and is usually measured in weeks.</li>
<li>It might be possible to reduce the <em>preferred lifetime </em>in the RA messages to a very low number, but the lifetime of an interface prefix based on a delegated prefix is not configurable (implementation issue).</li>
</ul>
<p class="warn">Please don’t try to tell me that the whole thing works if you use two CPE routers. It might work once the <a href="http://tools.ietf.org/html/draft-ietf-6man-rfc3484-revise-03#section-2.3">host stacks implement RFC 3484 bis</a>, but we’re not there yet (and I’ll describe that scenario in an upcoming blog post).</p>
<h4>More information and tested router configurations</h4><p>Various IPv6 access- and core network designs and <a href="http://www.ipspace.net/Building_IPv6_Service_Provider_Core#Router_configurations">numerous sample configurations</a> are included in the <a href="http://www.ipspace.net/Building_IPv6_Service_Provider_Core">Building IPv6 Service Provider Core</a> webinar (currently available <a href="http://www.ipspace.net/Recordings?code=IPv6SPCore">only as a recording</a>). </p>
<h4>Do your own tests</h4><p>If you want to test how your hosts behave in this scenario or try to fix my router configurations, use these configurations as a starting point:</p>
<p class="codecaption">CPE router configuration (cleaned up)</p>
<pre class="code">version 15.1<br/>service timestamps debug datetime msec<br/>service timestamps log datetime msec<br/>no service password-encryption<br/>!<br/>hostname CPE<br/>!<br/>ipv6 unicast-routing<br/>ipv6 cef<br/>!<br/>interface FastEthernet0/0<br/> description Inside interface<br/> ipv6 address ISPA ::1/64<br/> ipv6 address ISPB ::1/64<br/> ipv6 nd router-preference High<br/> ipv6 nd ra interval 10<br/>!<br/>interface FastEthernet1/0<br/> description ISP A uplink<br/> ipv6 address autoconfig default<br/> ipv6 dhcp client pd ISPA<br/>!<br/>interface FastEthernet1/1<br/> description ISP B uplink<br/> ipv6 address autoconfig<br/> ipv6 dhcp client pd ISPB<br/>!<br/>ipv6 route ::/0 FastEthernet1/1 FE80::2 30<br/>!<br/>line con 0<br/> exec-timeout 0 0<br/> privilege level 15<br/>line vty 0 4<br/> exec-timeout 0 0<br/> privilege level 15<br/> no login<br/>!<br/>ntp logging<br/>end</pre><p class="codecaption">PE-router configuration (cleaned up)</p>
<pre class="code">hostname PE<br/>!<br/>ipv6 unicast-routing<br/>ipv6 cef<br/>ipv6 dhcp pool ISPA<br/> prefix-delegation pool ISPA<br/>!<br/>ipv6 dhcp pool ISPB<br/> prefix-delegation pool ISPB<br/>!<br/>interface Loopback0<br/> ipv6 address 2001:DB8:CAFE::1/64<br/>!<br/>interface FastEthernet0/0<br/> description ISP A interface<br/> ipv6 address FE80::1 link-local<br/> ipv6 address 2001:DB8:1:FF01::1/64<br/> ipv6 dhcp server ISPA<br/>!<br/>interface FastEthernet0/1<br/> description ISP B interface<br/> <br/> ipv6 address FE80::2 link-local<br/> ipv6 address 2001:DB8:7:FF01::1/64<br/> ipv6 dhcp server ISPB<br/>!<br/>ipv6 local pool ISPA 2001:DB8:1::/49 60<br/>ipv6 local pool ISPB 2001:DB8:7::/49 60<br/>!<br/>line con 0<br/> exec-timeout 0 0<br/> privilege level 15<br/>line vty 0 4<br/> exec-timeout 0 0<br/> privilege level 15<br/> no login<br/>!<br/>ntp logging<br/>end</pre>

