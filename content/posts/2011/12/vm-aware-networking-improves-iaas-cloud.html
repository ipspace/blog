---
title: "VM-aware Networking Improves IaaS Cloud Scalability"
date: "2011-12-05T06:26:00.000+01:00"
tags: [ switching,Workshop,cloud,virtualization ]
---

<p>In the <a href="http://blog.ioshints.info/2011/12/vmware-vswitch-baseline-of-simplicity.html"><em>VMware vSwitch – the baseline of simplicity</em></a> post I described simple layer-2 switches offered by most hypervisor vendors and the scalability challenges you face when trying to build large-scale solutions with them. You can solve at least one of the scalability issues pretty easily: VM-aware networking solutions available from most data center networking vendors dynamically adjust the list of VLANs on server-to-switch links.<!--more--></p>
<h4>What’s the problem</h4><p>Let’s briefly revisit the problem: vSwitches have almost no control plane. A vSwitch thus cannot tell the adjacent physical switches what VLANs it needs to support VMs connected to the vSwitch. Lacking that information, you have to configure a wide range of VLANs on the server-facing ports on the physical switch to allow free movement of VMs between the servers (hypervisor hosts).</p>
<p>The following diagram illustrates the problem: </p>
<ul class="ListParagraph"><li>Two tenants are running in a vSphere cluster (ESX-A and ESX-B);</li>
<li><em>Red </em>tenant is using VLAN 100, <em>Blue </em>tenant is using VLAN 200;</li>
<li>With the VM distribution shown in the diagram, ESX-A needs access to VLAN 100; ESX-B needs access to VLAN 200.</li>
<li>As the networking gear cannot predict how the VMs will move between vSphere hosts, you have to configure both VLANs on all server-facing ports (Ge1/0 on SW-1 and Ge2/3 on SW-2) as well as on all inter-switch links.</li>
</ul>
<p>The list of VLANs configured on the server-facing ports of the access-layer switches thus commonly includes completely unnecessary VLANs.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-Q9F5g84YFjI/TtpNxPtwMoI/AAAAAAAAEkk/w_APXqeFkCA/s1600/VLANRange.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="320" width="284" src="http://1.bp.blogspot.com/-Q9F5g84YFjI/TtpNxPtwMoI/AAAAAAAAEkk/w_APXqeFkCA/s320/VLANRange.png" /></a></div>
<p>The wide range of VLANs configured on all server-facing ports causes indiscriminate flooding of broadcasts, multicasts and unknown unicasts to all the servers, even when those packets are not needed by the servers (because the VLAN on which they’re flooded is not active in the server). The flooded packets increase the utilization of the server uplinks; their processing (and dropping) also increases the CPU load.</p>
<h4>The standard solution</h4><p><a href="http://blog.ioshints.info/2011/05/edge-virtual-bridging-evb-8021qbg-eases.html">VSI Discovery Protocol (VDP)</a>, part of Edge Virtual Bridging (EVB, 802.1Qbg) would solve that problem, but it’s not implemented in any virtual switch. Consequently, there’s no support in the physical switches, although <a href="http://h30499.www3.hp.com/hpeb/attachments/hpeb/bladesblog00/130/1/VEPA-EVB%20Industry%20Whitepaper.pdf">HP</a> and <a href="http://blog.ioshints.info/2011/04/new-data-center-switches-from-force10.html">Force10</a> keep promising EVB support; HP for more than a year. </p>
<p>The closest we’ve ever got to a shipping EVB-like product is <a href="http://blog.ioshints.info/2011/08/vm-fex-how-convoluted-can-you-get.html">Cisco’s VM-FEX</a>. The Virtual Ethernet Module (VEM) running within the vSphere kernel uses a protocol similar to VDP to communicate its VLAN/interface needs with the UCS manager.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="http://en.wikipedia.org/wiki/Loch_Ness_Monster"><img border="0" height="215" width="232" src="http://4.bp.blogspot.com/-28F-Nu820pk/TtpN7p_BpoI/AAAAAAAAEkw/SC2gxPGwRJ4/s320/Lochnessmonster.jpg" /></a><span>It seems more people have seen Nessie than an EVB-compliant vSwitch</span></div>
<h4>The real-world solutions</h4><p>Faced with the lack of EVB support (or any other similar control-plane protocol) in the vSwitches, the networking vendors implemented a variety of kludges. Some of them are implemented in the access-layer switches (Arista’s <a href="http://blog.ioshints.info/2011/06/automatic-edge-vlan-provisioning-with.html">VM Tracer</a>, Force10’s HyperLink, Brocade’s vCenter Integration), others in network management software (Juniper’s Junos Space Virtual Control and ALU’s OmniVista Virtual Machine Monitor). </p>
<p class="note">Have I missed a VM-aware networking solution? Please write a comment ... and note that I haven’t forgotten VM-FEX; it uses a <a href="http://blog.ioshints.info/2011/08/vm-fex-how-convoluted-can-you-get.html">completely different architecture</a>.</p>
<p>In all cases, a VM-aware solution has to discover the network topology first. Almost all solutions send CDP packets from access-layer switches and use CDP listeners in the vSphere hosts to discover host-to-switch connectivity. The CDP information gathered by vSphere hosts is usually extracted from vCenter using VMware’s API (yes, you usually have to talk to the vCenter if you want to communicate with the VMware environment). </p>
<div class="separator" style="clear: both; text-align: center;"><img border="0" height="320" width="320" src="http://3.bp.blogspot.com/-w3jFEOw0lRU/TtpPSXKN2cI/AAAAAAAAEk8/o0lYpxSWAMg/s320/godfather2.jpg" /><span>Ah, those pesky networking vendors. They want to<br />talk to someone, they have to talk to me.</span></div>
<p>Have you noticed I mentioned VMware API in the previous paragraph? Good. Because no hypervisor vendor bothered to implement a standard protocol, the networking vendors have to implement a different solution for each hypervisor. Almost all of the VM-aware solutions support vSphere/vCenter, a few vendors claim they also support Xen, KVM or Hyper-V, and I haven’t seen anyone supporting anything beyond the big four.</p>
<p>After the access-layer topology has been discovered, the VM-aware solutions track VM movements between hypervisor hosts and dynamically adjust the VLAN range on access-layer switch ports. Ideally you’d combine that with MVRP in the network core to further trim the VLANs, but only a few vendors implemented MVRP (and supposedly only a few customers are using it). <a href="http://blog.ioshints.info/search?q=qfabric">QFabric</a> is a shining (proprietary) exception: because its architecture mandates <a href="http://blog.ioshints.info/2011/09/qfabric-part-3-forwarding.html">single ingress lookup which should result in a list of egress ports</a>, it also performs optimum VLAN flooding.</p>
<p class="note">Have I missed another MVRP-like solution? Please write a comment!</p>
<h4>Does it matter?</h4><p>Without VM-aware networking you have to configure every VM-supporting VLAN on every switch-facing port, reducing the whole data center network to a single broadcast domain (effectively a single VLAN from the scalability perspective). If your data center has just a few large VLANs, you probably don’t care (most hypervisor hosts have to see most of the flooded VLAN traffic anyway); if you have a large number of small VLANs, VM-aware networking makes perfect sense.</p>
<p>Using the rough estimates from the <a href="http://tools.ietf.org/html/rfc5556#section-2.6">RFC 5556 (section 2.6)</a>, implementing VM-aware networking moves us from <em>around 1,000 end-hosts in a single bridged LAN</em><em> </em>to <em>100,000 end-hosts inside 1,000 VLANs</em>. While I wouldn’t run 100,000 VMs in a purely bridged environment, the scalability improvements you can gain with VM-aware networking are definitely worth the investment.</p>
<h4>More information</h4><p>You’ll find a lot more information about virtualized networking in my webinars:</p>
<ul class="ListParagraph"><li>Start with <a href="http://www.ipspace.net/Introduction_to_Virtualized_Networking">Introduction to Virtualized Networking</a>;</li>
<li>Learn everything there is to know about VMware’s vSwitch and other VMware-related networking solutions in <a href="http://www.ipspace.net/VMware_Networking_Deep_Dive">VMware Networking Deep Dive</a>.</li>
<li>Cloud networking-specific topics are the focus of <a href="http://www.ipspace.net/Cloud_Computing_Networking:_Under_the_Hood">Cloud Computing Networking – Under the Hood</a> webinar.</li>
<li>Generic data center technologies and designs are described in <a href="http://www.ipspace.net/Data_Center_3.0_for_Networking_Engineers">Data Center 3.0 for Networking Engineer</a>.</li>
<li>You’ll find large-scale bridged network designs (including leaf &amp; spine and Clos network architectures) in the <a href="http://www.ipspace.net/Data_Center_Fabrics">Data Center Fabric Architectures</a> webinar. </li>
</ul>
<p>And don’t forget: you get access to all these webinars (and numerous others) if you buy the <a href="http://www.ipspace.net/Subscription">yearly subscription</a>.</p>

