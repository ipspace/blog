---
date: 2011-12-09T06:54:00.000+01:00
tags:
- VXLAN
- switching
- workshop
- cloud
- overlay networks
- virtualization
title: Decouple virtual networking from the physical world
url: /2011/12/decouple-virtual-networking-from.html
---

<p>Isn’t it amazing that we can build the Internet, run the same web-based application on thousands of servers, give millions of people access to cloud services … and stumble badly every time we’re designing virtual networks. No surprise, by trying to keep vSwitches simple (and their R&amp;D and support costs low), the virtualization vendors violate one of the basic scalability principles: <a href="https://blog.ipspace.net/2011/05/complexity-belongs-to-network-edge.html">complexity belongs to the network edge</a>.<!--more--></p>
<h4>VLAN-based solutions</h4><p>The <a href="https://blog.ipspace.net/2011/12/vmware-vswitch-baseline-of-simplicity.html">simplest possible virtual networking technology (802.1Q-based VLANs)</a> is also the least scalable, because of its tight coupling between the virtual networking (and VMs) and the physical world.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/12/s1600-Decouple_VLAN.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="262" src="/2011/12/s320-Decouple_VLAN.png" width="320"/></a></div>
<p>VLAN-based virtual networking uses bridging (<a href="https://blog.ipspace.net/2010/07/bridging-and-routing-is-there.html">which doesn’t scale</a>), 12-bit VLAN tags (limiting you to approximately 4000 virtual segments), and expect all switches to know the MAC addresses of all VMs. You’ll get localized unknown unicast flooding if a ToR switch experiences MAC address table overflow and a massive core flooding if the same thing happens to a core switch.</p>
<p>In its simplest incarnation (every VLAN enabled on every server port on ToR switches), the VLAN-based virtual networking also causes massive flooding proportional to the total number of VMs in the network.</p>
<p><a href="https://blog.ipspace.net/2011/12/vm-aware-networking-improves-iaas-cloud.html">VM-aware networking scales better</a> (depending on the number of VLANs you have and the number of VMs in each VLAN). The core switches still need to know all VM MAC addresses, but at least the dynamic VLAN changes on the server-facing ports limit the amount of flooding on the switch-to-server links; flooding becomes proportional to the number of VLANs active in a particular hypervisor host, and the number of VMs in those VLANs.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/12/s1600-Decouple_VMaware.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="320" src="/2011/12/s320-Decouple_VMaware.png" width="232"/></a></div>
<h4>Other bridging-based solutions</h4><p><a href="https://blog.ipspace.net/2010/11/vcloud-director-hand-network-over-to.html">vCDNI</a> is the first solution that decouples at least one of the aspects of the virtual networks from the physical world. It uses MAC-in-MAC encapsulation and thus hides the VM MAC addresses from the network core. vCDNI also removes VLAN limitations, but <a href="https://blog.ipspace.net/2011/04/vcloud-director-networking.html">causes massive flooding due to its suboptimal implementation</a> – the amount of flooding is yet again proportional to the total number of VMs in the vCDNI domain.</p>
<p>Provider Backbone Bridging (PBB) or VPLS implemented in ToR switches fare better. The core network needs to know the MAC addresses (or IP loopbacks) of the ToR switches; all the other virtual networking details are hidden. </p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/12/s1600-Decouple_VPLS.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="281" src="/2011/12/s320-Decouple_VPLS.png" width="320"/></a></div>
<p>Major showstopper: dynamic provisioning of such a network is a major pain; I’m not aware of any commercial solution that would dynamically create VPLS instances (or PBB SIDs) in ToR switches based on VLAN changes in the hypervisor hosts ... and the dynamic adaptation to VLAN changes is a must if you want the network to scale.</p>
<p>While PBB or VPLS solves the core network address table issues, the MAC address table size in ToR switches cannot be reduced without dynamic VPLS/PBB instance creation. If you configure all VLANs on all ToR switches, the ToR switches have to store the MAC addresses of all VMs in the network (or risk unicast flooding after MAC address table experiences trashing).</p>
<h4>MAC-over-IP solutions</h4><p>The only proper way to decouple virtual and physical networks is to treat virtual networking like yet another application (like VoIP, iSCSI or any other “infrastructure” application). Virtual switches that can encapsulate L2 or L3 payloads in UDP (<a href="https://blog.ipspace.net/2011/08/finally-mac-over-ip-based-vcloud.html">VXLAN</a>) or GRE (NVGRE/Open vSwitch) envelopes appear as IP hosts to the network; you can use the time-tested large-scale network design techniques to build truly scalable data center networks.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/12/s1600-Decouple_VXLAN.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="175" src="/2011/12/s320-Decouple_VXLAN.png" width="320"/></a></div>
<p>However, MAC-over-IP encapsulation might not bring you to seventh heaven. VXLAN does not have a control plane and thus has to rely on IP multicast to perform flooding of virtual MAC frames. All hypervisor hosts using VXLAN have to join VXLAN-specific IP multicast groups, creating lots of (S,G) and (*,G) entries in the core network. The virtual network data plane is thus fully decoupled from the physical network, the control plane isn’t.</p>
<p>A truly scalable virtual networking solution would require no involvement from the transport IP network. Hypervisor hosts would appear as simple IP hosts to the transport network, and use only unicast IP traffic to exchange virtual network payloads; such a virtual network would use the same transport mechanisms as today’s Internet-based applications and could thus run across huge transport networks. I’m positive <a href="https://blog.ipspace.net/2011/05/scaling-iaas-network-infrastructure.html">Amazon has such a solution</a>, and it seems <a href="https://blog.ipspace.net/2011/10/what-is-nicira-really-up-to.html">Nicira’s Network Virtualization Platform</a> is another one (but I’ll believe that when I see it).</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/12/s1600-Decouple_Nicira.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="261" src="/2011/12/s320-Decouple_Nicira.png" width="320"/></a></div>
<h4>More information</h4><p>All the diagrams in this post were taken from the <a href="http://www.ipspace.net/Cloud_Computing_Networking:_Under_the_Hood">Cloud Computing Networking – Under the Hood</a> webinar (<a href="http://cloudnetworking.eventbrite.com/">register for the live session</a>) that focuses on virtual networking scalability.</p>
<p>You might also want to check <a href="http://www.ipspace.net/Introduction_to_Virtualized_Networking">Introduction to Virtual Networking</a> and <a href="http://www.ipspace.net/VMware_Networking_Deep_Dive">VMware Networking Deep Dive</a> recordings ... and don’t forget to listen to the <a href="http://packetpushers.net/show-71-openflow-sdn-vxlan-controllers-wishing/">Packet Pushers Podcast #71</a>.</p>
<p>Finally, if you’d like to have a second opinion on the scalability of your design (or any other similar topic), consider the <a href="http://www.ipspace.net/ExpertExpress">ExpertExpress</a> IaaS.</p>

