---
url: /2011/12/junos-day-one-mpls-behind-scenes.html
title: "Junos Day One: MPLS Behind The Scenes"
date: "2011-12-02T07:19:00.001+01:00"
tags: [ MPLS,Junos ]
---

<p>When I started making my first wobbling steps into the Junos MPLS world, Dan (@Johansfo) Backman took time to explain the differences between Cisco IOS and Junos MPLS implementations (and some of the reasons they are so different). This is my feeble attempt at describing what I understood he told me.<!--more--></p>
<h4>A bit of a history first</h4><p>The fundamental reason for widely different MPLS implementation is the first use case: <a href="https://blog.ipspace.net/2011/01/campfire-true-story-of-mpls.html">Cisco IOS started with <em>tag switching</em> targeted at IP-over-ATM transport</a>, where every IP prefix needs an end-to-end LSP; Junos started with layer-3 MPLS/VPNs, where you need LSPs only toward BGP next hops (or was it MPLS-TE? See the comments).</p>
<h4>MPLS in Cisco IOS</h4><p>Let’s revisit how LDP-based MPLS works in Cisco IOS and what its data structures are:</p>
<ul class="ListParagraph"><li>Every routing protocol has its own data structures (OSPF or IS-IS topology databases) and its own routing table (SPF results in OSPF or IS-IS or Routing Information Base – RIB – in BGP);</li>
<li>Routes from per-protocol routing tables are copied into the main IP routing table using <em>administrative distance </em>as the criterion to prefer routes from one routing protocol over routes from another one;</li>
<li>Fully evaluated entries from the main routing table are copied into IP forwarding table (FIB or CEF table);</li>
<li>LDP assigns a label to every non-BGP entry in the FIB, stores those labels in LFIB and in its LDP database and advertises them to LDP neighbors;</li>
<li>CEF table and LDP database are combined to find outbound labels (labels assigned to IP prefixes by next-hop routers) that are then used in CEF table (FIB) and LFIB.</li>
</ul>
<p>The following diagram illustrates the protocols, data structures and their relationships.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/12/s1600-MPLSDS_Cisco.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="/2011/12/s520-MPLSDS_Cisco.png"/></a></div>
<h4>MPLS in Junos</h4><p>Junos has a completely different approach to MPLS. Let’s start with IP routing tables:</p>
<ul class="ListParagraph"><li>Some routing protocols still have their own data structures (OSPF or IS-IS topology database), others don't (BGP and RIP).</li>
<li>There are no per-protocol IP routing tables (or BGP RIB); entries from different routing protocols are stored directly in the main IP routing table (inet.0);</li>
<li>Active routes from the IP routing table are copied into the IP forwarding table (because inet.0 serves both as IP routing table and BGP RIB, you might have inactive routes in the inet.0 table);</li>
</ul>
<p>LDP and other label distribution protocols (for example, MPLS-TE) create local labels and FEC-to-label mappings:</p>
<ul class="ListParagraph"><li>Labels received LDP neighbors are stored in the LDP database;</li>
<li>Labels received from next-hop routers are also stored in the FEC mapping table (inet.3);</li>
<li>Local LDP labels are created for all entries in the inet.3 table (thus implementing <em>ordered label distribution control</em>) and stored in the LDP database;</li>
<li>Local labels are also created for loopback interfaces (default behavior) or IP prefixes matched by the <strong>egress-policy </strong>routing policy;</li>
<li>Local-to-next-hop label mappings are stored in Label Routing Table (mpls.0) and copied into Label Forwarding Table (LFIB).</li>
</ul>
<p>Finally, Junos uses the FEC mapping table to insert outbound labels into the IP routing table (not just FIB). The FEC mapping table is (by default) used only for BGP destinations. Traffic toward BGP next hop (for example, SNMP traffic sent to a PE-router’s  loopback interface) is thus not labeled, traffic for BGP destinations using the same next hop is.</p>
<p>The interactions between OSPF, BGP, LDP, and various Junos data structures are shown in the following diagram:</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/12/s1600-MPLSDS_Junos.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="/2011/12/s520-MPLSDS_Junos.png"/></a></div>
<h4>Default behavior</h4><p>If you enable MPLS (using the default settings) in a Cisco IOS-based network, every router generates labels for all non-BGP IP prefixes, and all the traffic is labeled by the first-hop routers. </p>
<p>If you enable MPLS (yet again using default settings) in a Junos-based network, the routers generate labels only for the loopback interfaces, and label only the traffic sent toward BGP destinations reachable through loopback-based BGP next hops.</p>
<p>In a multi-vendor network, you’ll get a mixture of both behaviors: </p>
<ul class="ListParagraph"><li>Labels will be assigned to most prefixes by most routers. Once a Cisco IOS router allocates a label to an IGP prefix, all upstream Junos routers will allocate labels to the same prefix;</li>
<li>IP traffic received by a Cisco IOS router will be labeled if at all possible (outbound label is entered in the FIB whenever there’s a corresponding mapping in LDP database);</li>
<li>Junos routers will label only IP traffic for BGP destinations.</li>
</ul>
<p>Yet again, remember that this section describes default behavior; you can change it on both Cisco IOS and Junos.</p>
<h4>An example is worth more than a thousand words</h4><p>To illustrate the Junos MPLS behavior, let’s look at data structures in a small OSPF/BGP/LDP network. I took a sample MPLS network created by Dan Backman, disabled RSVP, enabled LDP, and added a global EBGP connection (to test global BGP behavior):</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/12/s1600-MPLSDS_Net.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="/2011/12/s520-MPLSDS_Net.png"/></a></div>
<p>The IP routing table on R3 contains all directly connected, IGP and BGP destinations:</p>
<p class="codecaption">IP routing table @ R3</p>
<pre class="code">root@R3&gt; show route table inet.0 terse<br/><br/>inet.0: 37 destinations, 37 routes (37 active, 0 holddown, 0 hidden)<br/>+ = Active Route, - = Last Active, * = Both<br/><br/>A Destination        P Prf   Metric 1   Metric 2  Next hop        AS path<br/>* 10.0.2.0/30        D   0                       &gt;ge-0/0/5.0<br/>* 10.0.2.1/32        L   0                        Local<br/>* 10.0.2.4/30        D   0                       &gt;ge-0/0/4.0<br/>* 10.0.2.5/32        L   0                        Local<br/>* 10.0.2.8/30        O  10          2             10.0.2.6<br/>                                                 &gt;10.0.2.2<br/>* 10.0.2.12/30       D   0                       &gt;ge-0/0/6.0<br/>* 10.0.2.13/32       L   0                        Local<br/>* 10.0.2.16/30       O  10          2            &gt;10.0.2.6<br/>* 10.0.4.0/30        D   0                       &gt;ge-0/0/3.0<br/>* 10.0.4.2/32        L   0                        Local<br/>* 10.0.4.4/30        O  10          2             10.0.4.13<br/>                                                 &gt;10.0.4.1<br/>* 10.0.4.8/30        O  10          2            &gt;10.0.4.1<br/>                                                  10.0.2.6<br/>* 10.0.4.12/30       D   0                       &gt;ge-0/0/2.0<br/>* 10.0.4.14/32       L   0                        Local<br/>* 10.0.4.16/30       O  10          2            &gt;10.0.4.13<br/>                                                  10.0.2.6<br/>* 10.0.8.0/30        O  10          2            &gt;10.0.2.14<br/>* 10.0.8.4/30        O  10          2            &gt;10.0.2.2<br/>                                                  10.0.2.14<br/>* 10.0.8.8/30        O  10          2            &gt;10.0.2.2<br/>* 10.0.8.12/30       O  10          3             10.0.2.6<br/>                                                 &gt;10.0.2.2<br/>                                                  10.0.2.14<br/>* 10.0.255.1/32      O  10          1            &gt;10.0.4.13<br/>* 10.0.255.2/32      O  10          1            &gt;10.0.4.1<br/>* 10.0.255.3/32      D   0                       &gt;lo0.0<br/>* 10.0.255.4/32      O  10          1            &gt;10.0.2.6<br/>* 10.0.255.5/32      O  10          1            &gt;10.0.2.2<br/>* 10.0.255.6/32      O  10          1            &gt;10.0.2.14<br/>* 10.0.255.7/32      O  10          2            &gt;10.0.2.6<br/>                                                  10.0.2.2<br/>* 10.0.255.8/32      O  10          2            &gt;10.0.2.14<br/>* 10.233.240.0/20    D   0                       &gt;ge-0/0/0.0<br/>* 10.233.255.239/32  L   0                        Local<br/>* 172.17.20.0/23     B 170        100             10.0.2.6        65022 I<br/>                                                 &gt;10.0.2.2<br/>* 172.17.30.0/23     B 170        100            &gt;10.0.2.6        65022 I<br/>                                                  10.0.2.2<br/>* 172.17.31.0/30     O  10          3             10.0.2.6<br/>                                                 &gt;10.0.2.2<br/>* 192.168.0.0/24     O  10          3            &gt;10.0.2.14<br/>* 192.168.1.0/24     O  10          3            &gt;10.0.2.14<br/>* 192.168.2.0/24     O  10          3            &gt;10.0.2.14<br/>* 192.168.3.0/24     O  10          3            &gt;10.0.2.14<br/>* 224.0.0.5/32       O  10          1             MultiRecv</pre><p>FEC mapping table (inet.3) is much shorter than the IP routing table. It contains only the loopback addresses (the /32 prefixes), and an IP prefix for external BGP next hop that I added to LDP using <strong>egress-policy</strong> on R7 (the /30 prefix). Prefixes advertised by adjacent routers (R1, R2, R4 and R5) don’t have an outbound label (due to penultimate hop popping), R7’s loopback and EBGP next hop do.</p>
<p class="codecaption">FEC mapping table @ R3</p>
<pre class="code">root@R3&gt; show route table inet.3<br/><br/>inet.3: 6 destinations, 6 routes (6 active, 0 holddown, 0 hidden)<br/>+ = Active Route, - = Last Active, * = Both<br/><br/>10.0.255.1/32      *[LDP/9] 00:04:52, metric 1<br/>                    &gt; to 10.0.4.13 via ge-0/0/2.0<br/>10.0.255.2/32      *[LDP/9] 03:52:19, metric 1<br/>                    &gt; to 10.0.4.1 via ge-0/0/3.0<br/>10.0.255.4/32      *[LDP/9] 00:02:32, metric 1<br/>                    &gt; to 10.0.2.6 via ge-0/0/4.0<br/>10.0.255.5/32      *[LDP/9] 03:52:17, metric 1<br/>                    &gt; to 10.0.2.2 via ge-0/0/5.0<br/>10.0.255.7/32      *[LDP/9] 00:02:32, metric 1<br/>                      to 10.0.2.6 via ge-0/0/4.0, Push 299872<br/>                    &gt; to 10.0.2.2 via ge-0/0/5.0, Push 299888<br/>172.17.31.0/30     *[LDP/9] 00:02:32, metric 1<br/>                      to 10.0.2.6 via ge-0/0/4.0, Push 299872<br/>                    &gt; to 10.0.2.2 via ge-0/0/5.0, Push 299888</pre><p>Local labels are created for all prefixes in inet.3 table; locally-originated prefixes don’t need labels; they are associated with label 3 (POP).</p>
<p class="codecaption">LDP-generated part of the LFIB table on R3</p>
<pre class="code">root@R3&gt; show route table mpls.0 terse protocol ldp<br/><br/>mpls.0: 22 destinations, 22 routes (21 active, 0 holddown, 1 hidden)<br/>+ = Active Route, - = Last Active, * = Both<br/><br/>A Destination        P Prf   Metric 1   Metric 2  Next hop        AS path<br/>* 299776             L   9          1            &gt;10.0.4.1<br/>* 299776(S=0)        L   9          1            &gt;10.0.4.1<br/>* 299824             L   9          1            &gt;10.0.2.2<br/>* 299824(S=0)        L   9          1            &gt;10.0.2.2<br/>* 299888             L   9          1            &gt;10.0.4.13<br/>* 299888(S=0)        L   9          1            &gt;10.0.4.13<br/>* 299904             L   9          1            &gt;10.0.2.6<br/>* 299904(S=0)        L   9          1            &gt;10.0.2.6<br/>* 299920             L   9          1             10.0.2.6<br/>                                                 &gt;10.0.2.2</pre><p>If you display detailed information from the mpls.0 table, you can also see the IP prefixes associated with the label entry (note that there are two IP prefixes associated with the same label):</p>
<p class="codecaption">A single entry in the LFIB table</p>
<pre class="code">root@R3&gt; show route table mpls.0 protocol ldp detail | find 299920<br/>299920 (1 entry, 1 announced)<br/>        *LDP    Preference: 9<br/>                Next hop type: Router<br/>                Next-hop reference count: 1<br/>                Next hop: 10.0.2.6 via ge-0/0/4.0<br/>                Label operation: Swap 299872<br/>                Next hop: 10.0.2.2 via ge-0/0/5.0, selected<br/>                Label operation: Swap 299888<br/>                State: &lt;Active Int&gt;<br/>                Local AS: 65412<br/>                Age: 6:49       Metric: 1<br/>                Task: LDP<br/>                Announcement bits (1): 0-KRT<br/>                AS path: I<br/>                Prefixes bound to route: 10.0.255.7/32<br/>                                         172.17.31.0/30</pre><p>LDP database contains all the information received from LDP neighbors or advertised to them; you can inspect the whole LDP database or entries received or sent to an individual neighbor. As expected, output label database contains labels for all entries in inet.3 table and label 3 (POP) for all locally-originated LDP prefixes.</p>
<p class="codecaption">Parts of LDP database on R3 (limited to R5)</p>
<pre class="code">root@R3&gt; show ldp database session 10.0.255.5<br/>Input label database, 10.0.255.3:0--10.0.255.5:0<br/>  Label     Prefix<br/> 299936     10.0.255.1/32<br/> 299872     10.0.255.2/32<br/> 299856     10.0.255.3/32<br/> 299952     10.0.255.4/32<br/>      3     10.0.255.5/32<br/> 299888     10.0.255.7/32<br/> 299888     172.17.31.0/30<br/><br/>Output label database, 10.0.255.3:0--10.0.255.5:0<br/>  Label     Prefix<br/> 299888     10.0.255.1/32<br/> 299776     10.0.255.2/32<br/>      3     10.0.255.3/32<br/> 299904     10.0.255.4/32<br/> 299824     10.0.255.5/32<br/> 299920     10.0.255.7/32<br/> 299920     172.17.31.0/30</pre><p>Last but definitely not least, let’s inspect the routing table entry for the external BGP next hop. You won’t find a label in this entry.</p>
<p class="codecaption">Route toward BGP next-hop on R3</p>
<pre class="code">root@R3&gt; show route 172.17.31.0/30 extensive<br/><br/>inet.0: 37 destinations, 37 routes (37 active, 0 holddown, 0 hidden)<br/>172.17.31.0/30 (1 entry, 1 announced)<br/>TSI:<br/>KRT in-kernel 172.17.31.0/30 -&gt; {10.0.2.2}<br/>        *OSPF   Preference: 10<br/>                Next hop type: Router, Next hop index: 262148<br/>                Next-hop reference count: 6<br/>                Next hop: 10.0.2.6 via ge-0/0/4.0<br/>                Next hop: 10.0.2.2 via ge-0/0/5.0, selected<br/>                State: &lt;Active Int&gt;<br/>                Local AS: 65412<br/>                Age: 3:44:50    Metric: 3<br/>                Area: 0.0.0.0<br/>                Task: OSPF<br/>                Announcement bits (3): 0-KRT 3-LDP 5-Resolve tree 2<br/>                AS path: I</pre><p>Just to ensure there’s no other magic going on behind the scenes, let’s inspect the forwarding table entry for the same prefix. Yet again, no label.</p>
<p class="codecaption">Forwarding entry for BGP next-hop on R3</p>
<pre class="code">root@R3&gt; show route forwarding-table destination 172.17.31.0/30 extensive<br/>Routing table: default.inet [Index 0]<br/>Internet:<br/><br/>Destination:  172.17.31.0/30<br/>  Route type: user<br/>  Route reference: 0                   Route interface-index: 0<br/>  Flags: sent to PFE, rt nh decoupled<br/>  Nexthop: 10.0.2.2<br/>  Next-hop type: unicast               Index: 631      Reference: 16<br/>  Next-hop interface: ge-0/0/5.0<br/></pre><p>On the other hand, the routing table entry for a BGP destination using that same BGP next hop has two labels (because R3 can reach the EBGP next hop through two next-hop routers, R4 and R5.</p>
<p class="codecaption">BGP route on R3</p>
<pre class="code">root@R3&gt; show route 172.17.20.0/23 extensive<br/><br/>inet.0: 37 destinations, 37 routes (37 active, 0 holddown, 0 hidden)<br/>172.17.20.0/23 (1 entry, 1 announced)<br/>TSI:<br/>KRT in-kernel 172.17.20.0/23 -&gt; {indirect(262146)}<br/>        *BGP    Preference: 170/-101<br/>                Next hop type: Indirect<br/>                Next-hop reference count: 6<br/>                Source: 10.0.255.7<br/>                Next hop type: Router, Next hop index: 262154<br/>                Next hop: 10.0.2.6 via ge-0/0/4.0<br/>                Label operation: Push 299872<br/>                Next hop: 10.0.2.2 via ge-0/0/5.0, selected<br/>                Label operation: Push 299888<br/>                Protocol next hop: 172.17.31.2<br/>                Indirect next hop: 90d23c0 262146<br/>                State: &lt;Active Int Ext&gt;<br/>                Local AS: 65412 Peer AS: 65412<br/>                Age: 3:50:47    Metric2: 1<br/>                Task: BGP_65412.10.0.255.7+179<br/>                Announcement bits (2): 0-KRT 5-Resolve tree 2<br/>                AS path: 65022 I Aggregator: 65022 172.17.21.2<br/>                Accepted<br/>                Localpref: 100<br/>                Router ID: 10.0.255.7<br/>                Indirect next hops: 1<br/>                        Protocol next hop: 172.17.31.2 Metric: 1<br/>                        Indirect next hop: 90d23c0 262146<br/>                        Indirect path forwarding next hops: 2<br/>                                Next hop type: Router<br/>                                Next hop: 10.0.2.6 via ge-0/0/4.0<br/>                                Next hop: 10.0.2.2 via ge-0/0/5.0<br/>                        172.17.31.0/30 Originating RIB: inet.3<br/>                          Metric: 1                       Node path count: 1<br/>                          Forwarding nexthops: 2<br/>                                Nexthop: 10.0.2.6 via ge-0/0/4.0<br/>                                Nexthop: 10.0.2.2 via ge-0/0/5.0</pre><p>The outgoing label is also copied into the forwarding table. By default, Junos doesn’t perform load balancing toward BGP destinations; the forwarding table thus contains only a single outgoing label.</p>
<p class="codecaption">Forwarding entry for a BGP route on R3</p>
<pre class="code">root@R3&gt; show route forwarding-table destination 172.17.20.0/23 extensive<br/>Routing table: default.inet [Index 0]<br/>Internet:<br/><br/>Destination:  172.17.20.0/23<br/>  Route type: user<br/>  Route reference: 0                   Route interface-index: 0<br/>  Flags: sent to PFE, prefix load balance<br/>  Next-hop type: indirect              Index: 262146   Reference: 3<br/>  Nexthop: 10.0.2.2<br/>  Next-hop type: Push 299888           Index: 668      Reference: 1<br/>  Next-hop interface: ge-0/0/5.0</pre>

