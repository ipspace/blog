---
title: "Penultimate Hop Popping (PHP) demystified"
date: "2011-07-27T06:32:00.000+02:00"
tags: [ MPLS,Workshop ]
---

<p>I got an interesting question after writing the <a href="http://blog.ioshints.info/2011/07/asymmetric-mpls-mtu-problem.html"><em>Asymmetric MPLS MTU Problem</em></a><em> </em>post: “<em>Why does PHP happen only on directly-connected interfaces but not on other non-MPLS routes?</em>” Obviously it’s time for a deep dive into <a href="http://wiki.nil.com/Implicit_and_explicit_NULL_in_MPLS_networks">Penultimate Hop Popping</a> (PHP) mysteries (warning label: <a href="http://blog.ioshints.info/2007/07/update-preparing-for-mpls-ccip-exam.html">read the MPLS books</a> if you plan to get seriously involved with MPLS).<!--more--></p>
<p>When developing the MPLS architecture, its designers had to consider two fundamental facts:</p>
<ul class="ListParagraph"><li>Label lookup is simpler than IP lookup;</li>
<li>Two lookups (label + IP) are more expensive (in whatever terms) than one lookup.</li>
</ul>
<p class="note">The “label lookup is simpler” is no longer true for hardware-based L3 switches, although the label lookup might still incur slightly lower latency as it can be done as a simple table lookup, not a TCAM search. Furthermore, some hardware-based switching platforms don’t support two lookups at all.</p>
<p>The goals they tried to achieve with PHP were thus:</p>
<ul class="ListParagraph"><li>Use <em>implicit null </em>whenever an IP lookup would have to be performed anyway to prevent two lookups;</li>
<li>Use explicit labels whenever you can.</li>
</ul>
<p>There is a very clear case that always requires an IP lookup: a summary route generated by the router (for example, an OSPF ABR). Consider the following OSPF configuration:</p>
<pre class="code">router ospf 1<br/> log-adjacency-changes<br/> area 11 range 10.2.0.0 255.255.0.0</pre><p>The <strong>area range </strong>command causes the IP prefix 10.2.0.0/16 to be advertised into the backbone area (assuming at least one more specific prefix in that range is in area 11). However, the router does not know in advance where to send the packets forwarded toward that prefix from the OSPF backbone; it has to perform a full IP lookup on them.</p>
<p>The <strong>area range </strong>command generates a summary route pointing to <em>null 0 </em>in IP routing table and CEF table to prevent forwarding loops:</p>
<pre class="code">C1#<strong>show ip route 10.2.0.0</strong><br/>Routing entry for 10.2.0.0/16<br/>  Known via "ospf 1", distance 110, metric 60, type intra area<br/>  Routing Descriptor Blocks:<br/>  <span class="high">* directly connected, via Null0</span><br/>      Route metric is 60, traffic share count is 1<br/>C1#<strong>show ip cef 10.2.0.0 detail</strong><br/>10.2.0.0/16, epoch 0<br/>  attached to Null0</pre><p>The corresponding entry in LFIB contains <em>implicit null </em>label (displayed as <em>None</em>)<em> </em>and <em>punt </em>outgoing interface (meaning: do a full IP lookup).</p>
<pre class="code">C1#<strong>show mpls forwarding-table 10.2.0.0 detail</strong><br/>Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop<br/>Label      Label      or Tunnel Id     Switched      interface<br/><span class="high">None</span>       No Label   10.2.0.0/16      0             <span class="high">punt</span><br/>        MAC/Encaps=0/0, MRU=0, Label Stack{}<br/>        No output feature configured</pre><p>On the other hand, packets forwarded toward a prefix received from another router don’t need an IP lookup – we know who the next hop is, we can build full L2 header in advance and afterwards forward IP packets toward the destination without inspecting the IP header.</p>
<p>Let’s look at an OSPF route received from another router in the same area. As expected, it’s associated with an IP next hop and an outgoing interface:</p>
<pre class="code">C1#<strong>show ip route 10.2.2.0</strong><br/>Routing entry for 10.2.2.0/24<br/>  Known via "ospf 1", distance 110, metric 60, type intra area<br/>  Last update from 10.0.7.5 on Serial1/0, 00:09:46 ago<br/>  Routing Descriptor Blocks:<br/>  * <span class="high">10.0.7.5, from 10.0.1.1, 00:09:46 ago, via Serial1/0</span><br/>      Route metric is 60, traffic share count is 1<br/>C1#<strong>show ip cef 10.2.2.0 detail</strong><br/>10.2.2.0/24, epoch 0<br/>  local label info: global/1004<br/>  <span class="high">nexthop 10.0.7.5 Serial1/0</span></pre><p>The corresponding LFIB entry contains the outgoing interface <em>and the full L2 header </em>(in our case, the PPP header associated with IP datagrams).</p>
<pre class="code">C1#<strong>show mpls forwarding-table 10.2.2.0 detail</strong><br/>Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop<br/>Label      Label      or Tunnel Id     Switched      interface<br/>1004       No Label   10.2.2.0/24      0             <span class="high">Se1/0</span>      point2point<br/>        MAC/Encaps=4/4, MRU=1504, Label Stack{}<br/>        <span class="high">FF030021</span><br/>        No output feature configured</pre><p>The <em>outgoing label </em>associated with an IP prefix received from another router could be:</p>
<ul class="ListParagraph"><li><em>No Label </em>if MPLS is not enabled on the outgoing interface or if the next-hop router has not advertised a label for the prefix;</li>
<li><em>Pop label </em>if the next-hop router has advertised <em>implicit null </em>label for the prefix;</li>
<li>Label advertised by the next-hop router for the IP prefix through LDP.</li>
</ul>
<p>Going one step further, let’s look at an LFIB entry containing an outgoing label. The L2 information associated with the LFIB entry contains not only the L2 header (yet again, PPP header in our printout), but also the outgoing MPLS label stack. The Label Switch Router (LSR) performing the label lookup thus fetches the full outgoing header (L2 header + MPLS label stack) during the lookup operation.</p>
<pre class="code">C2#<strong>show mpls forwarding 10.2.2.0 detail</strong><br/>Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop<br/>Label      Label      or Tunnel Id     Switched      interface<br/>2014       <span class="high">1004</span>       10.2.2.0/24      0             Se1/1      point2point<br/>        MAC/Encaps=4/8, MRU=1500, Label Stack{1004}<br/>        <span class="high">FF030281 003EC000</span><br/>        No output feature configured</pre><p class="note">When comparing the above printout with the previous one, note the difference in PPP protocol type (0x0021 for IP versus 0x0281 for labeled packets). The 0x03EC value in the MPLS label header is the outgoing label (1004) displayed in hex.</p>
<p>Just in case you’re wondering how an LFIB entry looks like for LAN next hops, here’s a sample printout. As expected, full MAC header is included in the LFIB entry (0x8847 at the end of the MAC header is MPLS Ethertype).</p>
<pre class="code">PE-A#<strong>show mpls forwarding-table 10.0.1.3 detail</strong><br/>Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop<br/>Label      Label      or Tunnel Id     Switched      interface<br/>25         16         10.0.1.3/32      0             Fa0/0      10.2.2.2<br/>        MAC/Encaps=14/18, MRU=1500, Label Stack{16}<br/>        <span class="high">CA0107880008CA00078800088847</span> 00010000<br/>        No output feature configured</pre><p>To summarize what we’ve discovered so far:</p>
<ul class="ListParagraph"><li>Summary routes always require an IP lookup. The routers always advertise <em>implicit null </em>or <em>explicit null </em>prefix (if so configured) for them.</li>
<li>We don’t need to perform IP lookups for packets sent toward prefixes associated with explicit IP next hops; we can build outgoing L2 header in advance and fetch it during label lookup.</li>
</ul>
<p>Last step: the connected interfaces. Obviously, there’s no next hop associated with a connected interface. In fact, the router has to use a different L2 header for every directly connected host and has to perform an IP lookup on inbound packets to figure out which directly connected host is the final destination (and which L2 header to fetch from the ARP table on LAN interfaces). LDP therefore advertises null labels (implicit or explicit) for directly connected IP prefixes, causing penultimate hop popping (when the <em>implicit null</em> is advertised) on the upstream router.</p>
<p class="info">A directly connected subnet could also be considered a summary route for a bunch of host routes. In fact, that’s exactly how L3 switching for directly connected subnets is implemented in many hardware-based L3 switches.</p>
<h4>More information</h4><p>You’ll find in-depth description of MPLS/VPN technology and enterprise network deployment hints in my <a href="http://www.ioshints.info/EntMPLS">Enterprise MPLS/VPN Deployment</a> webinar (<a href="http://mpls.eventbrite.com/">register for a live session </a>or <a href="http://www.ioshints.info/Recordings?code=EntMPLS">buy its recording</a>). For more VPN webinars, check my <a href="http://www.ioshints.info/Roadmap/VPN_webinars">VPN webinar roadmap</a>. You get access to all those webinars when you buy the <a href="http://www.ioshints.info/Subscription_to_ioshints_webinars">yearly subscription</a>.</p>

