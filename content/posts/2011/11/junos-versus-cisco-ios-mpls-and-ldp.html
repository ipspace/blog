---
url: /2011/11/junos-versus-cisco-ios-mpls-and-ldp/
title: "Junos Versus Cisco IOS: MPLS and LDP"
date: "2011-11-16T06:55:00.000+01:00"
tags: [ MPLS,LDP,Junos ]
---

<p>The comments <em>igp2bgp</em> and <a href="http://www.linkedin.com/pub/tiziano-tofoni/9/175/136">Tiziano Tofoni</a> made to my <a href="/2011/11/ldp-igp-synchronization-in-mpls/"><em>LDP-IGP Synchronization in MPLS Networks</em></a> post prompted me to look deeper into basic Junos MPLS configuration and LDP behavior. As expected, there are some significant differences between Cisco’s and Juniper’s LDP implementations (and, as is usually the case, they’re both strictly conformant with <a href="http://tools.ietf.org/html/rfc5036">RFC 5036</a>).<!--more--></p>
<h4>Configuration Details</h4><p>When you configure <strong>mpls ip </strong>on an interface in a Cisco router, you implicitly start LDP. In Junos, you have to start LDP explicitly by creating <strong>protocols ldp </strong>and list all interfaces on which LDP should run with <strong>interface </strong>commands within <strong>protocol ldp</strong>. Even that’s not enough; you have to enable MPLS family on each interface listed in the <strong>protocols ldp </strong>section.</p>
<p class="codecaption">Cisco IOS configuration</p>
<pre class="code">interface GigabitEthernet0/0/2<br/> mpls ip<br/>interface GigabitEthernet0/0/3<br/> mpls ip<br/>interface GigabitEthernet0/0/4<br/> mpls ip<br/>interface GigabitEthernet0/0/5<br/> mpls ip</pre><p class="codecaption">Equivalent Junos configuration</p>
<pre class="code">interfaces {<br/>    ge-0/0/2 {<br/>        unit 0 {<br/>            family mpls;<br/>        }<br/>    }<br/>    ge-0/0/3 {<br/>        unit 0 {<br/>            family mpls;<br/>        }<br/>    }<br/>    ge-0/0/4 {<br/>        unit 0 {<br/>            family mpls;<br/>        }<br/>    }<br/>    ge-0/0/5 {<br/>        unit 0 {<br/>            family mpls;<br/>        }<br/>    }<br/>}<br/>protocols {<br/>    ldp {<br/>        interface ge-0/0/2.0;<br/>        interface ge-0/0/3.0;<br/>        interface ge-0/0/4.0;<br/>        interface ge-0/0/5.0;<br/>    }<br/>}</pre><p class="note">I am positive Junos approach has its benefits (and a very apparent verbosity drawback) and I’m not even trying to say which one is better – both CLIs are facts of life. And you don’t have to remind me there are <em>commit scripts </em>that can sync both parts of Junos configuration.</p>
<p class="warn">For whatever reason, during some of my tests LDP failed to start till I configured <strong>protocol ldp transport-address router-id</strong>. Reload might have helped ;)</p>
<h4>Label Distribution Control Mode</h4><p>Cisco IOS uses <a href="http://tools.ietf.org/html/rfc5036#section-2.6.1.1"><em>independent label distribution control</em></a><em> </em>– every LSR advertises a label for every IP prefix in its routing table that matches its label allocation policy (see also <em>Label Allocation Rules </em>below).</p>
<p>Junos uses <a href="http://tools.ietf.org/html/rfc5036#section-2.6.1.2"><em>ordered label distribution control</em></a><em> – </em>LSR allocates and advertises labels for prefixes configured with <em>egress policy </em>(see <em>Label Allocation Rules</em> below) and for prefixes in its IP routing table for which it’s already received a label mapping from the next-hop LSR.</p>
<p>In both cases, you can’t configure the label distribution control mode (more about whether that matters in a follow-up post).</p>
<h4>Label Allocation Rules</h4><p>Cisco IOS allocates an MPLS label for every non-BGP IP prefix in the IP routing table. You can change that behavior with <strong>allocate global prefix-list | host-routes</strong> global configuration command (introduced in 12.2SRC). You can also filter labels sent to LDP neighbors with the <strong>mpls ldp advertise-label </strong>global configuration command.<strong><em> </em></strong></p>
<p>Junos allocates labels only for loopback interfaces. You can change the set of prefixes for which the local labels are allocated with the <strong>protocol ldp egress-policy</strong> (and outbound filters with the <strong>export </strong>policy).</p>
<p class="warn">Any IP prefix matched by the LDP egress policy will get a locally-originated label that will not be stitched with the label allocated by downstream LSR. Effectively, a Junos router becomes tail-end LSR for every prefix matched by the <strong>egress-policy</strong>.</p>
<p>To emulate Cisco IOS label allocation behavior on Junos, use the following configuration:</p>
<pre class="code">protocols {<br/>    ldp {<br/>        egress-policy connected;<br/>        interface ge-0/0/2.0;<br/>        interface ge-0/0/3.0;<br/>        interface ge-0/0/4.0;<br/>    }<br/>}<br/>policy-options {<br/>    policy-statement connected {<br/>        from protocol direct;<br/>        then accept;<br/>    }<br/>}</pre><h4>FEC Aggregation</h4><p>Cisco IOS allocates a different label to every IP prefix that deserves to get a label (see <em>Label Allocation Rules</em>).</p>
<p>Junos allocates a single label to all IP prefixes<em> </em>that have (A) the same IP next hop and (B) the same label advertised by the next-hop LSR. You can change that behavior with <strong>protocol ldp deaggregate </strong>command.</p>
<h4>Does it matter?</h4><p>In most well-designed networks, the differences between Cisco IOS and Junos are not significant (exception: in a BGP-free ISP core with external BGP next hops you have to allocate labels to external subnets). </p>
<p>Junos is way more conservative in its label allocation policy and will thus (with the default settings) generate fewer labels and consume fewer resources than Cisco IOS.</p>
<p>You can change most LDP parameters (apart from the label distribution control mode) and make Cisco IOS behave almost like Junos or vice versa.</p>
<p>So why does it matter? The only real reason is troubleshooting: you have to understand why you’re seeing fewer (or more) labels than you’d expect to see and why you don’t see a label for a prefix that should have one (hint: ordered label distribution control).</p>
<h4>Disclosure</h4><p>This post would never have been written without a gentle nudge from Tiziano and <em>igp2bgp</em> who’d tickled my curiosity. Thank you!</p>
<p>I did all the tests in Junosphere environment kindly provided by Juniper (thanks to @abnerg) ... but I never promised anyone I would write anything about Junosphere or Junos (and of course they knew I couldn’t possibly resist the temptation).</p>

