---
url: /2011/11/ldp-igp-synchronization-in-mpls.html
title: "LDP-IGP synchronization in MPLS networks"
date: "2011-11-14T06:28:00.000+01:00"
tags: [ MPLS,IS-IS,OSPF,LDP ]
---

<p>A reader of my blog planning to migrate his network from a traditional BGP-everywhere design to a BGP-over-MPLS one wondered about potential unexpected consequences. The <a href="https://blog.ipspace.net/2011/07/mpls-mtu-challenges.html">MTU implications of introducing MPLS in a running network</a> are usually well understood (even though you <a href="https://blog.ipspace.net/2011/07/asymmetric-mpls-mtu-problem.html">could get some very interesting behavior</a>); if you can, increase the MTU size by at least 16 bytes (4 labels) and <a href="https://blog.ipspace.net/2011/07/all-mtus-are-not-same.html">check whether MTU includes L2 header</a>. Another somewhat more mysterious beast is the interaction between IGP and LDP that can cause traffic disruptions <em>after the physical connectivity has been reestablished</em>.<!--more--></p>
<p>Here’s a typical BGP-over-MPLS design (applies equally well to MPLS/VPN, 6PE, 6VPE, VPLS or pseudowires):</p>
<ul class="ListParagraph"><li>Edge routers (PE-routers) run BGP between themselves to exchange external (customer) prefixes;</li>
<li>Edge and core (P) routers run IGP (usually OSPF or IS-IS) to find optimum path toward BGP next hops;</li>
<li>P- and PE-routers use LDP to exchange labels for known IP prefixes (including BGP next hops). LDP indirectly builds end-to-end LSPs across the network core.</li>
</ul>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/11/s1600-LDPIGP_BasicSetup.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="159" src="/2011/11/s320-LDPIGP_BasicSetup.png" width="304"/></a></div>
<p>IP packets can be forwarded across BGP-free core even though the core routers don’t know how to forward them. Ingress PE-router labels incoming IP packets with MPLS labels for BGP next hops, labeled packets are sent across the core (core routers don’t perform IP lookup), last P-router pops the top label (<a href="https://blog.ipspace.net/2011/07/penultimate-hop-popping-php-demystified.html">penultimate hop popping</a>) and the egress PE-router performs IP lookup and sends the datagram toward an external destination (the process is <a href="http://wiki.nil.com/MPLS_Traffic_Engineering_in_MPLS_VPN_environment">slightly different when you use technologies like MPLS/VPN that need a two-label stack</a>).</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/11/s1600-LDPIGP_FWD.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="167" src="/2011/11/s320-LDPIGP_FWD.png" width="320"/></a></div>
<p>If a core link fails, IGP quickly finds an alternate path. LDP does not need to converge; when using <em>independent label distribution</em> and <em>liberal label retention mode</em> (default settings on most modern routers), every LSR saves labels advertised by all its neighbors. In our network, when A discovers that it can use B to reach the egress router, it already has the label B assigned to EG prefix in its Label Information Base (LIB). LDP thus causes no interruption in traffic flow.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/11/s1600-LDPIGP_Backup.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="153" src="/2011/11/s320-LDPIGP_Backup.png" width="320"/></a></div>
<p>The situation is completely different after the physical link is restored. IGP quickly discovers new neighbors and reconverges; LDP is slower. In the short interval between IGP convergence and LDP synchronization router A sends IP packets through the new shortest path toward the egress router <em>with no label</em> (it hasn’t received a label from D yet and thus has no outgoing label to use). Router D, not running BGP, has no idea what to do with those packets and thus drops them.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/11/s1600-LDPIGP_Restore.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="161" src="/2011/11/s320-LDPIGP_Restore.png" width="316"/></a></div>
<p class="info">The same problem can occur if you clear an LDP session or disable MPLS on an interface with <strong>no mpls ip</strong>.</p>
<p>There are two solutions to this problem:</p>
<p><strong>LDP-IGP synchronization</strong>: Link cost of a newly established adjacency is set to the maximum value until LDP tells IGP it’s OK to use the link. You can configure the LDP-IGP synchronization in OSPF or IS-IS, either with the <strong>mpls ldp sync </strong>command in the routing protocol configuration or with the <strong>mpls ldp igp sync </strong>interface configuration command where you can also specify an additional delay (to ensure both IGP and LDP are completely stable before you start using the new link for packet forwarding).</p>
<p class="warn">The details of LDP-IGP synchronization are a bit tricky. <a href="http://www.cisco.com/en/US/docs/ios/mpls/configuration/guide/mp_ldp_igp_synch_ps10592_TSD_Products_Configuration_Guide_Chapter.html">Read the corresponding documentation</a> before enabling this feature in your network.</p>
<p><strong>LDP session protection</strong>: A router tries to retain LDP sessions with all its neighbors even if they are currently not directly connected (A and D in our link failure scenario). Since the router no longer receives multicast LDP hellos from such neighbors, it uses <em>targeted LDP hellos </em>(unicast UDP packets sent to neighbor’s LDP transport address) to prevent session timeouts.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/11/s1600-LDPIGP_Targeted.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="159" src="/2011/11/s320-LDPIGP_Targeted.png" width="304"/></a></div>
<p>Targeted LDP sessions allow the routers to retain LIB information that can be used immediately after IGP convergence. There’s also no need to reestablish LDP sessions with the newly-adjacent neighbors as they were never disconnected.</p>
<p>To configure this feature, use the <strong>mpls ldp session protection </strong>global configuration command. You can use an ACL to specify the neighbors you’re interested in (it makes more sense to use this feature on core links than on non-redundant access links) and the duration of the session protection (default: 24 hours).</p>
<h4>More background information</h4><p><a href="http://www.ioshints.info/Enterprise_MPLS_VPN_Deployment">Enterprise MPLS/VPN Deployment</a> webinar (<a href="http://www.ioshints.info/Recordings?code=EntMPLS">recording</a>) describes the basics of LDP, LSP establishment and packet forwarding across MPLS networks (including label stack used by MPLS/VPN and penultimate hop popping). If you need a bit more in-depth details, <a href="https://blog.ipspace.net/2007/06/using-mpls-vpn-books-to-study-for-ccip.html">buy one of the MPLS books</a> (unfortunately none of my books covers the new features like LDP session protection).</p>
<!-- <div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-V3uut2q7Kiw/TqKpQJf3CkI/AAAAAAAAEdo/19ZYR3AjUSE/s1600/LDPIGP_BasicSetup.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="159" width="304" src="http://4.bp.blogspot.com/-V3uut2q7Kiw/TqKpQJf3CkI/AAAAAAAAEdo/19ZYR3AjUSE/s320/LDPIGP_BasicSetup.png" /></a></div> <div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-4dsAnRP7dTg/TqKpQC1jCAI/AAAAAAAAEd0/TWrjHkrUgyo/s1600/LDPIGP_FWD.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="167" width="320" src="http://4.bp.blogspot.com/-4dsAnRP7dTg/TqKpQC1jCAI/AAAAAAAAEd0/TWrjHkrUgyo/s320/LDPIGP_FWD.png" /></a></div> <div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-8_9Yw_CeSr8/TqKpQWGYuxI/AAAAAAAAEeA/PbmfqdK48lA/s1600/LDPIGP_Backup.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="153" width="320" src="http://2.bp.blogspot.com/-8_9Yw_CeSr8/TqKpQWGYuxI/AAAAAAAAEeA/PbmfqdK48lA/s320/LDPIGP_Backup.png" /></a></div> <div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-hHO0I4ldIag/TqKpQoQb8lI/AAAAAAAAEeM/TBnKV8b4waM/s1600/LDPIGP_Restore.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="161" width="316" src="http://2.bp.blogspot.com/-hHO0I4ldIag/TqKpQoQb8lI/AAAAAAAAEeM/TBnKV8b4waM/s320/LDPIGP_Restore.png" /></a></div> <div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-UF8gW_NptAQ/TqKpQyEyuFI/AAAAAAAAEeY/2hmmtkZhrCY/s1600/LDPIGP_Targeted.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="159" width="304" src="http://2.bp.blogspot.com/-UF8gW_NptAQ/TqKpQyEyuFI/AAAAAAAAEeY/2hmmtkZhrCY/s320/LDPIGP_Targeted.png" /></a></div>-->

