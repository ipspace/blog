---
url: /2011/11/virtual-switches-need-bpdu-guard/
title: "Virtual switches need BPDU guard"
date: "2011-11-04T09:09:00.000+01:00"
tags: [ bridging,virtualization ]
---

<p>An engineer attending my <a href="https://www.ipspace.net/VMware_Networking_Deep_Dive">VMware Networking Deep Dive</a> webinar has asked me a tough question that I was unable to answer: </p>
<blockquote class="cite">What happens if a VM running within a vSphere host sends a BPDU? Will it get dropped by the vSwitch or will it be sent to the physical switch (potentially triggering BPDU guard)?</blockquote>
<p>I got the answer from visibly harassed <a href="http://www.network-janitor.net/">Kurt (@networkjanitor) Bales</a> during the Networking Tech Field Day; one of his customers has managed to do just that.</p>
<p class="update">Update 2011-11-04: The post was rewritten based on extensive feedback from Cisco, VMware and numerous readers.<!--more--></p>
<p>Here’s a sketchy overview of what was going on: they were running a Windows VM inside his VMware infrastructure, decided to configure bridging between a vNIC and a VPN link, and the VM started to send BPDUs through the vNIC. vSwitch ignored them, but the physical switch didn’t – it shut down the port, cutting a number of VMs off the network.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/11/s1600-vSwitch_BPDU.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="225" src="/2011/11/s320-vSwitch_BPDU.png" width="320"/></a></div>
<p>Best case, BPDU guard on the physical switch blocks but doesn’t shut down the port – all VMs pinned to that link get blackholed, but the damage stops there. More often BPDU guard shuts down the physical port (the reaction of BPDU guard is vendor/switch-specific), VMs using that port get pinned to another port, and the misconfigured VM triggers BPDU guard on yet another port, until the whole vSphere host is cut off from the rest of the network. Absolutely worst case, you’re running VMware High Availability, the vSphere host triggers isolation response, and the offending VM is restarted on another host (eventually bringing down the whole cluster).</p>
<p>There is only one good solution to this problem: <strong>implement BPDU guard on the virtual switch</strong>. Unfortunately, no virtual switch running in VMware environment implements BPDU guard. </p>
<p class="info">Interestingly, the same functionality would be pretty easy to implement in Xen/XenServer/KVM; either by modifying the open-source Open vSwitch or by forwarding the BPDU frames to OpenFlow controller, which would then block the offending port.</p>
<p>Nexus 1000V seems to offer a viable alternative. It has an <a href="http://www.cisco.com/en/US/prod/collateral/switches/ps9441/ps9902/guide_c07-556626.html#wp9000160">implicit BPDU filter</a> (you cannot configure it) that would block the BPDUs coming from a VM, but that only hides the problem – you could still get forwarding loops if a VM bridges between two vNICs connected to the same LAN. However, you can <em>reject forged transmits </em>(source-MAC-based filter, a standard vSphere feature) to block bridged packets coming from a VM. </p>
<p class="note">According to VMware’s documentation (ESX Configuration Guide) the default setting in vSphere 4.1 and <a href="http://pubs.vmware.com/vsphere-50/topic/com.vmware.vsphere.networking.doc_50/GUID-62914CF2-A6A8-4DCC-90A9-8CD4BBF50017.html">vSphere 5</a> is to <em>accept forged transmits</em>. </p>
<p>Lacking Nexus 1000V, you can use a virtual firewall (example: <a href="http://www.vmware.com/pdf/vshield_50_admin.pdf">vShield App</a>) that can filter layer-2 packets based on ethertype. Yet again, you should combine that with rejection of forged transmits.</p>
<div class="separator" style="clear: both; text-align: center;"><img border="0" height="300" src="/2011/11/s320-blackberry_guardsman.jpg" width="253"/><br/><span style="font-size: 90%">No BPDUs past this point</span></div>
<p>In theory, an interesting approach might be to use VM-FEX. A <a href="/2011/08/vm-fex-how-convoluted-can-you-get/">VM using VM-FEX is connected directly to a logical interface in the upstream switch</a> and the BPDU guard configured on that interface would shut down just the offending VM. Unfortunately, I can’t find a way to configure BPDU guard in UCS Manager.</p>
<p>Other alternatives to BPDU guard in a vSwitch range from bad to worse:</p>
<p><strong>Disable BPDU guard on the physical switch</strong>. You’ve just moved the problem from access to distribution layer (if you use BPDU guard there) ... or you’ve made the whole layer-2 domain totally unstable, as any VM could cause STP topology change.</p>
<p><strong>Enable BPDU filter on the physical switch</strong>. Even worse – if someone actually manages to configure bridging between two vNICs (or two physical NICs in a Hyper-V host), you’re toast; BPDU filter causes the physical switch to pretend the problem doesn’t exist.</p>
<p><strong>Enable BPDU filter on the physical switch and reject forged transmits in vSwitch</strong>. This one protects against bridging within a VM, but not against physical server misconfiguration. If you’re absolutely utterly positive all your physical servers are vSphere hosts, you can use this approach (<a href="/2010/11/vmware-virtual-switch-no-need-for-stp/">vSwitch has built-in loop prevention</a>); if there’s a minimal chance someone might connect bare-metal server or a Hyper-V/XenServer host to your network, don’t even think about using BPDU filter on the physical switch.</p>
<p><strong>Anything else?</strong> Please describe your preferred solution in the comments!</p>
<h4>Summary</h4><p>BPDU filter available in Nexus 1000V or ethertype-based filters available in virtual firewalls can stop the BPDUs within the vSphere host (and thus protect the physical links). If you combine it with forged transmit rejection, you get a solution that protects the network from almost any VM-level misconfiguration.</p>
<p>However, I would still prefer a proper BPDU guard with logging in the virtual switches for several reasons:</p>
<ul class="ListParagraph"><li>BPDU filter just masks the configuration problem;</li>
<li>If the vSwitch accepts forged transmits, you could get an actual forwarding loop;</li>
<li>While the solution described above does protect the network, it also makes troubleshooting a lot more obscure – a clear logging message in vCenter telling the virtualization admin that BPDU guard has shut down a vNIC would be way better;</li>
<li>Last but definitely not least, someone just might decide to change the settings and accept forged transmits (with potentially disastrous results) while troubleshooting a customer problem @ 2AM.</li>
</ul>
<h4>Looking for more details? </h4><p>You’ll find them in the <a href="https://www.ipspace.net/VMware_Networking_Deep_Dive">VMware Networking Deep Dive</a> webinar (<a href="https://www.ipspace.net/Recordings?code=VMnet">buy a recording</a>); if you’re interested in more than one webinar, consider the <a href="https://www.ipspace.net/Subscription">yearly subscription</a>.</p>

