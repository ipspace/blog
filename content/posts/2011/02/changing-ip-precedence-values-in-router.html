---
url: /2011/02/changing-ip-precedence-values-in-router.html
title: "Changing IP precedence values in router-generated pings"
date: "2011-02-07T06:37:00.005+01:00"
tags: [ QoS ]
---

<p>When I was <a href="https://blog.ipspace.net/2011/02/end-to-end-qos-marking-in-mplsvpn-over.html">testing QoS behavior in MPLS/VPN-over-DMVPN networks</a>, I needed a traffic source that could generate packets with different DSCP/IP precedence values. If you have enough routers in your lab (and the MPLS/DMVPN lab that was used to generate the router configurations you get as part of the <a href="https://www.ipspace.net/EnterpriseMPLS">Enterprise MPLS/VPN Deployment</a> and <a href="https://www.ipspace.net/DMVPN">DMVPN: From Basics to Scalable Networks</a> webinars has 8 routers), it’s usually easier to use a router as a traffic source than to connect an extra IP host to the lab network. Task-at-hand: generate traffic with different DSCP values from the router.</p>
<!--more--><p>Nothing easier you should say: use extended <strong>ping</strong>. I did, but it has two annoying “qualities”:</p>
<ul class="ListParagraph"><li>You cannot specify all the parameters in a single command line (and pressing ENTER 10+ times gets annoying after a few test runs);</li>
<li>The <em>Type of service </em>question expects the value for the whole TOS byte; you have to figure out the position of IP precedence in the TOS byte and shift the desired value accordingly (precedence 3 that I was using is actually TOS value 0x60).</li>
</ul>
<p>Doing a single test with extended <strong>ping </strong>is thus quite a lengthy adventure. A <a href="https://blog.ipspace.net/2010/03/qppb-in-mpls-vpn.html">differently-attentive person</a> like me could easily get bored or lured into the realm of Twitter-and-friends.</p>
<pre class="code">R1A#<strong>ping</strong><br/>Protocol [ip]:<br/>Target IP address: <strong>172.16.</strong><strong>0</strong><strong>.2</strong><br/>Repeat count [5]:<br/>Datagram size [100]:<br/>Timeout in seconds [2]:<br/>Extended commands [n]: y<br/>Source address or interface:<br/>Type of service [0]: <strong>0x60</strong><br/>Set DF bit in IP header? [no]:<br/>Validate reply data? [no]:<br/>Data pattern [0xABCD]:<br/>Loose, Strict, Record, Timestamp, Verbose[none]:<br/>Sweep range of sizes [n]:<br/>Type escape sequence to abort.<br/>Sending 5, 100-byte ICMP Echos to 172.16.0.2, timeout is 2 seconds:<br/>!!!!!<br/>Success rate is 100 percent (5/5), round-trip min/avg/max = 4/8/24 ms</pre><p>Can we do better (without <a href="https://blog.ipspace.net/2010/07/pinging-from-eem-applet.html">writing an ugly EEM applet that feeds the values to the <strong>ping </strong>command</a>)? Of course we can – the <strong>ip local policy </strong>command can be used to change several attributes of IP packets generated by the router, including DF bit and DSCP value.</p>
<p>I was always pinging the same IP address, so I wrote a very specific PBR policy: only pings to a specific IP address would get IP precedence value 3.</p>
<pre class="code">route-map LocalPolicy permit 10<br/> match ip address TestPings<br/> set ip precedence flash<br/>!<br/>ip access-list extended TestPings<br/> permit icmp any host 172.16.0.2</pre><p>The solution worked quite well; I was able to use the short-form <strong>ping 172.16.0.2</strong> and the ICMP packets were sent with IP precedence set to three. </p>
<p>Next I wanted to test multiple IP precedence values. I could have created several pingable IP addresses on the remote end, but decided to test something else: route maps used in policy-based routing can also match on a range of packet lengths. I made shorter pings more important than longer ones:</p>
<pre class="code">route-map LocalPolicy permit 10<br/> match ip address ExtraPings<br/> match length 1 200<br/> set ip precedence flash<br/>!<br/>route-map LocalPolicy permit 20<br/> match ip address ExtraPings<br/> set ip precedence immediate</pre><p>After I modified the route-map, ICMP packets generated with <strong>ping 172.16.0.2 </strong>(and default packet size of 100 bytes) had IP precedence value 3, while ICMP packets generated with <strong>ping 172.16.0.2 size 300 </strong>had IP precedence value 2. Exactly what I needed ... but of course you can extend the solution to generate even more varied IP precedence or DSCP values.</p>

