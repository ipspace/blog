---
url: /2011/02/load-balancing-in-mplsvpn-networks-with.html
title: "Load sharing in MPLS/VPN networks with route reflectors"
date: "2011-02-14T13:35:00.002+01:00"
tags: [ Workshop,load balancing,MPLS VPN ]
---

<p>Some of the e-mails and comments I received after writing the “<a href="http://blog.ioshints.info/2011/02/changing-vpnv4-route-attributes-within.html"><em>Changing VPNv4 route attributes</em></a><em>” </em>post illustrated common MPLS/VPN misconceptions, so it’s worth addressing them in a series of posts. Let’s start with the simplest scenario: load <del class="error">balancing</del><ins class="corr">sharing</ins> toward a multi-homed customer site. We’ll use a very simple MPLS/VPN network with three customer sites, four CE-routers, four PE-routers a route reflector:</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/02/s1600-MPLSVPN_MH.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="103" src="/2011/02/s320-MPLSVPN_MH.png" width="320"/></a></div>
<p>Let’s assume that we use the default MPLS/VPN RT/RD design rules: one RD and one import/export RT per simple VPN. The IPv6 (or IPv4) default routes received by PE-A and PE-B are transformed into VPNv6 (or VPNv4) routes (<tt>[RD]::/0</tt> or <tt>RD:0.0.0.0/0</tt>) and sent to RR. </p>
<!--more--><p>RR receives two identical VPNv6 (or VPNv4) routes from two sources (PE-A and PE-B), installs both of them in its BGP table, <em>selects the best one </em>and <em>sends the best one to the other BGP neighbors</em>. PE-C and PE-D thus receive only <em>a single default route</em> and forward all traffic toward PE-A or PE-B (based on the decision BGP made on RR). There is <em>absolutely no way </em>to change the RR behavior – it’s one of those BGP rules that nobody wanted to touch (yet): only the best routes in the BGP table are propagated to BGP neighbors.</p>
<p class="note">The above statement is not entirely correct – the <a href="http://www.cisco.com/en/US/docs/ios/iproute_bgp/configuration/guide/irg_best_external.pdf">BGP Best External</a> feature is violating that rule and advertising <em>best external </em>route even when <em>better internal </em>route exists.</p>
<p>To enable PE-C and PE-D to forward traffic toward PE-A <em>and </em>PE-B, you have to make the two default routes somehow different. The <em>only </em>trick that works is changing the RD on one of them:</p>
<ul class="ListParagraph"><li>PE-A advertises the default route received from CE-A as <tt>[RD1]::/0</tt> (or <tt>RD1:0.0.0.0/0</tt>)</li>
<li>PE-B advertises the default route received from CE-B as <tt>[RD2]::/0</tt> (or <tt>RD2:0.0.0.0/0</tt>)</li>
<li>RR receives <em>two different routes </em>(within the VPNv6 address family, <tt>[RD1]::/0</tt> and <tt>[RD2]::/0</tt> are different routes) and propagates <em>both of them </em>to PE-C and PE-D.</li>
<li>PE-C and PE-D receive <em>both routes</em> and import <em>both of them </em>into the same VRF (remember: imports are based on RT, not RD) , enabling true load sharing toward PE-A and PE-B.</li>
</ul>
<p class="note">You have to configure BGP load sharing with the <strong>maximum-paths ibgp </strong><strong><em>number </em></strong>router configuration command within the IPv4 VRF address family on PE-C and PE-D, otherwise they will not insert more than one BGP route into the VRF IP routing table (even though two routes are present in the BGP table).</p>
<h4>More information</h4><p>If you’re considering MPLS/VPN deployment in your enterprise network, <a href="http://mpls.eventbrite.com/">register for</a> my <a href="http://www.ioshints.info/Enterprise_MPLS_VPN_Deployment">Enterprise MPLS/VPN Deployment</a> webinar. </p>
<p>If you were not familiar with this trick and plan to implement MPLS/VPN networks, I would strongly recommend reading my <a href="http://www.amazon.com/gp/product/1587050021?ie=UTF8&amp;tag=cisioshinandt-20&amp;linkCode=as2&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1587050021">MPLS and VPN Architectures</a> book (based on the technologies you want to implement, you might want to read <a href="http://www.amazon.com/gp/product/1587051125?ie=UTF8&amp;tag=cisioshinandt-20&amp;linkCode=as2&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1587051125">Volume 2</a> as well). <a href="http://www.amazon.com/gp/product/1587142414?ie=UTF8&amp;tag=cisioshinandt-20&amp;linkCode=as2&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1587142414">Definitive MPLS Network Designs</a> is also a good choice if you’re involved in MPLS network design.</p>

