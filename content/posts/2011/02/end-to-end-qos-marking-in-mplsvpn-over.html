---
url: /2011/02/end-to-end-qos-marking-in-mplsvpn-over.html
title: "End-to-end QoS marking in MPLS/VPN-over-DMVPN networks"
date: "2011-02-02T06:27:00.005+01:00"
tags: [ DMVPN,Workshop,MPLS VPN,QoS ]
---

<p>I got a great question in one of my <a href="http://www.ioshints.info/EnterpriseMPLS">Enterprise MPLS/VPN Deployment</a> webinars (<a href="http://mpls.eventbrite.com/">register here</a>) when I was describing how you could run MPLS/VPN across DMVPN cloud:</p>
<blockquote class="cite">That sounds great, but how does end-to-end QoS work when you run IP-over-MPLS-over-GRE-over-IPSec-over-IP?</blockquote>
<p>My initial off-the-cuff answer was:</p>
<blockquote class="cite">Well, when the IP packet arriving through a VRF interface gets its MPLS label, the IP precedence bits from the IP packet are copied into the MPLS EXP (now TC) bits. As for what happens when the MPLS packet gets encapsulated in a GRE packet and when the GRE packet is encrypted ... I have no clue. I need to test it.</blockquote>
<!--more--><p>Finally I found some time to do proper lab tests. I fired up one of my MPLS/VPN-over-DMVPN labs, turned one of the remote site routers (R1A in the following diagram) into a traffic source host (by disabling all its interface but its LAN interface) and started my tests.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2011/02/s1600-ADV_PhaseI_MPLSVPN_Topology.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="188" src="/2011/02/s320-ADV_PhaseI_MPLSVPN_Topology.png" width="320"/></a></div>
<p class="more">Have I told you that you get 10 different sets of router configurations, covering everything from Multi-VRF to MPLS/VPN-over-DMVPN with the <a href="http://www.ioshints.info/EnterpriseMPLS">Enterprise MPLS/VPN Deployment</a> webinar? <a href="http://www.ioshints.info/DMVPN">DMVPN: From Basics to Scalable Networks</a> has even more labs: you get complete router configurations for more than 20 full-blown DMVPN labs, each one having 2 hub routers and 4 spoke routers.</p>
<p><strong>MPLS label imposition</strong>. The default behavior of Cisco IOS is to copy IP precedence bits (the upper part of DSCP value) into MPLS EXP (aka TC) bits during label imposition.</p>
<p class="warn">Update 2011-02-05: This part of the post has been totally rewritten as the <a href="http://blog.ioshints.info/2011/02/week-of-blunders.html">unusual behavior I “discovered” in my early lab tests turned out to be totally irreproducible</a>.</p>
<p>You can change the default behavior by specifying the desired value in a <strong>policy-map</strong> that you apply as <em>inbound </em><strong>service-policy</strong> on the VRF interface (VPN label imposition seems to be conceptually tied to the incoming VRF interface, not the outgoing MPLS interface). For example, to ignore the IP precedence bits on untrusted interfaces and set MPLS EXP/TC bits to zero, use the following QoS service policy:</p>
<pre class="code">policy-map SetMPLSExp<br/> class class-default<br/>  set mpls experimental imposition 0<br/>!<br/>interface FastEthernet0/0<br/> ip vrf forwarding VPN<br/> ip address 172.16.10.2 255.255.255.0<br/> service-policy input SetMPLSExp</pre><p class="note">The need to configure <em>inbound </em>service policy surprised me (I wanted to configure <em>outbound </em>service policy on the DMVPN interface), but is actually a great solution: you can apply different policies to different VRF interfaces and trust IP precedence markings on per-interface basis.</p>
<p><strong>Propagation of MPLS EXP bits into GRE/IPSec headers</strong>. I was pleasantly surprised to find out that the MPLS EXP bits get copied into IP precedence bits of the GRE envelope with no extra configuration. As I’m always using IPSec in transport mode in DMVPN designs, IPSec encryption does not touch the IP header (including IP precedence) and thus we get the desired end-to-end IP precedence markings with minimal efforts.</p>

