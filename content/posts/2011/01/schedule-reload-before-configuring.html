---
url: /2011/01/schedule-reload-before-configuring/
title: "Schedule reload before configuring the router"
date: "2011-01-04T06:21:00.000+01:00"
tags: [ EEM ]
---

<p>John McManus published excellent <a href="http://etherealmind.com/remote-in-band-configuration-tips/">Remote (in Band) Configuration Tips </a>post on etherealmind.com last week, prompting a “<a href="http://twitter.com/mfratto/status/18034307402567680">Too bad there isn't a fix for forgetting ‘reload in’</a>” tweet by <a href="http://twitter.com/mfratto/">@mfratto</a>. My immediate reaction was “this should be easy to solve with EEM” ... and it is.</p>
<!--more--><p>Before going into details, I must warn you – don’t play with EEM applets that catch CLI commands on production devices. Develop and test the applet in your lab (using the very same IOS release you’re running in your production network), then download it into your production environment. Furthermore, if you manage to mangle an applet that catches critical configuration commands (for example, <strong>configure terminal</strong>), the only way to recover is a reload (assuming, of course, that haven’t already executed <strong>write mem</strong> ... oops, <strong>copy running-config startup-config</strong>, in which case you’ll be able to practice your password recovery skills). </p>
<p>I hate router-reload-induced thumb twiddling, so I made sure I had a recovery path – an applet that removes my applet:</p>
<pre class="code">event manager applet Cleanup authorization bypass <br/> event none<br/> action 1 cli command "enable"<br/> action 2 cli command "configure terminal"<br/> action 3 cli command "no event manager applet ConfigReload"</pre><p>As long as I left the <strong>event manager </strong>command intact, I was safe – I could always execute the <strong>event manager run Cleanup</strong> command.</p>
<p>Here’s the full-blown version of the applet:</p>
<pre class="code">event manager applet ConfigReload <br/> event cli pattern "^configure" sync yes<br/> action 1.0 puts "You are going to configure the router"<br/> action 1.1 puts nonewline "Schedule the reload [Y/N]"<br/> action 1.3 gets ans<br/> action 1.4 string tolower "$ans"<br/> action 1.5 string match "$_string_result" "y"<br/> action 2.0 if $_string_result eq 1<br/> action 2.1  cli command "enable"<br/> action 2.2  cli command "reload cancel"<br/> action 2.3  cli command "configure terminal"<br/> action 2.4  cli command "exit"<br/> action 2.5  cli command "reload in 15" pattern "yes"<br/> action 2.6  cli command "n" pattern "confirm"<br/> action 2.7  cli command "y"<br/> action 2.8  puts "Reload has been scheduled, don't forget to cancel it!"<br/> action 2.9 end<br/> action 99  set _exit_status "1"</pre><p>The sequence of commands executed in the applet is a bit convoluted: the <strong>reload in 15 </strong>command asks you whether you want to save the modified configuration, but only if the running configuration hasn’t been saved. I was too lazy to implement robust prompt handling, so the applet simply executes <strong>configure terminal </strong>to mark the running configuration modified. After that, we know exactly what the <strong>reload </strong>prompts are.</p>
<p>The applet uses numerous features of EEM 3.0; if you have a device running an older IOS release, the bare bones version of the applet might work for you:</p>
<pre class="code">event manager applet ConfigReload <br/> event cli pattern "^configure" sync yes<br/> action 2.1  cli command "enable"<br/> action 2.2  cli command "reload cancel"<br/> action 2.3  cli command "configure terminal"<br/> action 2.4  cli command "exit"<br/> action 2.5  cli command "reload in 15" pattern "yes"<br/> action 2.6  cli command "n" pattern "confirm"<br/> action 2.7  cli command "y"<br/> action 99  set _exit_status "1"</pre>

