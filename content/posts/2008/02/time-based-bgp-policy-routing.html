---
url: /2008/02/time-based-bgp-policy-routing.html
title: "Time-based BGP policy routing"
date: "2008-02-25T07:14:00.002+01:00"
tags: [ BGP,EEM ]
---

Petr Lapukhov describes an interesting scenarion in his post <a href="http://blog.internetworkexpert.com/2008/01/25/bgp-time-based-policy-routing/">BGP Time-Based Policy Routing</a>: a multi-homed customer that uses one upstream link (for example, more reliable but slower one) during the work hours, switching to the other upstream link (faster, less reliable) after that. <br/><br/>He uses BGP communities to achieve the switch (perfect solution if your ISP supports them) and time-based ACL in a <strong>route-map</strong> to set the community based on time-of-day. As Cisco changed the way BGP imports local routes in IOS release 12.3T, he then devises an ingenious solution based on <a href="https://blog.ipspace.net/2007/02/reliable-static-routing.html">reliable static routing</a> to trigger a change in the IP routing table. <br/><br/>The optimum solution is way simpler: you just configure two EEM applets to perform <strong>clear ip route <em>network</em></strong> command at appropriate times.<!--more-->Here is a tested configuration that changes BGP community of a locally sourced route one minute after the <strong>time-range</strong> changes state:<pre class="code">router bgp 65001<br/> network 172.18.1.0 mask 255.255.255.0 route-map TimeBasedCommunity<br/>!<br/>ip access-list extended MatchWorkingHours<br/> permit ip any any time-range WorkDay<br/>!<br/>time-range WorkDay<br/> periodic weekdays 9:00 to 16:59<br/>!<br/>route-map TimeBasedCommunity permit 10<br/> match ip address MatchWorkingHours<br/> set community 10:25 additive<br/>!<br/>route-map TimeBasedCommunity permit 15<br/>!<br/>event manager applet WeekdayStart<br/> event timer cron name "WeekdayStart" cron-entry "1 9 * * 1-5"<br/> action 1.0 cli command "enable"<br/> action 2.0 cli command "clear ip route 172.18.1.0"<br/>!<br/>event manager applet WeekdayEnd<br/> event timer cron name "WeekdayEnd" cron-entry "1 17 * * 1-5"<br/> action 1.0 cli command "enable"<br/> action 2.0 cli command "clear ip route 172.18.1.0"</pre><p>The <strong>cron-entry</strong> parameter in the <strong>event timer cron</strong> command specifies that the applet is run one minute after 9AM or 5PM (the reverse time/date order makes it particularly confusing) on every day of every month (the two asterisks) but only on weekdays (the 1-5 parameter for the day-of-week).</p>
<p class="note">I've decided to create two EEM applets to be able to perform different actions on the start/stop events. If you don't need that functionality, just merge them into a single applet; the <strong>cron-entry</strong> then becomes <em>"1 9,17 * * 1-5"</em>.</p>

