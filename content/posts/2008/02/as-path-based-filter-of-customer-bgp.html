---
url: /2008/02/as-path-based-filter-of-customer-bgp.html
title: "AS-path based filter of customer BGP routes"
date: "2008-02-13T07:04:00.003+01:00"
tags: [ BGP ]
---

<p>Any serious (or at least security-aware) ISP should not blindly accept BGP routes from its customers but at the very minimum do some sanity checks on them. For example, if a multi-homed customer is clumsy enough to advertise BGP routes between service providers, it’s nice if you still stop him from turning into a transit AS. The required filter is conceptually quite simple: all the BGP routes from the customer should contain only his AS number in the AS-path.</p>
<p class="info">If you're looking for more in-depth BGP knowledge, try our <a href="http://www.nil.si/ls/BS_BGP32?showlp">Configuring BGP on Cisco Routers</a> <a href="http://www.nil.si/C1256F0A00429755/html/bs_portfolio">e-learning solution</a>. If you just need to enhance your hands-on skill, the <a href="http://www.nil.si/ls/LB_RL_BGP32?showlp">BGP Remote Lab Bundle</a> is the perfect choice.</p>
<!--more--><p>The initial non-scalable approach is obvious: accept only the AS paths that have exactly the customer’s AS number in the AS path. For example, if your customer’s AS number is 65001, you could use this filter: <strong>ip as-path access-list 100 permit ^65001$</strong>.</p>
<p class="note"><strong>Note:</strong> the <em>caret sign</em> at the beginning of the string and the <em>dollar sign</em> at its end are mandatory; otherwise the <strong>as-path access-list</strong> will match any AS-path with the string 65001 in it.</p>
<p>A more generic approach might recognize that the AS path received from the customer shall contain a single AS number, so the filter can be rewritten as <strong>ip as-path access-list 100 permit ^[0-9]+$</strong>, where the expression <strong>[0-9]+</strong> matches <em>one or more digits</em> (also known as <em>a number</em>). </p>
<p>Both filters described above have a common problem: they fail if the customer is using <a href="https://blog.ipspace.net/2008/02/bgp-essentials-as-path-prepending.html">AS-path prepending</a>. In those cases, you should accept all AS-paths that contain a single number (potentially repeating multiple times). The explicit filter is simple: <strong>ip as-path access-list 100 permit ^65001(_65001)*$</strong>. This filter matches all AS paths that start with 65001 and contain zero or more occurrences of a delimiter (whitespace) followed by 65001. </p>
<p>Writing an implicit AS-path filter that recognizes AS-path prepending is trickier and requires the use of pattern recall – part of regular expression could match a pattern recognized earlier in the regular expression. In our case, the first AS number recognized could be repeated many times over as expressed with this cryptic filter: <strong>ip as-path access-list 100 permit ^([0-9]+)(_\1)*$</strong>. The <strong>\1</strong> part of the filter is pattern recall and matches whatever was matched within the first parenthesis (the first AS number in the AS path).</p>
<p class="info">Cisco partners and employees can access the <a href="http://cisco.partnerelearning.com/pec/Direct.asp?URL=20111033262035.1810 ">Employing AS-Path Filters remote lab</a> free-of-charge on the <a href="http://cisco.partnerelearning.com/">Partner Education Connection</a>.</p>

