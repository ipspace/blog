---
url: /2008/12/this-is-qos-who-cares-about-real-time.html
title: "This is QoS; who cares about real-time response?"
date: "2008-12-11T06:42:00.000+01:00"
tags: [ network management,Tcl,You've asked for it,QoS ]
---

<div class="bloggerBody"><p>It all started with a innocuous question: can you <a href="http://www.xmission.com/~hidden/aatqos/">detect voice traffic</a> with EEM? Looks simple enough: create a QoS class-map that matches voice calls and read the <tt>cbQosClassMapStats</tt> table in the CISCO-CLASS-BASED-QOS-MIB. The first obstacle was finding the correct indexes, but a <a href="http://wiki.nil.com/Class-based_QoS_MIB_indexes">Tcl script quickly solved that</a>; I was ready to create the EEM applet. The applet failed to work correctly and after lots of debugging I figured out the counters in the <tt>cbQosClassMapStats</tt> table <a href="https://blog.ipspace.net/2008/12/update-interval-for-ios-mib-counters.html">change only every 10 seconds</a>.</p>
<p>I couldn’t believe my eyes and simply had to test other MIB variables as well. As expected, the IF-MIB (standard interface MIB) counters increase in real-time, but obviously someone had the bright idea that we need to detect changes in traffic profile only every now and then. Although I've <a href="https://blog.ipspace.net/2008/12/update-interval-for-ios-mib-counters.html?showComment=1228864320000#c6315357989882685787">received suggestions from my readers</a>, none of them works on an 1800 or a 7200. Oh, well, Cisco developers from the days when I started working with routers would know better.</p>
<!--more--><p><a href="http://wiki.nil.com/"><img src="http://www.ioshints.info/images/Wiki.png" style="border: medium none; float: right; padding-bottom: 10px; padding-left: 10px;"/></a>To test the MIB variable behavior I wrote a <a href="http://wiki.nil.com/Continuously_poll_MIB_variables">simple Tcl script to test the MIB variables</a>. It reads the specified MIB variable at fixed intervals and prints the values, so you can monitor the changes in the MIB variable in real-time. I started low-bandwidth UDP flood across the router and monitored the <em>output bytes </em>interface counter. As expected the counter changed in real time and accurately tracked the amount of traffic sent through the router.</p>
<pre class="code">GW#<strong>pm ifOutOctets.3 public 10 1000</strong>          <br/>polling ifOutOctets.3 for 10 seconds (10 iterations)<br/><br/> 0.000 ifOutOctets.3=42528679        <br/> 1.000 ifOutOctets.3=42537767        <br/> 2.000 ifOutOctets.3=42546713        <br/> 3.000 ifOutOctets.3=42555719        <br/> 4.000 ifOutOctets.3=42564665        <br/> 5.000 ifOutOctets.3=42573611        <br/> 6.000 ifOutOctets.3=42582699        <br/> 7.000 ifOutOctets.3=42591645        <br/> 8.000 ifOutOctets.3=42600591        <br/> 9.000 ifOutOctets.3=42609537        </pre><p>Then I created a simple <strong>class-map </strong>and <strong>policy map</strong> …</p>
<pre class="code">GW#<strong>show policy-map interface</strong><br/> FastEthernet1/0 <br/><br/>  Service-policy output: LAN<br/><br/>    Class-map: Voice (match-all)<br/>      20438 packets, 2902196 bytes<br/>      30 second offered rate 70000 bps<br/>      Match: access-group name Voice<br/><br/>    Class-map: class-default (match-any)<br/>      41 packets, 3967 bytes<br/>      30 second offered rate 0 bps, drop rate 0 bps<br/>      Match: any </pre><p>… and monitored the pre-policy byte counter (<tt>cbQosCMPrePolicyByte64</tt>) for the Voice class. The value changed only once every ten seconds:</p>
<pre class="code">GW#<strong>pm cbQosCMPrePolicyByte64.50.10767521 public 10 1000</strong><br/>polling cbQosCMPrePolicyByte64.50.10767521 for 10 seconds (10 iterations)<br/><br/> 0.000 cbQosCMPrePolicyByte64.50.10767521=0x002865366<br/> 1.000 cbQosCMPrePolicyByte64.50.10767521=0x002865366<br/> 2.000 cbQosCMPrePolicyByte64.50.10767521=0x002865366<br/> 3.000 cbQosCMPrePolicyByte64.50.10767521=0x002865366<br/> 4.000 cbQosCMPrePolicyByte64.50.10767521=0x002865366<br/> 5.000 cbQosCMPrePolicyByte64.50.10767521=0x002865366<br/> 6.000 cbQosCMPrePolicyByte64.50.10767521=0x00287acf8<br/> 7.000 cbQosCMPrePolicyByte64.50.10767521=0x00287acf8<br/> 8.000 cbQosCMPrePolicyByte64.50.10767521=0x00287acf8<br/> 9.000 cbQosCMPrePolicyByte64.50.10767521=0x00287acf8</pre><p>What can I say ... apart from expressing my deepest disappointment :(</p>
</div>

