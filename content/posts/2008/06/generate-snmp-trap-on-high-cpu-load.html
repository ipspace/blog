---
url: /2008/06/generate-snmp-trap-on-high-cpu-load.html
title: "Generate SNMP trap on high CPU load"
date: "2008-06-02T07:29:00.002+02:00"
tags: [ network management,ERM,EEM ]
---

Gernot Nusshall has asked an interesting question:<blockquote class="cite">How could I configure the EEM to send an SNMP trap when the cpu load (interval=30sec) is higher than 30%?</blockquote>
My first solution was to enable resource policy traps with the <strong>snmp-server enable traps resource-policy</strong>, but this feature was introduced in 12.4(15)T and I am not sure everyone is willing to run the latest-and-greatest IOS code. Furthermore, it looks like the traps are sent only for resource policies defined through the <a href="http://www.cisco.com/en/US/docs/ios/netmgmt/configuration/guide/nm_erm_mib_ps6441_TSD_Products_Configuration_Guide_Chapter.html">ERM MIB</a>; I was not able to generate a trap from a manually configured resource policy. Obviously it was time for another EEM applet.<!--more-->The EEM version 2.0 (<a href="http://www.cisco.com/en/US/docs/ios/12_2sx/sw_modularity/configuration/guide/nmb_eemo.html#wp1051170">available in 12.2S, 12.3T and 12.4</a>) includes the <strong>action snmp-trap</strong> command, which can generate a trap from an EEM applet. To generate CPU utilization traps, <a href="https://blog.ipspace.net/2008/03/detect-cpu-spikes-with-embedded.html">configure the desired resource policy</a> and <a href="https://blog.ipspace.net/2008/03/use-eem-to-respond-to-erm-events.html">an EEM applet that is triggered on the ERM policy event</a>. The simplest EEM applet would just report a change in ERM policy …<pre class="code">event manager applet ReportHighCPU<br/> event resource policy "HighGlobalCPU"<br/> action 1.0 snmp-trap strdata "High CPU"<br/></pre><p>… but as the applet would be run on <em>rising</em> and <em>falling</em> events, it would make sense to include a few <a href="http://www.cisco.com/en/US/docs/ios/12_2sx/sw_modularity/configuration/guide/nmb_eemc.html#wp1071127">_resource_* environment variables</a> in the SNMP trap data. Last but not least, don't forget to enable EEM traps with the <strong>snmp-server enable traps event-manager</strong> configuration command.</p>
<p class="more">This article is part of <a href="https://blog.ipspace.net/2007/01/youve-asked-for-it-series.html">You've asked for it</a> <a href="https://blog.ipspace.net/tag/youve-asked-for-it.html">series</a>.</p>

