---
url: /2008/03/use-eem-to-respond-to-erm-events/
title: "Use EEM to respond to ERM events"
date: "2008-03-17T07:15:00.005+01:00"
tags: [ ERM,EEM ]
---

In a previous post, <a href="/2008/03/detect-cpu-spikes-with-embedded/">I've described how you can detect high CPU load with the Embedded Resource Manager (ERM)</a>. If you want to respond to these events, you could use the syslog event detector within EEM, but it's more reliable to use the new event resource detector <a href="http://www.cisco.com/en/US/docs/ios/12_4t/12_4t2/ht_eem.html">available in EEM version 2.2</a> (introduced in IOS release 12.4(2)T). The resource detector is best used in Tcl policy; if you use it in EEM applet, the same applet is triggered every time a resource policy threshold (minor/major/critical, rising or falling) is crossed. Within the EEM applet it's almost impossible to detect which threshold was crossed.<br/><br/>However, even EEM applet could solve some immediate problems. For example, if you want to store a snapshot of processes on a TFTP server every time the global CPU load crosses a policy threshold, you could use the following applet:<blockquote class="code">event manager applet ReportHighCPU<br/> event resource policy "HighGlobalCPU"<br/> action 1.0 cli command "show process cpu sorted 5sec | redirect tftp://10.0.0.10/highCPU$_resource_time_sent.txt"</blockquote>
<p class="note">To differentiate the snapshots, I've appended the _resource_time_sent variable <a href="http://www.cisco.com/en/US/docs/ios/12_4t/12_4t2/ht_eem.html#wp1051705">set by the EEM before the applet is started</a> to the file name, guaranteeing that the snapshot files will have unique names (at least until the router reload).</p>
As an alternative, you could send the <strong>show process</strong> output <a href="/2007/11/send-e-mail-when-interface-goes-down/">in an e-mail</a>:<pre class="code">event manager environment _ifDown_rcpt admin@lab.com<br>!<br>event manager applet ReportHighCPU<br/> event resource policy "HighGlobalCPU"<br/> action 1.0 cli command "show process cpu sorted 5sec"<br> action 1.1 info type routername<br> action 2.0 mail server "mail-gw" →<br/>    to "$_ifDown_rcpt" from "$_info_routername@lab.com" →<br/>    subject "CPU @ $_resource_current_value" →<br/>    body "$_cli_result"</br></br></br></br></pre><p class="more">This article is part of <a href="/2007/01/youve-asked-for-it-series/">You've asked for it</a> <a href="/tag/youve-asked-for-it/">series</a>.</p>

