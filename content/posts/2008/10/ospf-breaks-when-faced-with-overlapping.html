---
url: /2008/10/ospf-breaks-when-faced-with-overlapping.html
title: "OSPF breaks when faced with overlapping IP addresses"
date: "2008-10-17T06:37:00.001+02:00"
tags: [ OSPF,PPP,WAN ]
---

<div class="bloggerBody"><p>A while ago <a href="http://cciepursuit.wordpress.com/">cciepursuit</a> described his <a href="http://cciepursuit.wordpress.com/2008/09/21/ios-error-with-ospf-point-to-multipoint-network-in-pppofr-hub-and-spoke-topology/">problems with PPP-over-Frame Relay</a>. Very probably his problems were caused by a static IP address assigned to the virtual template interface (this address gets cloned to all virtual access interfaces and IOS allows you to have the same IP address on multiple WAN point-to-point links). I recreated very similar (obviously seriously broken) scenario in my lab using point-to-point subinterfaces over Frame Relay to simplify the setup.</p>
<p class="warn">This is not something you’d want to do in your production network.</p>
<!--more--><p>The relevant parts of router configurations are included below:</p>
<pre class="code">S1#<strong>show run | section interface Serial</strong><br/>interface Serial1/0<br/> no ip address<br/> encapsulation frame-relay<br/>!<br/>interface Serial1/0.100 point-to-point<br/> description Link to C1<br/> ip address 10.0.8.2 255.255.255.240<br/> frame-relay interface-dlci 100<br/><br/>S2#<strong>show run | section interface Serial</strong><br/>interface Serial1/0<br/> no ip address<br/> encapsulation frame-relay<br/> frame-relay lmi-type ansi<br/>!<br/>interface Serial1/0.100 point-to-point<br/> description Link to C1<br/> ip address 10.0.8.3 255.255.255.240<br/> frame-relay interface-dlci 100<br/><br/>C1#<strong>show run | section interface Serial</strong><br/>interface Serial1/0<br/> no ip address<br/> encapsulation frame-relay<br/>!<br/>interface Serial1/0.100 point-to-point<br/> description Link to S1<br/> ip address 10.0.8.1 255.255.255.240<br/> frame-relay interface-dlci 100<br/>!<br/>interface Serial1/0.101 point-to-point<br/> description Link to S2<br/> ip address 10.0.8.1 255.255.255.240<br/> frame-relay interface-dlci 101</pre><p>I expected the distance vector protocols to work flawlessly, as they track the next-hop as well as inbound interface over which the routing update was received. With the following RIP configuration on all three routers …</p>
<pre class="code">router rip<br/> version 2<br/> network 10.0.0.0<br/> no auto-summary</pre><p>… the routing table on C1 looked almost OK, apart from the weird entry for the 10.0.8.0/28 subnet:</p>
<pre class="code">C1#<strong>show ip route | begin Gateway</strong><br/>Gateway of last resort is not set<br/><br/>     10.0.0.0/8 is variably subnetted, 5 subnets, 3 masks<br/>C       10.0.8.0/28 is directly connected, Serial1/0.100<br/>                    is directly connected, Serial1/0.101<br/>R       10.0.0.2/32 [120/1] via 10.0.8.3, 00:00:01, Serial1/0.101<br/>C       10.0.0.3/32 is directly connected, Loopback0<br/>R       10.0.0.1/32 [120/1] via 10.0.8.2, 00:00:02, Serial1/0.100</pre><p>The next routing protocol was EIGRP; configuration was very similar to the RIP case:</p>
<pre class="code">router eigrp 1<br/> network 10.0.0.0<br/> no auto-summary</pre><p>Yet again, the IP routing table looks as expected:</p>
<pre class="code">C1#<strong>show ip route | begin Gateway</strong><br/>Gateway of last resort is not set<br/><br/>     10.0.0.0/8 is variably subnetted, 4 subnets, 2 masks<br/>C       10.0.8.0/28 is directly connected, Serial1/0.100<br/>                    is directly connected, Serial1/0.101<br/>D       10.0.0.2/32 [90/2297856] via 10.0.8.3, 00:02:33, Serial1/0.101<br/>C       10.0.0.3/32 is directly connected, Loopback0<br/>D       10.0.0.1/32 [90/2297856] via 10.0.8.2, 00:02:33, Serial1/0.100</pre><p>OSPF also behaved as expected, producing weird results. I never got both remote routes in the IP routing table on C1; one of them (or even both of them) was missing. This is not surprising; OSPF builds the SPF tree from the topology database and gets totally confused when two interfaces have the same IP address. </p>
<p>The information in the topology database is correct; in my lab, C1 advertised that it can reach S1 and S2 (both of them appeared as router-to-router links in the router LSA) …</p>
<pre class="code">C1#<strong>show ip ospf database router self-originate</strong><br/><br/>            OSPF Router with ID (10.0.0.3) (Process ID 2)<br/><br/>                Router Link States (Area 1)<br/><br/>  LS age: 283<br/>  Options: (No TOS-capability, DC)<br/>  LS Type: Router Links<br/>  Link State ID: 10.0.0.3<br/>  Advertising Router: 10.0.0.3<br/>  Number of Links: 5<br/><br/>    Link connected to: a Stub Network<br/>     (Link ID) Network/subnet number: 10.0.0.3<br/>     (Link Data) Network Mask: 255.255.255.255<br/>      Number of TOS metrics: 0<br/>       TOS 0 Metrics: 1<br/><br/><span class="high">    Link connected to: another Router (point-to-point)</span><br/><span class="high">     (Link ID) Neighboring Router ID: 10.0.0.2</span><br/><span class="high">     (Link Data) Router Interface address: 10.0.8.1</span><br/><span class="high">      Number of TOS metrics: 0</span><br/><span class="high">       TOS 0 Metrics: 64</span><br/><br/>    Link connected to: a Stub Network<br/>     (Link ID) Network/subnet number: 10.0.8.0<br/>     (Link Data) Network Mask: 255.255.255.240<br/>      Number of TOS metrics: 0<br/>       TOS 0 Metrics: 64<br/><br/><span class="high">    Link connected to: another Router (point-to-point)</span><br/><span class="high">     (Link ID) Neighboring Router ID: 10.0.0.1</span><br/><span class="high">     (Link Data) Router Interface address: 10.0.8.1</span><br/><span class="high">      Number of TOS metrics: 0</span><br/><span class="high">       TOS 0 Metrics: 64</span><br/><br/>    Link connected to: a Stub Network<br/>     (Link ID) Network/subnet number: 10.0.8.0<br/>     (Link Data) Network Mask: 255.255.255.240<br/>      Number of TOS metrics: 0<br/>       TOS 0 Metrics: 64</pre><p>… but OSPF got totally confused when trying to build the SPF tree, deciding that one (or both) of remote routers was unreachable:</p>
<pre class="code">C1#<strong>show ip ospf database router adv-router 10.0.0.1</strong><br/><br/>            OSPF Router with ID (10.0.0.3) (Process ID 2)<br/><br/>                Router Link States (Area 1)<br/><br/>  <span class="high">Adv Router is not-reachable</span><br/>  LS age: 356<br/>  Options: (No TOS-capability, DC)<br/>  LS Type: Router Links<br/>  Link State ID: 10.0.0.1<br/>  Advertising Router: 10.0.0.1<br/>  Number of Links: 3<br/><br/>    Link connected to: another Router (point-to-point)<br/>     (Link ID) Neighboring Router ID: 10.0.0.3<br/>     (Link Data) Router Interface address: 10.0.8.2<br/>      Number of TOS metrics: 0<br/>       TOS 0 Metrics: 64<br/><br/>    Link connected to: a Stub Network<br/>     (Link ID) Network/subnet number: 10.0.8.0<br/>     (Link Data) Network Mask: 255.255.255.240<br/>      Number of TOS metrics: 0<br/>       TOS 0 Metrics: 64<br/><br/>    Link connected to: a Stub Network<br/>     (Link ID) Network/subnet number: 10.0.0.1<br/>     (Link Data) Network Mask: 255.255.255.255<br/>      Number of TOS metrics: 0<br/>       TOS 0 Metrics: 1</pre><p>In my humble opinion, IOS could do better (the topology table has enough information to build the correct SPF tree), but this is a nonetheless a broken design that a router should never be exposed to.</p>
<p class="info">Summary: Virtual template interfaces should be unnumbered to prevent address overlap on virtual access interfaces. If you insist on using a fixed IP address on virtual template interfaces, don’t expect OSPF to work.</p>
</div>

