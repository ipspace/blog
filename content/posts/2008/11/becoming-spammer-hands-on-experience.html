---
url: /2008/11/becoming-spammer-hands-on-experience.html
title: "Becoming a spammer: hands-on experience"
date: "2008-11-11T17:37:00.003+01:00"
tags: [ security ]
---

<p><a href="http://commons.wikimedia.org/wiki/Image:Brad_Pitt_horse,_%C3%87anakkale.jpg"><img src="http://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Brad_Pitt_horse%2C_%C3%87anakkale.jpg/120px-Brad_Pitt_horse%2C_%C3%25" style="float: right; margin: 0 0 5px 10px;"/></a>Reading the stories of Windows workstations becoming members of a spam botnet becomes way less enjoyable when you’re faced with the same problem (<a href="https://blog.ipspace.net/2008/11/off-topic-disappointed-by-antivirus.html">one of my kids managed to install a Trojan</a>). It took me a day to clean the infected computer (it would have been easier to just format it, but the repeated installation of the Windows XP + Office software is so boring), but I’ve learned a few interesting networking lessons in the process that I’ll document in the next days.<!--more--></p>
<p>Let’s start with an easy one: once you discover one of your workstations is opening a lot of SMTP sessions, immediately block it on the firewall router (this access list will also help you verify that you've removed all spam-related infections). I’ve used the simplest access list possible; it blocks the outbound SMTP sessions from the infected workstation.</p>
<pre class="code">ip access-list extended Inside<br/> deny   tcp host 192.168.200.198 any eq smtp log<br/> permit ip any any<br/>!<br/>interface Vlan1<br/> ip access-group Inside in</pre><p>If you want a more sophisticated solution, you might log the outbound TCP sessions of the affected PC. The following access list blocks all outbound SMTP sessions and logs the SYN packets of outbound TCP sessions. DNS over UDP is allowed, but all other UDP is blocked. All other hosts are not affected (the <strong>permit ip any any </strong>at the end):</p>
<pre class="code">ip access-list extended InsideLog<br/> deny   tcp host 192.168.200.198 any eq smtp log<br/> permit tcp host 192.168.200.198 any established<br/> permit tcp host 192.168.200.198 any log<br/> permit udp host 192.168.200.198 any eq domain<br/> deny   udp host 192.168.200.198 any<br/> permit ip any any</pre><p>Recent IOS releases support access list matching on individual bits in the TCP header. Using this functionality, you can match and log only TCP packets with SYN bit set (the rest of the TCP session is permitted due to <strong>permit ip any any </strong>at the end).</p>
<pre class="code">ip access-list extended InsideLog<br/> deny   tcp host 192.168.200.198 any eq smtp log<br/> permit tcp host 192.168.200.198 any syn log<br/> permit udp host 192.168.200.198 any eq domain<br/> deny   udp host 192.168.200.198 any<br/> permit ip any any</pre>

