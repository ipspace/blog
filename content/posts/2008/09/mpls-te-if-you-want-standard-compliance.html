---
date: 2008-09-22T07:24:00.000+02:00
tags:
- MPLS
- you've asked for it
- traffic engineering
title: 'MPLS TE: If you want standard compliance, you have to ask nicely'
url: /2008/09/mpls-te-if-you-want-standard-compliance.html
---

<div class="bloggerBody"><p>In a comment to my post describing the <a href="https://blog.ipspace.net/2008/08/is-label-imposed-in-case-of-penultimate.html">role of implicit NULL in LDP</a>, an anonymous commenter <a href="https://blog.ipspace.net/2008/08/is-label-imposed-in-case-of-penultimate.html?showComment=1219355400000">complained about lack of Cisco’s standard compliance in MPLS TE tunnel setup process</a>. Time for packet capture and Wireshark :). The tests were performed on <a href="http://wiki.nil.com/MPLS_troubleshooting_with_LSP_ping">the MPLS TE network</a> I’ve used to illustrate <a href="http://wiki.nil.com/MPLS_troubleshooting_with_LSP_ping">MPLS troubleshooting with LSP ping</a>; packets were captured on the link between C4 and C2 (the penultimate hop and the tunnel tail-end) at the time when the MPLS TE tunnel was established from C1 to C2. In all tests, an ICMP Echo Request packet was sent over the tunnel to verify whether C4 performed PHP or used an MPLS shim header on the last hop of the tunnel.</p>
<p></p>
<!--more--><p>With the default settings, C2 signaled that C4 should use <em>explicit NULL </em>(label = 0), but C2 performed PHP (which is the usual action the penultimate hop of an MPLS TE tunnel should do). The wireshark decodes are shown below (note that C4 sends the ICMP packet traversing the tunnel without the MPLS shim header, indicating that it performed PHP):</p>
<pre class="code"><strong>Frame 1 (212 bytes on wire, 212 bytes captured)</strong><br/>Point-to-Point Protocol<br/>Internet Protocol, Src: 10.0.1.3 (10.0.1.3), Dst: 10.0.1.7 (10.0.1.7)<br/><strong>Resource ReserVation Protocol (RSVP): PATH Message.</strong><br/>    RSVP Header. PATH Message. <br/>    SESSION: IPv4-LSP, Destination 10.0.1.7, Tunnel ID 0, Ext ID a000103. <br/>    HOP: IPv4, 10.0.7.34<br/>    TIME VALUES: 30000 ms<br/>    EXPLICIT ROUTE: IPv4 10.0.7.33, IPv4 10.0.1.7<br/>    LABEL REQUEST: Basic: L3PID: IP (0x0800)<br/>    SESSION ATTRIBUTE: SetupPrio 7, HoldPrio 7, SE Style,  [C1_t0]<br/>    SENDER TEMPLATE: IPv4-LSP, Tunnel Source: 10.0.1.3, LSP ID: 13. <br/>    SENDER TSPEC: IntServ: Token Bucket, 62500 bytes/sec. <br/>    ADSPEC<br/><br/><strong>Frame 2 (132 bytes on wire, 132 bytes captured)</strong><br/>Point-to-Point Protocol<br/>Internet Protocol, Src: 10.0.7.33 (10.0.7.33), Dst: 10.0.7.34 (10.0.7.34)<br/><strong>Resource ReserVation Protocol (RSVP): RESV Message. </strong><br/>    RSVP Header. RESV Message. <br/>    SESSION: IPv4-LSP, Destination 10.0.1.7, Tunnel ID 0, Ext ID a000103. <br/>    HOP: IPv4, 10.0.7.33<br/>    TIME VALUES: 30000 ms<br/>    STYLE: Shared-Explicit (18)<br/>    FLOWSPEC: Controlled Load: Token Bucket, 62500 bytes/sec. <br/>    FILTERSPEC: IPv4-LSP, Tunnel Source: 10.0.1.3, LSP ID: 13. <br/>    LABEL: 0<br/><br/><strong>Frame 3 (104 bytes on wire, 104 bytes captured)</strong><br/>Point-to-Point Protocol<br/><strong>Internet Protocol, Src: 10.0.1.3 (10.0.1.3), Dst: 10.0.1.7 (10.0.1.7)</strong><br/>    Version: 4<br/>    Header length: 20 bytes<br/>    Differentiated Services Field: 0x00 (DSCP 0x00: Default; ECN: 0x00)<br/>    Total Length: 100<br/>    Identification: 0x0000 (0)<br/>    Flags: 0x00<br/>    Fragment offset: 0<br/>    Time to live: 253<br/>    Protocol: ICMP (0x01)<br/>    Header checksum: 0xa78f [correct]<br/>    Source: 10.0.1.3 (10.0.1.3)<br/>    Destination: 10.0.1.7 (10.0.1.7)<br/>Internet Control Message Protocol</pre><p>When the penultimate hop is a more compliant router, it uses the <em>explicit NULL </em>in the MPLS header to encapsulate the ICMP packet, resulting in potential problems on C2 (according to <a href="http://tools.ietf.org/html/rfc3032">RFC 3032</a>, the whole label stack should be discarded when an <em>explicit NULL </em>is encountered).</p>
<p>If you want C2 to behave in a more standard-compliant way, you have to ask nicely with the <strong>mpls traffic-eng signalling advertise implicit-null</strong> global configuration command. You can use an access list with this command to indicate which neighbors need standard-compliant signaling. The access list should be used if you have a mix of neighbors that interpret the <em>explicit NULL </em>the way it should be interpreted and older IOS devices that could be confused by the <em>implicit NULL </em>label in the RSVP RESV message.</p>
<p>Anyhow, after <strong>mpls traffic-eng signalling advertise implicit-null</strong> has been configured on C2, the RSVP RESV message used <em>implicit NULL </em>label (Label = 3):</p>
<pre class="code"><strong>Frame 1 (212 bytes on wire, 212 bytes captured)</strong><br/>Point-to-Point Protocol<br/>Internet Protocol, Src: 10.0.1.3 (10.0.1.3), Dst: 10.0.1.7 (10.0.1.7)<br/><strong>Resource ReserVation Protocol (RSVP): PATH Message. </strong><br/>    RSVP Header. PATH Message. <br/>    SESSION: IPv4-LSP, Destination 10.0.1.7, Tunnel ID 0, Ext ID a000103. <br/>    HOP: IPv4, 10.0.7.34<br/>    TIME VALUES: 30000 ms<br/>    EXPLICIT ROUTE: IPv4 10.0.7.33, IPv4 10.0.1.7<br/>    LABEL REQUEST: Basic: L3PID: IP (0x0800)<br/>    SESSION ATTRIBUTE: SetupPrio 7, HoldPrio 7, SE Style,  [C1_t0]<br/>    SENDER TEMPLATE: IPv4-LSP, Tunnel Source: 10.0.1.3, LSP ID: 16. <br/>    SENDER TSPEC: IntServ: Token Bucket, 62500 bytes/sec. <br/>    ADSPEC<br/><br/><strong>Frame 2 (132 bytes on wire, 132 bytes captured)</strong><br/>Point-to-Point Protocol<br/>Internet Protocol, Src: 10.0.7.33 (10.0.7.33), Dst: 10.0.7.34 (10.0.7.34)<br/><strong>Resource ReserVation Protocol (RSVP): RESV Message.</strong><br/>    RSVP Header. RESV Message. <br/>    SESSION: IPv4-LSP, Destination 10.0.1.7, Tunnel ID 0, Ext ID a000103. <br/>    HOP: IPv4, 10.0.7.33<br/>    TIME VALUES: 30000 ms<br/>    STYLE: Shared-Explicit (18)<br/>    FLOWSPEC: Controlled Load: Token Bucket, 62500 bytes/sec. <br/>    FILTERSPEC: IPv4-LSP, Tunnel Source: 10.0.1.3, LSP ID: 16. <br/>    LABEL: 3<br/><br/><strong>Frame 3 (104 bytes on wire, 104 bytes captured)</strong><br/>Point-to-Point Protocol<br/><strong>Internet Protocol, Src: 10.0.1.3 (10.0.1.3), Dst: 10.0.1.7 (10.0.1.7)</strong><br/>    Version: 4<br/>    Header length: 20 bytes<br/>    Differentiated Services Field: 0x00 (DSCP 0x00: Default; ECN: 0x00)<br/>    Total Length: 100<br/>    Identification: 0x000a (10)<br/>    Flags: 0x00<br/>    Fragment offset: 0<br/>    Time to live: 253<br/>    Protocol: ICMP (0x01)<br/>    Header checksum: 0xa785 [correct]<br/>    Source: 10.0.1.3 (10.0.1.3)<br/>    Destination: 10.0.1.7 (10.0.1.7)<br/>Internet Control Message Protocol</pre><p></p>
<p class="more">This article is part of <a href="https://blog.ipspace.net/2007/01/youve-asked-for-it-series.html">You've asked for it</a> <a href="https://blog.ipspace.net/tag/youve-asked-for-it.html">series</a>.</p>
</div>

