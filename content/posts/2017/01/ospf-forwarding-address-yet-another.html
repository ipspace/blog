---
url: /2017/01/ospf-forwarding-address-yet-another.html
title: "OSPF Forwarding Address: Yet another Kludge"
date: "2017-01-19T09:06:00.000+01:00"
tags: [ OSPF ]
---

<p>One of my readers sent me an interesting NSSA question (more in a future blog post) that sent me chasing for the reasons behind the OSPF Forwarding Address (FA) field in type-5 and type-7 LSAs.</p>
<p>This is the typical scenario for OSPF FA I was able to find on the Internet:<!--more--></p>
<div class="separator"><a href="/2017/01/s1600-OSPF_FA_1.png" imageanchor="1"><img border="0" src="/2017/01/s500-OSPF_FA_1.png"/></a></div>
<p>Two OSPF ASBRs are connected to the same external network, but only one of them is running the external routing protocol (BGP in my diagram) and redistributing external prefixes into OSPF. You’d want to send the traffic toward external destinations through both ASBRs, but can’t do that as only one of the ASBRs advertises the external routes.</p>
<p>Here are the relevant parts for E1 and E2 configuration:</p>
<p class="codecaption">OSPF and BGP configuration on E1</p>
<pre class="code">interface Loopback0<br/> description Loopback<br/> ip address 192.168.0.1 255.255.255.255<br/> ip ospf 1 area 1<br/>!<br/>interface GigabitEthernet0/1<br/> description to C1<br/> ip address 10.0.128.1 255.255.255.252<br/> ip ospf 1 area 1<br/> ip ospf cost 1<br/>!<br/>interface GigabitEthernet0/2<br/> description to External_LAN<br/> ip address 10.0.0.1 255.255.128.0<br/>!<br/>router ospf 1<br/> redistribute bgp 65000 subnets<br/> passive-interface Loopback0<br/>!<br/>router bgp 65000<br/> bgp log-neighbor-changes<br/> redistribute ospf 1<br/> neighbor 10.0.0.2 remote-as 65001</pre><p></p>
<p class="codecaption">OSPF configuration on E2</p>
<pre class="code">interface Loopback0<br/> description Loopback<br/> ip address 192.168.0.4 255.255.255.255<br/> ip ospf 1 area 1<br/>!<br/>interface GigabitEthernet0/1<br/> description to C1<br/> ip address 10.0.128.6 255.255.255.252<br/> ip ospf 1 area 1<br/> ip ospf cost 1<br/>!<br/>router ospf 1</pre><p class="note">BGP (and redistribution into OSPF) is configured on E1 but not on E2.</p>
<p>And here’s the relevant part of the OSPF topology database. The prefix 192.168.0.2/32 that is advertised by X1 over EBGP is redistributed as type-5 LSA into OSPF by E1 (192.168.0.1)</p>
<p class="codecaption">Type-5 LSA in OSPF topology database</p>
<pre class="code">C1#show ip ospf database external<br/><br/>            OSPF Router with ID (192.168.0.3) (Process ID 1)<br/><br/>    Type-5 AS External Link States<br/><br/>  LS age: 301<br/>  Options: (No TOS-capability, DC, Upward)<br/>  LS Type: AS External Link<br/>  Link State ID: 192.168.0.2 (External Network Number )<br/>  Advertising Router: 192.168.0.1<br/>  LS Seq Number: 80000001<br/>  Checksum: 0xA154<br/>  Length: 36<br/>  Network Mask: /32<br/>  Metric Type: 2 (Larger than any link state path)<br/>  MTID: 0<br/>  Metric: 1<br/>  Forward Address: 0.0.0.0<br/>  External Route Tag: 65001</pre><p class="more">If you want to reproduce the results, download the VIRL topology from my <a href="https://github.com/ipspace/VIRL">VIRL Github repository</a>.</p>
<p>Enter the YAK (Yet Another Kludge) twilight zone: what if the ASBR advertises external next hop (forwarding address) in the type-5 LSA, and both ASBRs advertise the external prefix (hopefully as a stub network)? Recursive next-hop lookup would solve the problem and C1 would get two equal-cost routes toward the external destinations.</p>
<p>To enable this functionality E1 and E2 have to advertise the external subnet as an internal OSPF route, so we’ll add the external interface to the OSPF process on E1 and E2.</p>
<p class="codecaption">Enabling OSPF on external interface on E1 and E2</p>
<pre class="code">interface GigabitEthernet0/2<br/> description to External_LAN<br/> ip ospf cost 1</pre><p class="warn">You cannot make the external interface passive (= stub network). At least the recent versions of Cisco IOS do not set a forwarding address if the next-hop is on a passive interface; the external network must be a fully-functional OSPF interface. I was not able to find any relevant requirements in RFC 2328 – I probably missed something, if anyone knows more details, please write a comment.</p>
<p>After the configuration change the Type-5 LSA in the OSPF topology database gets the <em>forwarding address </em>value and C1 gets two equal-cost paths to the external destination.</p>
<p class="codecaption">Type-5 LSA with Forwarding Address field set to external next hop</p>
<pre class="code">C1&gt;show ip ospf database external<br/><br/>            OSPF Router with ID (192.168.0.3) (Process ID 1)<br/><br/>Type-5 AS External Link States<br/><br/>  LS age: 907<br/>  Options: (No TOS-capability, DC, Upward)<br/>  LS Type: AS External Link<br/>  Link State ID: 192.168.0.2 (External Network Number )<br/>  Advertising Router: 192.168.0.1<br/>  LS Seq Number: 80000001<br/>  Checksum: 0x2CBD<br/>  Length: 36<br/>  Network Mask: /32<br/>Metric Type: 2 (Larger than any link state path)<br/>MTID: 0<br/>Metric: 1<br/>Forward Address: 10.0.0.2<br/>External Route Tag: 65001</pre><p></p>
<p class="codecaption">Two equal-cost routes to external destination</p>
<pre class="code">C1&gt;show ip route 192.168.0.2<br/>Routing entry for 192.168.0.2/32<br/>  Known via "ospf 1", distance 110, metric 1<br/>  Tag 65001, type extern 2, forward metric 2<br/>  Last update from 10.0.128.6 on GigabitEthernet0/2, 00:15:21 ago<br/>  Routing Descriptor Blocks:<br/>    10.0.128.6, from 192.168.0.1, 00:15:21 ago, via GigabitEthernet0/2<br/>      Route metric is 1, traffic share count is 1<br/>      Route tag 65001<br/>  * 10.0.128.1, from 192.168.0.1, 00:15:21 ago, via GigabitEthernet0/1<br/>      Route metric is 1, traffic share count is 1<br/>      Route tag 65001</pre><p>Problem solved? <strong>NO, OF COURSE NOT</strong>. You just made it worse:</p>
<ul class="ListParagraph"><li>Even though it looks like everything works as expected, E1 is a single point of failure – if it crashes, you lose route redistribution, and thus connectivity to external destinations;</li>
<li>The already-too-complex link-state routing protocol got another hard-to-figure-out quirk. See the <em>passive interface </em>gotcha above, and check all the complications T5 FA caused in OSPF route selection process (<a href="https://tools.ietf.org/html/rfc2328">RFC 2328</a>);</li>
<li>You have to run OSPF on the external interface (at least with recent Cisco IOS releases) to make this kludge work. Not exactly the most secure design I’ve seen in my life (and please don’t even mention that you could use an ACL to filter incoming OSPF packets on the external interface before <a href="https://blog.ipspace.net/2013/08/temper-your-macgyver-streak.html">reading this blog post</a>).</li>
</ul>
<p>The proper design would be to run external routing protocol and route redistribution on both ASBRs (yeah, I know, the beauties of two-way redistribution), and tell everyone who complained about this <em>deficiency </em>of OSPF to get lost and fix his design. </p>
<p>Alas, that’s not how <a href="https://xkcd.com/927/">standards are made</a>. No wonder academics are making fun of the complexities of distributed routing protocols (and <a href="https://www.sdxcentral.com/articles/news/scott-shenker-preaches-revised-sdn-sdnv2/2014/10/">backpedaling on their own ridiculous claims</a>), and we’re continuously involved in <a href="http://sethgodin.typepad.com/seths_blog/2005/03/dont_shave_that.html">YAK shaving</a> exercises.</p>
<p>Oh, and just because we got this wonderful unnecessary knob in OSPF, <a href="http://www.cisco.com/c/en/us/support/docs/ip/open-shortest-path-first-ospf/25493-type5-lsa.html">debugging OSPF became even more interesting</a>. Hooray!</p>

