---
url: /2017/03/nerd-knobs-save-day-nssa-saga-continues.html
title: "Nerd Knobs Save the Day: NSSA Saga Continues"
date: "2017-03-02T13:43:00.000+01:00"
tags: [ OSPF ]
---

<p>Remember the <a href="https://blog.ipspace.net/2017/02/the-unintended-consequences-of-nssa.html">OSPF NSSA Forwarding Address</a> kludge and <a href="http://blog.ipspace.net/2017/02/why-ospf-needs-forwarding-address-with.html">its consequences</a>? Let’s figure out whether the nerd knobs available in Cisco IOS can save the day.</p>
<p><strong>TL&amp;DR</strong>: Don’t use OSPF areas if you can avoid them. Don’t use NSSA areas.<!--more--></p>
<h4>The OSPF Forwarding Address and NSSA Saga</h4><p>This blog post is the last in a series of six blog posts, and the only reason I published it was a huge <em>Thank You </em>I got from one of my friends when we met at Cisco Live Berlin. He said “<em>I forwarded your blog posts to a customer who planned on building a network using OSPF NSSA areas. They probably changed his mind.</em>”</p>
<p>So let's conclude the saga with a <a href="https://blog.ipspace.net/2013/08/temper-your-macgyver-streak.html">MacGyver fix</a> – a series of nerd knobs that have to be adjusted to make the network work. If this won't persuade you to stay away from NSSA areas nothing will.</p>
<h4>Other Blog Posts in This Saga</h4><p>You might want to read these blog posts before continuing:</p>
<ul class="ListParagraph"><li><a href="https://blog.ipspace.net/2017/01/ospf-forwarding-address-yet-another.html">OSPF Forwarding Address – Yet Another Kludge</a></li>
<li><a href="https://blog.ipspace.net/2017/01/ospf-forwarding-address-yak-take-2.html">OSPF Forwarding Address – Take 2</a></li>
<li><a href="https://blog.ipspace.net/2017/02/why-ospf-needs-forwarding-address-with.html">Why OSPF Needs Forwarding Address with NSSA Areas</a></li>
<li><a href="https://blog.ipspace.net/2017/02/the-unintended-consequences-of-nssa.html">The Unintended Consequences of NSSA Kludges</a></li>
<li><a href="https://blog.ipspace.net/2017/02/more-thoughts-on-ospf-forwarding-address.html">More Thoughts on OSPF Forwarding Address</a></li>
</ul>
<h4>Breaking the Network</h4><p>As before, we’ll start with what seems to be a perfectly designed network (trust me, <a href="https://blog.ipspace.net/2017/02/why-ospf-needs-forwarding-address-with.html">there's a snake in this paradise</a>):</p>
<div class="separator"><a href="/2017/03/s1600-OSPF_NSSA_1.png" imageanchor="1"><img border="0" src="/2017/03/s500-OSPF_NSSA_1.png"/></a></div>
<p class="info">If you want to replicate the results published in this blog post use <a href="https://github.com/ipspace/VIRL/blob/master/OSPF-NSSA-Forwarding-Address.virl">this VIRL topology file</a> from my <a href="https://github.com/ipspace/VIRL">VIRL topologies GitHub repository</a>.</p>
<p>As expected, C1 has two equal-cost paths to 192.168.1.0/24 and can reach 192.168.1.1:</p>
<p class="codecaption">Expected network behavior</p>
<pre class="code">C1#<strong>show ip route | sect 192.168.1.0</strong><br/>O E1  192.168.1.0/24 [110/33] via 10.0.0.13, 00:00:21, GigabitEthernet0/2<br/>                     [110/33] via 10.0.0.9, 00:00:21, GigabitEthernet0/1<br/>C1#<strong>ping 192.168.1.1</strong><br/>Type escape sequence to abort.<br/>Sending 5, 100-byte ICMP Echos to 192.168.1.1, timeout is 2 seconds:<br/>!!!!!<br/>Success rate is 100 percent (5/5), round-trip min/avg/max = 2/4/7 ms</pre><p>After we shut down the loopback interface on E1 (to emulate a broken design with no loopback interface on ASBR), C1 loses one of the paths to E1 but can still reach it. For detailed explanation of this behavior read the previous blog posts mentioned above.</p>
<p class="codecaption">C1 loses one path toward E1</p>
<pre class="code">C1#<strong>show ip route | sect 192.168.1.0</strong><br/>O E1  192.168.1.0/24 [110/32] via 10.0.0.13, 00:00:07, GigabitEthernet0/2<br/>C1#<strong>ping 192.168.1.1</strong><br/>Type escape sequence to abort.<br/>Sending 5, 100-byte ICMP Echos to 192.168.1.1, timeout is 2 seconds:<br/>!!!!!<br/>Success rate is 100 percent (5/5), round-trip min/avg/max = 2/4/7 ms</pre><p>Finally, when the interface between A2 and E1 breaks down in a mysterious way (line protocol is up, but something on the link drops OSPF traffic), C1 has the route to 192.168.1.0/24 but can no longer reach 192.168.1.1</p>
<p class="codecaption">Traffic blackhole after the A2-E1 link failure</p>
<pre class="code">C1#show ip route | sect 192.168.1.0<br/>O E1  192.168.1.0/24 [110/32] via 10.0.0.13, 00:00:11, GigabitEthernet0/2<br/>C1#ping 192.168.1.1<br/>Type escape sequence to abort.<br/>Sending 5, 100-byte ICMP Echos to 192.168.1.1, timeout is 2 seconds:<br/>U.U.U<br/>Success rate is 0 percent (0/5)</pre><h4>Nerd Knobs Save the Day</h4><p>Cisco IOS OSPF implementation has way too many nerd knobs, some of them violating OSPF standards to make your network work. We’ll use two of them here.</p>
<p>The <strong>area nssa translate type7 suppress-fa </strong>knob disables the Forwarding Address propagation from type-7 to type-5 LSA. The backbone type-5 LSA is originated without the forwarding address (making it look like the external subnet is attached directly to ABR) and <em>with no OSPF cost adjustment</em>. From the SPF perspective, the cost to traverse the NSSA area is zero.</p>
<p>After configuring this feature on A1 and A2 the type-5 LSA observed on C1 has the same OSPF cost as before (E1 cost 30) but no forwarding address.</p>
<p class="codecaption">Type-5 LSA on C1</p>
<pre class="code">C1#<strong>show ip ospf data external</strong><br/><br/>            OSPF Router with ID (192.168.0.3) (Process ID 1)<br/><br/>Type-5 AS External Link States<br/><br/>  LS age: 20<br/>  Options: (No TOS-capability, DC, Upward)<br/>  LS Type: AS External Link<br/>  Link State ID: 192.168.1.0 (External Network Number )<br/>  Advertising Router: 192.168.0.1<br/>  LS Seq Number: 80000002<br/>  Checksum: 0xF749<br/>  Length: 36<br/>  Network Mask: /24<br/>Metric Type: 1 (Comparable directly to link state metric)<br/>MTID: 0<br/>Metric: 30<br/>Forward Address: 0.0.0.0<br/>External Route Tag: 0</pre><p>Change in forwarding address fixes the network. C1 can see a path to 192.168.1.0/24 going through A1 (10.0.0.9) – remember that the A2-E1 link is still broken. It can also reach 192.168.1.1 (a major improvement).</p>
<p class="codecaption">Connectivity to 192.168.1.0/24 works</p>
<pre class="code">C1#<strong>show ip route | sect 192.168.1.0</strong><br/>O E1  192.168.1.0/24 [110/31] via 10.0.0.9, 00:00:39, GigabitEthernet0/1<br/>C1#<strong>ping 192.168.1.1</strong><br/>Type escape sequence to abort.<br/>Sending 5, 100-byte ICMP Echos to 192.168.1.1, timeout is 2 seconds:<br/>!!!!!<br/>Success rate is 100 percent (5/5), round-trip min/avg/max = 2/4/5 ms</pre><p>However, once we fix the A2-E1 link C1 still sees only a single path to C1, this time through 10.0.0.13 (A2).</p>
<p class="codecaption">C1 sees a single path to 192.168.1.0/24</p>
<pre class="code">C1#<strong>show ip route | sect 192.168.1.0</strong><br/>O E1  192.168.1.0/24 [110/31] via 10.0.0.13, 00:02:15, GigabitEthernet0/2</pre><p>The reason for that unexpected behavior is quite simple: due to NSSA rules a single ABR translates the type-7 LSA into type-5 LSA, and as we no longer have the forwarding address in type-5 LSA, routers in other OSPF areas don’t know there are two equal-cost paths to E1.</p>
<p>When inspecting the type-5 LSAs in the backbone area you can see that the type-5 LSA for 192.168.1.0/24 is no longer originated by 192.168.0.1 (A1) but by 192.168.0.4 (A2).</p>
<p class="codecaption">Type-5 LSA on C1</p>
<pre class="code">C1#show ip ospf data external<br/><br/>            OSPF Router with ID (192.168.0.3) (Process ID 1)<br/><br/>Type-5 AS External Link States<br/><br/>  LS age: 170<br/>  Options: (No TOS-capability, DC, Upward)<br/>  LS Type: AS External Link<br/>  Link State ID: 192.168.1.0 (External Network Number )<br/>  Advertising Router: 192.168.0.4<br/>  LS Seq Number: 80000001<br/>  Checksum: 0xE757<br/>  Length: 36<br/>  Network Mask: /24<br/>Metric Type: 1 (Comparable directly to link state metric)<br/>MTID: 0<br/>Metric: 30<br/>Forward Address: 0.0.0.0<br/>External Route Tag: 0</pre><p>To fix that side effect we need yet another nerd knob: <em>always </em>translate type-7 LSAs into type-5 LSAs: <strong>area 1 nssa translate type7 suppress-fa always</strong>.</p>
<p>After the configuration change both A1 <em>and </em>A2 advertise type-5 LSA corresponding to the original type-7 LSA:</p>
<p class="codecaption">C1 has two type-5 LSAs in its OSPF database</p>
<pre class="code">C1#<strong>show ip ospf data external</strong><br/><br/>            OSPF Router with ID (192.168.0.3) (Process ID 1)<br/><br/>Type-5 AS External Link States<br/><br/>  LS age: 37<br/>  Options: (No TOS-capability, DC, Upward)<br/>  LS Type: AS External Link<br/>  Link State ID: 192.168.1.0 (External Network Number )<br/>  Advertising Router: 192.168.0.1<br/>  LS Seq Number: 80000001<br/>  Checksum: 0xF948<br/>  Length: 36<br/>  Network Mask: /24<br/>Metric Type: 1 (Comparable directly to link state metric)<br/>MTID: 0<br/>Metric: 30<br/>Forward Address: 0.0.0.0<br/>External Route Tag: 0<br/><br/>  LS age: 221<br/>  Options: (No TOS-capability, DC, Upward)<br/>  LS Type: AS External Link<br/>  Link State ID: 192.168.1.0 (External Network Number )<br/>  Advertising Router: 192.168.0.4<br/>  LS Seq Number: 80000001<br/>  Checksum: 0xE757<br/>  Length: 36<br/>  Network Mask: /24<br/>Metric Type: 1 (Comparable directly to link state metric)<br/>MTID: 0<br/>Metric: 30<br/>Forward Address: 0.0.0.0<br/>External Route Tag: 0</pre><p>Not surprisingly, C1 has two equal-cost paths to 192.168.1.0.</p>
<pre class="code">C1#show ip route | sect 192.168.1.0<br/>O E1  192.168.1.0/24 [110/31] via 10.0.0.13, 00:03:32, GigabitEthernet0/2<br/>                     [110/31] via 10.0.0.9, 00:00:28, GigabitEthernet0/1</pre><h4>Lesson Learned</h4><p>You might fix networks using OSPF NSSA areas with nerd knobs that violate OSPF standards. They might come handy if you have to fix an existing network, but just because they are there you <strong>SHOULD NOT</strong><strong> </strong>use them when designing a network. Try to stay away from OSPF areas, and don’t use NSSA areas – even though OSPF looks like a Swiss Army Knife, there are better tools to get the job done.</p>
<h4>Initial router configurations</h4><p>Here are the relevant parts of router configurations in case you can’t extract them from VIRL topology file:</p>
<pre class="code">hostname C1<br/>!<br/>interface Loopback0<br/> ip address 192.168.0.3 255.255.255.255<br/> ip ospf 1 area 0<br/>!<br/>interface GigabitEthernet0/1<br/> description to A1<br/> ip address 10.0.0.10 255.255.255.252<br/> ip ospf 1 area 0<br/>!<br/>interface GigabitEthernet0/2<br/> description to A2<br/> ip address 10.0.0.14 255.255.255.252<br/> ip ospf 1 area 0<br/>!<br/>router ospf 1</pre><p></p>
<pre class="code">hostname A1<br/>!<br/>interface Loopback0<br/> ip address 192.168.0.1 255.255.255.255<br/>!<br/>interface GigabitEthernet0/1<br/> description to C1<br/> ip address 10.0.0.9 255.255.255.252<br/> ip ospf 1 area 0<br/>!<br/>interface GigabitEthernet0/2<br/> description to E1<br/> ip address 10.0.0.5 255.255.255.252<br/> ip ospf 1 area 1<br/>!<br/>router ospf 1<br/> area 1 nssa</pre><p></p>
<pre class="code">hostname A2<br/>!<br/>interface Loopback0<br/> ip address 192.168.0.4 255.255.255.255<br/>!<br/>interface GigabitEthernet0/1<br/> description to C1<br/> ip address 10.0.0.13 255.255.255.252<br/> ip ospf 1 area 0<br/>!<br/>interface GigabitEthernet0/2<br/> description to E1<br/> ip address 10.0.0.17 255.255.255.252<br/> ip ospf 1 area 1<br/>!<br/>router ospf 1<br/> area 1 nssa</pre><p></p>
<pre class="code">hostname E1<br/>!<br/>interface Loopback0<br/> description Loopback<br/> ip address 192.168.0.2 255.255.255.255<br/> ip ospf 1 area 1<br/>!<br/>interface Loopback1<br/> ip address 192.168.1.1 255.255.255.0<br/>!<br/>interface GigabitEthernet0/1<br/> description to A1<br/> ip address 10.0.0.6 255.255.255.252<br/> ip ospf 1 area 1<br/>!<br/>interface GigabitEthernet0/2<br/> description to A2<br/> ip address 10.0.0.18 255.255.255.252<br/>### ip access-group blockospf in ### use to block OSPF between A2 and E1<br/> ip ospf 1 area 1<br/>!<br/>router ospf 1<br/> area 1 nssa<br/> redistribute connected metric 30 metric-type 1 subnets<br/>!<br/>ip access-list extended blockospf<br/> deny   ospf any any<br/> permit ip any any</pre>

