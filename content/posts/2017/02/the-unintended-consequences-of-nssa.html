---
date: 2017-02-09T10:39:00.000+01:00
tags:
- design
- OSPF
title: The Unintended Consequences of NSSA Kludges
url: /2017/02/the-unintended-consequences-of-nssa.html
---

<p>Remember the <a href="http://blog.ipspace.net/2017/02/why-ospf-needs-forwarding-address-with.html">kludges needed to make OSPF NSSA areas work correctly</a>? We concluded that saga by showing how the rules of RFC 3101 force a poor ASBR to choose an IP address on one of its OSPF-enabled interfaces as a forwarding address to be used in Type-7 LSA. </p>
<p>What could possibly go wrong with such a “simple” concept?<!--more--></p>
<p>Let’s start with the network we used in the <a href="http://blog.ipspace.net/2017/02/why-ospf-needs-forwarding-address-with.html">previous blog post</a>. In the end of that blog post we shut down the loopback interface on E1 to force it to select something else as the Type-7 LSA forwarding address. While that resulted in suboptimal traffic flow, we could still ping 192.168.1.1 (IP address on a non-OSPF loopback interface on E1) from C1.</p>
<div class="separator"><a href="/2017/02/s1600-OSPF_NSSA_2.png" imageanchor="1"><img border="0" src="/2017/02/s550-OSPF_NSSA_2.png"/></a></div>
<p>Now let’s pretend the interface E1 chose is a Metro Ethernet link and it just failed in one of those mysterious ways where everything seems OK but no packets make it across the link. We’ll emulate this too-well-known behavior (never a Service Provider fault if you ask them) with an incoming <strong>deny ip any any </strong>access list.</p>
<p class="note">Service Providers are more thorough – they’d also drop ARP packets and everything else, but this ACL will do for our purposes. </p>
<p>To make the fault look even more like a Metro Ethernet network, we’ll install the ACL only on E1 side of A2E1 link, resulting in a unidirectional link. As expected, the OSPF adjacency between A2 and E1 goes down. Totally unexpected, C1 can no longer ping external subnets on E1 <em>even though there’s a perfectly good path from C1 to E1.</em></p>
<p class="codecaption">C1 has the destination in its routing table</p>
<pre class="code">C1#show ip route 192.168.1.0<br/>Routing entry for 192.168.1.0/24<br/>  Known via "ospf 1", distance 110, metric 20, type extern 2, forward metric 2<br/>  Last update from 10.0.0.13 on GigabitEthernet0/2, 00:29:09 ago<br/>  Routing Descriptor Blocks:<br/>  * 10.0.0.13, from 192.168.0.4, 00:29:09 ago, via GigabitEthernet0/2<br/>      Route metric is 20, traffic share count is 1</pre><p class="codecaption">Pings return <em>destination unreachable </em>ICMP replies</p>
<pre class="code">C1&gt;ping 192.168.1.1<br/>Type escape sequence to abort.<br/>Sending 5, 100-byte ICMP Echos to 192.168.1.1, timeout is 2 seconds:<br/>U.U.U<br/>Success rate is 0 percent (0/5)</pre><p class="more">If you want to reproduce the results, start with OSPF-NSSA-Forwarding-Address VIRL topology from my <a href="https://github.com/ipspace/VIRL">VIRL Github repository</a> and add the incoming ACL Gi0/2 interface on E1.</p>
<h4>Wait, what?</h4><p>Let’s trace the path from C1 to E1. The routing entry for 192.168.1.0/24 on C1 points to A2, and A2 claims it doesn’t know anything about 192.168.1.0/24. Confusing, right?</p>
<p class="codecaption">A2 doesn’t know anything about 192.168.1.0</p>
<pre class="code">A2#show ip route 192.168.1.0<br/>% Network not in table</pre><p>Well, it turns out the broken link between A2 and E1 also broke the NSSA area in two parts, and A2 wouldn’t consider the Type-7 LSA from E1 when running SPF as it has no intra-area connectivity to E1. </p>
<div class="separator"><a href="/2017/02/s1600-OSPF_NSSA_3.png" imageanchor="1"><img border="0" src="/2017/02/s550-OSPF_NSSA_3.png"/></a></div>
<p class="codecaption">Type-7 LSA refers to an unreachable router ID and is thus ignored</p>
<pre class="code">A2#show ip ospf data nssa-external<br/><br/>            OSPF Router with ID (192.168.0.4) (Process ID 1)<br/><br/>    Type-7 AS External Link States (Area 1)<br/><br/>  LS age: 1284<br/>  Options: (No TOS-capability, Type 7/5 translation, DC, Upward)<br/>  LS Type: AS External Link<br/>  Link State ID: 192.168.1.0 (External Network Number )<br/>  Advertising Router: 192.168.0.2<br/>  LS Seq Number: 8000000C<br/>  Checksum: 0xD3C5<br/>  Length: 36<br/>  Network Mask: /24<br/>  Metric Type: 2 (Larger than any link state path)<br/>  MTID: 0<br/>  Metric: 20<br/>  Forward Address: 10.0.0.18<br/>  External Route Tag: 0</pre><p>The packet from C1 arrives to A2, and A2 simply drops it (resulting in ICMP unreachables observed on C1).</p>
<p>Will the situation get any better when Type-7 LSA ages out on A2? Let’s reset the OSPF process on A2 with the <strong>clear ip ospf process </strong>command. Type-7 LSA is gone, and A2 sees only the backbone Type-5 LSA but still refuses to install 192.168.1.0/24 into the forwarding table:</p>
<p class="codecaption">Type-5 LSA looks good, but is still not used</p>
<pre class="code">A2#show ip ospf data external<br/><br/>            OSPF Router with ID (192.168.0.4) (Process ID 1)<br/><br/>    Type-5 AS External Link States<br/><br/>  LS age: 893<br/>  Options: (No TOS-capability, DC, Upward)<br/>  LS Type: AS External Link<br/>  Link State ID: 192.168.1.0 (External Network Number )<br/>  Advertising Router: 192.168.0.1<br/>  LS Seq Number: 80000001<br/>  Checksum: 0x842B<br/>  Length: 36<br/>  Network Mask: /24<br/>  Metric Type: 2 (Larger than any link state path)<br/>  MTID: 0<br/>  Metric: 20<br/>  Forward Address: 10.0.0.18<br/>  External Route Tag: 0</pre><p>It seems this behavior is a consequence of Rule #4 of Section 16.4 in <a href="https://tools.ietf.org/html/rfc2328">RFC 2328</a> (OSPF v2):</p>
<blockquote class="cite">If the forwarding address is non-zero, look up the forwarding address in the routing table. The matching routing table entry must specify an intra-area or inter-area path.</blockquote>
<p>Looks like a stub interface (OSPF-enabled interface with no neighbors on it) doesn’t satisfy the <em>intra-area or inter-area path </em>criteria. A2 thus ignores the Type-5 LSA pointing to its directly connected interface.</p>
<h4>Nerd Knobs to Rescue</h4><p>The <strong>area nssa translate type7 always suppress-fa</strong><strong> </strong>nerd knob suggested by Angelos Vassiliou would solve this problem (because there would be no recursive lookup for the forwarding address) while at the same time violating paragraph (2) of <a href="#section-3.2">section 3.2 in RFC 3101</a>.</p>
<p class="note">You could argue that the ABR behaves like every type-7 LSA would be aggregated into a separate address range as described in paragraph (3) of the same section. I still have to check how Cisco IOS handles the costs of such type-5 LSA.</p>
<h4>The Really Sad Part</h4><p>I created at least one OSPF deep-dive course, and taught it at least a dozen of times (quite often having Cisco’s TAC engineers in the audience), and I was still surprised to see this behavior.</p>
<h4>Summary</h4><p>OSPF is way too complex for its own good. If you must use OSPF get rid of as much of its complexity as you can– use a single area if at all possible, and stay away from NSSA areas.</p>

