---
date: 2015-11-25T14:37:00.000+01:00
tags:
- data center
- SAN
title: Ethernet Checksums Are Not Good Enough for Storage (Updated)
url: /2015/11/ethernet-checksums-are-not-good-enough.html
---

<p>A while ago I described why <a href="https://blog.ipspace.net/2013/03/does-dedicated-iscsi-infrastructure.html">some storage vendors require end-to-end layer-2 connectivity for iSCSI replication</a>.</p>
<p><strong>TL&amp;DR version</strong>: they were too lazy to implement iSCSI checksums and rely on Ethernet checksums because TCP/IP checksums are not good enough.</p>
<p>It turns out even Ethernet checksums fail every now and then.</p>
<p class="update">2015-12-06: I misunderstood the main technical argument in Evan’s post. The real problem is that switches recalculate CRC, so the Ethernet CRC is no longer end-to-end protection mechanism.<!--more--></p>
<p class="update">2015-11-15: Fixed: TCP/IP checksums are not XORs (thanks to <a href="https://twitter.com/ayourtch/status/669535569207234560">Andrew Yourtchenko</a>).</p>
<p>TCP and IP checksums are simple <del>XOR operations</del> <ins><a href="https://en.wikipedia.org/wiki/IPv4_header_checksum">ones' complement sums</a></ins>, and we know <a href="http://www.evanjones.ca/tcp-checksums.html">they’re weak</a>. As Evan Jones <a href="http://www.evanjones.ca/tcp-and-ethernet-checksums-fail.html">explained in his blog</a>, you might expect that one in ~65000 corrupt packets won’t be detected, which combined with pretty low error rates we see on Ethernet these days might be good enough… or not, if you’re Twitter and dealing with petabytes of traffic.</p>
<p>Ethernet CRC is supposed to save the day. After all, a switch receiving a packet checks the CRC regardless of whether the packet is subsequently bridged or routed. Ethernet CRC should reliably detect transmission errors, and the TCP/IP checksums should detect extremely rare intra-device data corruption errors… or so the theory goes.</p>
<p>In practice, there’s a gap between theory and practice: cut-through switches (becoming yet again ever more popular due to reduced latency) don’t check the CRC<del>. Even worse, they slap the correct CRC on corrupted data, making it impossible to detect the corruption further down the line </del>(more details in an <a href="http://thenetworksherpa.com/cut-through-corruption-and-crc-stomping/">excellent blog post by John Harrington</a>), <ins>and the store-and-forward switches recalculate the CRC, which thus no longer protects the integrity of Ethernet frame between end hosts.</ins></p>
<p><strong>Evan’s conclusion</strong>: if you care about data integrity, implement application-level checksum, preferably using CRC32C, which is implemented in hardware on recent CPUs. </p>
<p><strong>Also note</strong>: Stretched VLAN is not a data protection feature for your iSCSI network. If the iSCSI or NFS solution you’re using doesn’t support application-level checksums, your data is at risk no matter what.</p>
<p>Finally, how many application-level protocols apart from SSL/TLS and iSCSI (when implemented) implement an application-level checksum? Please write a comment!</p>

