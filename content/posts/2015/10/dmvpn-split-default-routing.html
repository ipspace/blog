---
url: /2015/10/dmvpn-split-default-routing.html
title: "DMVPN Split Default Routing"
date: "2015-10-12T08:27:00.000+02:00"
tags: [ DMVPN,IP routing ]
---

<p><a href="https://blog.ipspace.net/2015/06/software-defined-wanwell-orchestrated.html">SD-WAN</a> is <a href="http://blog.ipspace.net/2015/07/some-ridiculous-sd-wan-claims.html">all the rage</a> these days (at least according to software-defined pundits), but networking engineers still build DMVPN networks, even though they are supposedly impossibly-hard-to-configure <a href="https://en.wikipedia.org/wiki/Rube_Goldberg_machine">Rube Goldberg</a> machinery.</p>
<p>To be honest, DMVPN is not the easiest technology Cisco ever developed, and there are plenty of gotchas, including the problem of default routing in Phase 2/3 DMVPN networks.<!--more--></p>
<h4>The Problem</h4><p>In DMVPN <a href="https://blog.ipspace.net/2011/01/dmvpn-phase-2-fundamentals.html">Phase 2</a> or <a href="http://blog.ipspace.net/2014/03/the-fundamental-difference-between.html">Phase 3</a> designs a spoke site exchanges encrypted traffic directly with another spoke site. As we usually don’t know the IP addresses of other remote sites in advance, we solve the remote spoke site reachability problem with a default route on the spoke routers pointing to the Internet uplink.</p>
<p>On the other hand, we might want to use a default route throughout the corporate WAN network, be it to simplify routing or to attract all user-generated Internet traffic to the central site for inspection.</p>
<div class="separator"><a href="/2015/10/s1600-DMVPN_Split_Default_Problem.png" imageanchor="1"><img border="0" src="/2015/10/s520-DMVPN_Split_Default_Problem.png"/></a></div>
<p>The above picture clearly illustrates the problem we’re dealing with – different types of traffic (user traffic versus DMVPN-encapsulated WAN traffic) use different default routes. While you could use PBR to meet this requirement, I’d strongly discourage that – who knows how PBR applied to GRE/IPsec traffic works on platforms that implement IPsec encryption and/or DMVPN encapsulation in hardware.</p>
<h4>The Solution</h4><p>There’s a much cleaner solution: create a transport VRF with its own routing table and its own default route, and assign the Internet uplink to the transport VRF. The default route used in the transport (Internet) VRF is totally independent from the default route used by the user (or other router-generated) traffic. Problem solved.</p>
<div class="separator"><a href="/2015/10/s1600-DMVPN_Split_Default_Solution.png" imageanchor="1"><img border="0" src="/2015/10/s520-DMVPN_Split_Default_Solution.png"/></a></div>
<p>Well, there are (as always) a few other bits-and-pieces you have to configure. You have to associate the new VRF with the transport functionality of the DMVPN tunnel, and move the IKE/IPsec functionality to the VRF (Cisco’s IPsec documentation calls this <em>front door VRF – FVRF</em>). You’ll find the necessary details in Cisco’s online documentation or in <a href="http://www.ipspace.net/DMVPN_trilogy">my DMVPN webinars</a> (which include <a href="https://blog.ipspace.net/2010/09/advanced-dmvpn-webinar-router.html">fully-tested router configurations</a>).</p>
<div class="warn">SD-WAN solutions use exactly the same tricks (we don't know whether they use multiple routing tables or PBR because they hide the details), the only difference is a <a href="https://blog.ipspace.net/2015/07/routing-protocols-and-sd-wan-apples-and.html">nice orchestration UI</a> used by most SDN solutions as opposed to CLI syntax that has grown organically over the last 30 years.</div>
<h4>Potential Caveats</h4><p>One of the attendees of my recent <a href="http://www.ipspace.net/SDN,_OpenFlow_and_NFV_Workshop">SDN workshop</a> claimed that the NetBrain network mapping tool gets totally confused when faced with a VRF. There might be other non-VRF-aware network management tools out there – check them out before buying them.</p>
<p class="update">2015-10-23: As an anonymous commenter pointed out, NetBrain 5.2a is fully VRF aware. In any case, make sure you test most complex scenarios that you might encounter in your network when evaluating any network management tool.</p>

