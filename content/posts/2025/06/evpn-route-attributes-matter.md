---
title: "Dear Vendors, EVPN Route Attributes Matter"
date: 2025-06-18 07:50:00+0200
tags: [ EVPN, netlab ]
netlab_tag: quirks
evpn_tag: rant
---
_Another scary tale from the [Archives of Sloppy Code](/tag/netlab#quirks): we can't decide whether some attributes are mandatory or optional._

When I was fixing the errors in _netlab_ SR-OS configuration templates, I couldn't get the [EBGP-based EVPN with overlapping leaf AS numbers to work](https://github.com/ipspace/netlab/blob/24325f608d123102fa90096ee66f21a796bdb7c0/tests/integration/evpn/13-vxlan-ebgp-allowas.yml). I could see the EVPN routes in the SR-OS BGP table, but the device refused to use them. I concluded  (incorrectly) that there must be a quirk in the SR-OS EVPN code and moved on.
<!--more-->
However, when I ran the full integration tests for all platforms impacted by release 25.06, ArubaCX and Dell OS10 failed the same tests, even though they passed them before. I learned ([the hard way](/2025/06/linux-bridge-stuck-ports/)) to be very careful with my "let's see what has changed" approach to troubleshooting[^NT] and eventually figured out that the *only* thing that changed was the FRRouting software release I used for the other devices in the integration test.

[^NT]: This time, the answer was "nothing" -- the device templates or the integration test haven't changed in months.

{{<long-quote>}}
**Update (2025-06-21)**: Three days after I published this blog post, [Nick Bouliane](https://github.com/nick-bouliane) contacted me and told me he chased down the bug and [submitted a PR](https://github.com/FRRouting/frr/pull/19065) fixing it. Great job!

**Update (2025-06-26)**: Russ White reviewed the PR, and it took a few more days for it to be merged into the master branch. I don't think I've ever experienced a similar time-to-fix in networking software since the early 1990s, when someone within Cisco fixed an ARP issue that was crashing my router literally overnight.

**Update (2025-08-06)**: New FRR releases (10.3.2 and 10.4.1) include the fix and work as expected. Less than two months from a bug report to a shipping release.
{{</long-quote>}}

Before diving into the details, here's a quick overview of the [lab topology](https://github.com/ipspace/netlab/blob/24325f608d123102fa90096ee66f21a796bdb7c0/tests/integration/evpn/13-vxlan-ebgp-allowas.yml):

* VXLAN with EVPN control plane is used to extend a single VLAN between two leaf switches (L1, L2)
* The leaf switches are connected to a single spine switch (L1 → spine → L2).
* The three switches run EVPN over directly-connected EBGP sessions (the [sane EBGP setup](https://www.ipspace.net/Data_Center_BGP/BGP_in_EVPN-Based_Data_Center_Fabrics))
* The leaf switches have the same AS number and have to use something like **allowas-in** to disable the AS-path checks.

Let's skip the ~~hero's journey~~ troubleshooting details and go straight to the results. Recreating the same lab with three FRR nodes (running release 10.3), let's inspect the two EVPN type-3 routes[^ET3] generated by L1 and L2 on the spine switch:

[^ET3]: The routes used to build the list of remote VTEPs for the ingress packet replication

{{<cc>}}EVPN type-3 routes on the spine switch{{</cc>}}
```
spine# show bgp l2vpn evpn route detail type multicast
Route Distinguisher: 10.0.0.2:1000
BGP routing table entry for 10.0.0.2:1000:[3]:[0]:[32]:[10.0.0.2]
Paths: (1 available, best #1)
  Advertised to non peer-group peers:
  l1(10.1.0.1) l2(10.1.0.5)
  Route [3]:[0]:[32]:[10.0.0.2]
  65200
    10.0.0.2(l1) from l1(10.1.0.1) (10.0.0.2)
      Origin IGP, valid, external, bestpath-from-AS 65200, best (First path received)
      Extended Community: RT:65000:1000 ET:8
      Last update: Fri Jun 13 15:05:59 2025
      PMSI Tunnel Type: Ingress Replication, label: 1000
Route Distinguisher: 10.0.0.3:1000
BGP routing table entry for 10.0.0.3:1000:[3]:[0]:[32]:[10.0.0.3]
Paths: (1 available, best #1)
  Advertised to non peer-group peers:
  l1(10.1.0.1) l2(10.1.0.5)
  Route [3]:[0]:[32]:[10.0.0.3]
  65200
    10.0.0.3(l2) from l2(10.1.0.5) (10.0.0.3)
      Origin IGP, valid, external, bestpath-from-AS 65200, best (First path received)
      Extended Community: RT:65000:1000 ET:8
      Last update: Fri Jun 13 15:05:59 2025
      PMSI Tunnel Type: Ingress Replication, label: 1000
```

The routes seem legit. They are also almost identical, but that's to be expected, right? Now let's look at the same routes on L1. One of the routes is generated by L1, the other is advertised by L2, and propagated by Spine over EBGP sessions. Can you spot the difference (ignoring RD, AS-path, and the like)?

{{<cc>}}EVPN type-3 routes on L1{{</cc>}}
```
l1# show bgp l2vpn evpn route detail type multicast
Route Distinguisher: 10.0.0.2:1000
BGP routing table entry for 10.0.0.2:1000:[3]:[0]:[32]:[10.0.0.2]
Paths: (1 available, best #1)
  Advertised to non peer-group peers:
  spine(10.1.0.2)
  Route [3]:[0]:[32]:[10.0.0.2] VNI 1000
  Local
    10.0.0.2(l1) from 0.0.0.0 (10.0.0.2)
      Origin IGP, weight 32768, valid, sourced, local, bestpath-from-AS Local, best (First path received)
      Extended Community: ET:8 RT:65000:1000
      Last update: Fri Jun 13 15:05:56 2025
      PMSI Tunnel Type: Ingress Replication, label: 1000
Route Distinguisher: 10.0.0.3:1000
BGP routing table entry for 10.0.0.3:1000:[3]:[0]:[32]:[10.0.0.3]
Paths: (1 available, best #1)
  Advertised to non peer-group peers:
  spine(10.1.0.2)
  Route [3]:[0]:[32]:[10.0.0.3]
  65100 65200
    10.0.0.3(spine) from spine(10.1.0.2) (10.0.0.1)
      Origin IGP, valid, external, bestpath-from-AS 65100, best (First path received)
      Extended Community: RT:65000:1000
      Last update: Fri Jun 13 15:06:01 2025
      PMSI Tunnel Type: Ingress Replication, label: 1000
```

Did you notice this tiny detail?

{{<cc>}}Local route{{</cc>}}
```
      Extended Community: ET:8 RT:65000:1000
```

{{<cc>}}Route propagated over two EBGP sessions{{</cc>}}
```
      Extended Community: RT:65000:1000
```

The ET attribute is missing from the remote EVPN route.

Next step: trying to figure out what the poet had in mind when he wrote ET (probably not [this one](https://en.wikipedia.org/wiki/E.T._the_Extra-Terrestrial)). Digging through BGP Extended Communities described in [RFC 8365](https://datatracker.ietf.org/doc/html/rfc8365), I finally discovered the **BGP Encapsulation Extended Community** with the **BGP Tunnel Encapsulation Attribute Tunnel Type** where value 8 means VXLAN[^SJR].

[^SJR]: When squinting just right, I could even see a vague semblance between the name of a value in that BGP community and the acronym used in FRRouting.

**To recap**

* FRR release 10.3 attaches `BGP Encapsulation = VXLAN` extended community to EVPN routes
* FRR release 10.2 propagates that community to other EBGP neighbors while FRR release 10.3 drops it. There is no good reason to do that, as the BGP next hop is unchanged. The device dropping the extended community is not in the VXLAN data path (it's just forwarding IP) and thus has no business deciding what encapsulation to use.
* ArubaCX, Dell OS10, and Nokia SR-OS, when configured to use VXLAN encapsulation with EVPN control plane, refuse to use EVPN routes without the `BGP Encapsulation` community.
* It looks like [all other EVPN implementations for which we implemented **allowas-in** functionality](https://release.netlab.tools/_html/coverage.evpn) (Cumulus, EOS, Nexus OS, SR Linux, VyOS) ignore the lack of that community and happily use the routes without them.

OK, one set of vendors must be wrong, right? Welcome to the wonderfully vague world of EVPN. Here are a few choice morsels from that [wonderful RFC](https://datatracker.ietf.org/doc/html/rfc8365):

{{<long-quote>}}
Section 5.1.3: If the BGP Encapsulation Extended Community is not present, then either MPLS encapsulation or a statically configured encapsulation is assumed.
{{</long-quote>}}

I'm reading the above as "the community is optional" but also "all bets are off."

{{<long-quote>}}
Section 6: An ingress NVE can send a frame to an egress NVE only if the set of encapsulations advertised by the egress NVE forms a non-empty intersection with the set of encapsulations supported by the ingress NVE.
{{</long-quote>}}

Now it seems like the BGP Encapsulation community is mandatory. However, the same paragraph contains this gem:

{{<long-quote>}}
If the BGP Encapsulation extended community is not present, then the default MPLS encapsulation or a locally configured encapsulation is assumed
{{</long-quote>}}

Finally, the wonderfully vague cherry on the cake that concludes Section 6:

{{<long-quote>}}
It is the responsibility of the operator of a given EVI to ensure that all of the NVEs in that EVI support at least one common encapsulation. If this condition is violated, it could result in service disruption or failure. The use of the BGP Encapsulation Extended Community provides a method to detect when this condition is violated, but the actions to be taken are at the discretion of the operator and are outside the scope of this document.
{{</long-quote>}}

The more I'm forced to dig into the details of EVPN, the more they prove my gut feeling that we're dealing with the SIP of networking. Do I need to keep elaborating on why I would [never recommend](/2024/03/multivendor-evpn-revisited/) to build a production EVPN network with [devices from more than one vendor](https://blog.ipspace.net/2023/04/multi-vendor-evpn-fabric/)?