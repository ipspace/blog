---
url: /2007/05/command-authorization-fails-with-eem.html
title: "Command Authorization Fails with EEM applet or Tcl policy"
date: "2007-05-14T07:15:00.000+02:00"
tags: [ Tcl,You've asked for it,EEM ]
---

<p>One of my readers <a href="https://blog.ipspace.net/2007/01/youve-asked-for-it-series.html">asked an interesting question</a>: „why do the commands executed within a EEM Tcl policy fail with Command authorization fails message?“ The short answer is simple: If you use AAA command authorization (which you can only do if you're using a TACACS+ server), you have to specify the username under which the EEM will execute its CLI commands with the <strong>event manager session cli username <em>user</em></strong> configuration command.<!--more--></p>
<p class="note"><strong>Note:</strong> This is only required if you use TACACS+ server, as <a href="https://blog.ipspace.net/2006/11/cli-command-logging-without-tacacs.html">the command authorization cannot be performed in AAA environments using RADIUS servers</a>.</p>
<p>For those of you who want to know more, here's the in-depth explanation:</p>
<p>The EEM applets or Tcl policies <a href="https://blog.ipspace.net/2007/03/where-does-tcl-output-go.html">do not execute in the context of a <strong>line</strong></a> (physical or virtual terminal interface), it's therefore impossible to execute CLI commands directly from the EEM policies (contrary to <a href="https://blog.ipspace.net/2007/04/executing-ios-commands-from-tcl-shell.html">what you can do in Tcl shell with <strong>exec</strong> command</a>). To execute CLI commands, you have to open a quasi-telnet session with the <strong>cli_open</strong> call and send and receive characters with the <strong>cli_exec</strong> call or a combination of <strong>cli_write</strong>/<strong>cli_read*</strong> calls. The same approach is used for the commands executed with the action cli commands within EEM applets, the only difference being that you cannot process the output generated by the CLI commands in the EEM applet. </p>
<p>The commands executed by an EEM applet or Tcl policy undergo all the security checks usually performed by a router (they are no different from commands typed in by an operator using a telnet session, only the authentication process is skipped). If you have configured AAA command authorization, the router sends AAA request to the TACACS+ server for every command the EEM applet tries to execute ... and the authorization requests fail if there is no username included in the request. As the login process is skipped, you have to set the desired username manually with the <strong>event manager session cli username <em>user</em></strong> configuration command.</p>

