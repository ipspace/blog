---
title: "Configure DNS servers through IPCP"
date: "2007-11-28T06:54:00.000+01:00"
tags: [ DNS,PPP,WAN ]
---

After I've fixed the default routing in my home office, I've stumbled across another problem: the two ISPs I'm using for my primary and backup link have DNS servers that reply solely to the DNS requests sent from their own IP address range:<br /><br /><a href="http://bp0.blogger.com/_K_pkZO5-tTg/RzwzvCb6JbI/AAAAAAAAAuM/iyBVsjHo4sE/s1600-h/homeSetupDNS.jpg"><img style="display:block; margin:0px auto 10px; text-align:center;cursor:pointer; cursor:hand;" src="http://bp0.blogger.com/_K_pkZO5-tTg/RzwzvCb6JbI/AAAAAAAAAuM/iyBVsjHo4sE/s400/homeSetupDNS.jpg" border="0" alt=""id="BLOGGER_PHOTO_ID_5133034558496318898" /></a>When the traffic is switched from the primary to the backup ISP, I therefore also need to switch the DNS servers. Fortunately, this is quite easy to do on a router; you just need to configure <strong>ppp ipcp dns request</strong> on the dialer interface and the router starts asking for the DNS server address as part of the IPCP negotiation.<script>startHide()</script><br />The negotiation process can be debugged with the <strong>debug ppp negotiation</strong> command; it's a bit more complex than usual in my case since the access server has no secondary DNS (only the primary DNS is configured):<pre class='code'>Se1/0 IPCP: O CONFREQ [Closed] id 1 len 22<br />Se1/0 IPCP:    Address 0.0.0.0 (0x030600000000)<br /><span class='high'>Se1/0 IPCP:    PrimaryDNS 0.0.0.0 (0x810600000000)<br />Se1/0 IPCP:    SecondaryDNS 0.0.0.0 (0x830600000000)</span><br />Se1/0 PPP: Process pending ncp packets<br />Se1/0 IPCP: Redirect packet to Se1/0<br />Se1/0 IPCP: I CONFREQ [REQsent] id 1 len 10<br />Se1/0 IPCP:    Address 10.0.0.33 (0x03060A000021)<br />Se1/0 IPCP: O CONFACK [REQsent] id 1 len 10<br />Se1/0 IPCP:    Address 10.0.0.33 (0x03060A000021)<br />Se1/0 IPCP: I CONFREJ [ACKsent] id 1 len 10<br />Se1/0 IPCP:    SecondaryDNS 0.0.0.0 (0x830600000000)<br />Se1/0 IPCP: O CONFREQ [ACKsent] id 2 len 16<br />Se1/0 IPCP:    Address 0.0.0.0 (0x030600000000)<br />Se1/0 IPCP:    PrimaryDNS 0.0.0.0 (0x810600000000)<br />Se1/0 IPCP: I CONFNAK [ACKsent] id 2 len 16<br />Se1/0 IPCP:    Address 10.0.0.34 (0x03060A000022)<br />Se1/0 IPCP:    PrimaryDNS 10.0.0.10 (0x81060A00000A)<br />Se1/0 IPCP: O CONFREQ [ACKsent] id 3 len 16<br />Se1/0 IPCP:    Address 10.0.0.34 (0x03060A000022)<br />Se1/0 IPCP:    PrimaryDNS 10.0.0.10 (0x81060A00000A)<br /><span class='high'>Se1/0 IPCP: I CONFACK [ACKsent] id 3 len 16<br />Se1/0 IPCP:    Address 10.0.0.34 (0x03060A000022)<br />Se1/0 IPCP:    PrimaryDNS 10.0.0.10 (0x81060A00000A)</span><br />Se1/0 IPCP: State is Open</pre>The results can be inspected only with the show host command:<pre class='code'>GW#<strong>show host</strong><br />Default domain is not set<br />Name/address lookup uses domain service<br /><span class='high'>Name servers are 10.0.0.10</span></pre>The access server receiving the call requires no special configuration; the first IP address configured with the <strong>ip name-server</strong> command is used as the primary DNS and the second one as the secondary. Alternatively, you can configure a different set of DNS servers to pass to the client with the <strong>ppp ipcp dns <em>primary-DNS-address secondary-DNS-address</em></strong> interface configuration command.<br /><br />Unfortunately, the integration with LAN clients is not <a href="http://ioshints.blogspot.com/2007/08/import-dhcp-options-from-upstream-dhcp.html">as seamless as with DHCP</a>; to make the whole solution work, you have to configure the router as a forwarding DNS server and make the LAN clients use the router as the default gateway and DNS server with the DHCP pool configuration:<pre class='code'>ip dns server<br />!<br />ip dhcp pool LAN<br />&nbsp;&nbsp;&nbsp;import all<br />&nbsp;&nbsp;&nbsp;network 192.168.0.0 255.255.255.240<br />&nbsp;&nbsp;&nbsp;default-router 192.168.0.1<br />&nbsp;&nbsp;&nbsp;dns-server 192.168.0.1</pre><script>endHide()</script>

