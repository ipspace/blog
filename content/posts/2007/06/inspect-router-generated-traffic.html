---
url: /2007/06/inspect-router-generated-traffic.html
title: "Inspect router-generated traffic"
date: "2007-06-06T08:22:00.000+02:00"
tags: [ firewalls,NTP,security ]
---

A while ago <a href="https://blog.ipspace.net/2007/01/youve-asked-for-it-series.html">a reader has asked me</a> whether you could modify an IP access-list when the interface IP address changes. While that's definitely doable with Tcl and Embedded Event Manager, it's not a trivial task, so I've tried to understand why he would need such a functionality.<br/><br/>The answer was quite interesting: he's running NTP on his firewall router and thus needs to accept incoming NTP responses from an external NTP server. While that could be easily achieved with the following configuration (only the relevant bits-and-pieces are shown), he didn't want to make the access-list too generic (allowing NTP from the external server to any IP address).<pre class="code">ip inspect name DEFAULT100 tcp<br/>ip inspect name DEFAULT100 udp<br/>!<br/>interface Dialer0<br/> description $FW_OUTSIDE$<br/> ip access-group 102 in<br/> ip inspect DEFAULT100 out<br/>!<br/>access-list 102 remark #### Dialer0 incoming ####<br/>access-list 102 remark #### non-relevant lines deleted<br/><span class="high">access-list 102 permit udp host 1.2.3.4 eq ntp any eq ntp</span></pre>This problem nicely illustrates a broader issues: the router does not inspect it's own traffic and thus does not prepare conduits for the return packets; you have to specify all the return traffic you're expecting in the incoming access list. This drawback has been fixed in IOS release 12.3(14)T with the introduction of the <a href="http://www.cisco.com/en/US/products/ps6350/products_configuration_guide_chapter09186a0080455acd.html">Inspection of Router-Generated Traffic</a> feature. In our scenario you only need to change the inspect rules:<pre class="code">ip inspect name DEFAULT100 tcp router-traffic<br/>ip inspect name DEFAULT100 udp router-traffic</pre>... and the router synchronizes to an external NTP server:<pre class="code">sp#show ip inspect sessions<br/>Established Sessions<br/> Session 474032B4 (192.168.1.3:123)=&gt;(10.0.0.1:123) udp SIS_OPEN<br/>sp#<br/>01:04:34: %NTP-5-PEERSYNC: NTP synced to peer 10.0.0.1<br/>01:04:34: %NTP-6-PEERREACH: Peer 10.0.0.1 is reachable</pre><strong>Note: </strong>This article is part of <a href="https://blog.ipspace.net/2007/01/youve-asked-for-it-series.html">You've asked for it</a> <a href="https://blog.ipspace.net/tag/youve-asked-for-it.html">series</a>.

