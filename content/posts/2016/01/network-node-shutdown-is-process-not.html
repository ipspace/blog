---
date: 2016-01-18T07:36:00.000+01:00
tags:
- SDN
- data center
- fabric
title: Network Node Shutdown Is a Process, not an Event
url: /2016/01/network-node-shutdown-is-process-not.html
---

<p>In theory, you should shut down a network device with a well-defined procedure:</p>
<ul class="ListParagraph"><li>Drain the traffic from the device;</li>
<li>Verify the device is no longer forwarding traffic;</li>
<li>Turn off the device.</li>
</ul>
<p>In practice, network devices don’t have a <strong>shutdown </strong>command, and <strong>reload </strong>typically just restarts the network OS.<!--more--></p>
<h4>Graceful Shutdown</h4><p>Every major vendor claims they have <em>graceful shutdown </em>functionality, but there’s a small problem: the shutdown is usually not so very graceful. For example:</p>
<ul class="ListParagraph"><li>BGP router tears down BGP sessions;</li>
<li>OSPF router sends a HELLO packet with no neighbors (tearing down all adjacencies).</li>
</ul>
<p>In both cases, the neighbors immediately remove routes advertised by the device, go in panic mode and try to find alternate paths.</p>
<p>The only benefit of the so-called graceful shutdown is that the neighbors discover session/adjacency loss immediately and not after TCP/BGP/OSPF timeout/dead interval.</p>
<h4>Is there a better way?</h4><p>Of course – you could use <em>overload </em>bit in IS-IS (and IS-IS based fabrics like Cisco’s FabricPath), <strong>max-metric router-lsa </strong>in OSPF (I <a href="http://learning.nil.com/tips-and-tricks/technical-articles/show/bring-your-network-closer-to-five-nines-with-graceful-shutdown/">wrote about that one in 2007</a>), and route revocation in BGP. The first two can be configured with a single configuration command in Cisco IOS (Junos probably has similar functionality), the last one requires a bit more work.</p>
<h4>Next steps</h4><p>The very minimum you should do if you care about traffic loss following a network device shutdown/restart is a more controlled shutdown process: instead of typing <strong>reload</strong>, reconfigure the routing process (see above), wait for the network to converge (10 seconds should be more than enough) and then execute <strong>reload </strong>making sure the latest changes are not saved to permanent configuration. </p>
<p>You can also change the FHRP priority while waiting, and it’s pretty easy to automate the whole process.</p>
<p class="info">Recent releases of Nexus OS and Arista EOS support <em>maintenance mode</em>, which shuts down all interfaces apart from the management port – an ideal alternative to power-off or reload.</p>
<p>Finally, you could sprinkle some magic SDN dust on top of this solution: verify adjacent devices stopped using the network device before shutting it down. You could use SNMP to read IP routing tables, BGP-LS for OSPF or IS-IS, or <a href="https://tools.ietf.org/html/draft-ietf-grow-bmp-16">BGP Monitoring Protocol</a> or BGP-based SDN controller for BGP.</p>
<h4>More details</h4><p>Watch <a href="http://www.ipspace.net/BGP-Based_SDN_Solutions">BGP-based SDN</a> webinar to see how you could solve the problem in BGP-based data center fabrics, or <a href="https://ripe71.ripe.net/archives/video/152/">Facebook’s RIPE71 presentation</a> to see how Facebook uses similar functionality in their network.</p>

