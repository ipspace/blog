---
url: /2016/06/directed-arp-and-icmp-redirects/
title: "Directed ARP and ICMP Redirects"
date: "2016-06-15T11:46:00.000+02:00"
tags: [ ARP,IP routing ]
---

<p>One of my readers sent me this question:</p>
<blockquote class="cite">When I did my ***redacted*** I encountered a question about <strong>Directed ARP</strong>. The RFC (<a href="https://tools.ietf.org/html/rfc1433">https://tools.ietf.org/html/rfc1433</a>) is in the "experimental" stage, and I found it really weird from ***** to include such a hidden gem in the ***redacted***.</blockquote>
<p>Directed ARP is clearly one of those weird things that people were trying out in the early days of networking when packet forwarding and bandwidth were still expensive (read the RFC for more details), but I kept wondering “<em>what exactly is going on when a host receives an ICMP redirect?</em>” Time for a hands-on test.<!--more--></p>
<h4>Setup</h4><p>I built a very simple VIRL topology with a router and two servers connected to the same segment (you’ll find the VIRL topology file and setup instructions in my <a href="https://github.com/ipspace/VIRL">VIRL Github repository</a>).</p>
<p>The relevant part of the router configuration is here:</p>
<pre class="code">interface GigabitEthernet0/1<br/> description to L2<br/> ip address 10.0.1.1 255.255.255.0 secondary<br/> ip address 10.0.0.1 255.255.255.0</pre><h4>Getting the redirects</h4><p>In theory, the router should send an ICMP redirect whenever two servers that try to communicate could communicate directly. In practice it doesn’t. It looks like Cisco IOS behavior changed recently (make that “in the last 10 years or so”) as I remember seeing ICMP redirects using a similar setup sometime in previous millennium.</p>
<p>Time for a dirty trick: define a /16 subnet with two IP addresses on the router and keep the /24 subnets on the hosts. The router will think both hosts are in the same subnet and the two hosts will think they have to communicate across the router.</p>
<pre class="code">interface GigabitEthernet0/1<br/> description to L2<br/> ip address 10.0.1.1 255.255.0.0 secondary<br/> ip address 10.0.0.1 255.255.0.0</pre><p>Bingo! <strong>debug ip icmp </strong>displays ICMP redirects being sent to the hosts:</p>
<pre class="code">ICMP: redirect sent to 10.0.0.5 for dest 10.0.1.5, use gw 10.0.1.5<br/>ICMP: redirect sent to 10.0.1.5 for dest 10.0.0.5, use gw 10.0.0.5</pre><p><strong>Lesson learned</strong>: Cisco IOS will send ICMP redirects <em>only when the source and destination IP addresses are in the same subnet</em>.</p>
<p>You might expect to see the redirect entries on the Linux servers. Guess what – you won’t:</p>
<pre class="code">cisco@S1:~$ <strong>ip route</strong><br/>default via 10.255.0.1 dev eth0<br/>10.0.0.0/24 dev eth1  proto kernel  scope link  src 10.0.0.5<br/>10.0.0.0/8 via 10.0.0.1 dev eth1<br/>10.255.0.0/16 dev eth0  proto kernel  scope link  src 10.255.0.64</pre><p>You have to know that there should be a redirect entry in the cache, and once you know that, you can display it:</p>
<pre class="code">cisco@S1:~$ <strong>ip route get 10.0.1.5</strong><br/>10.0.1.5 via 10.0.1.5 dev eth1  src 10.0.0.5<br/>    cache &lt;redirected&gt;</pre><p>Makes troubleshooting extra simple, right? Just FYI: here’s <a href="http://commandline.ninja/2015/06/18/damn-you-icmp-redirect-or-rather-how-to-flush-a-cached-icmp-redirect-under-centos7linux/">another epic struggle with the redirect cache</a>.</p>
<p class="update">2016-06-17: Mathieu Millet suggested using <strong>ip route show cache</strong> command to display the whole redirect cache. Unfortunately that command doesn't work on the Ubuntu 14.04.2 LTS included with VIRL.</p>
<h4>ARPing around</h4><p>OK, we got the ICMP redirect into the Linux IPv4 route cache. Now let’s see what happens when the two servers try to communicate directly.</p>
<p>Step#1: Start <strong>tcpdump </strong>on S2 to capture the ARP entries</p>
<pre class="code">cisco@S2:~$ <strong>sudo tcpdump -n -i eth1 arp &amp;</strong></pre><p class="note">VIRL uses <em>eth0 </em>on Linux servers to communicate with the outside world, and <strong>tcpdump </strong>uses the lowest-numbered interface by default, so I had to specify the interface name.</p>
<p>Step#2: Clear the ARP cache</p>
<pre class="code">cisco@S2:~$ <strong>sudo ip neighbor flush all</strong></pre><p>Step#3: Ping S2 from S1 and inspect the <strong>tcpdump </strong>printout on S2</p>
<pre class="code">09:41:27.200279 ARP, Request who-has 10.0.1.5 tell 10.0.0.5, length 28<br/>09:41:27.200314 ARP, Reply 10.0.1.5 is-at fa:16:3e:9f:d0:87, length 28<br/>09:41:27.200552 ARP, Request who-has 10.0.1.1 tell 10.0.1.5, length 28<br/>09:41:27.203598 ARP, Reply 10.0.1.1 is-at fa:16:3e:63:f3:48, length 46</pre><p><strong>Lesson learned</strong>: Linux kernel has no problems ARPing any IP address (even if it’s outside of the interface subnet) as long as the IP routing table or IP cache claims the IP address is directly reachable.</p>
<h4>And now for some extra weirdness</h4><p>S1 created the redirect entry in its route cache while pinging S2, but S2 didn’t even though the router was continuously sending ICMP redirects to S2.</p>
<pre class="code">root@S2:~# <strong>ping 10.0.0.5</strong><br/>PING 10.0.0.5 (10.0.0.5) 56(84) bytes of data.<br/>From 10.0.0.1: icmp_seq=1 Redirect Host(New nexthop: 10.0.0.1)<br/>64 bytes from 10.0.0.1: icmp_seq=1 ttl=64 time=2.90 ms<br/>From 10.0.0.1: icmp_seq=2 Redirect Host(New nexthop: 10.0.0.1)<br/>64 bytes from 10.0.0.1: icmp_seq=2 ttl=64 time=5.13 ms<br/>From 10.0.0.1: icmp_seq=3 Redirect Host(New nexthop: 10.0.0.1)<br/>64 bytes from 10.0.0.1: icmp_seq=3 ttl=64 time=10.5 ms<br/>From 10.0.0.1: icmp_seq=4 Redirect Host(New nexthop: 10.0.0.1)<br/>64 bytes from 10.0.0.1: icmp_seq=4 ttl=64 time=7.48 ms<br/>From 10.0.0.1: icmp_seq=5 Redirect Host(New nexthop: 10.0.0.1)<br/>64 bytes from 10.0.0.1: icmp_seq=5 ttl=64 time=11.2 ms<br/>From 10.0.0.1: icmp_seq=6 Redirect Host(New nexthop: 10.0.0.1)</pre><p class="update">2016-06-17: Jim Hand sent me a nice email explaining the above problem - the ICMP redirect is coming from wrong source IP address. More in another blog post.</p>
<p>It’s also interesting that <strong>ping </strong>claimed the next hop in the ICMP redirect is 10.0.0.1 – I even ran <strong>tcmpdump </strong>to verify Cisco IOS sent the correct next hop in ICMP redirect:</p>
<pre class="code">IP (tos 0x0, ttl 64, id 24602, offset 0, flags [DF], proto ICMP (1), length 84)<br/>    10.0.1.5 &gt; 10.0.0.5: ICMP echo request, id 1520, seq 1, length 64<br/>IP (tos 0x0, ttl 255, id 200, offset 0, flags [none], proto ICMP (1), length 56)<br/>    10.0.0.1 &gt; 10.0.1.5: ICMP redirect 10.0.0.5 to host 10.0.0.5, length 36<br/>IP (tos 0x0, ttl 63, id 24602, offset 0, flags [DF], proto ICMP (1), length 84)<br/>    10.0.1.5 &gt; 10.0.0.5: ICMP echo request, id 1520, seq 1, length 64<br/>IP (tos 0x0, ttl 64, id 25789, offset 0, flags [none], proto ICMP (1), length 84)<br/>    10.0.0.5 &gt; 10.0.1.5: ICMP echo reply, id 1520, seq 1, length 64</pre><p class="update">2016-06-17: This seems to be a bug in <strong>ping</strong> utility. See comment by Anonymous below.</p>
<h4>Takeaway ;)</h4><p>While you can <a href="http://www.brainyquote.com/quotes/quotes/y/yogiberra125285.html">observe a lot by just watching</a> (or googling), you’ll definitely learn more by getting your hands dirty.</p>

