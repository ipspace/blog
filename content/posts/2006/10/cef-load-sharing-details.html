---
url: /2006/10/cef-load-sharing-details/
title: "CEF load sharing details"
date: "2006-10-20T09:52:00.000+02:00"
tags: [ CEF,load balancing ]
---

I had to investigate the details of CEF load sharing for one of my upcoming article and found (yet again) that the details are rather undocumented in official documentation. So, this is how it works (in case you ever need to know):<br/><ul><li>For every CEF entry (IP route) where there are multiple paths to the destination, the router creates a 16-row hash table, populating the entries with pointers to individual paths. The hash table can be inspected with the <b>show ip cef <i>prefix</i> internal</b> command.</li>
<li>The load balancing ratio is approxiated by number of entries in the hash table belonging to each path. If you have unequal-cost load balancing (EIGRP based on composite metrics and MPLS TE tunnels based on requested bandwidth), individual paths will be associated with different number of rows.<li>If you configure per-destination load balancing, the source and destination IP address in the incoming IP packet are hashed into a 4-bit value that selects the outgoing path in the CEF has table.</li>
</li>
</ul>
<!--more--><p>If this sounds confusing, here are two examples to make it easier: if you have two equal-cost paths to the same destination, each path will have eight entries in the hash table.</p>
<pre class="code">a1#<b>show ip route 192.168.0.0</b><br/>Routing entry for 192.168.0.0 255.255.255.0<br/>  Known via "ospf 1", distance 110, metric 51, type intra area<br/>  Last update from 172.16.0.21 on Serial0/0/0.100, 00:00:05 ago<br/>  Routing Descriptor Blocks:<br/>  * 172.16.0.21, from 172.16.0.22, 00:00:05 ago, via Serial0/0/0.100<br/>      Route metric is 51, traffic share count is 1<br/>    172.16.0.21, from 172.16.0.22, 00:00:05 ago, via Serial0/0/0.200<br/>      Route metric is 51, traffic share count is 1<br/>a1#<b>show ip cef 192.168.0.0 internal</b><br/>192.168.0.0/24, version 33, epoch 0, per-destination sharing<br/>0 packets, 0 bytes<br/>  via 172.16.0.21, Serial0/0/0.100, 0 dependencies<br/>    traffic share 1<br/>    next hop 172.16.0.21, Serial0/0/0.100<br/>    valid adjacency<br/>  via 172.16.0.21, Serial0/0/0.200, 0 dependencies<br/>    traffic share 1<br/>    next hop 172.16.0.21, Serial0/0/0.200<br/>    valid adjacency<br/><br/>  0 packets, 0 bytes switched through the prefix<br/>  tmstats: external 0 packets, 0 bytes<br/>           internal 0 packets, 0 bytes<br/><span class="high">  Load distribution: 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 (refcount 1)</span><br/><br/>  Hash  OK  Interface                 Address         Packets<br/>  1     Y   Serial0/0/0.100           point2point           0<br/>  2     Y   Serial0/0/0.200           point2point           0<br/>  3     Y   Serial0/0/0.100           point2point           0<br/>  4     Y   Serial0/0/0.200           point2point           0<br/>  5     Y   Serial0/0/0.100           point2point           0<br/>  6     Y   Serial0/0/0.200           point2point           0<br/>  7     Y   Serial0/0/0.100           point2point           0<br/>  8     Y   Serial0/0/0.200           point2point           0<br/>  9     Y   Serial0/0/0.100           point2point           0<br/>  10    Y   Serial0/0/0.200           point2point           0<br/>  11    Y   Serial0/0/0.100           point2point           0<br/>  12    Y   Serial0/0/0.200           point2point           0<br/>  13    Y   Serial0/0/0.100           point2point           0<br/>  14    Y   Serial0/0/0.200           point2point           0<br/>  15    Y   Serial0/0/0.100           point2point           0<br/>  16    Y   Serial0/0/0.200           point2point           0</pre><p>However, if you have three equal-cost paths to the destination, each path will have only five entries and the hash table will have 15 rows instead of 16.</p>
<pre class="code">a1#<b>show ip route 192.168.0.0</b><br/>Routing entry for 192.168.0.0 255.255.255.0<br/>  Known via "ospf 1", distance 110, metric 51, type intra area<br/>  Last update from 10.0.0.6 on FastEthernet0/0, 00:00:02 ago<br/>  Routing Descriptor Blocks:<br/>  * 172.16.0.21, from 172.16.0.22, 00:00:02 ago, via Serial0/0/0.100<br/>      Route metric is 51, traffic share count is 1<br/>    172.16.0.21, from 172.16.0.22, 00:00:02 ago, via Serial0/0/0.200<br/>      Route metric is 51, traffic share count is 1<br/>    10.0.0.6, from 172.16.0.22, 00:00:02 ago, via FastEthernet0/0<br/>      Route metric is 51, traffic share count is 1<br/>a1#<b>show ip cef 192.168.0.0 internal</b><br/>192.168.0.0/24, version 44, epoch 0, per-destination sharing<br/>0 packets, 0 bytes<br/>  via 172.16.0.21, Serial0/0/0.100, 0 dependencies<br/>    traffic share 1<br/>    next hop 172.16.0.21, Serial0/0/0.100<br/>    valid adjacency<br/>  via 172.16.0.21, Serial0/0/0.200, 0 dependencies<br/>    traffic share 1<br/>    next hop 172.16.0.21, Serial0/0/0.200<br/>    valid adjacency<br/>  via 10.0.0.6, FastEthernet0/0, 0 dependencies<br/>    traffic share 1<br/>    next hop 10.0.0.6, FastEthernet0/0<br/>    valid adjacency<br/><br/>  0 packets, 0 bytes switched through the prefix<br/>  tmstats: external 0 packets, 0 bytes<br/>           internal 0 packets, 0 bytes<br/><span class="high">  Load distribution: 0 1 2 0 1 2 0 1 2 0 1 2 0 1 2 (refcount 1)</span><br/><br/>  Hash  OK  Interface                 Address         Packets<br/>  1     Y   Serial0/0/0.100           point2point           0<br/>  2     Y   Serial0/0/0.200           point2point           0<br/>  3     Y   FastEthernet0/0           10.0.0.6              0<br/>  4     Y   Serial0/0/0.100           point2point           0<br/>  5     Y   Serial0/0/0.200           point2point           0<br/>  6     Y   FastEthernet0/0           10.0.0.6              0<br/>  7     Y   Serial0/0/0.100           point2point           0<br/>  8     Y   Serial0/0/0.200           point2point           0<br/>  9     Y   FastEthernet0/0           10.0.0.6              0<br/>  10    Y   Serial0/0/0.100           point2point           0<br/>  11    Y   Serial0/0/0.200           point2point           0<br/>  12    Y   FastEthernet0/0           10.0.0.6              0<br/>  13    Y   Serial0/0/0.100           point2point           0<br/>  14    Y   Serial0/0/0.200           point2point           0<br/>  15    Y   FastEthernet0/0           10.0.0.6              0</pre>

