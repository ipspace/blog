---
url: /2014/08/load-sharing-in-mpls-core/
title: "Load Sharing in MPLS Core"
date: "2014-08-06T17:49:00.000+02:00"
tags: [ MPLS,load balancing ]
---

<p>Here’s a question that bothered me for years till I finally gave up and labbed it: does ECMP load sharing work in an MPLS core? More specifically, will an LSP split into multiple LSPs?<!--more--></p>
<h4>The Scenario</h4><p>Imagine a network with alternate paths across the network core. We know that IP traffic takes all paths across the core (usually as long as they are equal-cost, and based on the load sharing algorithm).</p>
<div class="separator"><a href="/2014/08/s1600-MPLS+Load+Sharing+Scenario.jpg" imageanchor="1"><img border="0" src="/2014/08/s400-MPLS+Load+Sharing+Scenario.jpg"/></a></div>
<p>Does MPLS work the same way? For example, would labeled traffic from A to Z go over B-C-E and B-D-E links? Would the A-Z LSP split into two LSPs at B?</p>
<p>I was somewhat pleasantly surprised to figure out ECMP works with MPLS. As expected, there are two entries in the IP routing table on router B for the loopback interface of router Z:</p>
<pre class="code">B#<strong>show ip route 10.0.1.6</strong>                    <br/>Routing entry for 10.0.1.6/32<br/>  Known via "isis", distance 115, metric 40, type level-2<br/>  Redistributing via isis<br/>  Last update from 10.0.7.22 on Serial1/1, 00:02:39 ago<br/>  Routing Descriptor Blocks:<br/>    10.0.7.26, from 10.0.1.8, 00:02:39 ago, via Serial1/2<br/>      Route metric is 40, traffic share count is 1<br/>  * 10.0.7.22, from 10.0.1.8, 00:02:39 ago, via Serial1/1<br/>      Route metric is 40, traffic share count is 1 </pre><p>Interestingly, there are also two entries in the corresponding LFIB entry. Inbound traffic with label 1015 is split across two outbound LSPs with labels 2013 and 3015.</p>
<pre class="code">B#<strong>show mpls forwarding-table 10.0.1.6 detail</strong><br/>Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop    <br/>Label      Label      or Tunnel Id     Switched      interface              <br/>1015       2013       10.0.1.6/32      0             Se1/1      point2point <br/>    MAC/Encaps=4/8, MRU=1500, Label Stack{2013}<br/>    FF030281 007DD000<br/>    No output feature configured<br/>    Per-destination load-sharing, slots: 0<br/>           3015       10.0.1.6/32      0             Se1/2      point2point <br/>    MAC/Encaps=4/8, MRU=1500, Label Stack{3015}<br/>    FF030281 00BC7000<br/>    No output feature configured<br/>    Per-destination load-sharing, slots: 1</pre><p>Please note that ECMP in MPLS core works only with LDP-established paths (which use IP routing table for topology discovery) – MPLS TE tunnels are unidirectional paths established and controlled by the tunnel head-end router. If you want to perform ECMP load balancing across the MPLS TE tunnels, you have to establish multiple tunnels from the head-end router (and use affinity bits or loose source routing to ensure they go across different paths in the MPLS core).</p>

