---
url: /2014/08/mpls-load-sharing-data-plane.html
title: "MPLS Load Sharing – Data Plane Considerations"
date: "2014-08-13T08:32:00.000+02:00"
tags: [ MPLS,load balancing ]
---

<p>In <a href="https://blog.ipspace.net/2014/08/load-sharing-in-mpls-core.html">a previous blog post</a> I explained how load sharing across LDP-controlled MPLS core works. Now let’s focus on another detail: how are the packets assigned to individual paths across the core?</p>
<p class="update">2014-08-14: Additional information was added to the blog post based on comments from Nischal Sheth, Frederic Cuiller and Tiziano Tofoni. Thank you!<!--more--></p>
<p>The answer is trivial if you’re doing headend-based load sharing (example: using multiple MPLS TE tunnels) – the headend router has full visibility into the original MAC frame or IP packet and can do any type of load sharing it wants (from <a href="https://blog.ipspace.net/2006/12/per-destination-or-per-packet-cef-load.html">per-destination</a> to <a href="http://blog.ipspace.net/2006/12/per-port-cef-load-sharing.html">per-session</a> load balancing).</p>
<p>Load sharing at the LSP split point (in the network core) is trickier and mostly vendor-dependent. Let’s use the same sample network we used in the previous blog post to illustrate the difficulties. How will Label Switch Router (LSR) B decide which labeled packets with incoming label 1015 should go toward LSR C and which ones should go toward LSR D, if all it ever sees are the labeled packets?</p>
<div class="separator"><a href="/2014/08/s1600-MPLS+Load+Sharing+Scenario.jpg" imageanchor="1"><img border="0" src="/2014/08/s400-MPLS+Load+Sharing+Scenario.jpg"/></a></div>
<p>An LSR could perform the load balancing based on the next label in the stack, based on the last label in the stack, or based on the actual labeled payload. Unfortunately a transit LSR has no idea what the payload is – only the ingress and egress LSRs know what they agreed to use the LSP for. </p>
<p>Some implementations of transit LSRs <a href="#L3">look into the first nibble of the payload</a> and treat the payload as IPv4 packet (using the load-sharing algorithm configured for unlabeled IPv4 packets) if the value in the first nibble is 0x04, and likewise treat the payload as IPv6 packet if the value in the first nibble is 0x06.</p>
<p class="more">For in-depth discussion of MPLS load balancing on ASR 9000, <a href="https://supportforums.cisco.com/document/111291/asr9000xr-loadbalancing-architecture-and-characteristics">read this document</a>. </p>
<p>That approach works well for L3VPN traffic (where labeled IPv4 or IPv6 datagrams are transported across MPLS core), but fails miserably for non-IP traffic (example: L2VPN traffic, which has MAC header at the beginning of the payload).</p>
<p class="warn">The guesswork based on first nibble of the payload might incorrectly load balance EoMPLS traffic when the destination MAC address starts with 04 or 06. You can use the <a href="http://tools.ietf.org/html/rfc4448#section-4.6"><em>control word </em>functionality</a> of EoMPLS pseudowires to set the first nibble of the payload to zero.</p>
<p>Some L2VPN solutions (EoMPLS, VPLS, EVPN) use additional labels to enhance the load sharing behavior of the MPLS core. An ingress LSR using this approach collects the fields that it would use in its load sharing algorithm from the inbound packet, hashes them into a 20-bit value and adds that label to the bottom of the MPLS stack. A transit LSRs can then use the additional label to decide how to share the load across multiple outbound links going to the same destination.</p>
<p>The initial approach to enhanced load balancing of MPLS pseudowires uses a single Flow Label (defined in <a href="http://tools.ietf.org/html/rfc6391">RFC 6391</a>) and relies on <a href="http://tools.ietf.org/html/rfc6391#section-4">LDP signaling between ingress and egress LSR</a> to negotiate the use of flow label. A more generic approach uses a special <em>entropy label indicator </em>(ELI, label value 7, defined in <a href="http://tools.ietf.org/html/rfc6790">RFC 6790</a>) in the MPLS label stack to tell the egress LSR to discard the flow label (now called <em>entropy label</em>) following the ELI.</p>
<h4>New to MPLS?</h4><p>Check out my <a href="http://www.ipspace.net/Books">MPLS books</a> and <a href="http://www.ipspace.net/Roadmap/VPN_webinars">VPN webinars</a>.</p>

