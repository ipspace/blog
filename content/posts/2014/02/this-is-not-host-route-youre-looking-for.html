---
url: /2014/02/this-is-not-host-route-youre-looking-for.html
title: "This Is Not the Host Route You’re Looking For"
date: "2014-02-26T06:56:00.000+01:00"
tags: [ switching,IP routing ]
---

<p>When describing Hyper-V Network Virtualization packet forwarding I briefly mentioned that the hypervisor switches create (an equivalent of) a host route for every VM they need to know about, <a href="https://blog.ipspace.net/2014/01/complex-routing-in-hyper-v-network.html?showComment=1391106053894#c1743154142478380137">prompting some readers to question the scalability of such an approach</a>. As it turns out, layer-3 switches did the same thing under the hood for years.<!--more--></p>
<h4>How We Think It Works</h4><p>IP forwarding process is traditionally explained along these lines:</p>
<ul class="ListParagraph"><li>Destination IP address is looked up in IP forwarding table (FIB), resulting in IP next hop or connected interface (in which case the next hop is the destination IP address itself);</li>
<li>ARP cache is looked up to find the MAC address of the IP next hop.</li>
</ul>
<p>According to this explanation, the IP FIB contains the prefixes copied from the IP routing table. However, this is not how most layer-3 switches work.</p>
<h4>How It Actually Works</h4><p>I’ll use a recent implementation of Cisco Express Forwarding (CEF) to illustrate what’s really going on behind the scenes. The printouts were taken from vIOS running within <a href="https://blog.ipspace.net/2013/10/cisco-modeling-lab-virl-behind-scenes.html">Cisco CML</a> (it’s great to have cloud-based routers when you can’t access your home lab due to <a href="http://blog.ipspace.net/2014/02/disasters-and-recoveries-part-2.html">10-day-long power outage</a>).</p>
<p>This is the routing table I had on the router (static route and default route were set through DHCP).</p>
<pre class="code">R1#<strong>show ip route 10.11.12.0 longer</strong><br/>[…]<br/>Gateway of last resort is 10.11.12.1 to network 0.0.0.0<br/><br/>      10.0.0.0/8 is variably subnetted, 3 subnets, 2 masks<br/>C        10.11.12.0/24 is directly connected, GigabitEthernet0/0<br/>S        10.11.12.2/32 [254/0] via 10.11.12.1, GigabitEthernet0/0<br/>L        10.11.12.3/32 is directly connected, GigabitEthernet0/0</pre><p>CEF table closely reflects the IP table, but there are already a few extra entries:</p>
<pre class="code">R1#<strong>show ip cef | include 10.11.12 </strong> <br/>10.11.12.0/24        attached             GigabitEthernet0/0<br/>10.11.12.0/32        receive              GigabitEthernet0/0<br/>10.11.12.1/32        attached             GigabitEthernet0/0<br/>10.11.12.2/32        10.11.12.1           GigabitEthernet0/0<br/>10.11.12.3/32        receive              GigabitEthernet0/0<br/>10.11.12.255/32      receive              GigabitEthernet0/0</pre><p>Now let’s ping a directly connected host …</p>
<pre class="code">R1#<strong>ping 10.11.12.4</strong><br/>Type escape sequence to abort.<br/>Sending 5, 100-byte ICMP Echos to 10.11.12.4, timeout is 2 seconds:<br/>.!!!!</pre><p>… and there’s an extra entry in the CEF table:</p>
<pre class="code">R1#<strong>show ip cef | include 10.11.12</strong>  <br/>10.11.12.0/24        attached             GigabitEthernet0/0<br/>10.11.12.0/32        receive              GigabitEthernet0/0<br/>10.11.12.1/32        attached             GigabitEthernet0/0<br/>10.11.12.2/32        10.11.12.1           GigabitEthernet0/0<br/>10.11.12.3/32        receive              GigabitEthernet0/0<br/>10.11.12.4/32        attached             GigabitEthernet0/0<br/>10.11.12.255/32      receive              GigabitEthernet0/0</pre><h4>Wait, What?</h4><p>Does that mean that the <strong>ping </strong>command created an extra entry in the CEF table? Of course not – but it did trigger the ARP process, which indirectly created a <a href="https://blog.ipspace.net/2007/05/what-is-cached-cef-adjacency.html">new adjacency in the CEF table</a> (these adjacencies don’t expire due to <a href="http://blog.ipspace.net/2007/06/ar.html">repeated ARPing done by Cisco IOS</a>). The ARP-generated adjacency looks exactly like any other host route (although you can see from various fields in the detailed CEF printout that it’s an adjacency route):</p>
<pre class="code">R1#<strong>show ip cef 10.11.12.4 internal</strong><br/>10.11.12.4/32, epoch 0, flags [att], refcnt 5, per-destination sharing<br/>  sources: Adj <br/>  subblocks:<br/>    Adj source: IP adj out of GigabitEthernet0/0, addr 10.11.12.4 0D0AB300<br/>      Dependent covered prefix type adjfib, cover 10.11.12.0/24<br/>  ifnums:<br/>    GigabitEthernet0/0(2): 10.11.12.4<br/>  path list 0D14E48C, 3 locks, per-destination, flags 0x4A [nonsh, rif, hwcn]<br/>    path 0D581C30, share 1/1, type adjacency prefix, for IPv4<br/>      attached to GigabitEthernet0/0, IP adj out of GigabitEthernet0/0, addr 10.11.12.4 0D0AB300<br/>  output chain:<br/>    IP adj out of GigabitEthernet0/0, addr 10.11.12.4 0D0AB300</pre><h4>How Do We Know Hardware Switches Work the Same Way?</h4><p>Obviously it’s impossible to claim with any certainty how a particular switch works without seeing the hardware specs (mission impossible for vendor ASICs as well as Broadcom’s merchant silicon).</p>
<p>Some switch vendors still talk about IP routing entries and ARP entries, others (for example, <a href="http://www.cisco.com/c/en/us/products/collateral/switches/nexus-3000-series-switches/data_sheet_c78-651097.html">Nexus 3000</a>) already use <em>IP prefix</em> and <em>IP host</em> entry terminology. I chose Nexus 3000 for a reason – many data center switches use the same chipset and thus probably use the same forwarding techniques.</p>
<p>Intel is way more forthcoming than Broadcom – the <a href="http://www.intel.com/content/dam/www/public/us/en/documents/datasheets/ethernet-switch-fm4000-datasheet.pdf">FM4000 data sheet</a> contains plenty of details about its forwarding architecture, and if I understand it correctly, IP forwarding table lookup must result in an ARP entry (which means that the IP forwarding table must contain host routes).</p>
<h4>Summary</h4><p>Hardware layer-3 switches need an IP forwarding entry for every attached IP host, although some vendors might call these entries ARP entries. Virtual layer-3 switches are no different, and might use a totally different terminology for the <em>host route </em>forwarding entries to confuse the casual reader.</p>

