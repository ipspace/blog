---
title: "Micro-BFD: BFD over LAG (Port Channel)"
date: "2014-10-20T07:15:00.000+02:00"
tags: [ Link aggregation,IP routing ]
---

<p>The discussion in the comments to my <a href="http://blog.ipspace.net/2014/10/lag-versus-ecmp.html"><em>LAG versus EC</em><em>M</em><em>P</em></a> post took a totally unexpected turn when someone mentioned BFD failure detection over port channels (link aggregation groups – LAGs).</p>
<p>What’s the big deal?<!--more--></p>
<h4>What is BFD</h4><p>Bidirectional Forwarding Detection (BFD) is a lightweight protocol that “<em>provides low-overhead, short-duration detection of failures in the path between adjacent forwarding engines</em>” (straight from <a href="http://tools.ietf.org/html/rfc5880">RFC 5880</a>).</p>
<p>Networking engineers love BFD for several reasons:</p>
<ul class="ListParagraph"><li>It’s simpler and less CPU-intensive than routing protocol adjacency messages;</li>
<li>It can be implemented in smart linecards, further reducing the control-plane CPU load, and making it possible to detect forwarding failures in milliseconds even on boxes with hundreds of interfaces (try doing that with OSPF);</li>
<li>It detects <a href="http://en.wikipedia.org/wiki/Byzantine_fault_tolerance">byzantine failures</a> between two forwarding engines that cannot be reliably detected at physical and data-link layers.</li>
</ul>
<p>BFD uses the principle of <a href="http://blog.ipspace.net/2014/08/fate-sharing-in-ip-networks.html"><em>shared fate</em></a><em> </em>to do its job – it tests the actual transmission path using the same protocol (IP) as the forwarded traffic – and thus reliably detects a forwarding failure in a simple transmission path, regardless of the number of components in the path.</p>
<div class="separator"><a href="/2014/10/s1600-MicroBFD+-+Single+link.png" imageanchor="1"><img border="0" src="/2014/10/s500-MicroBFD+-+Single+link.png"/></a></div>
<h4>BFD and LAG</h4><p>LAG appears as a single layer-2 forwarding path to layer-3 forwarding engine. BFD messages can take any one of the links in the LAG (based on the LAG load balancing algorithm), breaking the <em>shared fate </em>assumption – a forwarded packet traversing another LAG member link might encounter a partially failed component, and it’s impossible for BFD to detect that.</p>
<div class="separator"><a href="/2014/10/s1600-MicroBFD+-+BFD+over+LAG.png" imageanchor="1"><img border="0" src="/2014/10/s500-MicroBFD+-+BFD+over+LAG.png"/></a></div>
<p>The only solution to this problem is to run BFD across <em>every </em>LAG member link – the BFD code has to become LAG-aware and test end-to-end connectivity across every member link independently (see <a href="http://tools.ietf.org/html/rfc7130">RFC 7130</a> for more details). Even more, LACP and BFD have to work in parallel – a member is added to a LAG only when both LACP and BFD agree it’s OK to do so.</p>
<div class="separator"><a href="/2014/10/s1600-MicroBFD+Sessions.png" imageanchor="1"><img border="0" src="/2014/10/s500-MicroBFD+Sessions.png"/></a></div>
<h4>Where can I get it?</h4><p>Micro-BFD is available in <a href="http://www.juniper.net/documentation/en_US/junos13.3/topics/concept/bfd-for-lag-overview.html">Junos release 13.3</a>, <a href="http://www.cisco.com/c/en/us/td/docs/switches/datacenter/nexus5500/sw/interfaces/6x/b_5500_Interfaces_Config_Guide_Release_6x/b_5500_Interfaces_Config_Guide_Release_6x_chapter_0110.html#concept_0B1573CB2DE248338D6EF32C62FC904D">Cisco Nexus OS</a> and Cisco <a href="http://www.cisco.com/c/en/us/td/docs/routers/crs/software/crs_r4-0/interfaces/configuration/guide/hc40crsbook/hc40bifw.pdf">IOS XR Release 4.0</a>. Any other implementation? Write a comment!</p>
<h4>More information</h4><p>I <a href="http://learning.nil.com/tips-and-tricks/technical-articles/show/improve-the-convergence-of-mission-critical-networks-with-bidirectional-forwarding-detection-bfd/">wrote about BFD</a> a long long time ago.</p>

