---
url: /2014/06/mice-elephants-and-virtual-switches.html
title: "Mice, Elephants and Virtual Switches"
date: "2014-06-30T14:06:00.000+02:00"
tags: [ QoS,virtualization ]
---

<p>The <em>Mice and Elephants </em>is a traditional QoS fable – latency-sensitive real time traffic (or request-response protocol like HTTP) <a href="https://blog.ipspace.net/2014/05/queuing-mechanisms-in-modern-switches.html">stuck in the same queue</a> behind megabytes of file transfer (or backup or iSCSI) traffic.</p>
<p>The solution is also well known – color the elephants pink (aka DSCP marking) and sort them into a different queue – until the reality intervenes.<!--more--></p>
<p>It seems oh-so-impossible to figure out which applications might generate elephant flows and mark them accordingly on the originating server; there’s no other way to explain the need for traffic classification and marking on the ingress switch, and <a href="https://blog.ipspace.net/2013/08/temper-your-macgyver-streak.html">other MacGyver contraptions</a> the networking team uses to make sure “it’s not the network’s fault” instead of saying “<a href="http://blog.ipspace.net/2013/04/they-want-networking-to-be-utility-lets.html">we’re a utility – you’re getting exactly what you’ve asked for.</a>”</p>
<p>Matching TCP and UDP port numbers on the server (because FTP sessions tend to be more elephantine than DNS requests) and <a href="http://www.linuxtopia.org/Linux_Firewall_iptables/x4172.html">setting DSCP values of outbound packets</a> is also obviously a mission-impossible for some people; it’s way easier to pretend the problem doesn’t exist and blame the network for lack of proper traffic classification.</p>
<p class="info">One has to wonder how well the recent surge of application-aware networking solution will fare if the server/application teams cannot be bothered to tell the network what type of traffic it’s facing by setting a simple one-byte value in each packet, but let’s not go there.</p>
<p>Anyway, situation gets worse in environments with truly unclassifiable traffic (as the ultimate abomination imagine a solution doing backups over HTTP) where it’s impossible to separate elephant from mice based on their TCP/UDP port numbers. </p>
<p>If, however, one would have insight into the operating system TCP buffers, or measure per-flow rate, one might be able to figure out which flows exhibit overweight tendencies – and that’s <a href="http://blogs.vmware.com/networkvirtualization/2014/02/elephant-flow-mitigation.html">exactly what the Open vSwitch (OVS) team did</a>. </p>
<p>Additionally, OVS appears as a TCP-offload-capable NIC to the virtual machines, and the bulk applications happily dump megabyte-sized TCP segments straight into the output queue of the VM NIC, where it’s easy for the underlying hypervisor software (OVS) to spot them and mark them with a different DSCP value (this idea is marked as <em>pending </em>in Martin Casado’s presentation).</p>
<p>The results (<a href="http://www.slideshare.net/martin_casado/elephants-and-mice-elephant-detection-in-the-vswitch-with-hardware-handling">documented in a presentation</a>) shouldn’t be surprising – we know <em>ping </em>isn’t affected by an ongoing FTP transfer if they happen to be in different queues since the days Fred Baker proudly presented the first measurement results of the then-revolutionary Weighted Fair Queuing mechanism (<a href="https://www.isoc.org/inet97/mitigate.ppt">this</a> is the only presentation I could find, but WFQ <a href="#!topic/comp.dcom.sys.cisco/2eiRjnFrJII">already existed in late 1995</a>) at some mid- ‘90s incarnation of Cisco Live (probably even before the days Cisco Live was called Networkers).</p>
<p>The OVS-based elephant identification is a cool idea, although one has to wonder how well it works in practice if it measures the flow rate of each and every flow passing through a virtual switch (see also <a href="https://blog.ipspace.net/2014/02/flow-based-forwarding-doesnt-work-well.html">OVS scaling woes</a>). </p>
<p>Telling people how awesome it is that Cumulus-powered switches react to elephant flows in hardware is pure marketing – every switch works well when faced with properly marked packets. Calling DSCP marking “overlay-to-underlay integration” is also hogwash (no, I will not link to the source); we’ve been using DSCP marking for decades with no need for fancy names.</p>

