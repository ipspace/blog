---
url: /2014/04/changes-in-ibgp-next-hop-processing.html
title: "Changes in IBGP Next Hop Processing Drastically Improve BGP-based DMVPN Designs"
date: "2014-04-10T06:46:00.000+02:00"
tags: [ DMVPN,BGP ]
---

<p>I always <a href="https://blog.ipspace.net/2014/03/scaling-bgp-based-dmvpn-networks.html">recommended EBGP-based designs for DMVPN networks</a> due to the significant complexity of running IBGP without an underlying IGP. The <strong>neighbor next-hop-self all </strong>feature introduced in recent Cisco IOS releases has totally changed my perspective – it makes IBGP-over-DMVPN the best design option unless you want to <a href="http://www.ipspace.net/Integrating_Internet_VPN_with_MPLS_VPN_WAN">use DMVPN network as a backup for MPLS/VPN network</a>.<!--more--></p>
<h4>What was the problem?</h4><p>Imagine a simple DMVPN network with a hub router and two spoke routers. The hub router is further connected to WAN core, and all routers run IBGP (with DMVPN hub router being BGP route reflector for DMVPN spokes).</p>
<pre class="code">RA--+<br/>    !<br/>    +--hub—core<br/>    !<br/>RB--+</pre><p>Let’s assume the core router advertises BGP prefix 192.168.10.0/24 with BGP next hop 10.0.2.2.</p>
<pre class="code">Hub#<strong>show ip bgp 192.168.10.0</strong><br/>BGP routing table entry for 192.168.10.0/24, version 7<br/>Paths: (1 available, best #1, table default)<br/>  Advertised to update-groups:<br/>     1         <br/>  Refresh Epoch 1<br/>  Local<br/>    10.0.2.2 from 10.0.2.2 (10.11.12.6)<br/>      Origin IGP, metric 0, localpref 100, valid, internal, best</pre><p>When that update gets propagated to DMVPN spoke routers, they ignore the BGP prefix, as they cannot reach the BGP next hop (there’s no IGP on the DMVPN subnet):</p>
<pre class="code">RA#<strong>show ip bgp 192.168.10.0</strong><br/>BGP routing table entry for 192.168.10.0/24, version 12<br/>Paths: (1 available, no best path)<br/>  Not advertised to any peer<br/>  Refresh Epoch 1<br/>  Local<br/>    10.0.2.2 (inaccessible) from 10.0.0.3 (192.168.3.1)<br/>      Origin IGP, metric 0, localpref 100, valid, internal<br/>      Originator: 10.11.12.6, Cluster list: 192.168.3.1</pre><p>We can fix that problem in a number of ways:</p>
<ul class="ListParagraph"><li>Run EBGP across DMVPN subnet, potentially reusing the same AS number across multiple sites (the solution I usually proposed so far);</li>
<li>Advertise BGP next hops in BGP. A bit messy, but it works in recent IOS releases;</li>
<li>Change the BGP next hop in inbound updates on spoke routers;</li>
<li>Change the BGP next hop on the hub router.</li>
</ul>
<p>Let evaluate the last three options:</p>
<h4>Advertising IBGP next hops in IBGP</h4><p>Each IBGP router in our autonomous system could advertise all its connected interfaces (effectively turning IBGP into a path vector IGP). Once the IBGP next hops appear in BGP table, the DMVPN spoke routers start using the IBGP prefixes advertised by routers beyond the DMVPN hub:</p>
<pre class="code">RA#<strong>show ip bgp</strong><br/>BGP table version is 14, local router ID is 192.168.1.1<br/>Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, <br/>              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, <br/>              x best-external, a additional-path, c RIB-compressed, <br/>Origin codes: i - IGP, e - EGP, ? - incomplete<br/>RPKI validation codes: V valid, I invalid, N Not found<br/><br/>     Network          Next Hop            Metric LocPrf Weight Path<br/> *&gt;i 10.0.2.0/24      10.0.0.3                 0    100      0 i<br/> *&gt;  192.168.1.0      0.0.0.0                  0         32768 i<br/> *&gt;i 192.168.2.0      10.0.0.2                 0    100      0 i<br/> *&gt;i 192.168.3.0      10.0.0.3                 0    100      0 i<br/> *&gt;i 192.168.10.0     10.0.2.2                 0    100      0 i<br/>RA#<strong>show ip bgp 192.168.10.0</strong><br/>BGP routing table entry for 192.168.10.0/24, version 14<br/>Paths: (1 available, best #1, table default)<br/>  Not advertised to any peer<br/>  Refresh Epoch 1<br/>  Local<br/>    10.0.2.2 from 10.0.0.3 (192.168.3.1)<br/>      Origin IGP, metric 0, localpref 100, valid, internal, best<br/>      Originator: 10.11.12.6, Cluster list: 192.168.3.1</pre><p>There are at least two problems with this approach:</p>
<ul class="ListParagraph"><li>I remember having problems with IBGP routes using IBGP next hops (some versions of Cisco IOS refused to use them); either my memory is failing me or the behavior might have changed recently.</li>
<li>BGP doesn’t change next hop on IBGP updates, resulting in ever-deeper next hop recursion (the proof is left as an exercise for the reader), which may eventually break the next hop evaluation process.</li>
</ul>
<p><strong>Summary:</strong> don’t even try.</p>
<h4>Changing BGP next hop on spoke routers</h4><p>You could use inbound route map on spoke routers to change BGP next hop of all received BGP prefixes to the IP address of the hub router. The <strong>set ip next-hop peer-address </strong>command makes this approach even more viable, as you don’t have to specify the hub router’s IP address in the route map.</p>
<p class="info">You have to use slightly more complex route map in Phase 2 DMVPN networks – the BGP next hop has to be changed only if it doesn’t belong to the DMVPN subnet.</p>
<p>While this solution works, it requires additional configuration on all spoke routers. Not a problem unless you have thousands of spokes.</p>
<p><strong>Summary:</strong> use as a solution-of-last-resort. </p>
<h4>Changing BGP next hop on the hub router</h4><p>Ideally, the hub router would set the BGP next hop to its own IP address on all outbound updates sent to DMVPN spokes. Unfortunately a <a href="https://blog.ipspace.net/2011/08/bgp-next-hop-processing.html">BGP route reflector doesn’t change the attributes of reflected routes</a>, even when configured to do so with a route map or <strong>neighbor next-hop-self</strong>.</p>
<p>Recent IOS releases got a tweak on the <strong>neighbor next-hop-self </strong>command – the <strong>all </strong>option changes BGP next hop on all routes, including reflected routes. Problem solved.</p>
<p><strong>Summary</strong>: recommended solution if your hub router supports this feature.</p>

