---
url: /2014/03/scaling-bgp-based-dmvpn-networks.html
title: "Scaling BGP-Based DMVPN Networks"
date: "2014-03-17T07:36:00.000+01:00"
tags: [ DMVPN,BGP ]
---

<p>Cristiano sent me an interesting question:</p>
<blockquote class="cite">I saw that to configure BGP as the routing protocol running over DMVPN I have to configure BGP neighbors on the hub site router. Do I really have to configure all the neighbors on the hub site? How many neighbors could I configure? How can I scale that?</blockquote>
<p>According to Cisco Live presentations, <a href="https://blog.ipspace.net/2011/01/using-bgp-in-phase-1-dmvpn-network.html">BGP-over-DMVPN</a> scales to several thousand spoke sites (per hub router), so you shouldn’t be too worried about the protocol scalability. Configuring all those neighbors is a different issue.<!--more--></p>
<p>Fortunately anonymous BGP neighbors (which were banned from Cisco IOS years ago) reappeared in a different disguise (<a href="http://www.cisco.com/c/en/us/td/docs/ios-xml/ios/iproute_bgp/configuration/15-mt/irg-15-mt-book/irg-dynamic-neighbor.html">dynamic BGP neighbors</a>) in IOS release 15.1T – you can configure an access list which defines whether the remote IP address is a valid BGP neighbor, and accept all incoming TCP requests on port 179 matched by the ACL. The “only” drawback: dynamic neighbors matched by a single <strong>bgp listen peer-group </strong>command must share the same neighbor parameters, including an AS number.</p>
<p class="note">You can list several AS numbers in the <strong>neighbor </strong><strong><em>peer-group </em></strong><strong>remote-as</strong> command, but that doesn’t exactly help you if you have 500 remote sites.</p>
<p>Faced with the requirement to have the same AS number on all remote sites you could use one of these two designs:</p>
<p><strong>Running IBGP across DMVPN</strong>. While you <em>could </em>make it work, I wouldn’t recommend doing that unless you’re a BGP guru. <a href="https://blog.ipspace.net/2011/08/ibgp-or-ebgp-in-enterprise-network.html">IBGP was not designed to be used without IGP</a>, and there are simply too many things that can bite you if you’re trying to run IBGP without an underlying IGP. You probably don’t want to run an IGP across a large DMVPN network or you wouldn’t be reading this blog post. </p>
<p><strong>Running EBGP across DMVPN</strong> with all spoke sites being in the same autonomous system. This design works great for Phase 1 or Phase 3 DMVPN: spoke sites will ignore routes advertised by other spoke sites (due to BGP loop prevention logic), and a default route advertised by the hub router will take care of the inter-site traffic flow. </p>
<p>Phase 2 DMVPN is trickier; every spoke site should have routes from all other spoke sites (with correct BGP next hops) if you want spoke sites to communicate directly. You can disable BGP loop prevention logic on spoke sites (using <strong>neighbor allowas-in</strong>) or play dirty tricks with the AS path like <strong>neighbor remove-private-as </strong>or <strong>neighbor as-override </strong>on the hub router (not recommended).</p>
<h4>More information</h4><ul class="ListParagraph"><li><a href="http://www.ipspace.net/BGP_Routing_in_DMVPN_Access_Network"><em>BGP routing in DMVPN Access Networks</em></a> case study;</li>
<li>DMVPN webinars: <a href="http://www.ipspace.net/Roadmap/VPN_webinars">buy them individually</a>, or <a href="http://www.ipspace.net/DMVPN_trilogy">in a bundle</a>.</li>
</ul>

