---
url: /2014/11/coping-with-byzantine-routing-failures.html
title: "Coping with Byzantine Routing Failures"
date: "2014-11-19T08:41:00.000+01:00"
tags: [ IP routing, MPLS VPN, WAN, high availability ]
---

<p>One of my readers sent me an interesting challenge:</p>
<blockquote class="cite">We have two MPLS providers sending us default routes and it seems like whenever we have problem with SP1 our failover is not happening properly and actually we have to go in manually and influence our traffic to forward via another path.</blockquote>
<p>Welcome to the wondrous world of <a href="http://en.wikipedia.org/wiki/Byzantine_fault_tolerance">byzantine routing failures</a> ;)<!--more--></p>
<p>Let’s recap what the problem is:</p>
<ul class="ListParagraph"><li>The customer uses two service providers (ISPs, MPLS/VPN providers – doesn’t really matter);</li>
<li>Both SPs announce aggregated prefixes (example: default route);</li>
<li>The aggregated prefix is not revoked when the SP has a bad-hair-day.</li>
</ul>
<p>It might be that the primary provider is clueless enough to generate the default route on the PE-router without considering the state of the rest of the network (because they never read <a href="http://blog.ipspace.net/2011/09/responsible-generation-of-bgp-default.html">this blog post</a>), in which case the problem cannot be solved with BGP (the <a href="http://blog.ipspace.net/2014/08/fate-sharing-in-ip-networks.html">“shared fate” property of BGP</a> is broken due to localized default route origination).</p>
<p>In any case, there are two commonly used solutions when one cannot trust the routing provided by the SP (no surprise there):</p>
<ul class="ListParagraph"><li>Running your own routing protocol between your sites across an <strong>overlay network</strong> (example: DMVPN, potentially without the encryption part if you’re running DMVPN across an MPLS/VPN infrastructure, or <a href="http://blog.ipspace.net/2011/03/mplsvpn-over-gre-over-ipsec-does-it.html">something way more complex</a>).</li>
<li><strong>Locally generated default route</strong> based on IP SLA measurements (for example, pinging Google DNS or one or more root nameservers).</li>
</ul>
<p>You’ll find plenty of information on the overlay approach in the <a href="http://www.ipspace.net/DMVPN_trilogy">DMVPN webinars</a>, and I covered some aspects of multi-provider connectivity in the <a href="http://www.ipspace.net/Data_Center_Design_Case_Studies">Data Center Design Case Studies</a> book. I also blogged extensively about individual components of the second solution, but don’t have a comprehensive case study addressing it yet.</p>
<p>You might want to augment the DMVPN solution with <a href="http://docwiki.cisco.com/wiki/PfRv3:Home">PFRv3</a> (the combo known under the marketing name Intelligent WAN), and orchestrate it with <a href="http://www.gluenetworks.com/products-services/gluware-orchestration-engine">Gluware Orchestration Engine</a>, or consider one of the startups working in this space: <a href="http://blog.ipspace.net/2014/10/border6-non-stop-internet-commercial.html">Border6 if you need a BGP-only solution</a> or <a href="http://blog.ipspace.net/2014/11/viptela-sen-hybrid-wan-connectivity.html">Viptela if you need end-to-end private WAN</a> load balanced across both SPs.</p>
<p>Last but definitely not least, I’m always available for <a href="http://www.ipspace.net/ExpertExpress">short online consulting sessions</a>.</p>
<p>And finally – don’t forget to read <a href="https://gnunet.org/sites/default/files/smli_tr-2005-146.pdf">Radia Perlman’s take on routing with byzantine robustness</a></p>

