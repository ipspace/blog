---
title: "Beware of the pre-bestpath cost extended BGP community"
date: "2012-10-24T06:51:00.000+02:00"
tags: [ EIGRP,BGP,MPLS VPN ]
---

<p>One of my readers sent me an interesting problem a few days ago: the BGP process running on a PE-router in his MPLS/VPN network preferred an iBGP route received from another PE-router to a locally sourced (but otherwise identical) route. When I looked at the detailed printout, I spotted something “interesting” – the <em>pre-bestpath cost</em> extended BGP community.<!--more--></p>
<pre class="code">PE2#<strong>sh ip bgp vpnv4 vrf XXX 0.0.0.0 </strong><strong><br></strong>BGP routing table entry for 172.16.1.105:0:0.0.0.0/0, version 159367 <br><br>Paths: (2 available, best #1, table XXX) <br>   Local, imported path from 100:0:0.0.0.0/0 <br>     172.16.1.104 (metric 11) from 172.16.1.104 (172.16.1.104) <br>       Origin incomplete, metric 0, localpref 100, valid, internal, best <br>       Extended Community: RT:100:0 <span class=" high">Cost:pre-bestpath:129:25600 0x8800:0:0</span> <br>         0x8801:100:0 0x8802:65280:25600 0x8803:65281:1500 <br>         0x8804:1936:184188929 0x8805:9:0 0x8806:0:184188929<br />       mpls labels in/out nolabel/372<br />   Local <br>     10.251.0.130 from 0.0.0.0 (172.16.1.105) <br>       Origin incomplete, metric 0, localpref 100, weight 32768, valid, sourced <br>       Extended Community: RT:100:0 </pre><p>The <a href="http://tools.ietf.org/html/draft-retana-bgp-custom-decision-02">BGP cost community</a> modifies the <a href="http://21500.net/?p=336">BGP path selection process</a>: if the cost community has ABSOLUTE_VALUE (displayed as pre-bestpath) point-of-insertion, it’s considered before the “standard” BGP path selection attributes (yes, it’s stronger than <em>weight</em>).</p>
<p>BGP paths without the <em>cost</em> community are assumed to have a pretty high cost value (<span>2147483647, as </span><a href="http://www.cisco.com/en/US/docs/ios/12_0s/feature/guide/s_bgpcc.html"><span>explained by Cisco’s documentation</span></a><span>), causing the iBGP route to be better than the local route (which had no cost community).</span></p>
<p><span>The </span><span><em>cost </em></span><span>extended BGP community is usually seen in </span><a href="http://blog.ioshints.info/2008/07/multihomed-eigrp-sites-in-mpls-vpn.html"><span>networks running EIGRP between PE-and CE-routers</span></a><span> that try to cope with multihomed customer sites. Although you could change it manually with the </span><span><strong>set extcommunitiy cost </strong></span><span>command in numerous places where a route-map can be used, it should not appear in my reader’s network – his default route was a simple static route redistributed into BGP without a route-map.</span></p>
<p><span>It turned out he stumbled upon a bug; he was using EIGRP in the same VRF, and removing and re-enabling EIGRP-to-BGP redistribution in the VRF address family removed the stray </span><span><em>cost</em></span><span> community from the default route. Obviously that fix isn’t always applicable – you can’t simply bounce EIGRP redistribution every time a BGP prefix gets a weird set of communities – but fortunately you can ignore the </span><span><em>cost </em></span><span>community with the </span><span><strong>bgp bestpath cost-community ignore </strong></span><span>router configuration command.</span><span><strong> </strong></span></p>

