---
date: 2012-01-17T07:03:00.000+01:00
tags:
- DMVPN
- OSPF
- workshop
title: Redundant DMVPN designs, Part 1 (The Basics)
url: /2012/01/redundant-dmvpn-designs-part-1-basics.html
---

<p>Most of the DMVPN-related questions I get are a variant of the “<em>how many tunnels/hubs/interfaces/areas do I need for a redundant DMVPN design?</em>” As always, the right answer is “it depends” (and I can always <a href="http://www.ipspace.net/ExpertExpress">help you with your design</a> if you’d like to get a second opinion), but here’s what I’ve learned so far.<!--more--></p>
<h4>Single router/single uplink on spoke site</h4><p>This blog post focuses on the simplest possible design – each spoke site has a single router and a single uplink. There’s no redundancy at the spokes, which might be an acceptable tradeoff (or you could use 3G connection as a backup for DMVPN). </p>
<p>You’d probably want to have two hub routers (preferably with independent uplinks), which brings us to the fundamental question: “<em>do we need one or two DMVPN clouds?</em>”</p>
<h4>Design#1 – one hub per DMVPN tunnel</h4><p>In this design, each hub router controls its own DMVPN subnet, and spoke routers have multiple tunnel interfaces (one per hub). Each hub router is the NHRP server for the subnet it controls, and propagates routing information between spokes.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/01/s1600-DMVPN_1S2I2H.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="210" src="/2012/01/s400-DMVPN_1S2I2H.png" width="400"/></a></div>
<p>This design is by far the simplest, cleanest, and easiest to understand/troubleshoot – it has no intricate dependencies between routing protocols and NHRP. You can also <a href="https://blog.ipspace.net/2011/01/sometimes-you-need-to-step-back-and.html">easily deploy primary/backup hub router scenarios</a> by increasing the interface cost of one tunnel interface, or you could load-share the traffic between both hub routers.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/01/s1600-DMVPN_2TP1.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="214" src="/2012/01/s400-DMVPN_2TP1.png" width="400"/></a></div>
<p>And now for the drawbacks:</p>
<ul class="ListParagraph"><li>Multiple IPsec sessions could be established between a pair of spoke routers in <a href="https://blog.ipspace.net/2011/01/dmvpn-phase-2-fundamentals.html">DMVPN Phase 2 deployments</a> (one over each tunnel interface);</li>
</ul>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/01/s1600-DMVPN_2TP2.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="226" src="/2012/01/s400-DMVPN_2TP2.png" width="400"/></a></div>
<ul class="ListParagraph"><li>GRE keys are mandatory in Phase 2 deployments (otherwise the spokes cannot decipher which tunnel the other spoke router was using), causing performance degradation if the hub routers don’t support GRE keys in hardware (Catalyst 6500 doesn’t)</li>
<li>This design does not work with large-scale Phase 3 DMVPNs where you want each spoke to connect to a subset of hubs (you cannot establish Phase 2/3 shortcuts across DMVPN tunnels, only within a tunnel).</li>
</ul>
<h4>Design#2 – multiple hubs in a single DMVPN tunnel</h4><p>In this design, you connect all hub routers to the same DMVPN tunnel. All hub routers act as NHRP servers, and propagate routing information between the spokes (if you <a href="https://blog.ipspace.net/2011/01/configuring-ospf-in-phase-2-dmvpn.html">use OSPF, one of the hub routers would become a DR, another one a BDR</a>).</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/01/s1600-DMVPN_1S2H1T.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="175" src="/2012/01/s400-DMVPN_1S2H1T.png" width="400"/></a></div>
<p><a href="https://blog.ipspace.net/2011/01/dmvpn-phase-1-fundamentals.html">Phase 1 DMVPN</a> using multiple hub routers per tunnel is pretty easy to design/deploy – NHRP is used solely to register spokes with all the hubs, and the convergence is controlled by the routing protocols. Implementing primary/backup hub routers is a tricky task; you have to use routing protocol tricks like per-neighbor cost in <a href="https://blog.ipspace.net/2011/01/ospf-configuration-in-phase-1-dmvpn.html">OSPF</a> or per-interface offset lists with EIGRP.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/01/s1600-DMVPN_1TP1.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="179" src="/2012/01/s400-DMVPN_1TP1.png" width="400"/></a></div>
<p><a href="https://blog.ipspace.net/2011/01/dmvpn-phase-2-fundamentals.html">Phase 2/3 DMVPN</a> designs with multiple hub routers per tunnel could experience severe convergence issues – <a href="https://blog.ipspace.net/2011/05/nhrp-convergence-issues-in-multi-hub.html">detecting failure of a hub router could take as long as three minutes</a>. On the <em>benefits </em>side, this design does not require GRE keys (which is good news if your hub router is a Catalyst 6500) or multiple IPsec sessions between spoke routers.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/01/s1600-DMVPN_1TP2.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="208" src="/2012/01/s400-DMVPN_1TP2.png" width="400"/></a></div>
<h4>Summary</h4><ul class="ListParagraph"><li>One hub router per DMVPN subnet is the ideal design for Phase 2 DMVPN deployments ... unless you have Catalyst 6500 as your hub router, in which case you must use one DMVPN subnet due to lack of hardware GRE key support.</li>
<li>You could use both designs with Phase 1 DMVPN; one hub router per subnet is a better alternative if you have primary/backup hub router requirements.</li>
<li>One DMVPN subnet is probably the best design for Phase 3 DMVPN and it’s mandatory if you have partial spoke-to-hub NHRP connectivity.</li>
</ul>
<p class="note">I need to run a few more convergence tests before fully embracing <em>one DMVPN subnet </em>design as the best one in all Phase 3 DMVPN scenarios.</p>
<p>Coming next: spoke routers with multiple uplinks and spoke sites with redundant routers.</p>
<h4>Need help?</h4><p>Start with the <a href="http://www.ipspace.net/DMVPN:_From_Basics_to_Scalable_Networks"><em>DMVPN – from basics to scalable networks</em></a> webinar; it probably contains 95% of what you need to know about DMVPN (the <a href="http://www.ipspace.net/DMVPN_New_Features"><em>DMVPN New Features</em></a> one describes DMVPN features introduced in IOS releases 15.x). </p>
<p>If you need a second opinion or help with your DMVPN design, check out the <a href="http://www.ipspace.net/ExpertExpress">ExpertExpress service</a>. You could also <a href="http://www.nil.com/solutions/">engage our professional services team</a> for <a href="https://blog.ipspace.net/2010/10/dmvpn-from-concept-to-pilot-in-36-hours.html">larger design/deployment projects</a></p>

