---
title: "IP renumbering in disaster avoidance Data Center designs"
date: "2012-01-20T12:03:00.000+01:00"
tags: [ Data Center,Workshop,load balancing,LISP,virtualization ]
---

<p>It’s hard for me to admit, but there just might be a <a href="http://blog.ioshints.info/2011/08/quotes-of-week.html">corner use case for split subnets and inter-DC bridging</a>: even if you move a cold VM between data centers in a controlled disaster avoidance process (moving live VMs <a href="http://blog.ioshints.info/2011/09/long-distance-vmotion-for-disaster.html">rarely makes sense</a>), you <a href="http://www.yellow-bricks.com/2012/01/19/avoid-changing-your-vms-ip-in-a-dr-procedure/">might not be able to change its IP address</a> due to hard-coded IP addresses, be it in application code or configuration files.</p>
<p class="note">Disaster recovery is a different beast: if you’ve lost the primary DC, it doesn’t hurt if you instantiate the same subnet in the backup DC.<!--more--></p>
<p>However, before jumping headfirst into a misty pool filled with unicorn tears (actually, a <a href="http://blog.ioshints.info/2011/12/large-scale-l2-dci-true-story.html">brittle solution</a> with too many moving parts that <a href="http://blog.ioshints.info/2011/11/busting-layer-2-data-center.html">usually makes no sense</a>), let’s see if there are alternatives. Here are some ideas in exponentially decreasing order of preference:</p>
<p><strong>Ever heard of </strong><strong>DNS?</strong> If the application uses hardcoded addresses in its clients or between servers, there’s not much you can do, but one would expect truly hardcoded addresses only in home-brewed craplications ... and masterpieces created by those “programming gurus” that never realized <em>hostnames </em>should be used in configuration files instead of <em>IP addresses</em>.</p>
<div class='separator'><a href='http://www.despair.com/incompetence.html'><img src='http://demotivators.despair.com/incompetencedemotivator.jpg' width='520' /></a></div>
<p>If your application is somewhat well-behaved, there are all sorts of <a href="http://en.wikipedia.org/wiki/Dynamic_DNS">dynamic DNS</a> solutions that you can use to automatically associate server’s new IP address with its DNS FQDN. <a href="http://blog.ioshints.info/2011/06/multisite-clusters-done-right-by-none.html">Windows clusters do that automatically</a>, many DHCP servers automatically create dynamic DNS entries after client address allocation, and there are <a href="http://dyn.com/support/clients/linux/">numerous Linux clients</a> that you can use even with static IP addresses.</p>
<p class="warn">Use low TTL values if you’re changing DNS records, or the clients won’t be able to connect to the migrated servers due to stale local DNS caches.</p>
<p><strong>H</strong><strong>ost routes?</strong> For whatever reason some people think host routes are worse than long-distance bridging. They’re not – if nothing else, you have all the forwarding information in one place ... and modern L3 switches use hosts routes for directly connected IP hosts anyway.</p>
<p>Automatic network-side configuration of host routes is mission impossible. <a href="http://blog.ioshints.info/2011/02/local-area-mobility-lam-true-story.html">Local Area Mobility (LAM) worked years ago</a>, but is not supported in data center switches ... and the only other mechanism I could think of that wouldn’t involve loads of homemade scripting glue is <a href="http://blog.ioshints.info/2011/11/openflow-deployment-models.html">OpenFlow-driven RIB modification supposedly working on Juniper MX routers</a>.</p>
<p>LISP is another option. <a href="http://www.cisco.com/en/US/prod/collateral/iosswrel/ps6537/ps6554/ps6599/ps10800/solution_overview_c22-650815.html">LISP VM Mobility</a> detects out-of-subnet IP addresses and uses LISP mappings to steer traffic toward them. LISP VM mobility is somewhat similar to host routes, but uses tunneling across IP core instead of forwarding state distribution. Another bonus: host routes (actually LISP mappings for /32 prefixes) are created automatically.</p>
<p><strong>Routing protocols?</strong> Routing protocols running on servers were pretty popular years ago (that’s how <a href="http://www-03.ibm.com/support/techdocs/atsmastr.nsf/WebIndex/PRS1708">IBM implemented IP multipathing on mainframes</a>). Instead of configuring hardcoded IP address on server’s LAN interface, configure it on a loopback and run OSPF over DHCP-addressed LAN interfaces. </p>
<p class="info">Assuming you still use Cat 6500 in your data center instead of Nexus switches, you could use <a href="http://wiki.nil.com/OSPF_flooding_filters_in_hub-and-spoke_environment">OSPF database filters</a> to minimize the impact of changes in OSPF topology.</p>
<p>Yeah, I know, a stupid solution like this requires actual changes to server configurations ... and it’s so much easier to pretend the problem doesn’t exist and claim that the network should support whatever we throw at it ;)</p>
<p><strong>Route Health Injection on load balancers?</strong> Same idea as server-side routing protocols, but implemented in front of the whole application infrastructure. </p>
<p>Assuming your application sits behind a load balancer and you’re doing a cold migration of all application components in one step, you can preconfigure all the required IP subnets in the disaster recovery site (after all, they’re hidden behind a load balancer) and rely on the load balancer to insert the publicly-visible route to the application’s public IP address once everything is ready to go.</p>
<p><strong>The </strong><strong>universal </strong><strong>duct tape – NAT</strong>. If the clients use DNS to connect to the servers, but the servers have to use fixed IP addresses, use NAT to hide server subnets behind different public IP addresses (one per site). </p>
<p class="note">Obviously you have to move the whole application infrastructure at once if you want to use this approach or things will break really badly. </p>
<p>Apart from the usual NAT-is-bad and NAT-breaks-things mantras, there are a few additional drawbacks:</p>
<ul class="ListParagraph"><li>Clients have to rely on changed DNS records as you cannot insert a host route into the outside network like a load balancer can with RHI.</li>
<li>NAT devices usually don’t support dynamic DNS registration, so you have to change the DNS entries “manually”.</li>
</ul>
<p><strong>Virtual appliances?</strong> Duncan Epping <a href="http://www.yellow-bricks.com/2012/01/19/avoid-changing-your-vms-ip-in-a-dr-procedure/">proposed using vShield Edge as a NAT device</a>.  I wouldn’t – on top of all the other drawbacks mentioned above, vShield Edge becomes a single point of failure that uses <a href="http://blog.ioshints.info/2011/08/high-availability-fallacies.html">VMware HA to provide somewhat better availability</a>. </p>
<p><strong>Anything else?</strong> I’m positive I’ve missed an elegant idea or two. Your comments are most welcome ... including those telling me why the ideas mentioned above would never be implementable.</p>

