---
date: 2012-05-28T07:08:00.000+02:00
tags:
- bridging
- data center
- virtualization
title: Layer-2 Network Is a Single Failure Domain
url: /2012/05/layer-2-network-is-single-failure.html
---

<p>This topic has been on my to-write list for over a year and its working title was phrased as a question, but all the horror stories you’ve shared with me over the last year or so (some of them published in my blog) have persuaded me that there’s no question – it’s a fact.</p>
<p class="note">If you think I’m rephrasing the same topic ad nauseam, you’re right, but every month or so I get an external trigger that pushes me back to the same discussion, this time <a href="http://it20.info/2012/05/typical-vxlan-use-case/">an interesting comment thread on Massimo Re Ferre’s blog</a>.<!--more--></p>
<p>There are numerous reasons why we’re experiencing problems with transparently bridged Ethernet networks, ranging from challenges inherent in the design of Spanning Tree Protocol (STP) and <a href="/2012/04/stp-loops-strike-again.html">suboptimal implementations of STP</a>, to <a href="/2012/05/transparent-bridging-aka-l2-switching.html">flooding behavior inherent in transparent bridging</a>. </p>
<p>You can solve some of these issues with novel technologies like <a href="/2010/08/trill-and-8021aq-are-like-apples-and.html">SPB (802.1aq) or TRILL</a>, but you can’t change the basic fact: once you get a loop in a bridged network, and a broadcast packet caught in that loop (and flooded all over the network every time it’s forwarded by a switch), you’re toast.</p>
<p class="info">SPB aficionados will tell me loops cannot happen in SPB networks because of RPF checks. Just wait till you hit the first interesting software bug or an IS-IS race condition.</p>
<p>Yes, there’s storm control, and you can deploy it on every link in your network, but the single circulating broadcast packet (and its infinite copies) will trigger storm control on all switches, and prevent other valid broadcasts (for example, ARP requests) from being propagated, effectively causing a DoS attack on the whole layer-2 domain. Furthermore, the never-ending copies of the same broadcast packets delivered to the CPU of every single switch in the layer-2 domain will eventually start interfering with the control-plane protocols, causing further problems.</p>
<p><strong>The obvious conclusion</strong>: transparently bridged network (aka layer-2 network or VLAN) is a single failure domain.</p>
<h4>Why am I telling you this (again and again)?</h4><p>Some people think that you experience bridging-related problems only if you’re big enough, but everything is going to be fine if you have less than a thousand VMs, less than a hundred servers, less than ten switches … or whatever other number you come up with to pretend you’re safe. That’s simply not true – I’ve seen a total network meltdown in a (pretty small) data center with three (3) switches.</p>
<div class="separator" style="clear: both; text-align: center;"><img border="0" height="292" src="/2012/05/s400-BridgingDoesntScale.png" width="400"/></div>
<p>The only difference between a small(er) and big(ger) data center is that you might not care if your small data center goes offline for an hour or so, but if you do, then you simple <strong>have to </strong>split it up into multiple layer-2 domains connected through layer-3 switches (or load balancers or firewalls if you so desire). </p>
<p>If you’re serious about the claims that you have <a href="/2011/02/what-exactly-makes-something-mission.html">mission-critical applications</a> that <a href="/2011/08/high-availability-fallacies.html">require high availability</a> (and everyone claims they have them), then you simply have to create multiple availability zones in your network, and spread multiple copies of the same application across them. As <a href="http://it20.info/2011/04/tcp-clouds-udp-clouds-design-for-fail-and-aws/">Amazon proved</a>, even multiple availability zones might not be good enough, but having them is infinitely better than having a single failure domain.</p>
<h4>The usual counterarguments</h4><p>This is what I usually hear after presenting the above sad facts to data center engineers: “<em>there’s nothing we can do</em>”, “<em>but our users require unlimited VM mobility</em>”, “<em>our applications won’t work otherwise</em>” and a few similar ones. These are all valid claims, but as always in life, you have to face the harsh reality: either you do it right (and everyone accepts the limitations of doing it right), or you’ll pay for it in the future.</p>
<h4>Other options?</h4><p>As always (in the IT world), there’s always the third way: use MAC-over-IP network virtualization (in form of <a href="/2011/08/finally-mac-over-ip-based-vcloud.html">VXLAN</a>, <a href="/2011/09/nvgre-because-one-standard-just-wouldnt.html">NVGRE</a> or <a href="/2012/03/do-we-really-need-stateless-transport.html">STT</a>). Once these technologies get widely adopted and <a href="/2011/10/vxlan-termination-on-physical-devices.html">implemented in firewalls and load balancers</a> (or we decide to migrate from physical to virtual appliances), they’ll be an excellent option. In the meantime, you have to choose the lesser evil (whatever you decide it is).</p>
<h4>More information</h4><p>You probably know you’ll find a lot more information in my <a href="http://www.ipspace.net/Roadmap/Data_center_webinars">data center</a> and <a href="http://www.ipspace.net/Roadmap/Virtualization_webinars">virtualization webinars</a>, but there’s also a book I would highly recommend to anyone considering more than just how to wire a bunch of switches together – <a href="http://www.amazon.com/gp/product/0321753887?ie=UTF8&amp;tag=cisioshinandt-20&amp;linkCode=xm2&amp;camp=1789&amp;creativeASIN=0321753887">Scalability Rules</a> is an awesome collection of common-sense and field-tested scalability rules (including a number of networking-related advices not very dissimilar from what I’m always telling you). Finally, if you’d like to have my opinion on your data center design, check out the <a href="http://www.ipspace.net/ExpertExpress">ExpertExpress service</a>.</p>

