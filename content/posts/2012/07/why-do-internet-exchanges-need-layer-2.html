---
url: /2012/07/why-do-internet-exchanges-need-layer-2.html
title: "Why Do Internet Exchanges Need Layer-2?"
date: "2012-07-12T07:18:00.000+02:00"
tags: [ switching,Internet,BGP ]
---

<p>My <a href="https://twitter.com/ioshints/status/208994429716013059">tweet</a> about the <a href="http://www.theregister.co.uk/2012/06/01/linx_outage_caused_by_internet_loop/print.html">latest proof</a> of my <a href="/2012/05/layer-2-network-is-single-failure.html">layer-2 = single failure domain</a> claim has raised numerous questions about the use of bridging (aka switching) within Internet Exchange Points (IXP). Let’s see why most IXPs use L2 switching and why L2 switching is the simplest solution to the problem they’re solving.<!--more--></p>
<h4>What is an Internet Exchange Point?</h4><p>This section is a gross oversimplification intended for readers who have never been exposed to this topic. Please listen to the <a href="http://packetpushers.net/show-24-internet-exchanges-peering/">Packet Pushers Show 24</a> for a more in-depth IXP discussion.</p>
<p><strong>Quick summary</strong>: <a href="http://en.wikipedia.org/wiki/Internet_exchange_point">IXP</a> is the place where ISPs (member of the IXP) exchange traffic.</p>
<p>Only a few very large transit providers are considered <a href="http://en.wikipedia.org/wiki/Tier_1_network">Tier 1 networks</a> (see <a href="http://www.renesys.com/blog">Renesys blog</a> for <a href="http://www.renesys.com/blog/2012/02/a-bakers-dozen-2011-edition.shtml">yearly updates</a>), everyone else has to buy transit to the rest of the Internet from one or more of the bigger fish in the pond. </p>
<p>The smaller providers are thus interested in minimizing the amount of transit traffic and <a href="http://en.wikipedia.org/wiki/Peering_agreement#Peering_agreement">peering agreements</a> are usually a good mechanism. However, there are usually tens or hundreds of ISPs operating in a given geographical area, and private peering between them would result in an N-square full mesh problem. It’s thus in interest of almost everyone to meet in a common place, connect to a shared infrastructure – Internet Exchange Point – and exchange traffic.</p>
<h4>How does an IXP work?</h4><p>To keep things simple, let’s gloss over the details, and assume that every ISP participating in an IXP brings its own router to premises owned by IXP, and connects it to a shared network infrastructure.</p>
<p>Each ISP has its own AS number and uses BGP to exchange routes with other ISPs. ISPs might decide to peer with everyone, or with a select set of peers, and accept all routes or just a few routes from their peers.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/07/s1600-Low_IXP_BGP.jpg" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="287" src="/2012/07/s400-Low_IXP_BGP.jpg" width="350"/></a></div>
<p>An ISP can also decide to implement local transit agreements across an IXP infrastructure, or prefer routes from one of the peering partners over routes received from another peering partner. </p>
<p>In the example in the following diagram, AS 3 receives two paths toward AS X, one from AS 2, one from AS 4. It might prefer the route through AS 4, whereas AS 1 cannot use that route, since it’s not peering with AS 4 (unless AS 2 is willing to provide transit services).</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/07/s1600-Low_IXP_BGP_2P.jpg" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="/2012/07/s500-Low_IXP_BGP_2P.jpg"/></a></div>
<p><strong>To summarize:</strong> each ISP participating in an IXP might have its own BGP routing policy, resulting in an individualized view of the local parts of the Internet.</p>
<h4>IP- or MAC-based forwarding in an IXP?</h4><p>In the previous diagrams, the IXP infrastructure was drawn as a symbolic Ethernet cable, and some very early IXPs were actually implemented that way, using either <a href="http://en.wikipedia.org/wiki/10BASE5">thick coax</a> or Ethernet hubs. </p>
<p>Today we could use L2 or L3 switches to implement the IXP infrastructure. Ethernet-based IXP design is obvious and simple (while we’re still glossing over details): all ISP routers connect to a switched LAN.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/07/s1600-Low_IXP_L2.jpg" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="315" src="/2012/07/s400-Low_IXP_L2.jpg" width="350"/></a></div>
<p>We all know <a href="/2012/05/transparent-bridging-aka-l2-switching.html">bridging doesn’t scale</a>, so one might want to implement IP-based IXP infrastructure – all ISP routers would be connected to an IXP router, exchange BGP routes with it, and potentially still run BGP between themselves to support various routing policies.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/07/s1600-Low_IXP_L3.jpg" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="311" src="/2012/07/s400-Low_IXP_L3.jpg" width="350"/></a></div>
<p>This scenario might work as long as all ISPs share the same routing policy. IP uses hop-by-hop destination-only forwarding (tunnels are obvious exceptions triggering the scholastic <a href="http://packetpushers.net/show-102-a-layer-of-indirection-is-mpls-tunneling/"><em>Is MPLS Tunneling</em></a> problem), and thus it’s impossible for the IXP router to forward packets from different ISPs based on their preferred routing policy.</p>
<p>Going back to our example: if the IXP router decides to prefer route to AS X going through AS 2, it’s impossible for AS 3 to forward the packets toward AS X through AS 4. While the router in AS 3 might decide to prefer the path advertised by AS 4, once the IP packets leave it and arrive at the IXP router, the IXP router will make its own independent forwarding decision and send the packets to AS 2.</p>
<p><strong>Conclusion:</strong> Internet Exchange Points are one of the rare scenarios where large L2 domains actually make sense, and once they grow and get distributed across multiple locations (example: <a href="http://www.ams-ix.net/infrastructure/">AMS-IX</a>, <a href="https://www.linx.net/pubtools/topology.html">LINX</a>), they get exposed to the same set of problems all large L2 networks face, including occasional meltdowns.</p>

