---
url: /2012/07/bgp-route-replication-in-mplsvpn-pe.html
title: "BGP route replication in MPLS/VPN PE-routers"
date: "2012-07-19T06:58:00.000+02:00"
tags: [ BGP,load balancing,MPLS VPN ]
---

<p>Whenever I’m explaining MPLS/VPN technology, I recommend using the same route targets (RT) and route distinguishers (RD) in all VRFs belonging to the same simple VPN. The <em>Single RD per VPN</em> recommendation <a href="https://blog.ipspace.net/2011/02/load-balancing-in-mplsvpn-networks-with.html">doesn’t work well for multi-homed sites</a>, so one might wonder whether it would be better to use a different RD in every VRF. The RD-per-VRF design also works, but results in significantly increased memory usage on PE-routers.</p>
<p class="update">2012-07-24: Updated the conclusions based on feedback from <em>nosx</em><!--more--></p>
<h4>Sample network</h4><p>I’ll illustrate the problem using the same network I used in <a href="https://blog.ipspace.net/2011/02/load-balancing-in-mplsvpn-networks-with.html">MPLS/VPN load balancing post</a>:</p>
<div class="separator"><a href="/2012/07/s1600-MPLSVPN_MH.png" imageanchor="1"><img border="0" src="/2012/07/s520-MPLSVPN_MH.png"/></a></div>
<p>Yet again, CE-A and CE-B are advertising BGP default route to PE-A and PE-B, but this time, PE-A, PE-B and PE-C use different route distinguishers in their VRF configurations:</p>
<p class="codecaption">VRF configuration on PE-A</p>
<pre class="code">ip vrf Customer<br/><strong> rd 65000:101</strong><br/> route-target export 65000:101<br/> route-target import 65000:101</pre><p class="codecaption">VRF configuration on PE-B</p>
<pre class="code">ip vrf Customer<br/> rd 65000:1101<br/> route-target export 65000:101<br/> route-target import 65000:101</pre><p class="codecaption">VRF and BGP configuration on PE-C</p>
<pre class="code">ip vrf Customer<br/> rd 65000:102<br/> route-target export 65000:101<br/> route-target import 65000:101<br/>!<br/>router bgp 65000<br/> !<br/> address-family ipv4 vrf Customer<br/>  no synchronization<br/>  maximum-paths ibgp  4 import 4<br/> exit-address-family</pre><h4>The results</h4><p>When the network reaches a stable state, PE-C should have two default routes in its BGP table, one from PE-A (with RD 65000:101) and one from PE-B (with RD 65000:1101).</p>
<p class="info">We have to use different route distinguishers on PE-A and PE-B to allow the two routes to pass through the route reflector. <a href="http://tools.ietf.org/html/draft-ietf-idr-add-paths"><em>Advertisement of Multiple Paths in BGP</em></a><em> (</em>BGP Add Paths) feature would solve that problem, but it’s not yet implemented in Cisco IOS. This feature is available in <a href="http://www.cisco.com/en/US/docs/routers/xr12000/software/xr12k_r4.1/routing/configuration/guide/routing_cg41xr12k_chapter1.html#concept_77EE033C2F0C4BDDB8423C25FA71E3F9">IOS XR</a>, IOS XE has <a href="http://www.cisco.com/en/US/docs/ios-xml/ios/iproute_bgp/configuration/xe-3s/irg_diverse_path.html">Diverse-Path Route Reflector</a> feature, and <a href="http://www.juniper.net/techpubs/en_US/junos/information-products/topic-collections/nce/bgp-add-path/configuring-bgp-add-path.pdf">Junos</a> supports BGP Add Paths for IPv4 prefixes (not really useful for our purpose).</p>
<p>Now let’s inspect the BGP table on PE-C:</p>
<p class="codecaption">VPNv4 BGP table on PE-C</p>
<pre class="code">PE-C#<strong>show bgp vpnv4 unicast all</strong><br/>[...edited...]<br/>   Network          Next Hop            Metric LocPrf Weight Path<br/>Route Distinguisher: 65000:101<br/>*&gt;i0.0.0.0          172.16.0.1               0    100      0 65100 i<br/><br/>Route Distinguisher: 65000:102 (default for vrf Customer)<br/>* i0.0.0.0          172.16.0.2               0    100      0 65100 i<br/>*&gt;i                 172.16.0.1               0    100      0 65100 i<br/><br/>Route Distinguisher: 65000:1101<br/>*&gt;i0.0.0.0          172.16.0.2               0    100      0 65100 i</pre><p>For whatever weird reason, the BGP table has <em>four </em>copies of the default route, not two. Let’s inspect these four entries in more details:</p>
<p class="codecaption">VPNv4 BGP entries for default route on PE-C</p>
<pre class="code">PE-C#<strong>show bgp vpnv4 unicast all 0.0.0.0</strong>                        <br/>BGP routing table entry for 65000:101:0.0.0.0/0, version 70<br/>Paths: (1 available, best #1, no table)<br/>Flag: 0x820<br/>  Not advertised to any peer<br/>  65100<br/>    172.16.0.1 (metric 129) from 172.16.0.5 (172.16.0.5)<br/>      Origin IGP, metric 0, localpref 100, valid, internal, best<br/>      Extended Community: RT:65000:101<br/>      Originator: 172.16.0.1, Cluster list: 172.16.0.5<br/>      mpls labels in/out nolabel/37<br/>BGP routing table entry for 65000:102:0.0.0.0/0, version 106<br/>Paths: (2 available, best #2, table Customer)<br/>Multipath: eBGP<br/>Flag: 0x820<br/>  Not advertised to any peer<br/>  65100, imported path from 65000:1101:0.0.0.0/0<br/>    172.16.0.2 (metric 129) from 172.16.0.5 (172.16.0.5)<br/>      Origin IGP, metric 0, localpref 100, valid, internal, multipath<br/>      Extended Community: RT:65000:101<br/>      Originator: 172.16.0.2, Cluster list: 172.16.0.5<br/>      mpls labels in/out nolabel/30<br/>  65100, imported path from 65000:101:0.0.0.0/0<br/>    172.16.0.1 (metric 129) from 172.16.0.5 (172.16.0.5)<br/>      Origin IGP, metric 0, localpref 100, valid, internal, multipath, best<br/>      Extended Community: RT:65000:101<br/>      Originator: 172.16.0.1, Cluster list: 172.16.0.5<br/>      mpls labels in/out nolabel/37<br/>BGP routing table entry for 65000:1101:0.0.0.0/0, version 69<br/>Paths: (1 available, best #1, no table)<br/>Flag: 0x820<br/>  Not advertised to any peer<br/>  65100<br/>    172.16.0.2 (metric 129) from 172.16.0.5 (172.16.0.5)<br/>      Origin IGP, metric 0, localpref 100, valid, internal, best<br/>      Extended Community: RT:65000:101<br/>      Originator: 172.16.0.2, Cluster list: 172.16.0.5<br/>      mpls labels in/out nolabel/30</pre><p>On top of the two routes received from PE-A and PE-B, there are two almost identical routes with RD 65000:102 marked <em>imported path</em>. Weird, isn’t it?</p>
<h4>What’s going on?</h4><p>You probably know the basic principles of MPLS/VPN and BGP route selection (<a href="https://blog.ipspace.net/2007/06/using-mpls-vpn-books-to-study-for-ccip.html">read my MPLS/VPN books</a> or watch my <a href="http://www.ipspace.net/Enterprise_MPLS_VPN_Deployment">Enterprise MPLS/VPN webinar</a> if you need more details). Best MPLS/VPN routes are selected using (approximately) this algorithm: </p>
<ol class="ListParagraph"><li>BGP routing process performs best path selection in the VPNv4 table using the <a href="http://www.cisco.com/en/US/tech/tk365/technologies_tech_note09186a0080094431.shtml">standard set of BGP path selection rules</a>.</li>
<li>The IPv4 parts of the best-path VPNv4 prefixes with the route targets matching local VRFs are inserted into the VRF routing tables (where they compete with routes learned through per-VRF routing protocols based on their administrative distance);</li>
<li>Per-VRF FIB is built from the VRF routing table (more details in <a href="https://blog.ipspace.net/2010/09/ribs-and-fibs.html">RIBs and FIBs</a>)</li>
</ol>
<p>The first step in this process (BGP best path selection) cannot work correctly if the prefixes in VPNv4 table are not comparable. Remember: we have to compare the whole VPNv4 prefix as different customers might have overlapping address spaces. </p>
<p>The BGP process thus has to make local copies of those BGP paths that have RDs different from the local RD value to make them comparable to local BGP paths (for example, routes received from a CE-router through an EBGP session). The BGP paths received from other PE-routers are <em>imported </em>(BGP process creates a copy with the local value of the RD) and then used in the BGP best path selection process.</p>
<p class="info">To be precise, step#2 in the above algorithm (copy from VPNv4 BGP table into VRF RIB) should read “... with the route targets <em>and route distinguishers </em>matching local VRFs ...”</p>
<h4>Is this bad?</h4><p>As always, the answer is “It depends.” If you have an occasional route distinguisher mismatch, you’ll slightly increase your memory consumption. But if you’d go to the extreme and use a different VRF and RD for every site connected to a PE-router, the overhead of the <em>imported </em>BGP routes might become significant.</p>
<p>Let’s continue with our example and add another VRF on PE-C with the same RT but a different RD:</p>
<p class="codecaption">Second VRF on PE-C</p>
<pre class="code">ip vrf Site-B<br/><strong> rd 65000:103</strong><br/> route-target export 65000:101<br/> route-target import 65000:101</pre><p>As expected, PE-C creates another copy of default routes received from PE-A and PE-B, further increasing BGP memory consumption:</p>
<p class="codecaption">Multiple copies of VPN default route on PE-C</p>
<pre class="code">PE-C#<strong>show bgp vpnv4 unicast all</strong><br/>[...edited...]<br/>   Network          Next Hop            Metric LocPrf Weight Path<br/>Route Distinguisher: 65000:101<br/>*&gt;i0.0.0.0          172.16.0.1               0    100      0 65100 i<br/><br/>Route Distinguisher: 65000:102 (default for vrf Customer)<br/>* i0.0.0.0          172.16.0.2               0    100      0 65100 i<br/>*&gt;i                 172.16.0.1               0    100      0 65100 i<br/><br/>Route Distinguisher: 65000:103 (default for vrf Site-B)<br/>* i0.0.0.0          172.16.0.2               0    100      0 65100 i<br/>*&gt;i                 172.16.0.1               0    100      0 65100 i<br/><br/>Route Distinguisher: 65000:1101<br/>*&gt;i0.0.0.0          172.16.0.2               0    100      0 65100 i</pre><h4>Summary</h4><p>If you offer a simple VPN service, the <em>use a single RD and RT value for a simple VPN </em>is still be best advice I can give you. If you plan to support <a href="https://blog.ipspace.net/2011/02/load-balancing-in-mplsvpn-networks-with.html">multipath load sharing</a> or fast failover, the per-PE-per-VRF RD is the way to go till Cisco and Juniper implement BGP Add Paths functionality for VPNv4 prefixes.</p>
<p class="info"><em>nosx</em> made an excellent suggestion - use RDs in the <em>global.ipv4.loopback.address:vpnid</em> format. The RDs will definitely be unique, and you might find the presence of PE router identifier (its loopback address) useful during troubleshooting.</p>
<h4>Need help?</h4><p>The basics of MPLS/VPN technology and its enterprise use cases are described in the <a href="http://www.ipspace.net/Enterprise_MPLS_VPN_Deployment">Enterprise MPLS/VPN Deployments</a> webinar (also available as <a href="http://www.ipspace.net/Subscription_to_ioshints_webinars">part of the yearly subscription</a>), and I’m <a href="http://www.ipspace.net/ExpertExpress">always available for a discussion, quick design review or troubleshooting session</a>.</p>

