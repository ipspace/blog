---
title: "The Difference between Metro Ethernet and Stretched Data Center Subnets"
date: "2012-07-24T07:25:00.000+02:00"
tags: [ bridging,Data Center,Workshop,Service Providers,WAN ]
---

<p>Every time I rant about <a href="http://blog.ioshints.info/2012/05/layer-2-network-is-single-failure.html">large-scale bridging</a> and <a href="http://blog.ioshints.info/2011/11/busting-layer-2-data-center.html">stretched L2 subnets</a>, someone inevitably points out that Carrier (or Metro) Ethernet works perfectly fine using the same technologies and principles.</p>
<p>I won’t spend any time on the “perfectly fine” part (Greg Ferro had a lot to say about that in the early <a href="http://packetpushers.net/category/podcast-post/">Packet Pushers podcasts</a>), but focus on the fundamental difference between the two: the use case.<!--more--></p>
<h4>Typical Metro Ethernet use case</h4><p>Engineers who know what they’re doing connect individual sites to Metro Ethernet services with layer-3 devices (some others will <a href="http://blog.ioshints.info/2009/05/vpls-is-not-aspirin.html">eventually figure it out</a> after a meltdown or two). </p>
<div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-R8dQzStn0fo/UAl_h3sAhVI/AAAAAAAAFAw/X4M4Sx-6TIw/s1600/MetroEthernet.png"><img border="0" src="http://3.bp.blogspot.com/-R8dQzStn0fo/UAl_h3sAhVI/AAAAAAAAFAw/X4M4Sx-6TIw/s500/MetroEthernet.png" /></a></div>
<p>It doesn’t matter whether you call the site edge devices routers or switches, they perform several critical functions:</p>
<ul class="ListParagraph"><li>They split the <em>inside </em>(your site) and the <em>outside </em>(service provider transport network) into two separate L3 subnets and two failure domains;</li>
<li>They run routing protocols. Other devices attached to the same Metro Ethernet service can thus figure out whether a site is reachable or not;</li>
<li>They can find alternate paths (if they exist) after a link or service failure.</li>
</ul>
<p>In principle, the routers connecting your sites to a Metro Ethernet service treat that service as one of the potential transport networks, and can use the routing protocols or BFD/CFM to figure out when the Metro Ethernet service is gone even if the local link status doesn’t change.</p>
<p>Worst case, if the Metro Ethernet service falls apart, and you’ve provisioned backup links, your sites can still communicate with each other. If the Metro Ethernet service experiences a severe meltdown, the hosts inside your sites will not be affected (the routers might be due to heavy CPU load induced by broadcasts received from Metro Ethernet LAN).</p>
<p><strong>Summary</strong>: it’s perfectly safe to use layer-2 transport network as long as you terminate it with a layer-3 device.</p>
<h4>Typical stretched data center subnet use case</h4><p>Hosts are directly attached to stretched layer-2 subnets (VLANs) in a typical layer-2 data center interconnect design, as shown in the next diagram.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-yQXfJbYUoPU/UAl_0DmepiI/AAAAAAAAFA8/zs6X9icThRw/s1600/L2DCI.png"><img src="http://2.bp.blogspot.com/-yQXfJbYUoPU/UAl_0DmepiI/AAAAAAAAFA8/zs6X9icThRw/s450/L2DCI.png" /></a></div>
<p>The servers (IP hosts) attached to stretched VLANs usually have no routing intelligence; all they know are two simple rules:</p>
<ul class="ListParagraph"><li>If the destination IP address belongs to the same subnet, use ARP to find the MAC address of the other host, and send the IP packet to that MAC address. If the ARP request fails, the other host is unreachable.</li>
<li>Otherwise, send the IP packet to the IP address of the default gateway.</li>
</ul>
<p class="note">The lack of routing intelligence in typical servers is not a software/OS issue. <a href="http://lartc.org/howto/lartc.dynamic-routing.html">Linux</a> and <a href="http://www-03.ibm.com/support/techdocs/atsmastr.nsf/WebIndex/PRS1708">z/OS</a> support routing daemons, and so did <a href="http://technet.microsoft.com/en-us/library/cc758016(v=ws.10)">Windows server</a> until it <a href="http://social.technet.microsoft.com/Forums/en-US/winserverNIS/thread/8026e9e4-57ad-4675-9f2d-73d9cb0dd80a/">got lobotomized</a>. However, it seems many engineers think <a href="http://en.wikipedia.org/wiki/Naked_singularity">naked singularity</a> would materialize and gobble up their whole data center if they configured OSPF on a server.</p>
<p>Typical IP hosts have no means of detecting the VLAN failure or partitioning, and cannot find alternate paths. They rely on network devices providing the connectivity, and with no layer-3 intelligence in the path, there’s <a href="http://blog.ioshints.info/2010/07/bridging-and-routing-is-there.html">only so much the networking devices can do</a>.</p>
<p>The layer-2 data center interconnect thus becomes the most critical part of the whole data center infrastructure – if it breaks, everything else stops working (<a href="http://blog.ioshints.info/2011/06/stretched-clusters-almost-as-good-as.html">assuming the servers or VMs in the same subnet are on both ends of the failure</a>). Is that a good idea? Not in my book.</p>

