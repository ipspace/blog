---
url: /2012/08/vxlan-and-otv-ive-been-suckered.html
title: "VXLAN and OTV: I’ve been suckered"
date: "2012-08-27T07:07:00.000+02:00"
tags: [ VXLAN,Overlay networks,LAN,virtualization ]
---

<p>When VXLAN came out a year ago, a lot of us looked at the packet format and wondered why Cisco and VMware decided to use UDP instead of <a href="https://blog.ipspace.net/2011/09/nvgre-because-one-standard-just-wouldnt.html">more commonly used GRE</a>. One explanation was evident: UDP port numbers give you more entropy that you can use in 5-tuple-based load balancing. The other explanation looked even more promising: <a href="http://blogs.cisco.com/datacenter/vxlan-deep-dive-part-2-looking-at-the-options/">VXLAN and OTV use very similar packet format</a>, so the hardware already doing OTV encapsulation (Nexus 7000) could be used to do <a href="https://blog.ipspace.net/2011/10/vxlan-termination-on-physical-devices.html">VXLAN termination</a>. Boy have we been suckered.</p>
<p class="update">Update 2015-07-12: NX-OS 7.2.0 supports OTV encapsulation with VXLAN-like headers on F3 linecards. See <a href="http://www.cisco.com/c/en/us/td/docs/switches/datacenter/sw/nx-os/OTV/config_guide/b_Cisco_Nexus_7000_Series_NX-OS_OTV_Configuration_Guide-RI/adv-otv.html#concept_DA4DC5F6510B44889243866C807C34BA">OTV UDP Encapsulation</a> for more details (HT: Nik Geyer).<!--more--></p>
<p>It turns out nobody took the time to analyze an OTV packet trace with the Wireshark; everyone believed whatever IETF drafts were telling us. Here’s the packet format from <a href="http://tools.ietf.org/html/draft-hasmit-otv-03">draft-hasmit-otv-03</a>:</p>
<pre class="code">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|Version|  IHL  |Type of Service|          Total Length         |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|         Identification        |Flags|      Fragment Offset    |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|  Time to Live | Protocol = 17 |         Header Checksum       |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|                Source-site OTV Edge Device IP Address         |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|       Destination-site OTV Edge Device (or multicast) Address |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|     Source Port = xxxx        |         Dest Port = 8472      |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|           UDP length          |        UDP Checksum = 0       |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|R|R|R|R|I|R|R|R|           Overlay ID                          |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|          Instance ID                          | Reserved      |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|                                                               |<br/>|               Frame in Ethernet or 802.1Q Format              |<br/>|                                                               |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</pre><p>And here’s the packet format from <a href="http://tools.ietf.org/html/draft-mahalingam-dutt-dcops-vxlan-02">draft-mahalingam-dutt-dcops-vxlan</a>. Apart from a different UDP port number, the two match perfectly.</p>
<pre class="code"><strong>Outer IP Header:</strong><br>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|Version|  IHL  |Type of Service|          Total Length         |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|         Identification        |Flags|      Fragment Offset    |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|  Time to Live |    Protocol   |         Header Checksum       |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|                       Outer Source Address                    |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|                   Outer Destination Address                   |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br><strong>Outer UDP Header:</strong><br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|       Source Port = xxxx      |       Dest Port = VXLAN Port  |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|           UDP Length          |        UDP Checksum           |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br><strong>VXLAN Header:</strong><br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|R|R|R|R|I|R|R|R|            Reserved                           |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|                VXLAN Network Identifier (VNI) |   Reserved    |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ <br><strong>Inner Ethernet Header:           </strong><strong><br/></strong>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|             Inner Destination MAC Address                     |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>| Inner Destination MAC Address | Inner Source MAC Address      |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>|                Inner Source MAC Address                       |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>| Optional Ethertype = C-Tag    | Inner.VLAN Tag Information    |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br><strong>Payload:</strong><br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>| Ethertype of Original Payload |                               |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |<br/>|                                  Original Ethernet Payload    |<br/>|                                                               |<br/>| (Note that the original Ethernet Frame's FCS is not included) |<br/>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</br></br></br></br></br></pre><p>However, it turns out the OTV draft four Cisco’s engineers published in 2011 has nothing to do with the actual implementation and encapsulation format used by Nexus 7000. It seems <a href="http://www.linkedin.com/in/bmcgahan">Brian McGahan</a> was the first one to <a href="http://blog.ine.com/2012/08/17/otv-decoded-a-fancy-gre-tunnel/">actually do the OTV packet capture and analysis and published his findings</a>. He discovered that OTV is nothing else than the very familiar EoMPLSoGREoIP. No wonder the first VXLAN gateway device Cisco announced at Cisco Live is not the Nexus 7000 but a Nexus 1000V-based solution (at least that’s the way I understood <a href="http://www.cisco.com/en/US/prod/collateral/iosswrel/content/white_paper_c11-707978.pdf">this whitepaper</a>).</p>

