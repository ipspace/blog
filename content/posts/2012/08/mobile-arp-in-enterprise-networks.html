---
url: /2012/08/mobile-arp-in-enterprise-networks.html
title: "Mobile ARP in Enterprise Networks"
date: "2012-08-16T06:30:00.000+02:00"
tags: [ ARP,IP routing ]
---

<p>Keith sent me a set of Mobile ARP questions, starting with “<em>What’s your view on using Mobile ARP in a large enterprise?</em>” </p>
<p><strong>Short summary</strong>: Mobile ARP is an <a href="https://blog.ipspace.net/2011/02/local-area-mobility-lam-true-story.html">ancient technology that was designed to solve a problem that disappeared with deployment of DHCP</a>. Now let’s look at the bigger picture.<!--more--></p>
<h4>The basics</h4><p>What we could do with Mobile ARP is what I’ll call <em>IP address mobility</em> in the scope of this article (if there’s a better name, write a comment) – the ability to create host routes to IP hosts in “wrong” subnet, and distribute those host routes through a routing protocol to everyone that might care to know how to reach those hosts.</p>
<p>Obviously, this approach doesn’t scale well, particularly if implemented with a single enterprise-wide IGP. However, that hasn’t stopped some people from proposing a similar LISP Mobility Architecture, yet again proving the infinite wisdom of <a href="http://tools.ietf.org/html/rfc1925">RFC 1925 (section 2.11)</a>.</p>
<p>Furthermore, the original problem Mobile ARP was trying to solve did not involve moving nodes or fast topology changes – it allowed a stationary node to appear in a foreign IP subnet and still receive traffic for its IP address, but did not allow fast moves between IP subnets.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/08/s1600-Snail.jpg" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="308" src="/2012/08/s400-Snail.jpg" width="400"/></a><br/>That's the proper pace for Mobile ARP-driven IP address mobility (source: <a href="http://openphoto.net/gallery/image.html?image_id=10035">openphoto.net</a>)</div>
<h4>Campus networks</h4><p>Problems with host route scalability prompted IETF to design Mobile IP for IPv4 and IPv6 years ago. If you have to support mobile IP nodes moving across L3 subnets in your campus network, you’re better off enabling Mobile IP support on them.</p>
<p class="note">A <a href="http://www.pragma.si/resume/index.html">friend of mine</a> is <a href="http://translate.google.com/translate?sl=sl&amp;tl=en&amp;u=http%3A%2F%2Fgo6.si%2F2010%2F12%2Fhome-agent-server-za-mobile-ipv6-postavljen-tudi-sloveniji%2F&amp;act=url">working on 3G/4G Mobile IPv6 deployment for emergency response teams with Nokia</a>. They got the whole thing up and running in a semi-production environment; contact him for more details.</p>
<h4>Data centers</h4><p>Data center is a whole different story. Nobody can ever touch the virtualized holy cows (aka VMs) because something just might break if you install an additional bit of software on them, so the common assumption is Mobile IP is off-limits, and we’re using <a href="https://blog.ipspace.net/2010/09/vmotion-elephant-in-data-center-room.html">all sorts of kludges to allow VMs to be moved around and still retain their IP addresses</a>. </p>
<p>Hypervisors already use fake gratuitous ARP messages to indicate a VM has moved to a different location in the data center, so the Mobile ARP seems to be a perfect match. After all, the first-hop routers could use those gratuitous ARPs to discover the VM moves and change the IP forwarding tables accordingly (and there’s the <a href="http://tools.ietf.org/html/draft-xu-virtual-subnet-04">Virtual Subnet IETF draft that proposes exactly that</a>).</p>
<p>The fake gratuitous ARP trick works only due to non-deterministic data-plane-driven forwarding behavior of layer-2 switches (formerly known as bridges) – as soon as the hypervisor to which the VM has been moved sends the gratuitous ARP with the VM’s source MAC address, every switch in the network scraps the previous information and installs the new forwarding entry. Unfortunately, that’s not how routers work.</p>
<p>A proper L3-focused IP mobility solution would need at least two steps:</p>
<ul class="ListParagraph"><li>The hypervisor from which the VM has been removed would have to inform the first-hop router that the VM’s IP address is no longer reachable;</li>
<li>The hypervisor to which the VM has moved would have to inform its first-hop router that a new IP address has appeared.</li>
</ul>
<p>Gratuitous ARP is a mechanism that could potentially solve the second problem assuming we ignore all the security implications, overloaded semantics, and the fact that ARP works only for IPv4 ... but we’re still missing the first step (although the <a href="http://tools.ietf.org/html/draft-xu-virtual-subnet-04#page-9">Virtual Subnet draft uses an interesting trick</a> to solve that problem). Note that we can’t rely on ARP timeouts (like Mobile ARP does); the traffic disruption would be way too long.</p>
<h4>VM mobility with LISP</h4><p>Cisco has yet another solution for your data center woes: <a href="http://www.cisco.com/en/US/prod/collateral/iosswrel/ps6537/ps6554/ps6599/ps10800/at_a_glance_c45-646350.pdf">LISP for Virtual Machine Mobility</a> (is it just me or does LISP really look like a hammer desperately searching for a nail?), which is only slightly better than Mobile ARP. </p>
<p>LISP for VM Mobility won’t pollute the core IP routing tables with VM host routes because LISP uses another layer of indirection (and IP-over-IP tunneling), but is still hasn’t solved the fundamental problem: since there’s no protocol between hypervisors and xTRs (LISP terminology for PE-router), LISP relies on traffic snooping to figure out a VM has moved. </p>
<p class="note"><a href="https://blog.ipspace.net/2011/06/inter-dc-ip-based-vmotion-with-lisp.html">LISP on Nexus 1000V would be a great solution</a> (because Nexus 1000V knows exactly what’s going on with VMs, and could update LISP mapping database accordingly), but that code mysteriously disappeared almost two years ago.</p>
<h4>Short summary</h4><p>Mobile ARP is an ancient technology that was solving a now-extinct problem. Please don’t try to resurrect it; you just might experience a zombie apocalypse.</p>

