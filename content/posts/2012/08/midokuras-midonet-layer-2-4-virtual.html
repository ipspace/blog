---
date: 2012-08-30T08:43:00.000+02:00
tags:
- VPN
- SDN
- data center
- OpenFlow
- IP routing
- overlay networks
- virtualization
title: 'Midokura’s MidoNet: a Layer 2-4 virtual network solution'
url: /2012/08/midokuras-midonet-layer-2-4-virtual/
---

<p>Almost everyone agrees the current way of implementing virtual networks with <a href="/2011/12/vmware-vswitch-baseline-of-simplicity/">dumb hypervisor switches</a> and <a href="/2011/12/vm-aware-networking-improves-iaas-cloud/">top-of-rack kludges</a> (including <a href="/2012/02/edge-virtual-bridging-8021qbg/">Edge Virtual Bridging – EVB or 802.1Qbg</a> – and <a href="/2012/08/8021br-same-old-same-old/">802.1BR</a>) doesn’t scale. Most people working in the field (with the notable exception of some hardware vendors busy protecting their turfs in the <a href="http://datatracker.ietf.org/wg/nvo3/charter/">NVO3 IETF working group</a>) also agree <a href="/2012/05/virtual-networks-skype-analogy/">virtual networks running as applications on top of IP fabric</a> are the <a href="/2011/12/decouple-virtual-networking-from/">only reasonable way to go</a> ... but that’s all they currently agree upon.<!--more--></p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/08/s1600-midokura_VLANs.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="135" src="/2012/08/s400-midokura_VLANs.png" width="400"/></a><br/>Traditional VLAN-based virtual networks implemented in the physical switches</div>
<div class="separator" style="clear: both; text-align: center; margin-top: 1em;"><a href="/2012/08/s1600-midokura_virtual_over_IP.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="/2012/08/s400-midokura_virtual_over_IP.png" width="320"/></a><br/>Virtual networks implemented in the hypervisor switches on top of an IP fabric</div>
<h4>A brief overview of where we are</h4><p>Cisco, VMware and Microsoft disappointingly chose the easiest way out: VXLAN and NVGRE are MAC-over-IP virtual networks with no control plane. They claim they need layer-2 virtual networks to support existing applications (like <a href="/2012/02/microsoft-network-load-balancing-behind/">Microsoft’s load balancing marvels</a>) and rely on flooding (emulated with IP multicast) to build the remote-MAC-to-remote-IP mappings in hypervisor virtual switches.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/08/s1600-VXLAN-Details.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em; border-bottom-style: none; "><img border="0" src="/2012/08/s540-VXLAN-Details.png"/></a><br/>VXLAN architecture</div>
<p>Nicira’s Network Virtualization Platform is way better – it has a central control plane that uses OpenFlow to distribute MAC-to-IP mapping information to individual hypervisors. The version of their software I’m familiar with implemented simple layer-2 virtual networks; they were promising layer-3 support, but so far haven’t updated me on their progress.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/08/s1600-Decouple_Nicira.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em; border-bottom-style: none; "><img border="0" height="261" src="/2012/08/s320-Decouple_Nicira.png" width="320"/></a></div>
<h4>The Missing L3-4 Problem</h4><p>We know application teams trying to <a href="/2012/08/pvlan-vxlan-and-cloud-application/">deploy their application stacks on top of virtual networks</a> usually need more than a single virtual network (or security zone). A typical scale-out application has multiple tiers that have to be connected with load balancers or firewalls. </p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/08/s1600-Scale_Out.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em; border-bottom-style: none; "><img border="0" src="/2012/08/s520-Scale_Out.png"/></a><br/>Simplified scale-out application architecture</div>
<p>All the vendors mentioned above are dancing around that requirement claiming you can always implement whatever L3-7 functionality you need with software appliances running as virtual machines on top of virtual networks. A typical example of this approach is vShield Edge, a VM with baseline load balancing, NAT and DHCP functionality.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/08/s1600-midokura_LB_as_VM.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="167" src="/2012/08/s400-midokura_LB_as_VM.png" width="400"/></a><br>Load balancer as a VM appliance</br></div>
<p class="note">To keep the record straight: VMware, Cisco, Juniper and a few others offer hypervisor-level firewalls; traffic going between security zones doesn’t have to go through an external appliance (although it <a href="/2011/11/junipers-virtual-gateway-virtual/">still goes through a VM if you’re using VMware’s vShield Zones/App</a>). Open vSwitch used by Nicira’s NVP could be easily configured to provide ACL-like functionality, but I don’t know how far Nicira got in implementing it.</p>
<h4>Midokura’s MidoNet: a L2-4 virtual SDN</h4><p>A month ago <a href="http://www.linkedin.com/in/bcherian">Ben Cherian</a> <a href="/2012/07/legacy-protocols-in-openflow-based/#c1185555761189378507">left a comment</a> on my blog saying “<em>Our product, </em><em>MidoNet</em><em>, supports BGP, including multihoming and ECMP, for interfacing </em><em>MidoNet</em><em> virtual routers with external L3 networks.</em>” Not surprisingly, I wanted to know more and he quickly organized a phone call with <a href="http://www.linkedin.com/in/dmdumitriu">Dan Mihai Dimitriu</a>, Midokura’s CTO. This is one of the slides they shared with me ... showing exactly what I was hoping to see in a virtual networks solution:</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/08/s1600-midonet-virtual-example.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="/2012/08/s520-midonet-virtual-example.png"/></a><br/>Typical MidoNet virtual network topology</div>
<p>As expected, they decided to implement virtual networks with GRE tunnels between hypervisor hosts. A typical virtual network topology mapped onto underlying IP transport fabric would thus like this:</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/08/s1600-midonet-overview-example.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="/2012/08/s520-midonet-overview-example.png"/></a><br/>MidoNet virtual networks implemented with commodity<br/>compute nodes on top of an IP fabric</div>
<p>Short summary of what they’re doing:</p>
<ul class="ListParagraph"><li>Their virtual networks solution has layer-2 virtual networks that you can link together with layer-3 virtual routers.</li>
<li>Each virtual port (including VM virtual interface) has ingress and egress firewall rules and chains (inspired by Linux <em>iptables</em>).</li>
<li>Virtual routers support baseline load balancing and NAT functionality.</li>
<li>Virtual routers are not implemented as virtual machines – they are an abstract concept used by hypervisor switches to calculate the underlay IP next hop.</li>
<li>As one would expect in a L3 solution, hypervisors are answering ARP and DHCP requests locally.</li>
<li>The edge nodes run EBGP with the outside world, appearing as a single router to external BGP speakers.</li>
</ul>
<p>Interestingly, they decided to go against the current <a href="https://www.opennetworking.org/images/stories/downloads/white-papers/wp-sdn-newnorm.pdf">centralized control plane religion</a>, and implemented most of the intelligence in the hypervisors. They use Open vSwitch (OVS) kernel module as the switching platform (proving my claim that OVS provides all you need to implement L2-4 functionality), but replaced the OpenFlow agents and centralized controller with their own distributed software.</p>
<h4>MidoNet packet forwarding process</h4><p>This is how Dan and Ben explained a day in the life of an IP packet passing through the MidoNet overlay virtual networks (I haven’t set it up to see how it really works):</p>
<p>Their forwarding agents (running in user space on all hypervisor hosts) intercept traffic belonging to unknown flows (much like the <a href="http://openvswitch.org/cgi-bin/ovsman.cgi?page=vswitchd%2Fovs-vswitchd.8">ovs-vswitchd</a>), but process the unknown packets locally instead of sending them to central OpenFlow controller. </p>
<p>The forwarding agent receiving an unknown packet would check the security rules, consult the virtual network configuration, calculate the required flow transformation(s) and egress next hop, install the flow in the local OVS kernel module, insert flow data in a central database for stateful firewall filtering of return traffic, and send the packet toward egress node encapsulated in a GRE envelope with the GRE key indicating the egress port on the egress node.</p>
<p class="note">According to Midokura, the forwarding agents generate the most-generic flow specification they can – load balancing obviously requires microflows, simple L2 or L3 forwarding doesn’t. While the OVS kernel module supports only microflow-based forwarding, the forwarding agent doesn’t have to recalculate the virtual network topology for each new flow.</p>
<p>The egress OVS switch has pre-installed flows that map GRE keys to output ports. The packet is thus forwarded straight to the destination port without going through the forwarding agent on the egress node. Like in MPLS/VPN or <a href="/2011/09/qfabric-part-3-forwarding/">QFabric</a>, the ingress node performs all forwarding decisions, the “only” difference being that MidoNet runs as a cluster of distributed software switches on commodity hardware.</p>
<p class="info">Asymmetrical return traffic is no longer an issue because MidoNet uses central flow database for stateful firewall functionality – all edge nodes act as a single virtual firewall.</p>
<p><strong>The end result:</strong> MidoNet (Midokura’s overlay virtual networking solution) performs simple L2-4 operations within the hypervisor, and forwards packets of established flows within the kernel OVS. </p>
<p>Midokura claims they achieved linerate (10GE) performance on commodity x86 hardware ... but of course you shouldn’t blindly trust me or them. Get in touch with Ben and test-drive their solution.</p>
<p class="update">Update 2012-10-07: For more details and a longer (and more comprehensive) analysis, read <a href="http://bradhedlund.com/2012/10/06/mind-blowing-l2-l4-network-virtualization-by-midokura-midonet/">Brad Hedlund's blog post</a>.</p>

