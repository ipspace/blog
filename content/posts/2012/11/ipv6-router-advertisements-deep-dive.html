---
url: /2012/11/ipv6-router-advertisements-deep-dive.html
title: "IPv6 Router Advertisements Deep Dive"
date: "2012-11-21T07:11:00.000+01:00"
tags: [ IPv6,security ]
---

<p>I’m constantly getting questions about the intricate interworking of various flags present in IPv6 Router Advertisement messages. Here’s a (hopefully comprehensive) summary taken primarily from <a href="http://tools.ietf.org/html/rfc4861">RFC 4861</a>.<!--more--></p>
<h4>A bit of the theory</h4><p>The M and O flags are always present in <a href="http://tools.ietf.org/html/rfc4861#section-4.4">RA messages</a>:</p>
<ul class="ListParagraph"><li><strong>M – Managed Address Configuration</strong>. DHCPv6 is available for IPv6 address allocation.</li>
<li><strong>O – Other Configuration</strong>. Other configuration information (ex: DNS server IPv6 address) is available through DHCPv6.</li>
</ul>
<p>RA messages may include <a href="http://tools.ietf.org/html/rfc4861#section-4.6.2">prefix information</a>. Each prefix has L and A flags:</p>
<ul class="ListParagraph"><li><strong>L – On-Link Flag</strong>. The prefix can be used for <a href="http://tools.ietf.org/html/rfc5942">on-link determination</a> (other IPv6 addresses with the same prefix are on the same L2 subnet).</li>
<li><strong>A – Address Configuration Flag</strong>. The prefix can be used for <a href="http://tools.ietf.org/html/rfc4862">stateless address configuration (SLAAC)</a>.</li>
</ul>
<h4>Default behavior: SLAAC</h4><p>The most common IPv6 address allocation mechanism is SLAAC. If you want the hosts to use SLAAC, the routers MUST include one or more prefixes with A flag set in their RA messages. </p>
<p>The RA messages SHOULD have the O flag set to prompt the end hosts to use DHCPv6 to get DNS server IPv6 address (alternative: <a href="http://tools.ietf.org/html/rfc6106">RFC 6106</a>, which is not yet widely implemented).</p>
<h4>Enforcing DHCPv6-only address assignment</h4><p>Setting the M flag in RA messages is not enough to enforce IPv6 address assignment through DHCPv6. Some hosts (example: Windows 7) will use DHCPv6 to get an IPv6 address, but also create a pseudo-random IPv6 address using <a href="http://tools.ietf.org/html/rfc4941">SLAAC privacy extensions (RFC 4941)</a>, and prefer the SLAAC-generated address.</p>
<p>You MUST clear the A flag in the prefixes advertised by the router to enforce DHCPv6-only address assignment.</p>
<p class="warn">Removing the on-link prefix from the RA messages will stop SLAAC, but also enforce PVLAN-like traffic flow. You have to remove the prefix; clearing the L flag won't stop SLAAC.</p>
<h4>Enforcing PVLAN-like traffic flow</h4><p>You can use the <a href="http://tools.ietf.org/html/rfc5942">on-link determination functionality</a> to force local host-to-host traffic through the first-hop router. IPv6 hosts use RA messages to discover on-link prefixes: all prefixes advertised in RA messages with L bit set are in the same layer-2 domain.</p>
<p class="info">This feature can be used to send direct traffic between IPv6 hosts in different IPv6 subnets.</p>
<p>To force the local host-to-host traffic through the first-hop router, clear the L flag or remove the on-link prefix from RA messages. Hosts can still use SLAAC (if the A flag is set) or DHCPv6 (if the M flag is set); the L flag affects the traffic flow, not the address assignment process.</p>
<p class="warn">The L flag is not a security measure; hosts can use local IPv6 configuration to bypass the information sent in the RA messages.</p>
<p class="update">2012-11-21 7:44Z - reworded some sections based on feedback from Tore Anderson and copied his list of gotchas into the blog post.</p>
<h4>More RA/SLAAC/DHCPv6 gotchas (courtesy of Tore Anderson):</h4><p>Tore Anderson listed numerous other gotchas in his comment (thank you!). The italicized comments are mine.</p>
<ul class="ListParagraph"><li>The O flag is meaningless if the M flag is set, as the O flag is basically a subset of the M flag (<em>broken OS stack might require both though</em>);</li>
<li>When it comes to DNS server assignment, there are OS-es that only support DHCPv6 (e.g., Windows), and there are some that only support the RDNSS Option (e.g., Mac OS X 10.6.x). Therefore, for maximum host compatibility, I recommend using both simultaneously (<em>but there are very few switches/routers supporting RDNSS</em>).</li>
<li>A prefix information option with both A and L flags unset is meaningless and might as well be removed.</li>
<li>SLAAC can only occur for prefixes with a length of 64, so setting the A flag for other prefix lenghts is meaningless. The L flag, on the other hand, works for any prefix length.</li>
<li>DHCPv6 does not carry prefix length information, so a prefix information option with L=1 is the *only* way a host may acquire an on-link route.</li>
<p class="note">For more information, read the <a href="http://blog.ioshints.info/2012/11/ipv6-on-link-determination-what-is-it.html">IPv6 On-Link Determination</a> blog post.</p>
<li>Receipt of a RA (with lifetime &gt; 0) will cause the host to install a default route to the RA's source address. This is the *only* way to advertise a default route in IPv6 (on Ethernet at least), as DHCPv6 cannot carry this information. Furthermore, the RA is guaranteed to come from a link-local address (within fe80::/64), which is crucial in making off-link prefixes work.</li>
</ul>
<h4>More information</h4><p>You’ll find detailed description of RA and DHCPv6 functionality, design recommendations and router configurations in the <a href="http://www.ipspace.net/Building_Large_IPv6_Service_Provider_Networks">Building Large IPv6 Service Provider Networks</a> webinar. You can <a href="http://www.ipspace.net/Recordings?code=IPv6SPCore">buy its recording</a> or get it as part of the <a href="http://www.ipspace.net/IPv6_trilogy">IPv6 trilogy</a> or <a href="http://www.ipspace.net/Subscription_to_ioshints_webinars">yearly subscription</a>.</p>

