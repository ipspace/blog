---
url: /2012/02/nicira-open-vswitch-inside-vsphereesx.html
title: "Nicira Open vSwitch inside vSphere/ESX"
date: "2012-02-09T08:40:00.000+01:00"
tags: [ SDN,Workshop,OpenFlow,Overlay networks,virtualization ]
---

<p>I got intrigued when reading <a href="http://www.nicira.com/en/network-virtualization-platform">Nicira’s white paper</a> claiming their Open vSwitch can run within vSphere/ESX hypervisor. There are three APIs that you could use to get that job done: <a href="http://blogs.vmware.com/vcloud/2010/04/what-actually-is-vmsafe-and-the-vmsafe-api.html">dvFilter API</a> (intercepting VM NIC like <a href="http://blog.ioshints.info/2011/04/vcloud-director-networking.html">vCDNI</a> does), the API used by Cisco’s <a href="http://blog.ioshints.info/2011/06/what-exactly-is-nexus-1000v.html">Nexus 1000V</a>, or the device driver interface (intercepting uplink traffic). Turns out Nicira decided to use a fourth approach using nothing but publicly-available APIs.<!--more--></p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/02/s1600-Nicira+ESX+%28API%29.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="185" src="/2012/02/s400-Nicira+ESX+%28API%29.png" width="400"/></a><br/>The three development APIs one could use</div>
<p>As I wrote in the <a href="http://blog.ioshints.info/2012/02/nicira-uncloaked.html">update to the Nicira Uncloaked post</a>, the cool trick they used relies on a few obscure properties of the Distributed vSwitch (vDS) and statically bound Distributed Ports. Let me show you how it actually works step-by-step (if you don’t want to spoil the magic, stop reading right now)... but before starting the journey, remember where we want to end: we want to have virtual machines connected to Open vSwitch, which uses the <em>transport network </em>(VLAN tags or MAC-over-GRE tunneling) to <a href="http://blog.ioshints.info/2011/10/what-is-nicira-really-up-to.html">build virtual networks as dictated by the OpenFlow controller</a> (Nicira’s Network Virtualization Platform – NVP).</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/02/s1600-Nicira+ESX+%28Goal%29.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="168" src="/2012/02/s400-Nicira+ESX+%28Goal%29.png" width="400"/></a></div>
<p class="note">This blog post focuses on the intra-vSphere part of the solution. For more details on the "transport" part (which I left cloudy for a reason), read my other <a href="http://www.google.si/search?q=openflow+or+nicira+site%3Aioshints.info">OpenFlow/Nicira blog posts</a>, for example <a href="http://blog.ioshints.info/2011/10/what-is-nicira-really-up-to.html"><em>What is Nicira really up to</em></a> and <a href="http://blog.ioshints.info/2011/12/decouple-virtual-networking-from.html"><em>Decouple virtual networking from the physical world</em></a>. And a short summary for the differently-attentive: the "transport" cloud is almost "NVGRE/VXLAN with a centralized control plane".</p>
<p>Start with a distributed switch (vDS). It seems like it spans across a number of hosts, but that’s just the management-plane perception; in reality, every vSphere host has an independent forwarding component.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/02/s1600-Nicira+ESX+%28VDS+transport%29.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="118" src="/2012/02/s400-Nicira+ESX+%28VDS+transport%29.png" width="400"/></a></div>
<p>Now imagine you have a vDS (or a port group within a vDS) with no uplinks. It seems to span across numerous ESX hosts, you can vMotion VMs between the hosts, but only the VMs inside the same host can actually communicate.</p>
<p>Next, start an Open vSwitch-hosting VM in every ESX host and connect it to the isolated port group as well as the outside transport network (another port group). The traffic between VMs connected to the isolated port group and the outside world has to pass through the OVS VM, and since there is no other way for the isolated VMs to reach the outside world, there can be no forwarding loops.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/02/s1600-Nicira+ESX+%28OVS+transport%29.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="132" src="/2012/02/s400-Nicira+ESX+%28OVS+transport%29.png" width="400"/></a></div>
<p>Still, the VMs connected to the same port group can communicate with each other. We need another trick – the per-port properties of statically bound Distributed Ports. If you use vDS, you can set numerous properties on individual ports (VM NICs), <em>including access VLAN</em>. Yes, you can run multiple VLANs <em>within a single port group. </em>Mindboggling. I never realized you could do that.</p>
<p>So this is what you do:</p>
<ul class="ListParagraph"><li>For every single VM connected to the port group, use <em>Virtual Switch Tagging </em>and set the access VLAN to a unique value (this does limit the number of VMs you can connect to the same port group to 409x, but that should be more than enough).</li>
<li>Configure the port connecting the OVS VM to the isolated port group to <em>Virtual Guest Tagging</em> and allow <em>promiscuous mode</em>. </li>
</ul>
<p>The OVS VM will receive all traffic generated by the VMs, nicely tagged with per-VM VLAN tags.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/02/s1600-Nicira+ESX+%28VLANs%29.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="265" src="/2012/02/s400-Nicira+ESX+%28VLANs%29.png" width="400"/></a></div>
<p>Finally, let’s take a look deeper into the OVS VM. It needs three interfaces: VM-facing interface, transport interface (where it can use VLAN tags or MAC-over-GRE tunneling to send traffic between OVS switches), and management interface (over which it communicates with the NVP OpenFlow controller). </p>
<p>The VM-facing interface appears as a physical interface to Linux running inside the VM; you can create VLAN subinterfaces on top of it (one per VM) and connect individual subinterfaces (point-to-point VLAN-tagged links to individual VMs) to OVS ports.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="/2012/02/s1600-Nicira+ESX+%28InsideVM%29.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="192" src="/2012/02/s400-Nicira+ESX+%28InsideVM%29.png" width="400"/></a></div>
<h4>Does this make sense?</h4><p>The switch-inside-a-VM solution has two obvious drawbacks:</p>
<ul class="ListParagraph"><li>The Open vSwitch VM becomes a single point of failure (but let’s <a href="http://tvtropes.org/pmwiki/pmwiki.php/Main/HandWave">handwave</a> that away – after all, <a href="http://blog.ioshints.info/2011/08/high-availability-fallacies.html">every SPOF can be removed with High Availability</a>).</li>
<li>All the inter-VM traffic has to pass through the OVS VM, which <a href="http://blog.ioshints.info/2011/10/what-is-nicira-really-up-to.html">becomes a performance bottleneck</a> (you can’t push more than a few Gbps through <a href="http://en.wikipedia.org/wiki/User_space">userland</a>).</li>
</ul>
<p>Does such a kludge make sense? It just might in (at least) three scenarios:</p>
<ul class="ListParagraph"><li>It enables a gradual migration from VMware environment to Xen/KVM/OpenStack.</li>
<li>It allows you to connect VMs that have to run on VMware for whatever reason to Xen/OpenStack/Quantum non-VLAN virtual networks (people <a href="http://www.network-janitor.net/2011/08/wholesale-virtualisation-and-selective-qinq/">complaining about VLAN limits in certain data center switches</a> might appreciate this).</li>
<li>It makes for a nice test bed. You can test OpenFlow/OVS/NVP without fully committing to a Linux-based hypervisor.</li>
</ul>
<h4>More information</h4><p>If you’re faced with the question “<em>what is this virtual network stuff all about?</em>” the <a href="http://www.ipspace.net/VMintro"><em>Introduction to Virtual Networking</em></a><em> </em>webinar might give you the answers you need. <a href="http://www.ipspace.net/VMware_Networking_Deep_Dive"><em>VMware Networking Deep Dive</em></a> webinar describes distributed switches, port groups, dvFilter API and virtual appliances; the <a href="http://www.ipspace.net/Cloud_Computing_Networking:_Under_the_Hood"><em>Cloud Computing Networking</em></a> one focuses on large-scale virtual networks needed in IaaS clouds. You get immediate access to all three webinars (and a dozen more) with the <a href="http://www.ipspace.net/Subscription_to_ioshints_webinars">yearly subscription</a>. </p>
<h4>Need help?</h4><p>If you need a second opinion or a review of your data center design, check out the <a href="http://www.ipspace.net/ExpertExpress">ExpertExpress service</a>. You could also <a href="http://www.nil.com/solutions/">engage our professional services team</a>; after all, we were the first Cisco-certified <a href="http://newsroom.cisco.com/press-release-content?type=webcontent&amp;articleId=5937271">Cloud Builders</a> in the eastern hemisphere. </p>

