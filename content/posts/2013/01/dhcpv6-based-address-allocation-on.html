---
url: /2013/01/dhcpv6-based-address-allocation-on.html
title: "DHCPv6-based address allocation on PPPoE links"
date: "2013-01-21T06:57:00.000+01:00"
tags: [ IPv6,PPP ]
---

<p><a href="http://www.linkedin.com/pub/cassidy-larson/10/786/719">Cassidy Larson</a> from <a href="http://www.infowest.com/">InfoWest</a> sent me an interesting challenge: using the sample configurations I provided in the <a href="http://www.ipspace.net/Building_Large_IPv6_Service_Provider_Networks"><em>Building Large IPv6 Service Provider Networks</em></a> webinar he was getting weird DHCPv6 errors when a residential CPE device requested a delegated prefix from the BRAS router (before moving forward, have to mention how nice it is to see an US ISP deploying IPv6 ;).<!--more--></p>
<h4>The symptoms</h4><p>He was using a configuration very similar to this one with local PPPoE address pool and local prefix delegation pool ...</p>
<p class="codecaption">Simple IPv6-over-PPPoE configuration with local pools</p>
<pre class="code">ipv6 dhcp pool Clients<br/> prefix-delegation pool DhcpPool<br/> address prefix FEC0:1:23FF:FFFF::/64<br/> dns-server FEC0::CCCC:4<br/> domain-name example.com<br/>!<br/>interface Virtual-Template10<br/> mtu 1480<br/> peer default ipv6 pool PPP<br/> ipv6 enable<br/> ipv6 nd other-config-flag<br/> no ipv6 nd ra suppress<br/> ipv6 dhcp server Clients<br/> no keepalive<br/> ppp authentication pap<br/> ppp direction callin<br/>!<br/>ipv6 local pool DhcpPool FEC0:1:2200::/40 56<br/>ipv6 local pool PPP FEC0:1:2300::/48 64</pre><p>... and observing DHCPv6 debugging printouts similar to the one below (reproduced in my lab):</p>
<p class="codecaption">DHCPv6 SOLICIT packet</p>
<pre class="code">IPv6 DHCP: Received SOLICIT from FE80::C804:7FF:FEE6:8 on Virtual-Access2.1<br/>IPv6 DHCP: detailed packet contents<br/>  src FE80::C804:7FF:FEE6:8 (Virtual-Access2.1)<br/>  dst FF02::1:2<br/>  type SOLICIT(1), xid 2333403<br/>  option ELAPSED-TIME(8), len 2<br/>    elapsed-time 0<br/>  option CLIENTID(1), len 10<br/>    00030001CA0407E60008<br/>  option ORO(6), len 4<br/>    DNS-SERVERS,DOMAIN-LIST<br/><strong>  option IA-NA(3), len 12</strong><br/><strong>    IAID 0x000B0001, T1 0, T2 0</strong></pre><p class="codecaption">DHCPv6 request processing</p>
<pre class="code">IPv6 DHCP: Using interface pool Clients<br/>IPv6 DHCP: Binding for IA_NA 000B0001 not found<br/>IPv6 DHCP: Allocating IA_NA 000B0001 in binding for FE80::C804:7FF:FEE6:8<br/>IPv6 DHCP: Freeing IA_NA 000B0001 from binding for FE80::C804:7FF:FEE6:8<br/>IPv6 DHCP: Binding for IA_NA 000B0001 not found</pre><p class="codecaption">DHCPv6 ADVERTISE response</p>
<pre class="code">IPv6 DHCP: Sending ADVERTISE to FE80::C804:7FF:FEE6:8 on Virtual-Access2.1<br/>IPv6 DHCP: detailed packet contents<br/>  src FE80::C800:7FF:FEE5:8<br/>  dst FE80::C804:7FF:FEE6:8 (Virtual-Access2.1)<br/>  type ADVERTISE(2), xid 2333403<br/>  option SERVERID(2), len 10<br/>    00030001CA0007E50008<br/>  option CLIENTID(1), len 10<br/>    00030001CA0407E60008<br/><strong>  option IA-NA(3), len 31</strong><br/><strong>    IAID 0x000B0001, T1 0, T2 0</strong><br/><strong>    option STATUS-CODE(13), len 15</strong><br/><strong>      status code NOADDRS-AVAIL(2)</strong><br/><strong>      status message: NOADDRS-AVAIL</strong><br/>  option DNS-SERVERS(23), len 16<br/>    FEC0::CCCC:4<br/>  option DOMAIN-LIST(24), len 13<br/>    example.com</pre><h4>A bit of a background</h4><p>DHCPv6 is used for (at least) three purposes in IPv6 access networks:</p>
<ul class="ListParagraph"><li>To assign IPv6 addresses to DHCPv6 clients (IA-NA option);</li>
<li>To pass DNS information (DNS server address, default domain) to the clients (DNS-SERVERS and DOMAIN-LIST options);</li>
<li>To delegate prefixes to CPE routers (IA-PD option).</li>
</ul>
<p>The use of DHCPv6 for the first two purposes SHOULD be controlled by the flags sent by the routers in Router Advertisement messages:</p>
<ul class="ListParagraph"><li>If the M flag is set, hosts COULD use DHCPv6 to get their addresses;</li>
<li>If the O flag is set, hosts COULD use DHCPv6 to get other information.</li>
</ul>
<p>You cannot force an end host to use DHCPv6 by setting the M flag in the RA messages (but you could prevent an end hosts from using SLAAC by not advertising SLAAC-able prefixes in RA messages).</p>
<p>Based on the information Cassidy sent me some CPE devices ignore the M flag as well; virtual access template was configured with <strong>ipv6 nd other-config-flag </strong>and debugging printouts indicated M flag was not set in RA messages:</p>
<p class="codecaption">Dump of RA packet</p>
<pre class="code">ICMPv6-ND: Request to send RA for FE80::C800:7FF:FEE5:8<br/>ICMPv6-ND: Setup RA from FE80::C800:7FF:FEE5:8 to FF02::1 on Virtual-Access2.1<br/>ICMPv6-ND: Setup RA common:Other stateful configuration<br/>ICMPv6-ND:  MTU = 1480<br/>ICMPv6-ND:     prefix = FEC0:1:2300::/64 onlink autoconfig<br/>ICMPv6-ND:           2592000/604800 (valid/preferred)<br/>ICMPv6: Sent R-Advert, Src=FE80::C800:7FF:FEE5:8, Dst=FF02::1</pre><p class="info">I used <strong>ipv6 address dhcp </strong>on a Cisco IOS-based CPE to force this behavior; Cassidy was using a Linksys CPE on which he could only enable or disable IPv6.</p>
<h4>Where’s the problem?</h4><p>Depending on the DHCPv6 client code in the CPE, you could observe one of these behaviors:</p>
<ul class="ListParagraph"><li>CPE gets annoyed when it can’t get an IPv6 address with DHCPv6 and never asks for the delegated prefix. User has no IPv6 connectivity (this is how my Cisco IOS release behaves ... but then I forced it to use DHCPv6);</li>
<li>CPE asks for IPv6 address and delegated prefix in the same request, but never completes the DHCPv6 address allocation because it’s upset by the STATUS-CODE in IA-NA option (yeah, you really couldn’t expect half of your request to fail, could you?). Seems the Linksys router Cassidy is using is in this category;</li>
<li>CPE survives the partial DHCPv6 response failure, but still doesn’t use SLAAC on the outside interface and thus never gets a globally routable outside IPv6 address. This shouldn’t be a big problem unless the customer tries to do a ping from the CPE (or configures NAT66 ;).</li>
</ul>
<p>Anyhow, history shows we cannot rely on CPEs doing the right thing (after all, why would a CPE use DHCPv6 IA-NA if the BRAS never tells it to do so), so we have to cope with whatever is thrown at us.</p>
<h4>Can we fix it? Yes we can!</h4><p>DHCPv6 server in Cisco IOS was doing IA-PD prefix delegation for a long time. They added IA-NA address allocation somewhere in the 15.x M&amp;T train, so it’s pretty easy to add an <strong>address-prefix </strong>to <strong>ipv6 dhcp pool:</strong></p>
<p class="codecaption">IPv6 DHCP pool with address and prefix delegation</p>
<pre class="code">ipv6 dhcp pool Clients<br/> prefix-delegation pool DhcpPool<br/> address prefix FEC0:1:23FF:FFFF::/64<br/> dns-server FEC0::CCCC:4<br/> domain-name example.com</pre><p>This configuration would work great on a Metro Ethernet or a WiFi subnet, but not so well in PPPoE environments – every PPPoE session is a separate virtual access interface and thus needs a separate IPv6 subnet for clients who prefer to do SLAAC (or don’t have DHCPv6 IA-NA support at all). </p>
<p>To support all possible (and impossible) combinations of client hosts and CPEs, you’d have to:</p>
<ul class="ListParagraph"><li>Assign a /64 prefix to every PPPoE link to support hosts expecting to use SLAAC;</li>
<li>Support prefix delegation and assign another prefix (anything from /48 to /64 depending on your L8-10 persuasions) to CPEs requesting the prefix;</li>
<li>Assign an IPv6 address from IA-NA pool to clients or CPEs who want to use DHCPv6 for address assignment.</li>
</ul>
<p>However, it’s impossible to make the IPv6 address CPE gets from the IA-NA pool be in the dynamic subnet allocated to each PPPoE link. To make the CPE device reachable from the IPv6 Internet, you need another static route (similar to the one generated by prefix delegation) ... and the <strong>ipv6 dhcp iana-route-add</strong> global configuration command is here to help you. After configuring it, the BRAS generates static /128 routes for DHCPv6-allocated IPv6 addresses.</p>
<p class="codecaption">IPv6 routes on virtual access interface</p>
<pre class="code">PE-A#show ipv6 route interface vi2.1 | begin ^[SC]_<br/>S   FEC0:1:2200::/56 [1/0]<br/>     via FE80::C804:7FF:FEE6:8, Virtual-Access2.1<br/>C   FEC0:1:2300::/64 [0/0]<br/>     via Virtual-Access2.1, directly connected<br/>S   FEC0:1:23FF:FFFF:C1D7:32FE:F4C7:DF8C/128 [1/0]<br/>     via FE80::C804:7FF:FEE6:8, Virtual-Access2.1</pre><h4>The final gotcha</h4><p>And thus it seems our problem is solved ... unless you’re a lucky owner of an ASR or any other Cisco IOS device running 15.2S software – they accept <strong>ipv6 dhcp iana-route-add</strong><strong> </strong>configuration command but never generate the /128 static route. Neat, isn’t it? Who would ever need that in a service provider environment?</p>
<h4>Related webinars</h4><p>You’ll find detailed description of DHCPv6 address allocation and prefix delegation mechanisms, and related design, deployment and configuration guidelines in the <a href="http://www.ipspace.net/Building_Large_IPv6_Service_Provider_Networks">Building Large IPv6 Service Provider Networks</a> webinar (you can get it as individual <a href="http://www.ipspace.net/Recordings?code=IPv6SPCore">recording</a>, or as part of the <a href="http://www.ipspace.net/IPv6_trilogy">IPv6 trilogy</a> or <a href="http://www.ipspace.net/Subscription">yearly subscription</a>).</p>

