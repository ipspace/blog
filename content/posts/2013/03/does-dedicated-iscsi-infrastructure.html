---
date: 2013-03-21T07:30:00.000+01:00
tags:
- data center
- SAN
- workshop
- FCoE
- high availability
title: Does dedicated iSCSI infrastructure make sense?
url: /2013/03/does-dedicated-iscsi-infrastructure.html
---

<p><a href="http://www.fragmentationneeded.net">Chris Marget</a> recently asked a really interesting question:</p>
<blockquote class="cite">I've encountered an environment where the iSCSI networks are built just like FC networks: Multipathing software in use on servers and storage, switches dedicated to "SAN A" and "SAN B" VLANs, and full isolation of paths (redundant paths) between server and storage. I understand creating a dedicated iSCSI VLAN, but why would you need two? Isn’t the whole thing running on top of TCP? Am I missing something?</blockquote>
<p>Well, it actually makes sense in some mission-critical environments.</p>
<p class="update">Update 2015-12-06: Ethernet checksums are not a workaround for lack of iSCSI-level checksums. If your iSCSI solution doesn't support application-level checksum, your data might be at risk<!--more--></p>
<p class="warn">Disclaimer: This response has been written after being stranded for the better part of the day in various snowed-in airports, aircraft, shuttle buses etc ... and having enough liquids to wash down the aftertaste.</p>
<p>First, there's the <a href="http://en.wikipedia.org/wiki/Layer_8">layer 8-10</a> part: Things you do will never fail (after all, you're doing them). Things that are far enough from you (and thus you're totally clueless about them) will never fail (after all, how could a unicorn-powered reality-distortion magic black box ever fail) - e.g. <a href="http://en.wikipedia.org/wiki/Fallacies_of_Distributed_Computing">Fallacies of Distributed Computing</a>. Things that are adjacent to what you do are the scary part - after all, you know enough about them to know they could fail, and you are absolutely sure people running them can never be as good as you are ;) That's why programmers worry about server failures and remain completely oblivious to network failures.</p>
<p>Now for more realistic arguments.</p>
<p>Compared to networking, storage is serious business. If you drop a user session (or phone call), nobody but the affected user cares. If the user happens to be your boss or CEO (or you drop thousands of sessions for minutes or hours), you might feel the heat, otherwise everyone accepts that just-good-enough contains some elements of shit-happens.</p>
<p>Storage is a totally different beast. A SCSI failure arriving at just the right time could easily result in the famous colored screen (or some other panic), bringing down an application server or an operating system, not a session. If that server happens to be your database or SAP server, someone has to start polishing the resume.</p>
<p>Furthermore, we (= networking engineers) don't really care if user sessions experience data corruption. After all, if we would, we wouldn't use 8-bit XOR (or is it a sum? - can't be bothered to check the RFC) checksum in IP and TCP; these checksums can fail <a href="http://conferences.sigcomm.org/sigcomm/2000/conf/paper/sigcomm2000-9-1.pdf">more often than one would think</a>.</p>
<p>Storage experts developing iSCSI realized that's not good enough and added application-level checksums to iSCSI to prevent data corruption on inter-subnet iSCSI sessions - you wouldn't want to store corrupted data into a database (or anywhere else) where it can stay for years, would you? </p>
<p>Someone from IBM published a great article explaining the need for iSCSI checksums a while ago (and of course I can't find it; <a href="http://tools.ietf.org/html/rfc3385">RFC 3385</a> does contain some hints), and in case you wonder whether routers can actually corrupt packets, the answer is YES (and <a href="http://mina.naguib.ca/blog/2012/10/22/the-little-ssh-that-sometimes-couldnt.html">someone managed to isolate a faulty router three AS-es down the road</a>). I have also seen cut-through switches helping broken NICs (that didn't check the checksum) corrupt the data (admittedly that was 20 years ago, but the history has a nasty circular habit).</p>
<p>Of course some vendors cutting corners launched crippled boxes that require layer-2 connectivity for iSCSI replication. The only explanation I can find for that abominable restriction is lack of iSCSI-level checksums. Ethernet checksums are orders of magnitude better than IP/TCP ones, and actually comparable to iSCSI checksums, so if you're too lazy (or your hardware is too crappy) to do the proper thing, you <a href="https://blog.ipspace.net/2012/07/virtualized-squashed-complexity-sausage.html">stomp on the complexity sausage</a> and push the hard work the other way. After all, <a href="https://blog.ipspace.net/2012/10/if-something-can-fail-it-will.html">what could possible go wrong</a> with <a href="https://blog.ipspace.net/2011/06/stretched-clusters-almost-as-good-as.html">long-distance STP-assisted layer-2 connectivity</a> (aka “the thing we don’t understand at all, but it seems to work”).</p>
<p class="warn">It turns out those vendors believe in CRC fairy. <a href="https://blog.ipspace.net/2015/11/ethernet-checksums-are-not-good-enough.html">Stretched VLAN is not a data protection measure</a>, and if your iSCSI vendor doesn't support application-level checksum, your data is at risk no matter what.</p>
<p>Finally, when the proverbial substance hits the rotating blades, it's usually not limited to a single box, particularly in layer-2 environments favored by the just-mentioned storage vendors. A single STP loop (or any other loop-generating bug, including some past vPC bugs) can bring down the whole layer-2 domain ... including both server-to-storage paths.</p>
<p>With all this in mind, it makes perfect sense to have two airgapped iSCSI networks in some environments. Obviously some people (or their CFOs) don't care enough about data availability to invest in them, and prefer the <a href="http://en.wikipedia.org/wiki/Cargo_cult">cargo cult</a> approach of using two iSCSI VLANs to pretend they have FC-like connectivity, reminding me of some other people who don't want to invest in proper application development (and use of DNS for IP address resolution), load balancers etc. Believing in fairies and unicorns is so much easier.</p>
<p>Finally, a storage protocol rant wouldn’t be complete without a passing mention of FCoE. Every single vendor (ahem, both of them) is so proud of the A/B separation at server-to-ToR boundary (which, BTW, <a href="https://blog.ipspace.net/2011/12/fcoe-and-lag-industry-wide-violation-of.html">violates IEEE 802.1ax and BB-5</a>) that they forget to mention the A/B separation at the edge of a single network doesn't help once you have a network-wide meltdown.</p>
<div class="separator"><img border="0" src="/2013/03/s480-Sparks.png"/><br/>This is what happens when I start discussing FCoE and LAG (author: Jon Hudson)</div>

