---
url: /2013/10/can-bgp-route-reflectors-really.html
title: "Can BGP Route Reflectors Really Generate Forwarding Loops?"
date: "2013-10-08T07:48:00.000+02:00"
tags: [ MPLS,BGP,IP routing ]
---

<p>TL&amp;DR Summary: Yes (if you’re clumsy enough).</p>
<p>A while ago I read <a href="http://inl.info.ucl.ac.be/system/files/igpmig_bgp_tr.pdf"><em>Impact of Graceful IGP Operations on BGP</em></a> – an article that described how changes in IGP topology result in temporary (or sometimes even permanent) forwarding loops in networks using BGP route reflectors. </p>
<p>Is the problem real? Yes, it is. Could you generate a BGP RR topology that results in a permanent forwarding loop? Yes. It’s not that hard.<!--more--></p>
<h4>I Think I Broke It</h4><p>Here’s a particularly broken topology (connections with arrows are BGP sessions, R1 and R2 are route reflectors, all other routers are their clients).</p>
<div class="separator"><a href="/2013/10/s1600-BGP_RR_Broken.png" imageanchor="1"><img border="0" src="/2013/10/s500-BGP_RR_Broken.png"/></a></div>
<p>Assuming E1 and E2 advertise an identical external prefix (<em>IP-External</em>) over their IBGP sessions, this topology results in a permanent forwarding loop. Can you figure out why that’s the case?</p>
<div class="warn">Although the above topology looks utterly silly, you might get dangerously close to it in a well-designed network after one or more IBGP session failures.</div>
<h4>Route Reflector Is Just a Router</h4><p>A BGP route reflector is nothing more than a regular BGP router with <a href="https://blog.ipspace.net/2008/08/bgp-route-reflector-details.html">a few route propagation rules bolted onto the update generation code</a>. It still follows all the rules of BGP route processing:</p>
<ul class="ListParagraph"><li>Receive routes from BGP peers;</li>
<li>Install all (accepted) routes into BGP RIB;</li>
<li>For every IP prefix, select the best route from all RIB routes describing that prefix;</li>
<li>Advertise the best routes to BGP peers (and here’s where a route reflector deviates from standard BGP behavior – it <a href="https://blog.ipspace.net/2009/04/bgp-route-reflector-update-groups.html">advertises best routes to its clients</a> regardless of how it got them).</li>
</ul>
<h4>BGP Route Selection Rules Reexamined</h4><p>Route reflectors in our diagram (R1 and R2) receive BGP routes for the <em>IP-External</em> prefix from E1 and E2. Assuming the updates are identical, R1 and <a href="http://www.cisco.com/en/US/tech/tk365/technologies_tech_note09186a0080094431.shtml">R2 select their best BGP route based on lowest IGP cost</a> – R1 will select the route advertised by E1; R2 will select the route advertised by E2.</p>
<h4>BGP Route Reflectors and Forwarding Topology</h4><p>Next step in our forwarding loop creation: R1 advertises the best route to <em>IP-External </em>with E1 as the BGP next hop to all its clients (E1, E2 and C2). E1 and E2 ignore the update (they both have a better route), C2 uses it. </p>
<p>Similarly, R2 advertises its best route to <em>IP-External </em>with E2 as BGP next hop to E1, E2 and C1. C1 uses the advertised route.</p>
<p>Based on its BGP table (copied into IP routing table and FIB) C1 sends the traffic for <em>IP-External </em>toward BGP next hop E2. <a href="https://blog.ipspace.net/2010/09/ribs-and-fibs.html">Recursive next hop resolution</a> results in C2 being the true next hop. Likewise, C2 sends the traffic for <em>IP-External </em>to C1. Bingo! A permanent forwarding loop.</p>
<p>Can you prevent the forwarding loop? You can avoid most of them with a good design – make sure your BGP sessions don’t deviate too much from the forwarding topology. Ideally, all BGP route reflectors in a cluster would have equal IGP cost to all BGP next hops.</p>
<p>Alternatively, if you’re OK with a slightly slower convergence, you could establish IBGP sessions across physical links (so they’re guaranteed to follow the forwarding topology) and turn every single router into a BGP route reflector ... effectively turning BGP into RIP.</p>
<h4>MPLS is the answer. What was the question?</h4><p>OK, good design clearly helps. But can you <strong>prevent</strong> the forwarding loops? Sure – MPLS is always the right answer (these days it might be LISP, but I’m digressing).</p>
<p>If you deploy LDP-based MPLS forwarding in your BGP network, the packets toward the BGP next hops always carry an LDP-generated label for the BGP next hop (not the external prefix) and thus get across your autonomous system without a single additional L3 lookup. Even if the forwarding tables derived from BGP information don’t make much sense, the packets still get to some egress router (although they might take a suboptimal path).</p>
<p class="note">You don’t need to deploy a <a href="https://blog.ipspace.net/2012/01/bgp-free-service-provider-core-in.html">BGP-free core</a> to make MPLS work. MPLS-based forwarding gets rid of forwarding loops even in traditional networks with BGP running on every router.</p>

