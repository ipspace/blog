---
date: 2013-06-04T07:16:00.000+02:00
tags:
- data center
- workshop
- fabric
- IP routing
- LAN
title: VRRP, Anycasts, Fabrics and Optimal Forwarding
url: /2013/06/vrrp-anycasts-fabrics-and-optimal.html
---

<p>The <a href="https://blog.ipspace.net/2013/05/optimal-l3-forwarding-with-varp-and.html">Optimal L3 Forwarding with VARP/VRRP</a> post generated numerous comments, ranging from technical questions about VARP (more about that in a few days) to remarks along the lines of “you can do that with X” or “vendor Y supports Z, which does the same thing.” It seems I’ve opened yet another can of worms, let’s try to tame and sort them.<!--more--></p>
<h4>FHRP Basics</h4><p>First-hop redundancy protocols (FHRP) solve a simple problem: IPv4 has no standard host-to-router protocol. Hosts are usually configured with a static address of the first-hop router, forcing the routers to share an IP address (sometimes called Virtual Router IP Address) in redundant environments. In most cases the routers also share the MAC address of the shared first-hop router IP address to work around broken or <span style="text-decoration: line-through">misconfigured</span> secured IP stacks that ignore gratuitous ARPs sent after the ownership of the shared IP address changes.</p>
<p class="note">I’ll use the term FHRP throughout this document to indicate a range of protocols, including HSRP, GLBP, VRRP v2 and v3.</p>
<p>Typical FHRP use case is a large layer-2 domain connecting numerous end hosts to more than one router. The routers are (relatively) close together, and there’s some indeterminate layer-2 infrastructure (anything from a <a href="http://en.wikipedia.org/wiki/10BASE5">thick coax cable</a> to large TRILL or SPB fabric) between the end hosts and the routers.</p>
<div class="separator"><a href="/2013/06/s1600-FHRP_Generic.jpg" imageanchor="1"><img border="0" src="/2013/06/s320-FHRP_Generic.jpg"/></a></div>
<p>The first-hop routers cannot rely on any particular forwarding behavior of the underlying layer-2 infrastructure; each router must have its own set of MAC addresses that have to be <em>active</em> <em>– </em>traffic must be sourced from those MAC addresses lest the layer-2 switches start flooding the unicast traffic sent to one of the router’s MAC address.</p>
<div class="separator"><a href="/2013/06/s1600-FHRP_Generic_Inside.jpg" imageanchor="1"><img border="0" src="/2013/06/s320-FHRP_Generic_Inside.jpg"/></a></div>
<p>The <em>active MAC address</em> requirement usually limits the number of active FHRP forwarders to one – multiple forwarders using the same MAC address would cause <a href="http://www.nerdthinking.com/2011/cisco-mac-address-flapping-causing-high-cpu-utilization/">serious <em>MAC flapping </em> on intermediate switches</a>, and the intermediate switches wouldn’t be able to perform load balancing toward multiple identical MAC addresses anyway.</p>
<h4>Data Center Use Case</h4><p>The primary goal of <a href="https://blog.ipspace.net/2012/05/does-optimal-l3-forwarding-matter-in.html">optimal layer-3 forwarding in a data center environment</a> is to minimize the leaf-to-spine traffic in environments where the amount of east-west (server-to-server) traffic significantly exceeds the amount of north-south (server-to-client) traffic. The only way to reach this goal is to introduce layer-3 forwarding functionality into hypervisors or (failing that) the top-of-rack (ToR) switches.</p>
<div class="separator"><a href="/2013/06/s1600-FHRP_DC.jpg" imageanchor="1"><img border="0" src="/2013/06/s320-FHRP_DC.jpg"/></a></div>
<div class="info"><h4 style="margin-top: 0">Layer-3 Forwarding in Hypervisors</h4><p>While we'll definitely see AWS-style layer-3 forwarding in hypervisors, we're not there yet. The only shipping products supporting it in May 2013 are <a href="https://blog.ipspace.net/2012/12/hyper-v-network-virtualization-wnvnvgre.html">Hyper-V Network Virtualization</a> (which requires NVGRE encapsulation), NEC's <a href="https://blog.ipspace.net/2013/01/nec-launched-virtual-openflow-switch.html">ProgrammableFlow virtual switch for Hyper-V</a>, and <a href="https://blog.ipspace.net/2012/08/midokuras-midonet-layer-2-4-virtual.html">Midokura's Midonet</a>.</p>
</div>
<p>The ability to <a href="https://blog.ipspace.net/2010/09/vmotion-elephant-in-data-center-room.html">migrate a running VM between physical hosts</a> (and ToR switches) introduces additional requirements: all ToR switches have to share the same MAC address; nobody likes to see the <a href="https://blog.ipspace.net/2011/02/traffic-trombone-what-it-is-and-how-you.html">traffic trombones</a> that result from a VM being pinned to a MAC address of a remote ToR switch.</p>
<h4>The Solutions</h4><p>As always the networking industry tried to “solve” the problem by introducing all sorts of <span style="text-decoration: line-through">hacks</span> inspired ideas, some of them more useless than the others. The most common ones (described in this blog post) are:</p>
<ul class="ListParagraph"><li>No FHRP (core switches appear as a single entity);</li>
<li>Active/Active FHRP on a MLAG pair;</li>
<li>GLBP.</li>
</ul>
<p>More creative solutions are described in other blog posts: <ul><li><a href="https://blog.ipspace.net/2013/05/optimal-l3-forwarding-with-varp-and.html">Optimal L3 forwarding with VARP or active/active VRRP</a></li>
<li><a href="https://blog.ipspace.net/2011/09/qfabric-part-3-forwarding.html">QFabric part 3 - forwarding</a></li>
<li><a href="https://blog.ipspace.net/2012/09/building-large-l3-fabrics-with-brocade.html">Building large L3 fabrics with Brocade VDX switches</a></li>
</ul>
<h4>No FHRP with Borg architecture</h4><p>Vendors that implement redundant switching fabrics with <a href="https://blog.ipspace.net/2011/03/data-center-fabric-architectures.html">Borg architecture</a> (<a href="https://blog.ipspace.net/2010/10/multi-chassis-link-aggregation-stacking.html">single control plane</a> – Cisco’s VSS, HP’s IRF) don’t need FHRP. After all, the whole cluster of boxes acts as a single logical device with a single set of IP and MAC addresses.</p>
<p class="note">Juniper’s Virtual Chassis looks exactly the same as Cisco’s VSS or HP’s IRF from the outside, but uses a slightly different implementation mechanism: somewhat independent control planes coordinated through a shared management plane.</p>
<p class="warn">Before someone persuades you to solve optimal L3 forwarding problem with a virtual stack of ToR switches spread all over your data center (and I've seen consultants peddling this "design" to unsuspecting customers), consider <a href="https://blog.ipspace.net/2012/11/stackable-data-center-switches-do-math.html">how the traffic will flow</a>.</p>
<h4>Active/Active FHRP over MLAG</h4><p>Almost every vendor offering <a href="https://blog.ipspace.net/2010/10/multi-chassis-link-aggregation-basics.html">MLAG functionality</a> across a pair of independent core switches (Cisco’s vPC, Arista, ALU, Avaya …) supports active/active FHRP forwarding on the core switches:</p>
<div class="separator"><a href="/2013/06/s1600-FHRP_VPC.jpg" imageanchor="1"><img border="0" src="/2013/06/s320-FHRP_VPC.jpg"/></a></div>
<p>This solution is almost a no-brainer, although the implementation details must be pretty complex, otherwise it’s hard to understand why it took some vendors years to implement it. Here’s how it works:</p>
<ul class="ListParagraph"><li>FHRP is configured on the members of the MLAG group (vPC, MCLAG ...). One of the members is elected as the active FHRP gateway and advertises the FHRP MAC address.</li>
<li>All members of the MLAG group listen to the FHRP MAC address;</li>
<li>Packets coming from the FHRP MAC address (example: VRRP advertisements) are sent over one of the LAG member links to the ToR switch – ToR switch thus knows how to reach the FHRP MAC address;</li>
<li>Packets to the FHRP MAC address are sent from the ToR switch over one of the LAG member links (not necessarily the link over which the packet from FHRP MAC address arrived), resulting in <a href="http://packetpushers.net/the-scaling-limitations-of-etherchannel-or-why-11-does-not-equal-2/">somewhat optimal load balancing</a> toward FHRP MAC address.</li>
<li>Whichever core switch receives the inbound packet to FHRP MAC address performs L3 forwarding.</li>
</ul>
<p class="warn">As always, the devil is in the details: L3 switches might send the routed traffic from their hardware MAC address (not FHRP MAC address), thoroughly confusing devices with broken TCP stacks that <a href="http://www.jeremyfilliben.com/2010/08/hsrp-vpc-and-vpc-peer-gateway-command.html">prefer to glean incoming packets instead of using standard mechanisms like ARP</a>.</p>
<p>Active/active FHRP behavior is nice-to-have if you’re satisfied with L3 forwarding on core switches. Just remember that all inter-subnet east-west traffic traverses the core even when the two VMs sit in the same hypervisor host.</p>
<div class="separator"><a href="/2013/06/s1600-FHRP_MLAG_Flow.png" imageanchor="1"><img border="0" src="/2013/06/s320-FHRP_MLAG_Flow.png"/></a></div>
<h4>The GLBP Hack</h4><p>GLBP bypassed the single forwarder limitation with an interesting trick – different hosts would receive different MAC addresses (belonging to different routers) for the shared virtual router IP address. </p>
<p>While the trick might work well in original FHRP use cases (with large L2 domain between the hosts and the bank of routers), it’s totally useless in data center environments requiring L3 forwarding at the ToR switches:</p>
<ul class="ListParagraph"><li>VM might get a MAC address from a random ToR switch (not the closest switch);</li>
<li>VM is pinned to a MAC address of a ToR switch and sends the traffic to that same switch even when you vMotion the VM to a totally different physical location.</li>
</ul>
<div class="separator"><a href="/2013/06/s1600-FHRP_GLBP_Flow.png" imageanchor="1"><img border="0" src="/2013/06/s320-FHRP_GLBP_Flow.png"/></a></div>
<p>Multi-FHRP hack, where each router belongs to multiple FHRP groups on each interface and end-hosts use different first-hop gateways, is almost identical (but harder to manage) than GLBP hack</p>
<div class="separator"><a href="/2013/06/s1600-FHRP_HSRP_AB.png" imageanchor="1"><img border="0" src="/2013/06/s320-FHRP_HSRP_AB.png"/></a></div>
<h4>More information</h4><p>Got so far? Wow, I'm impressed. Here's more:</p>
<ul class="ListParagraph"><li><a href="http://www.ipspace.net/Data_Center_3.0_for_Networking_Engineers">Data Center 3.0 for Networking Engineers</a> webinar describes numerous data center-related technologies and challenges, including L2/L3 designs;</li>
<li><a href="http://www.ipspace.net/Data_Center_Fabrics">Data Center Fabric Architectures</a> webinar describes typical fabric architectures and vendor implementations;</li>
<li>Upcoming <a href="http://www.ipspace.net/Enterasys_Robust_Data_Center_Interconnect_Solutions">Enterasys Robust Data Center Interconnect Solutions</a> webinar (<a href="http://enterasys.eventbrite.com">register here</a>) describes (among numerous other topics) active/active VRRP (Fabric Routing) available on Enterasys switches.</li>
</ul>
<p>And don't forget the related blog posts:</p>
<ul><li><a href="https://blog.ipspace.net/2013/05/optimal-l3-forwarding-with-varp-and.html">Optimal L3 forwarding with VARP or active/active VRRP</a></li>
<li><a href="https://blog.ipspace.net/2011/09/qfabric-part-3-forwarding.html">QFabric part 3 - forwarding</a></li>
<li><a href="https://blog.ipspace.net/2012/09/building-large-l3-fabrics-with-brocade.html">Building large L3 fabrics with Brocade VDX switches</a></li>
</ul>
</p>

