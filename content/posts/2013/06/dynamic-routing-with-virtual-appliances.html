---
date: 2013-06-10T07:02:00.000+02:00
tags:
- data center
- workshop
- overlay networks
- virtualization
title: Dynamic Routing with Virtual Appliances
url: /2013/06/dynamic-routing-with-virtual-appliances.html
---

<p>Meeting Brad Hedlund in person was definitely one of the highlights of my Interop 2013 week. We had an awesome conversation and quickly realized how closely aligned our views of <a href="https://blog.ipspace.net/2013/04/vlans-are-wrong-abstraction-for-virtual.html">VLANs</a>, <a href="https://blog.ipspace.net/2011/12/decouple-virtual-networking-from.html">overlay networks</a> and <a href="https://blog.ipspace.net/2013/05/simplify-your-disaster-recovery-with.html">virtual appliances</a> are. </p>
<p>Not surprisingly, Brad quickly improved my ideas with a radical proposal: running BGP between the virtual and the physical world.<!--more--></p>
<p>Let’s revisit the application stack I used in the <a href="https://blog.ipspace.net/2013/05/simplify-your-disaster-recovery-with.html">disaster recovery with virtual appliances</a> post. One of the points connecting the virtual application stack with the physical world was the outside IP address of the firewall (or load balancer if you’re using bump-in-the-wire firewall).</p>
<div class="separator"><a href="/2013/06/s1600-VA_Interaction_Points.png" imageanchor="1"><img border="0" src="/2013/06/s320-VA_Interaction_Points.png"/></a></div>
<p>Now imagine inserting a router between the firewall and the outside world, allocating a prefix to the application stack (it could be a single /32 IPv4 prefix, a single /64 IPv6 prefix, or something larger), and advertising that prefix from the virtual router to the physical world via BGP.</p>
<div class="separator"><a href="/2013/06/s1600-VA_External_BGP.png" imageanchor="1"><img border="0" src="/2013/06/s320-VA_External_BGP.png"/></a></div>
<p class="note">Before you start writing a comment complaining how three virtual appliances in sequence reduce performance and introduce unnecessary network traversals: as most virtual appliances these days use Linux, it isn’t that hard to add a few more daemons to the same VM. The three boxes in the picture could be a single VM if you prefer performance optimization over flexibility.</p>
<p>You could easily preconfigure the ToR switches (or core switches – depending on your data center design) with BGP peer templates, allowing them to accept BGP connections from a range of directly connected IP addresses, assign outside IP address to the virtual routers via DHCP (potentially running on the same ToR switch), and use MD5 authentication to provide some baseline security.</p>
<p>An even better solution would be a central BGP route server where you could do some serious authentication and route filtering. Also, you could anycast the same IP address in multiple data centers, making it easier for the edge virtual router to find its BGP neighbor even after the whole application stack has been migrated to a different location.</p>
<p>This twist on the original idea makes the virtual application stack totally portable between compatible infrastructures. It doesn’t matter what VLAN the target data center is using, it doesn’t matter what IP subnet is configured on that VLAN, when you move the application stack the client-facing router gets an outside address, establishes a BGP session with someone, and starts advertising the public-facing address range of the application.</p>
<h4>More information</h4><p>I described the basics of overlay networks in <a href="http://www.ipspace.net/Cloud_Computing_Networking">Cloud Computing Networking</a> webinar and in <a href="http://www.interop.com/lasvegas/conference/networking.php?session_id=51">Overlay Virtual Networking Explained</a> presentation @ Interop 2013. In-depth overlay networking concepts will be explained in Data Center Network Virtualization and <a href="http://www.ipspace.net/Overlay_Virtual_Networking">Overlay Virtual Networking</a> webinars in fall 2013.</p>

