---
date: 2013-05-29T07:14:00.000+02:00
tags:
- data center
- workshop
- ARP
- fabric
- IP routing
title: Optimal L3 Forwarding with VARP and Active/Active VRRP
url: /2013/05/optimal-l3-forwarding-with-varp-and.html
---

<p>I’ve blogged about the <a href="https://blog.ipspace.net/2012/05/does-optimal-l3-forwarding-matter-in.html">need for optimal L3 forwarding across the whole data center</a> almost a year ago when I introduced it as one of the interesting requirements in <a href="http://www.ipspace.net/Data_Center_Fabrics">Data Center Fabrics</a> webinar. A year later, there are still only a few companies that can deliver this functionality.<!--more--></p>
<p>Fabric solutions that appear as a single system<em> </em>to the outside world usually offer optimal L3 forwarding. These solutions include:</p>
<ul class="ListParagraph"><li>Stacking ToR switches and <a href="https://blog.ipspace.net/2010/10/multi-chassis-link-aggregation-stacking.html">other similar solutions</a>, including HP IRF and Juniper’s Virtual Chassis) definitely fall in this category (note: <a href="https://blog.ipspace.net/2012/11/stackable-data-center-switches-do-math.html">using stacked switches or virtual chassis architectures with ring-based interconnect in environments with heavy east-west traffic is NOT a good idea</a>);</li>
<li>Other architectures that present the whole fabric as a single layer-3 entity: <a href="https://blog.ipspace.net/2011/09/qfabric-part-3-forwarding.html">Juniper’s QFabric</a> and Plexxi’s Affinity Networks;</li>
<li>Controller-based solutions like NEC’s Programmable Flow (more: <a href="http://demo.ipspace.net/get/2.1%20-%20ProgrammableFlow%20Basics.mp4">ProgrammableFlow Basics</a> and <a href="http://demo.ipspace.net/get/3%20-%20Virtual%20Networking.mp4">Virtual Tenant Networks</a>).</li>
</ul>
<p class="note">Plexxi’s Affinity Networking is architecturally closer to QFabric than to OpenFlow-based networks, as the individual switches retain a large amount of intelligence and autonomy. More in a few weeks when we clean up the recording of Dan Backman explaining the Plexxi architecture during the recent <a href="http://www.ipspace.net/Data_Center_Fabrics_Update">Data Center Fabrics Update</a> webinar.</p>
<p>However, there are only two companies I’m aware of that can do optimal L3 forwarding across the whole data center while using traditional network of independent devices: <a href="https://eos.aristanetworks.com/2011/05/active-active-router-redundancy-l3-anycast-gateway/">Arista with Virtual ARP</a> and Enterasys with Fabric Routing.</p>
<p>Arista’s Virtual ARP is extremely simple – it’s like VRRP without VRRP. You have to configure the same IP address (first-hop gateway) on a VLAN interface of all ToR switches with <strong>ip virtual-router address </strong>configuration command and associate a MAC address with the shared IP address with the <strong>ip virtual-router mac-address </strong>interface configuration command.</p>
<p>The first switch that is hit with an ARP request for the shared virtual IP address will reply with the shared MAC address (I’m not sure about the details – it might well be that the ARP broadcast gets flooded to all switches, in which case the sender gets numerous replies). When a host sends an IP packet to that same shared MAC address, the first ToR switch that the packet hits intercepts the packet (because it’s listening to the shared MAC address), and performs L3 routing.</p>
<div class="separator"><a href="/2013/05/s1600-Slide+-+Arista+EOS+VARP.jpg" imageanchor="1"><img border="0" src="/2013/05/s320-Slide+-+Arista+EOS+VARP.jpg"/></a></div>
<p>Things might get nasty if you have configuration mismatches – for example, missing <strong>ip virtual-router address </strong>configuration on one of the ToR switches – so make sure you use some sort of an orchestration system to configure the ToR switches. XMPP client implemented in Arista EOS might be good enough.</p>
<p>Enterasys uses a slightly more formal approach – they started with VRRP and implemented active/active gateways across the whole fabric. More about that solution in the <a href="http://www.ipspace.net/Enterasys_Robust_Data_Center_Interconnect_Solutions">upcoming webinar</a> – I can’t spill all the beans ;), but the webinar is free, so there’s no reason not to <a href="http://enterasys-blog.eventbrite.com">register</a>.</p>

