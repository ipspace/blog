---
title: "XML-to-JSON Information Loss, Cisco Nexus OS Edition"
date: 2021-01-20 07:57:00
tags: [ automation ]
series: xml-json
---
Last week I [wrote about the interesting challenges you might encounter when using data generated by a Junos device in an Ansible playbook](/2021/01/beware-xml-json-information-loss.html). Unfortunately it's not just Junos -- every system built around XML-based data structures might experience the same issues, including Cisco Nexus OS.

{{<note>}}To be fair to Ansible developers: it's not an Ansible problem, the problem is caused by fundamental incompatibility between XML and JSON encodings, and the naive use of standard XML Python libraries. It's just that engineers who might stumble upon that problem commonly use Ansible.{{</note>}}
<!--more-->
**TL&DR**: there's a [summary](#summary) at the end of this blog post.

Let's examine the XML document created by a **show vlan** command on a newly configured Cisco Nexus switch. Focus on the *ROW_vlanbrief* tag:

{{<cc>}}XML document describing a single VLAN configured on a Nexus switch{{</cc>}}
```
switch# show vlan | xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<nf:rpc-reply
  xmlns="http://www.cisco.com/nxos:1.0:vlan_mgr_cli" 
  xmlns:nf="urn:ietf:params:xml:ns:netconf:base:1.0">
 <nf:data>
  <show>
   <vlan>
    <__XML__OPT_Cmd_show_vlan___readonly__>
     <__readonly__>
      <TABLE_vlanbrief>
       <ROW_vlanbrief>
        <vlanshowbr-vlanid>1</vlanshowbr-vlanid>
        <vlanshowbr-vlanid-utf>1</vlanshowbr-vlanid-utf>
        <vlanshowbr-vlanname>default</vlanshowbr-vlanname>
        <vlanshowbr-vlanstate>active</vlanshowbr-vlanstate>
        <vlanshowbr-shutstate>noshutdown</vlanshowbr-shutstate>
        <vlanshowplist-ifidx>...</vlanshowplist-ifidx>
       </ROW_vlanbrief>
      </TABLE_vlanbrief>
      <TABLE_mtuinfo>
       <ROW_mtuinfo>
        <vlanshowinfo-vlanid>1</vlanshowinfo-vlanid>
        <vlanshowinfo-media-type>enet</vlanshowinfo-media-type>
        <vlanshowinfo-vlanmode>ce-vlan</vlanshowinfo-vlanmode>
       </ROW_mtuinfo>
      </TABLE_mtuinfo>
     </__readonly__>
    </__XML__OPT_Cmd_show_vlan___readonly__>
   </vlan>
  </show>
 </nf:data>
</nf:rpc-reply>
]]>]]>
```

**Notes**: 

* I removed the contents of *vlanshowplist-ifidx* tag to make the printout fit the column width.
* Noticed the weird `]]>]]>` sequence at the end of the XML document? That's NETCONF message delimiter sequence that *SHOULD NOT* be in an XML printout -- no decent XML parser would parse what you got from a Nexus OS **show |Â xml** printout.

Configure another VLAN, repeat the **show vlan** command and examine the resulting XML document. You'll notice *two* instances of the *ROW_vlanbrief* tag (if you read my previous blog post on this topic you probably know where this is going ðŸ˜‰)

{{<cc>}}XML document describing a two VLANs configured on a Nexus switch{{</cc>}}
```
switch# conf t
Enter configuration commands, one per line. End with CNTL/Z.
switch(config)# vlan 2
switch(config-vlan)# end
switch# show vlan | xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<nf:rpc-reply
  xmlns="http://www.cisco.com/nxos:1.0:vlan_mgr_cli"
  xmlns:nf="urn:ietf:params:xml:ns:netconf:base:1.0">
 <nf:data>
  <show>
   <vlan>
    <__XML__OPT_Cmd_show_vlan___readonly__>
     <__readonly__>
      <TABLE_vlanbrief>
       <ROW_vlanbrief>
        <vlanshowbr-vlanid>1</vlanshowbr-vlanid>
        <vlanshowbr-vlanid-utf>1</vlanshowbr-vlanid-utf>
        <vlanshowbr-vlanname>default</vlanshowbr-vlanname>
        <vlanshowbr-vlanstate>active</vlanshowbr-vlanstate>
        <vlanshowbr-shutstate>noshutdown</vlanshowbr-shutstate>
        <vlanshowplist-ifidx>...</vlanshowplist-ifidx>
       </ROW_vlanbrief>
       <ROW_vlanbrief>
        <vlanshowbr-vlanid>2</vlanshowbr-vlanid>
        <vlanshowbr-vlanid-utf>2</vlanshowbr-vlanid-utf>
        <vlanshowbr-vlanname>VLAN0002</vlanshowbr-vlanname>
        <vlanshowbr-vlanstate>active</vlanshowbr-vlanstate>
        <vlanshowbr-shutstate>noshutdown</vlanshowbr-shutstate>
       </ROW_vlanbrief>
      </TABLE_vlanbrief>
      <TABLE_mtuinfo>
       <ROW_mtuinfo>
        <vlanshowinfo-vlanid>1</vlanshowinfo-vlanid>
        <vlanshowinfo-media-type>enet</vlanshowinfo-media-type>
        <vlanshowinfo-vlanmode>ce-vlan</vlanshowinfo-vlanmode>
       </ROW_mtuinfo>
       <ROW_mtuinfo>
        <vlanshowinfo-vlanid>2</vlanshowinfo-vlanid>
        <vlanshowinfo-media-type>enet</vlanshowinfo-media-type>
        <vlanshowinfo-vlanmode>ce-vlan</vlanshowinfo-vlanmode>
       </ROW_mtuinfo>
      </TABLE_mtuinfo>
     </__readonly__>
    </__XML__OPT_Cmd_show_vlan___readonly__>
   </vlan>
  </show>
 </nf:data>
</nf:rpc-reply>
]]>]]>
```

While Cisco Nexus OS uses XML internally, it can also do an automatic XML-to-JSON conversion -- just add `| json` to the show command. When used on the **show vlan** command, the JSON data structure returns a list of configured VLANs. As expected, the *ROW_vlanbrief* element contains a list of VLANs.

{{<cc>}}JSON object describing two VLANs configured on a Nexus switch{{</cc>}}
```
$ connect.sh c_nxos "show vlan | json" | jq
{
  "TABLE_vlanbrief": {
    "ROW_vlanbrief": [
      {
        "vlanshowbr-vlanid": "1",
        "vlanshowbr-vlanid-utf": "1",
        "vlanshowbr-vlanname": "default",
        "vlanshowbr-vlanstate": "active",
        "vlanshowbr-shutstate": "noshutdown",
        "vlanshowplist-ifidx": "..."
      },
      {
        "vlanshowbr-vlanid": "2",
        "vlanshowbr-vlanid-utf": "2",
        "vlanshowbr-vlanname": "VLAN0002",
        "vlanshowbr-vlanstate": "active",
        "vlanshowbr-shutstate": "noshutdown"
      }
    ]
  },
  "TABLE_mtuinfo": {
    "ROW_mtuinfo": [
      {
        "vlanshowinfo-vlanid": "1",
        "vlanshowinfo-media-type": "enet",
        "vlanshowinfo-vlanmode": "ce-vlan"
      },
      {
        "vlanshowinfo-vlanid": "2",
        "vlanshowinfo-media-type": "enet",
        "vlanshowinfo-vlanmode": "ce-vlan"
      }
    ]
  }
}
```

**Notes**

* As before, I removed the contents of *â€Œvlanshowplist-ifidx* tag.
* While Nexus OS displays nicely formatted XML document, its JSON printout is a mess. I decided to send it through `jq` so you'll be able to see what's going on without parsing levels of curly brackets by hand.
* **connect.sh** is my script that extracts host IP address and SSH parameters from Ansible inventory and uses them to connect to the device or execute a SSH command. You'll find it in my [netsim-tools](https://github.com/ipspace/netsim-tools) repository.

But what happens when you execute the same command on a vanilla switch with a single VLAN? Here's what you get back:

{{<cc>}}JSON object describing two VLANs configured on a Nexus switch{{</cc>}}
```
$ connect.sh c_nxos "show vlan | json" | jq
{
  "TABLE_vlanbrief": {
    "ROW_vlanbrief": {
      "vlanshowbr-vlanid": "1",
      "vlanshowbr-vlanid-utf": "1",
      "vlanshowbr-vlanname": "default",
      "vlanshowbr-vlanstate": "active",
      "vlanshowbr-shutstate": "noshutdown",
      "vlanshowplist-ifidx": "..."
    }
  },
  "TABLE_mtuinfo": {
    "ROW_mtuinfo": {
      "vlanshowinfo-vlanid": "1",
      "vlanshowinfo-media-type": "enet",
      "vlanshowinfo-vlanmode": "ce-vlan"
    }
  }
}
```

What you get back is a *ROW_vlanbrief* **dictionary**, not a list of VLANs, proving that Nexus OS uses the same naive way of converting XML to JSON as *jxmlease* library used by **junos_command** Ansible module.

## Summary

* Cisco Nexus OS uses XML data structures internally;
* Those data structures could be displayed as a result of a **show** command (with some extra garbage at the end to ensure you'll have fun parsing it)
* The same data structures could also be displayed as a JSON object... but you'll consistently get a *dictionary* instead of a *list with one element*
* Ansible **nxos_command** module does not parse XML printout (like **junos_command** does... not that it helps). The only way to get structured data from Nexus OS is to generate a JSON document on the switch.

**Long story short**: Have fun trying to deal with things that might have one or more instances. The path to network automation is truly littered with broken glass.
