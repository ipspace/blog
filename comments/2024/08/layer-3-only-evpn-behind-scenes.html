<div class="comments post" id="comments">
  <h4>3 comments:</h4>
  <div class="comments-content">
    <div class="comment-thread">
        <ol>
      <div>
        <li class="comment" id="2378">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="" rel="nofollow">darshan</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c2378" href="#2378">13 August 2024 03:25</a>
              </span>
            </div>
            <div class="comment-content"><p>how does this actually scale in larger environments or even existing environments where majority of the VLANs have already been consumed?</p>

<p>ps. don&#39;t deploy vxlan, however i&#39;d like to understand more</p>
</div>
              <div class="comment-replies">
                <div class="comment-thread inline-thread">
                  <span class="thread-count"><a>Replies</a></span>
                    <ol>
      <div>
        <li class="comment" id="2379">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="" rel="nofollow">Ivan Pepelnjak</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c2379" href="#2379">13 August 2024 03:34</a>
              </span>
            </div>
            <div class="comment-content"><p>The only VLANs needed in this setup are the internal VLANs used for VXLAN-based transport (one per VRF). They are assigned dynamically (as needed) and don&#39;t have to match across the PE devices.</p>

<p>However, if you deployed all 409x VLANs on every access switch, you have a bigger problem ;)</p>
</div>
          </div>
        </li>
      </div>
  </ol>

                </div>
              </div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="2380">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="" rel="nofollow">Martin Rusko</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c2380" href="#2380">13 August 2024 05:07</a>
              </span>
            </div>
            <div class="comment-content"><p>Regarding &quot;the transit VNI does not have to match across the PE devices&quot; you are going to cover it in the future post, I speculate there could be a chipset limitations forcing the VNI to be the same or &quot;symmetric&quot;. This limitation is documented for Juniper&#39;s ACX7100, so is this the case for anything Jericho2 based?</p>
</div>
              <div class="comment-replies">
                <div class="comment-thread inline-thread">
                  <span class="thread-count"><a>Replies</a></span>
                    <ol>
      <div>
        <li class="comment" id="2381">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="" rel="nofollow">Ivan Pepelnjak</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c2381" href="#2381">13 August 2024 05:26</a>
              </span>
            </div>
            <div class="comment-content"><p>The obvious answer is &quot;We don&#39;t know&quot; (thank you, Broadcom, we love your NDAs), but I suspect it might be more of a case of a vendor doing a less-than-optimal job (in the case of L3VPN, L2VPN is another story)</p>
</div>
          </div>
        </li>
      </div>
  </ol>

                </div>
              </div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="2382">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="" rel="nofollow"> Stefano Sasso</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c2382" href="#2382">13 August 2024 10:24</a>
              </span>
            </div>
            <div class="comment-content"><p>AFAIK, not all the vendors require to have <em>dynamic virtual VLANs</em> to map a L3VNI.</p>

<p>I.e., Aruba CX and Dell OS10 don&#39;t (and - despite I hope nobody&#39;s doing that - you can potentially use for your network all the VLAN IDs).</p>

<p>Additionally, they also allow to statically set the <em>router-mac</em> to use on the L3VNI and RT5 announces (i.e. https://www.arubanetworks.com/techdocs/AOS-CX/10.08/HTML/vxlan/Content/Chp_EVPN/EVPN_cmds/vir-mac.htm)</p>

<p>Also Linux (frr, vyos, ...) does not require dynamic vlans, but instead requires to allocate a <em>dedicated bridge interface</em> (with no bridge slaves, apart from the vxlan device which maps the vni id) to be used for r-macs.</p>
</div>
              <div class="comment-replies">
                <div class="comment-thread inline-thread">
                  <span class="thread-count"><a>Replies</a></span>
                    <ol>
      <div>
        <li class="comment" id="2383">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="" rel="nofollow">Ivan Pepelnjak</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c2383" href="#2383">14 August 2024 08:33</a>
              </span>
            </div>
            <div class="comment-content"><p>&gt; AFAIK, not all the vendors require to have dynamic virtual VLANs to map a L3VNI.</p>

<p>Don&#39;t require or don&#39;t show them? Also, what they&#39;re doing in a VM might be different from what they&#39;re doing in ASIC.</p>

<p>&gt; Also Linux (frr, vyos, ...) does not require dynamic vlans, but instead requires to allocate a dedicated bridge interface</p>

<p>Correct, but how does that map into ASIC setup on Cumulus Linux (or any other switch using FRRouting)?</p>
</div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="2384">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="" rel="nofollow">Stefano Sasso</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c2384" href="#2384">14 August 2024 11:31</a>
              </span>
            </div>
            <div class="comment-content"><p>&gt;&gt; AFAIK, not all the vendors require to have dynamic virtual VLANs to map a L3VNI.</p>

<p>&gt; Don&#39;t require or don&#39;t show them? Also, what they&#39;re doing in a VM might be different from what they&#39;re doing in ASIC.</p>

<p>Talking about (BCM) ASIC here. </p>

<p>Let&#39;s put this way: they do not require a <em>strict</em> VLAN, allowing the user to use all the possible VLANs ID (I know this because I did a qualification testing using all the vlans at the same time plus vxlan distributed irb).</p>

<p>But since you triggered my curiosity, I went into the BCM shell to check.</p>

<p>Seems that BCM chipsets allows to define a <em>VLAN</em> ID &gt; 4096, and so <em>vendor</em> uses them for vxlan operations. This is what I see from the BCM shell on a fabric leaf which has only l3 vnis:</p>

<pre>
SAI.0&gt; l3 intf show
Free L3INTF entries: 16369
Unit  Intf  VRF Group VLAN    Source Mac     MTU TTL Tunnel InnerVlan  NATRealm
------------------------------------------------------------------
0     1     -3    0     4095 1c:72:1d:bf:e8:80  16383 1    0     0     0
0     2     -3    0     4095 1c:72:1d:bf:e8:99  1600 1    0     0     0
0     3     -3    0     4095 1c:72:1d:bf:e8:9d  1600 1    0     0     0
0     4     -3    0     4095 1c:72:1d:bf:e8:99  1600 1    0     0     0
0     5     -3    0     4095 1c:72:1d:bf:e8:9d  1600 1    0     0     0
0     4096  -3    0     28672 1c:72:1d:bf:e8:80  16383 1    0     0     0
0     16376 2     0     28680 1c:72:1d:bf:e8:d3  9184 1    0     0     0
0     16377 1     0     28679 1c:72:1d:bf:e8:d3  9184 1    0     0     0
0     16378 5     0     28678 00:00:66:66:05:06  9184 1    0     0     0
0     16379 4     0     28677 00:00:66:66:05:06  9184 1    0     0     0
0     16380 3     0     28676 00:00:66:66:05:06  9184 1    0     0     0
0     16381 2     0     28675 00:00:66:66:05:06  9184 1    0     0     0
0     16382 1     0     28674 00:00:66:66:05:06  9184 1    0     0     0
</pre>

<p>And <code>00:00:66:66:05:06</code> is the rMAC I statically defined on this leaf.</p>

<p>So, a virtual interface, with <em>VLAN</em> id <em>28XXX</em> is created for each VRF/L3 VNI, with the defined mac.</p>

<p>But no VLAN space of the ASIC is used:</p>

<pre>
SAI.0&gt; vlan show
vlan 1  ports xe1-xe23 (0x00000000000000000000000000000000000000000000000000007ff800001ffc), untagged xe1-xe23 (0x00000000000000000000000000000000000000000000000000007ff800001ffc) MCAST_FLOOD_UNKNOWN
vlan 4095       ports ce,xe (0x0000000000000000000000000000000000000000000000000008fff800023ffe), untagged ce,xe (0x0000000000000000000000000000000000000000000000000008fff800023ffe) MCAST_FLOOD_UNKNOWN
SAI.0&gt;
</pre>

<p>Then the virtual interface is used as <em>egress operation</em> for the VRF&#39;s routes. i.e.,</p>

<pre>
SAI.0&gt; l3 egress show 412291
Entry  Mac                 Vlan INTF PORT MOD MPLS_LABEL ToCpu Drop RefCount L3MC
412291  00:00:66:66:01:06 28675 16381     1    0        -1   no   no   37   no
</pre>

<p>in the above case, a specific route is sent to the rmac 00:00:66:66:01:06, which is another leaf, using the virtual interface 16381.</p>

<p>WRT Cumulus, if I&#39;m not wrong it uses the Linux switchdev framework. Unfortunately it seems the documentation is not complete, so if a kernel programmer could have a look into it we can answer also that point ;)</p>
</div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="2385">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="" rel="nofollow">Ivan Pepelnjak</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c2385" href="#2385">14 August 2024 01:11</a>
              </span>
            </div>
            <div class="comment-content"><p>Wow. Thanks a million for that deep dive!</p>

<p>As for Cumulus, it probably uses the Linux switchdev framework now that it only works on the Mellanox hardware &#x1F937;&zwj;&#x2642;&#xFE0F; (it used a proprietary translator between netlink and Broadcom SDK in the past)</p>
</div>
          </div>
        </li>
      </div>
  </ol>

                </div>
              </div>
          </div>
        </li>
      </div>
  </ol>

    </div>
  </div>
</div>
