{
   "comments": [
      {
         "comments": [
            {
               "date": "13 August 2024 03:34",
               "html": "<p>The only VLANs needed in this setup are the internal VLANs used for VXLAN-based transport (one per VRF). They are assigned dynamically (as needed) and don&#39;t have to match across the PE devices.</p>\n\n<p>However, if you deployed all 409x VLANs on every access switch, you have a bigger problem ;)</p>\n",
               "id": "2379",
               "name": "Ivan Pepelnjak",
               "pub": "2024-08-13T15:34:05",
               "ref": "2378",
               "type": "comment"
            }
         ],
         "date": "13 August 2024 03:25",
         "html": "<p>how does this actually scale in larger environments or even existing environments where majority of the VLANs have already been consumed?</p>\n\n<p>ps. don&#39;t deploy vxlan, however i&#39;d like to understand more</p>\n",
         "id": "2378",
         "name": "darshan",
         "pub": "2024-08-13T15:25:25",
         "type": "comment"
      },
      {
         "comments": [
            {
               "date": "13 August 2024 05:26",
               "html": "<p>The obvious answer is &quot;We don&#39;t know&quot; (thank you, Broadcom, we love your NDAs), but I suspect it might be more of a case of a vendor doing a less-than-optimal job (in the case of L3VPN, L2VPN is another story)</p>\n",
               "id": "2381",
               "name": "Ivan Pepelnjak",
               "pub": "2024-08-13T17:26:44",
               "ref": "2380",
               "type": "comment"
            }
         ],
         "date": "13 August 2024 05:07",
         "html": "<p>Regarding &quot;the transit VNI does not have to match across the PE devices&quot; you are going to cover it in the future post, I speculate there could be a chipset limitations forcing the VNI to be the same or &quot;symmetric&quot;. This limitation is documented for Juniper&#39;s ACX7100, so is this the case for anything Jericho2 based?</p>\n",
         "id": "2380",
         "name": "Martin Rusko",
         "pub": "2024-08-13T17:07:35",
         "type": "comment"
      },
      {
         "comments": [
            {
               "date": "14 August 2024 08:33",
               "html": "<p>&gt; AFAIK, not all the vendors require to have dynamic virtual VLANs to map a L3VNI.</p>\n\n<p>Don&#39;t require or don&#39;t show them? Also, what they&#39;re doing in a VM might be different from what they&#39;re doing in ASIC.</p>\n\n<p>&gt; Also Linux (frr, vyos, ...) does not require dynamic vlans, but instead requires to allocate a dedicated bridge interface</p>\n\n<p>Correct, but how does that map into ASIC setup on Cumulus Linux (or any other switch using FRRouting)?</p>\n",
               "id": "2383",
               "name": "Ivan Pepelnjak",
               "pub": "2024-08-14T08:33:25",
               "ref": "2382",
               "type": "comment"
            },
            {
               "date": "14 August 2024 11:31",
               "html": "<p>&gt;&gt; AFAIK, not all the vendors require to have dynamic virtual VLANs to map a L3VNI.</p>\n\n<p>&gt; Don&#39;t require or don&#39;t show them? Also, what they&#39;re doing in a VM might be different from what they&#39;re doing in ASIC.</p>\n\n<p>Talking about (BCM) ASIC here. </p>\n\n<p>Let&#39;s put this way: they do not require a <em>strict</em> VLAN, allowing the user to use all the possible VLANs ID (I know this because I did a qualification testing using all the vlans at the same time plus vxlan distributed irb).</p>\n\n<p>But since you triggered my curiosity, I went into the BCM shell to check.</p>\n\n<p>Seems that BCM chipsets allows to define a <em>VLAN</em> ID &gt; 4096, and so <em>vendor</em> uses them for vxlan operations. This is what I see from the BCM shell on a fabric leaf which has only l3 vnis:</p>\n\n<pre>\r\nSAI.0&gt; l3 intf show\r\nFree L3INTF entries: 16369\r\nUnit  Intf  VRF Group VLAN    Source Mac     MTU TTL Tunnel InnerVlan  NATRealm\r\n------------------------------------------------------------------\r\n0     1     -3    0     4095 1c:72:1d:bf:e8:80  16383 1    0     0     0\r\n0     2     -3    0     4095 1c:72:1d:bf:e8:99  1600 1    0     0     0\r\n0     3     -3    0     4095 1c:72:1d:bf:e8:9d  1600 1    0     0     0\r\n0     4     -3    0     4095 1c:72:1d:bf:e8:99  1600 1    0     0     0\r\n0     5     -3    0     4095 1c:72:1d:bf:e8:9d  1600 1    0     0     0\r\n0     4096  -3    0     28672 1c:72:1d:bf:e8:80  16383 1    0     0     0\r\n0     16376 2     0     28680 1c:72:1d:bf:e8:d3  9184 1    0     0     0\r\n0     16377 1     0     28679 1c:72:1d:bf:e8:d3  9184 1    0     0     0\r\n0     16378 5     0     28678 00:00:66:66:05:06  9184 1    0     0     0\r\n0     16379 4     0     28677 00:00:66:66:05:06  9184 1    0     0     0\r\n0     16380 3     0     28676 00:00:66:66:05:06  9184 1    0     0     0\r\n0     16381 2     0     28675 00:00:66:66:05:06  9184 1    0     0     0\r\n0     16382 1     0     28674 00:00:66:66:05:06  9184 1    0     0     0\r\n</pre>\n\n<p>And <code>00:00:66:66:05:06</code> is the rMAC I statically defined on this leaf.</p>\n\n<p>So, a virtual interface, with <em>VLAN</em> id <em>28XXX</em> is created for each VRF/L3 VNI, with the defined mac.</p>\n\n<p>But no VLAN space of the ASIC is used:</p>\n\n<pre>\r\nSAI.0&gt; vlan show\r\nvlan 1  ports xe1-xe23 (0x00000000000000000000000000000000000000000000000000007ff800001ffc), untagged xe1-xe23 (0x00000000000000000000000000000000000000000000000000007ff800001ffc) MCAST_FLOOD_UNKNOWN\r\nvlan 4095       ports ce,xe (0x0000000000000000000000000000000000000000000000000008fff800023ffe), untagged ce,xe (0x0000000000000000000000000000000000000000000000000008fff800023ffe) MCAST_FLOOD_UNKNOWN\r\nSAI.0&gt;\r\n</pre>\n\n<p>Then the virtual interface is used as <em>egress operation</em> for the VRF&#39;s routes. i.e.,</p>\n\n<pre>\r\nSAI.0&gt; l3 egress show 412291\r\nEntry  Mac                 Vlan INTF PORT MOD MPLS_LABEL ToCpu Drop RefCount L3MC\r\n412291  00:00:66:66:01:06 28675 16381     1    0        -1   no   no   37   no\r\n</pre>\n\n<p>in the above case, a specific route is sent to the rmac 00:00:66:66:01:06, which is another leaf, using the virtual interface 16381.</p>\n\n<p>WRT Cumulus, if I&#39;m not wrong it uses the Linux switchdev framework. Unfortunately it seems the documentation is not complete, so if a kernel programmer could have a look into it we can answer also that point ;)</p>\n",
               "id": "2384",
               "name": "Stefano Sasso",
               "pub": "2024-08-14T11:31:59",
               "ref": "2383",
               "type": "comment"
            },
            {
               "date": "14 August 2024 01:11",
               "html": "<p>Wow. Thanks a million for that deep dive!</p>\n\n<p>As for Cumulus, it probably uses the Linux switchdev framework now that it only works on the Mellanox hardware &#x1F937;&zwj;&#x2642;&#xFE0F; (it used a proprietary translator between netlink and Broadcom SDK in the past)</p>\n",
               "id": "2385",
               "name": "Ivan Pepelnjak",
               "pub": "2024-08-14T13:11:01",
               "ref": "2384",
               "type": "comment"
            }
         ],
         "date": "13 August 2024 10:24",
         "html": "<p>AFAIK, not all the vendors require to have <em>dynamic virtual VLANs</em> to map a L3VNI.</p>\n\n<p>I.e., Aruba CX and Dell OS10 don&#39;t (and - despite I hope nobody&#39;s doing that - you can potentially use for your network all the VLAN IDs).</p>\n\n<p>Additionally, they also allow to statically set the <em>router-mac</em> to use on the L3VNI and RT5 announces (i.e. https://www.arubanetworks.com/techdocs/AOS-CX/10.08/HTML/vxlan/Content/Chp_EVPN/EVPN_cmds/vir-mac.htm)</p>\n\n<p>Also Linux (frr, vyos, ...) does not require dynamic vlans, but instead requires to allocate a <em>dedicated bridge interface</em> (with no bridge slaves, apart from the vxlan device which maps the vni id) to be used for r-macs.</p>\n",
         "id": "2382",
         "name": " Stefano Sasso",
         "pub": "2024-08-13T22:24:23",
         "type": "comment"
      }
   ],
   "count": 3,
   "type": "post",
   "url": "2024/08/layer-3-only-evpn-behind-scenes.html"
}
