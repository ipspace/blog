<div class="comments post" id="comments">
  <h4>22 comments:</h4>
  <div class="comments-content">
    <div class="comment-thread">
        <ol>
      <div>
        <li class="comment" id="6025263184407753354">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="" rel="nofollow">Alan Jenkins</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c6025263184407753354" href="#6025263184407753354">02 October 2014 14:15</a>
              </span>
            </div>
            <div class="comment-content">Agree with that parenthetical (weird).  I wonder what would happen if the packet filter was sending TCP RST instead of ICMP unreach.  (-p TCP REJECT --reject-with tcp-reset).<br /><br />One point that does make sense is Linux (by default) ratelimits certain ICMP (including unreach) per target, to 1 per second.  Hence why the screenshot doesn&#39;t show more than one ICMP for all those incoming packets.   http://linux.die.net/man/7/icmp<br /><br />I didn&#39;t understand the red lines at the bottom either.  Doesn&#39;t the ICMP quote the TCP/IP headers, get passed to the transport layer, and terminate the connection immediately?  .  Hmm, it&#39;s claimed that at least Linux clients treat ICMPs for established TCP connections as soft errors (retransmit opportunities), to prevent DoS.  </div>
              <div class="comment-replies">
                <div class="comment-thread inline-thread">
                  <span class="thread-count"><a>Replies</a></span>
                    <ol>
      <div>
        <li class="comment" id="8477062843161952895">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="" rel="nofollow">Alan Jenkins</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c8477062843161952895" href="#8477062843161952895">02 October 2014 14:17</a>
              </span>
            </div>
            <div class="comment-content">Soft error cite: http://www.gont.com.ar/drafts/icmp-attacks/draft-ietf-tcpm-icmp-attacks-01.html#changingharderrors</div>
          </div>
        </li>
      </div>
  </ol>

                </div>
              </div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="2820836435978769044">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="" rel="nofollow">Anonymous</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c2820836435978769044" href="#2820836435978769044">02 October 2014 14:57</a>
              </span>
            </div>
            <div class="comment-content">Why do you say that out of order packets are SP&#39;s issue? SP only provides IP connectivity and does not care about top sessions </div>
              <div class="comment-replies">
                <div class="comment-thread inline-thread">
                  <span class="thread-count"><a>Replies</a></span>
                    <ol>
      <div>
        <li class="comment" id="5617524953630048629">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="https://www.blogger.com/profile/13457151406311272386" rel="nofollow">Ivan Pepelnjak</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c5617524953630048629" href="#5617524953630048629">02 October 2014 14:58</a>
              </span>
            </div>
            <div class="comment-content">... and who could potentially reorder the packets that the server obviously sent in sequence (otherwise there would be many more reorders)? Packet Gnomes?</div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="6505597423604238543">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="https://www.blogger.com/profile/12780532753626148232" rel="nofollow">Unknown</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c6505597423604238543" href="#6505597423604238543">03 October 2014 01:31</a>
              </span>
            </div>
            <div class="comment-content">...or Data Demons, or Packet Pixies. ...Seriously though, that made me laugh pretty hard.</div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="5305730910975407711">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="" rel="nofollow">Anonymous</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c5305730910975407711" href="#5305730910975407711">03 October 2014 11:24</a>
              </span>
            </div>
            <div class="comment-content">I also thought that TCP segment reordering is a job of the Transport layer, which is a layer on the client and server, and what in the middle are not aware of.</div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="5747894503829075058">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="" rel="nofollow">Draco</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c5747894503829075058" href="#5747894503829075058">03 October 2014 14:09</a>
              </span>
            </div>
            <div class="comment-content">Different packets in the same session are not guaranteed to take the same path through the internet.<br /><br />Due to various path and link load-balancing methods, different packets can take a different path, and some might be queued differently along the path, or the path might have a different latency -- resulting in unpredictable ordering.<br /><br />It is still TCP&#39;s job to produce a reliable stream from this.<br /><br />And if Apache sent all the data, the client should get all the data, before they process the closing of the TCP stream....<br /></div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="8344431680793934495">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="" rel="nofollow">Anonymous</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c8344431680793934495" href="#8344431680793934495">03 October 2014 20:47</a>
              </span>
            </div>
            <div class="comment-content">Yes, that&#39;s why SP only guarantee IP connectivity and it&#39;s not aware of the top session</div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="8953042787488891853">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="https://www.blogger.com/profile/11418671261451939355" rel="nofollow">R.-Adrian F.</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c8953042787488891853" href="#8953042787488891853">05 October 2014 12:31</a>
              </span>
            </div>
            <div class="comment-content">@Ivan : end system&#39;s TCP stack ? <br /><br />Unless you have very high-speed TCP connections (sensibly more than 100Mbps/TCP connection) out-of-order packets should have no impact. At very high speeds, you may start seeing some performance decrease.<br /><br />..... and then the security guys came with fancy ideas (badly) implemented in fancy firewalls .....</div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="6411718787190391514">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="https://www.blogger.com/profile/13457151406311272386" rel="nofollow">Ivan Pepelnjak</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c6411718787190391514" href="#6411718787190391514">05 October 2014 17:08</a>
              </span>
            </div>
            <div class="comment-content">Well, there is definitely something weird going on, more in a follow-up post. As for impact of out-of-order packets, where did you get the 100 Mbps+ number?</div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="1397574343128958669">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="https://www.blogger.com/profile/11418671261451939355" rel="nofollow">R.-Adrian F.</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c1397574343128958669" href="#1397574343128958669">05 October 2014 17:50</a>
              </span>
            </div>
            <div class="comment-content">I have to recognize that 100Mbps is quite random. On a LAN/MAN (ms-level latency), that limit is definitely higher. It all depends on &quot;how badly out-of order&quot; they are.</div>
          </div>
        </li>
      </div>
  </ol>

                </div>
              </div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="2154118860097474929">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="https://www.blogger.com/profile/10936865197048836868" rel="nofollow">Pavel Shirshov</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c2154118860097474929" href="#2154118860097474929">02 October 2014 19:22</a>
              </span>
            </div>
            <div class="comment-content">It looks as a http server bug. What http server do you have?<br />Did you check the http-server logs? Also you can run strace -p  to see on system calls arguments and return values. Possible it shows you something interesting.<br /></div>
              <div class="comment-replies">
                <div class="comment-thread inline-thread">
                  <span class="thread-count"><a>Replies</a></span>
                    <ol>
      <div>
        <li class="comment" id="6483435243739499286">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="https://www.blogger.com/profile/13457151406311272386" rel="nofollow">Ivan Pepelnjak</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c6483435243739499286" href="#6483435243739499286">02 October 2014 21:18</a>
              </span>
            </div>
            <div class="comment-content">Apache 2.2 (yeah, I know). No indication of weird behavior in the server logs, and unfortunately I cannot run strace because the problem appears very rarely and intermittently.</div>
          </div>
        </li>
      </div>
  </ol>

                </div>
              </div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="5966413771327665579">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="https://www.blogger.com/profile/16115281578739979183" rel="nofollow">Dave Taht</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c5966413771327665579" href="#5966413771327665579">02 October 2014 20:28</a>
              </span>
            </div>
            <div class="comment-content">If bufferbloat on the web server, implementing bql + sch_fq + pacing would help<br /><br />http://lwn.net/Articles/564825/<br /><br />Implementing htb + fq_codel on your home router would help more.<br /><br />http://snapon.lab.bufferbloat.net/~cero2/jimreisert/results.html<br /></div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="1360106713280161851">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="" rel="nofollow">Anonymous</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c1360106713280161851" href="#1360106713280161851">03 October 2014 11:19</a>
              </span>
            </div>
            <div class="comment-content">Could be traversing a FWSM in the SP infrastructure...<br /><br />https://supportforums.cisco.com/document/48551/single-tcp-flow-performance-firewall-services-module-fwsm#TCP_Sequence_Number_Randomization_and_SACK<br /></div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="1929501591110140020">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="http://blog.garraux.net" rel="nofollow">Oliver</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c1929501591110140020" href="#1929501591110140020">03 October 2014 21:02</a>
              </span>
            </div>
            <div class="comment-content">Are you sure the ICMP unreachable came from your box?  What does the TTL look like on the ICMP unreachable versus the other packets from your server?</div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="5159336934764976997">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="https://www.blogger.com/profile/13457151406311272386" rel="nofollow">Ivan Pepelnjak</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c5159336934764976997" href="#5159336934764976997">03 October 2014 21:08</a>
              </span>
            </div>
            <div class="comment-content">Wow. Thanks a million! I learn something new ever day ;)</div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="7621400726962116511">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="https://www.blogger.com/profile/16795482308125483743" rel="nofollow">Unknown</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c7621400726962116511" href="#7621400726962116511">05 October 2014 20:25</a>
              </span>
            </div>
            <div class="comment-content">another option to locate the source of the ICMP unreachable (in case its over a wan link ) is to see the original packet encapsulated in the ICMP and calculate the RTT of that packet  based on the delay from the original packet<br />This way you can understand where in the path the the the ICMP unreachable came from </div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="4247612160811754794">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="https://www.blogger.com/profile/16786647972887508643" rel="nofollow">Prasanna</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c4247612160811754794" href="#4247612160811754794">06 October 2014 05:44</a>
              </span>
            </div>
            <div class="comment-content">Good analysis<br />Agreed; a transparent proxy might have done this, after buffering the response on a slow connection it might have received close from server which might have lead to this ICMP error towards client.<br />I was thinking keepalive-timeout is applied to identify idle connection and triggered after completing the request but apache defines it as time after the last request received!! Is this a gap in our understanding or a bug? <br /><br /> </div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="4912337037043048323">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="" rel="nofollow">Anonymous</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c4912337037043048323" href="#4912337037043048323">06 October 2014 05:57</a>
              </span>
            </div>
            <div class="comment-content">Lot of questions than answer<br /><br />we are talking about 2 issues here TCP connection close and TCP-re-order. Is there are relationship between them ?. As per one of the comments on TCP_Sequence_Number_Randomization_and_SACK, how does the end node behave when SACK is invalid ?<br /><br />focusing on connection down issue, do not understand few things<br /><br />1) If the problem is due to buffer bloat (atleast that is what it seem to indicate due to increase in http keepalive timer), the ICMP packet generated by IPtables seem to reach earlier than actual download packets. Does the ISP throttling based on amount of upload/download ?<br /><br />2) The post has packet captures at one end, is there a packet captures from other end ?</div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="5908159807924731791">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="" rel="nofollow">Anonymous</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c5908159807924731791" href="#5908159807924731791">06 October 2014 11:01</a>
              </span>
            </div>
            <div class="comment-content">We had two issues lately with similar symptoms:<br />1. ngnix chunked encoding + content length bug: in this case files were corrupted between backend and frontend servers, but frontend happily passed broken files to clients - fixed by disabling some nginx modules.<br />2. TCP offload on hypervisor-NIC received large segments and ACK&#39;ed them on behalf of a VM, but VM&#39;s stack was out of buffers and never received this data - patially fixed with server-side shaping.</div>
          </div>
        </li>
      </div>
      <div>
        <li class="comment" id="5165089798388711103">
          <div class="comment-block">
            <div class="comment-header">
              <cite class="user"><a href="" rel="nofollow">Anonymous</a></cite>
              <span class="datetime secondary-text">
                <a rel="nofollow" id="c5165089798388711103" href="#5165089798388711103">13 October 2014 20:31</a>
              </span>
            </div>
            <div class="comment-content">Tcp offload on network card might do a lot of weird things, that is not possible to capture by wireshark, but SPAN.</div>
          </div>
        </li>
      </div>
  </ol>

    </div>
  </div>
</div>
